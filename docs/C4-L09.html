<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.11">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Oren Bochman">
<meta name="dcterms.date" content="2024-11-09">
<meta name="keywords" content="Time series, Filtering, Smoothing, NDLM, Normal Dynamic Linear Models, Seasonal NDLM, Superposition Principle, R code">
<meta name="description" content="Normal Dynamic Linear Models (NDLMs) are a class of models used for time series analysis that allow for flexible modeling of temporal dependencies.">

<title>96&nbsp; Bayesian Inference in the NDLM: Part 2 - M4L9 – Bayesian Statistics</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./C4-L09-Ex1.html" rel="next">
<link href="./C4-L08.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-279bd408c6dfe7bd56e8b154fe269440.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-923206e44a13b4518db4dede9f4ebdc9.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-279bd408c6dfe7bd56e8b154fe269440.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-cec409635dab7d42c7b562035797153a.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-987387ce273b62b48f1747d606bce1d5.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-cec409635dab7d42c7b562035797153a.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>

      .quarto-title-block .quarto-title-banner {
        background-image: url(images/banner_deep.jpg);
background-size: cover;
      }
</style>

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css">

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar floating quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const queryPrefersDark = window.matchMedia('(prefers-color-scheme: dark)');
    const darkModeDefault = queryPrefersDark.matches;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    queryPrefersDark.addEventListener("change", e => {
      if(window.localStorage.getItem("quarto-color-scheme") !== null)
        return;
      const alternate = e.matches
      toggleColorMode(alternate);
      localAlternateSentinel = e.matches ? 'alternate' : 'default'; // this is used alongside local storage!
      toggleGiscusIfUsed(alternate, darkModeDefault);
    });
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./C4-L00.html">Time Series Analysis</a></li><li class="breadcrumb-item"><a href="./C4-L09.html"><span class="chapter-number">96</span>&nbsp; <span class="chapter-title">Bayesian Inference in the NDLM: Part 2 - M4L9</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./C4-L00.html">Time Series Analysis</a></li><li class="breadcrumb-item"><a href="./C4-L09.html"><span class="chapter-number">96</span>&nbsp; <span class="chapter-title">Bayesian Inference in the NDLM: Part 2 - M4L9</span></a></li></ol></nav>
      <div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">96</span>&nbsp; <span class="chapter-title">Bayesian Inference in the NDLM: Part 2 - M4L9</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
            <p class="subtitle lead">Time Series Analysis</p>
                  <div>
        <div class="description">
          Normal Dynamic Linear Models (NDLMs) are a class of models used for time series analysis that allow for flexible modeling of temporal dependencies.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Bayesian Statistics</div>
                <div class="quarto-category">Time Series</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Oren Bochman </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">November 9, 2024</p>
      </div>
    </div>
    
      
    </div>
    

  <div>
    <div class="keywords">
      <div class="block-title">Keywords</div>
      <p>Time series, Filtering, Smoothing, NDLM, Normal Dynamic Linear Models, Seasonal NDLM, Superposition Principle, R code</p>
    </div>
  </div>
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Bayesian Statistics</a> 
        <div class="sidebar-tools-main">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./C1-L00.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">From Concept to Data Analysis</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Probability - M1L1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L01-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Paradigms of probability - M1L1HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Bayes’ Theorem - M1L2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L02-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Conditional Probability and Bayes’ Law - M1L2HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L02-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Probability and Bayes’ Theorem - M1L2HW2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Distributions - M1L3</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L03-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Random Variables - M1L3HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L03-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Homework on Distributions - M1L3HW2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Frequentist Inference - M2L4</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L04-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Frequentist MLE - M2L3HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Bayesian Inference - M2L5</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L05-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Homework on Likelihoods and MLEs - M2L5HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L05-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Homework on Bayesian Inference - M2L5HW2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Priors - M3L6</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L06-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Homework Posterior Probabilities - M3L6HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L07.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">M3L7 - Binomial Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L07-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Homework on Priors - M2L7HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L08.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Poisson Data - M3L8</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L08-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Homework on Poisson Data - M3L8HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L08-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Beta Bernoulli - M3L8HW2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L09.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">M4L9 - Exponential Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L09-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Homework on Exponential Data - M4L9HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Normally distributed Data - M4L10</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L10-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Homework on Normal Data - M4L10HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Non-Informative Priors - M4L11</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L11-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Homework Alternative Priors - M4L11HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Brief Review of Regression - M4L12</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L12-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">Homework Regression - M4L12HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L12-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">Homework Regression - M4L12HW2</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./C2-L00.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Techniques and Models</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">Statistical Modeling - M1L1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">M1L2 - Bayesian Modeling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">Monte Carlo estimation - M1L3</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">Metropolis-Hastings - M2L4</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L04-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">Homework on the Metropolis-Hastings algorithm - M2L4HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">Gibbs sampling - M2L5</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L05-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">Homework Gibbs-Sampling algorithm - M2L22HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">37</span>&nbsp; <span class="chapter-title">Assessing Convergence - M2L5</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L06-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">38</span>&nbsp; <span class="chapter-title">Homework on the Gibbs-Sampling algorithm - M2L5HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L06-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">Homework on M-H algorithm M2L5HW2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L07.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">40</span>&nbsp; <span class="chapter-title">Linear regression - M3L7</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L07-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">41</span>&nbsp; <span class="chapter-title">Homework on Linear Regression Model Part 1 - M2L5HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L07-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">42</span>&nbsp; <span class="chapter-title">Homework on Deviance information criterion - M2L5HW2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L08.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">43</span>&nbsp; <span class="chapter-title">ANOVA - M3L8</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L08-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">44</span>&nbsp; <span class="chapter-title">Homework on ANOVA - M3L8HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L08-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">45</span>&nbsp; <span class="chapter-title">Homework on Multiple Factor ANOVA - M3L8HW2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L09.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">46</span>&nbsp; <span class="chapter-title">Logistic regression - M3L9</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L09-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">47</span>&nbsp; <span class="chapter-title">Homework on Logistic Regression - M3L9HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">48</span>&nbsp; <span class="chapter-title">Poisson regression - M4L10</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L10-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">49</span>&nbsp; <span class="chapter-title">Homework on Poisson regression - M4L10HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">50</span>&nbsp; <span class="chapter-title">Hierarchical modeling - M4L11</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L11-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">51</span>&nbsp; <span class="chapter-title">Homework on Hierarchical Models - M4L11HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L11-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">52</span>&nbsp; <span class="chapter-title">Homework on Non-Normal Hierarchical Models - M4L11HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">53</span>&nbsp; <span class="chapter-title">Capstone Project - M4L12</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L12-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">54</span>&nbsp; <span class="chapter-title">Homework on Predictive distributions and mixture models - M4L12HW1</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./C3-L00.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Mixture Models</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">55</span>&nbsp; <span class="chapter-title">Definition of Mixture Models - M1L1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L01-Ex1-Basic-Definitions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">56</span>&nbsp; <span class="chapter-title">Basic Concepts of Mixture Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L01-Ex2-Gaussian-mixtures.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">57</span>&nbsp; <span class="chapter-title">Mixtures of Gaussians</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L01-Ex3-Zero-Inflated-distribution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">58</span>&nbsp; <span class="chapter-title">Zero inflated distributions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L01-Ex4-Def-mixture-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">59</span>&nbsp; <span class="chapter-title">Definition of Mixture Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">60</span>&nbsp; <span class="chapter-title">Likelihood functions for Mixture Models - M1L2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L02-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">61</span>&nbsp; <span class="chapter-title">Homework The Likelihood function - M1L2HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L02-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">62</span>&nbsp; <span class="chapter-title">Homework Identifiability - M1L2HW2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L02-Ex3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">63</span>&nbsp; <span class="chapter-title">Homework The likelihood function M1L2HW3</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L02-Ex4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">64</span>&nbsp; <span class="chapter-title">Homework on simulating from a Poisson Mixture Model - M1L2HW4</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L02-Ex5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">65</span>&nbsp; <span class="chapter-title">HW - Simulation of Poisson mixture model - M1L2HW5</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L02-Ex6.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">66</span>&nbsp; <span class="chapter-title">Homework Sim mixture of exponential distributions - M1L2HW6</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">67</span>&nbsp; <span class="chapter-title">The EM algorithm for Mixture models - M2L3</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L03-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">68</span>&nbsp; <span class="chapter-title">The EM algorithm for Zero-Inflated Mixtures</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L03-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">69</span>&nbsp; <span class="chapter-title">The EM algorithm for Mixture Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">70</span>&nbsp; <span class="chapter-title">MCMC for Mixture Models - M4L1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L04-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">71</span>&nbsp; <span class="chapter-title">The MCMC algorithm for Zero-Inflated Mixtures - M4L1HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L04-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">72</span>&nbsp; <span class="chapter-title">Markov chain Monte Carlo algorithms for Mixture Models - M4L1HW2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">73</span>&nbsp; <span class="chapter-title">Density Estimation - M4L5</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">74</span>&nbsp; <span class="chapter-title">Clustering - M4L6</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L07.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">75</span>&nbsp; <span class="chapter-title">Classification - M4L7</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L07-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">76</span>&nbsp; <span class="chapter-title">Old Faithful eruptions density estimation with the EM algorithm - M4L7HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L07-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">77</span>&nbsp; <span class="chapter-title">Old Faithful eruptions density estimation with the MCMC algorithms - M4L7HW2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L07-Ex3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">78</span>&nbsp; <span class="chapter-title">Homework on Bayesian Mixture Models for Classification of Banknotes - M4L7HW3</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L08.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">79</span>&nbsp; <span class="chapter-title">Computational Considerations - M5L8</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L08-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">80</span>&nbsp; <span class="chapter-title">Computational considerations for Mixture Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L09.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">81</span>&nbsp; <span class="chapter-title">Determining the number of components - M5L9</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L09-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">82</span>&nbsp; <span class="chapter-title">Homework on Bayesian Information Criteria (BIC) - M5L09HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L09-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">83</span>&nbsp; <span class="chapter-title">Homework on Estimating the number of components in Bayesian settings - M5L09HW2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L09-Ex3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">84</span>&nbsp; <span class="chapter-title">Homework on Estimating the partition structure in Bayesian models - M5L09HW3</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L09-Ex4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">85</span>&nbsp; <span class="chapter-title">Homework on BIC for zero-inflated mixtures - M5L09HW4</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./C4-L00.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Time Series Analysis</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C4-L01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">86</span>&nbsp; <span class="chapter-title">Stationarity, The ACF and the PCF M1L1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C4-L02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">87</span>&nbsp; <span class="chapter-title">The AR(1) process: definitions and properties - M1L2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C4-L03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">88</span>&nbsp; <span class="chapter-title">The AR(1): MLE and Bayesian inference - M1L3</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C4-L04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">89</span>&nbsp; <span class="chapter-title">The AR(p) process - M2L4</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C4-L05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">90</span>&nbsp; <span class="chapter-title">Bayesian Inference in the AR(p) - M2L5</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C4-L05-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">91</span>&nbsp; <span class="chapter-title">Quiz: Spectral representation of the AR(p) - M2L5</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C4-L05-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">92</span>&nbsp; <span class="chapter-title">Graded Assignment: Bayesian analysis of an EEG dataset using an AR(p) - M2L5</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C4-L06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">93</span>&nbsp; <span class="chapter-title">Normal Dynamic Linear Models, Part 1 - M3L6</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C4-L07.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">94</span>&nbsp; <span class="chapter-title">Bayesian Inference in the NDLM: Part 1 M3L7</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C4-L08.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">95</span>&nbsp; <span class="chapter-title">Seasonal NDLMs M4L8</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C4-L09.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">96</span>&nbsp; <span class="chapter-title">Bayesian Inference in the NDLM: Part 2 - M4L9</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C4-L09-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">97</span>&nbsp; <span class="chapter-title">Practice Graded Assignment: NDLM data analysis - M4L9</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C4-L10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">98</span>&nbsp; <span class="chapter-title">Final Project</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./C5-L00.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Capstone Project</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C5-L01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">99</span>&nbsp; <span class="chapter-title">Bayesian Conjugate Analysis for Autogressive Time Series Models - M1L1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C5-L01-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">100</span>&nbsp; <span class="chapter-title">Homework - Practice Quiz for Week 1 – M1L1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C5-L01-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">101</span>&nbsp; <span class="chapter-title">Homework - first-step-for-the-project – M1L1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C5-L02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">102</span>&nbsp; <span class="chapter-title">Model Selection Criteria - M2L2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C5-L02-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">103</span>&nbsp; <span class="chapter-title">Homework - Determine the order of your data – M2L2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C5-L02-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">104</span>&nbsp; <span class="chapter-title">Homework - Calculate DIC for single AR model – M2L2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C5-L03.1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">105</span>&nbsp; <span class="chapter-title">Bayesian location mixture of AR(p) models - M3L3</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C5-L03.2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">106</span>&nbsp; <span class="chapter-title">Determine the number of mixture components</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C5-L03.3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">107</span>&nbsp; <span class="chapter-title">Location and scale mixture of AR model</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./C6-L00.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Non-Parametric Models</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C6-L01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">108</span>&nbsp; <span class="chapter-title">Gaussian Processes for Regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C6-L02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">109</span>&nbsp; <span class="chapter-title">Dirichlet Process</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C6-L03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">110</span>&nbsp; <span class="chapter-title">Dirichlet Process</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Appendix: Notation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Appendix: Discrete Distributions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Appendix: Continuous Distributions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">D</span>&nbsp; <span class="chapter-title">Appendix: Exponents &amp; Logarithms</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A07.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">E</span>&nbsp; <span class="chapter-title">Appendix: The Law of Large Numbers</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A08.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">F</span>&nbsp; <span class="chapter-title">Appendix: The Central Limit Theorem</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A09.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">G</span>&nbsp; <span class="chapter-title">Appendix: Conjugate Priors</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">H</span>&nbsp; <span class="chapter-title">Appendix: Link Function</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">I</span>&nbsp; <span class="chapter-title">Appendix: Bayes by backprop</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">J</span>&nbsp; <span class="chapter-title">Bayesian Books in R &amp; Python</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A13.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">K</span>&nbsp; <span class="chapter-title">Appendix: Yule-Walker Equations &amp; Durbin-Levinson Recursion</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A14.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">L</span>&nbsp; <span class="chapter-title">Moore-Penrose Inversion &amp; Cholesky Decomposition</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A15.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">M</span>&nbsp; <span class="chapter-title">Appendix: Inequalities</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A16.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">N</span>&nbsp; <span class="chapter-title">Appendix: Wold’s theorem</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">O</span>&nbsp; <span class="chapter-title">References</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#section-NDLM-unknown-variance" id="toc-section-NDLM-unknown-variance" class="nav-link active" data-scroll-target="#section-NDLM-unknown-variance"><span class="header-section-number">96.1</span> Filtering, Smoothing and Forecasting: Unknown observational variance <span class="emoji" data-emoji="movie_camera">🎥</span></a>
  <ul class="collapse">
  <li><a href="#inference-in-the-ndlm-with-unknown-constant-observational-variance" id="toc-inference-in-the-ndlm-with-unknown-constant-observational-variance" class="nav-link" data-scroll-target="#inference-in-the-ndlm-with-unknown-constant-observational-variance"><span class="header-section-number">96.1.1</span> Inference in the NDLM with unknown constant observational variance:</a></li>
  <li><a href="#filtering" id="toc-filtering" class="nav-link" data-scroll-target="#filtering"><span class="header-section-number">96.1.2</span> Filtering</a></li>
  <li><a href="#forecasting" id="toc-forecasting" class="nav-link" data-scroll-target="#forecasting"><span class="header-section-number">96.1.3</span> Forecasting</a></li>
  <li><a href="#smoothing" id="toc-smoothing" class="nav-link" data-scroll-target="#smoothing"><span class="header-section-number">96.1.4</span> Smoothing</a></li>
  </ul></li>
  <li><a href="#summary-of-filtering-smoothing-and-forecasting-distributions-ndlm-unknown-observational-variance" id="toc-summary-of-filtering-smoothing-and-forecasting-distributions-ndlm-unknown-observational-variance" class="nav-link" data-scroll-target="#summary-of-filtering-smoothing-and-forecasting-distributions-ndlm-unknown-observational-variance"><span class="header-section-number">96.2</span> Summary of Filtering, Smoothing and Forecasting Distributions, NDLM unknown observational variance <span class="emoji" data-emoji="spiral_notepad">🗒️</span></a></li>
  <li><a href="#specifying-the-system-covariance-matrix-via-discount-factors" id="toc-specifying-the-system-covariance-matrix-via-discount-factors" class="nav-link" data-scroll-target="#specifying-the-system-covariance-matrix-via-discount-factors"><span class="header-section-number">96.3</span> Specifying the system covariance matrix via discount factors <span class="emoji" data-emoji="movie_camera">🎥</span></a></li>
  <li><a href="#ndlm-unknown-observational-variance-example" id="toc-ndlm-unknown-observational-variance-example" class="nav-link" data-scroll-target="#ndlm-unknown-observational-variance-example"><span class="header-section-number">96.4</span> NDLM, Unknown Observational Variance: Example <span class="emoji" data-emoji="movie_camera">🎥</span></a></li>
  <li><a href="#code-ndlm-unknown-observational-variance-example-mathcalr" id="toc-code-ndlm-unknown-observational-variance-example-mathcalr" class="nav-link" data-scroll-target="#code-ndlm-unknown-observational-variance-example-mathcalr"><span class="header-section-number">96.5</span> code: NDLM, Unknown Observational Variance Example <span class="emoji" data-emoji="spiral_notepad">🗒️</span> <span class="math inline">\mathcal{R}</span></a>
  <ul class="collapse">
  <li><a href="#nile-river-level-filtering-smoothing-and-forecasting-example" id="toc-nile-river-level-filtering-smoothing-and-forecasting-example" class="nav-link" data-scroll-target="#nile-river-level-filtering-smoothing-and-forecasting-example"><span class="header-section-number">96.5.1</span> Nile River Level Filtering Smoothing and Forecasting Example</a></li>
  </ul></li>
  <li><a href="#section-NDLM-eeg" id="toc-section-NDLM-eeg" class="nav-link" data-scroll-target="#section-NDLM-eeg"><span class="header-section-number">96.6</span> Case Study EEG data <span class="emoji" data-emoji="movie_camera">🎥</span></a></li>
  <li><a href="#section-NDLM-google-trends" id="toc-section-NDLM-google-trends" class="nav-link" data-scroll-target="#section-NDLM-google-trends"><span class="header-section-number">96.7</span> Case Study: Google Trends <span class="emoji" data-emoji="movie_camera">🎥</span></a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">






<section id="section-NDLM-unknown-variance" class="level2" data-number="96.1">
<h2 data-number="96.1" class="anchored" data-anchor-id="section-NDLM-unknown-variance"><span class="header-section-number">96.1</span> Filtering, Smoothing and Forecasting: Unknown observational variance <span class="emoji" data-emoji="movie_camera">🎥</span></h2>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Caution</span>Bumpy ride ahead!
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li>This material seems unnecessarily complicated:</li>
</ul>
<ol type="1">
<li>This section seems like a lots of mathematical gobbledygook without any context of motivation for application for each of the equations being presented.</li>
</ol>
<ul>
<li>After writing everything out and reviewing it multiple times, I began to develop a purely mathematical intuition i.e.&nbsp;I can relate them to the the general Bayesian inference framework,</li>
<li>I can’t however say I am much closer to using them in engineering solution based on this mathematics.</li>
<li>I doubt that doing a single capstone project will make much of a difference.</li>
</ul>
<ol start="2" type="1">
<li><p>While we will see three application in this module, (Nile river data, google trends, and EEG data). However, what I need to understand for each of these filtering, smoothing and forecasting distributions why are they useful rather than the original ones. I mean when we use to solve a specific challenge, for a dataset.</p></li>
<li><p>Perhaps the root cause here is that this course fails to acknowledge the connection of NDLM to the Kalman Filters and the much wider literature on Kalman Filters than NDLM. It appears to me that in the first course of the Kalman filtering specialization (KF bootcamp) there are a number of application that are presented each with a different requirements and that if we map the different challenges to the NDLM framework we should be able to navigate the math more easily.</p></li>
<li><p>Anyhow a lookup indicates that this model is called in the state-space modeling terminology as <strong>local level model</strong> for local level or trend filtering, such as in structural time series models, and in the Kalman filtering terminology as a KF with variance learning.</p></li>
</ol>
</div>
</div>
</div>
<p>In the case of the NDLM, where we <strong>assume</strong> That the observational variance <span class="math inline">\nu_t=v</span> i.e.&nbsp;is constant over time.</p>
<section id="inference-in-the-ndlm-with-unknown-constant-observational-variance" class="level3" data-number="96.1.1">
<h3 data-number="96.1.1" class="anchored" data-anchor-id="inference-in-the-ndlm-with-unknown-constant-observational-variance"><span class="header-section-number">96.1.1</span> Inference in the NDLM with unknown constant observational variance:</h3>
<p>Let <span class="math inline">\nu_t = v\ \forall t</span> with <span class="math inline">\nu</span> unknown and consider a DLM with the following structure: <span id="eq-NDLM-unknown-variance"><span class="math display">
\begin{aligned}
  y_t &amp;= \mathbf{F}_t' \boldsymbol{\theta}_t + \nu_t,                
      &amp;\nu_t &amp;\sim \mathcal{N} (0, \nu)
      &amp;\text{(obs)}\\
  \boldsymbol{\theta}_t &amp;= \mathbf{G}_t \boldsymbol{\theta}_{t-1} + \boldsymbol{\omega}_t,
      &amp; \boldsymbol{\omega}_t
      &amp;\sim \mathcal{N} (0, \nu \mathbf{W}^*_t)
      &amp;\text{(sys)}
\end{aligned}
\tag{96.1}</span></span></p>
<ul>
<li>where we have the usual suspects:
<ul>
<li>the first equation is the observation equation, that relates the hidden state <span class="math inline">\theta_t</span> to the observation and the observation level noise <span class="math inline">\nu_t</span>, (perhaps in our sensors)</li>
<li>the second equation is the state equation, which describes how the hidden state <span class="math inline">\theta_t</span> evolves over time with the system noise <span class="math inline">\boldsymbol{\omega}_t</span>. perhaps (due to an approximation in the system dynamics).</li>
<li><span class="math inline">\mathbf{F}_t</span> is a known observation matrix,</li>
<li><span class="math inline">\mathbf{G}_t</span> is a known state transition matrix,</li>
<li><span class="math inline">\boldsymbol{\theta}_t</span> is the state vector, and</li>
<li><span class="math inline">\boldsymbol{\omega}_t</span> is the system noise.</li>
<li><span class="math inline">\mathbf{W}_t</span> is a the known covariance matrix, for system noise which is assumed to be known for all time t</li>
</ul></li>
</ul>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>Question: why does <span class="math inline">\nu</span> appear in the <span class="math inline">w_t</span> distribution equation?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<p>Prado says is also <strong>assuming</strong> that the system noise is conditional on the variance <span class="math inline">\nu</span>. Yet this seems to be an assumption that should be justified.</p>
<p>In fact, What we are missing is a logical Model for this model i.e.&nbsp;simple use case</p>
</div>
</div>
</div>
<p>with conjugate prior distributions: <span id="eq-NDLM-unknown-variance-priors"><span class="math display">
\begin{aligned}
(\boldsymbol{\theta}_0 \mid \mathcal{D}_0, \nu) &amp;\sim \mathcal{N} (\mathbf{m}_0, \nu\ \mathbf{C}^*_0) \\ (\nu \mid \mathcal{D}_0) &amp;\sim \mathcal{IG}\left(\frac{n_0}{2}, \frac{d_0}{2}\right ) \\
d_0 &amp;= n_0 s_0
\end{aligned}
\tag{96.2}</span></span></p>
</section>
<section id="filtering" class="level3" data-number="96.1.2">
<h3 data-number="96.1.2" class="anchored" data-anchor-id="filtering"><span class="header-section-number">96.1.2</span> Filtering</h3>
<p>Assuming <span class="math inline">(\boldsymbol{\theta}_{t-1} \mid \mathcal{D}_{t-1}, \nu) \sim \mathcal{N} (\mathbf{m}_{t-1}, \nu\ \mathbf{C}^*_{t-1})</span>, we have the following results:</p>
<ul>
<li><span class="math inline">(\boldsymbol{\theta}_t \mid \mathcal{D}_{t-1}, \nu) \sim \mathcal{N} (\mathbf{a}_t, \nu \mathbf{R}^*_t)</span>
<ul>
<li>with
<ul>
<li><span class="math inline">\mathbf{a}_t = \mathbf{G}_t \mathbf{m}_{t-1}</span></li>
<li><span class="math inline">\mathbf{R}^*_t = \mathbf{G}_t \mathbf{C}^*_{t-1} \mathbf{G}'_t + \mathbf{W}^*_t</span>,</li>
</ul></li>
</ul></li>
</ul>
<p>and unconditional on <span class="math inline">\nu</span>, we have</p>
<ul>
<li><span class="math inline">(\boldsymbol{\theta}_t \mid \mathcal{D}_{t-1}) \sim T_{n_{t-1}} (\mathbf{a}_t, \mathbf{R}_t)</span>
<ul>
<li>with
<ul>
<li><span class="math inline">\mathbf{R}_t = s_{t-1} \mathbf{R}^*_t</span></li>
<li><span class="math inline">s_t\ \forall t</span> given in <a href="#eq-NDLM-unknown-variance-filtering" class="quarto-xref">Equation&nbsp;<span>96.3</span></a>.</li>
</ul></li>
</ul></li>
<li><span class="math inline">(y_t \mid \mathcal{D}_{t-1}, \nu) \sim \mathcal{N} (f_t, \nu q^*_t)</span>
<ul>
<li>with
<ul>
<li><span class="math inline">f_t = F'_t \mathbf{a}_t</span></li>
<li><span class="math inline">q^*_t = (1 + F'_t \mathbf{R}^*_t F_t)</span></li>
</ul></li>
</ul></li>
</ul>
<p>and unconditional on <span class="math inline">\nu</span> we have</p>
<ul>
<li><p><span class="math inline">(y_t \mid \mathcal{D}_{t-1}) \sim T_{n_{t-1}} (f_t, q_t)</span></p>
<ul>
<li>with
<ul>
<li><span class="math inline">q_t = s_{t-1} q^*_t</span></li>
</ul></li>
</ul></li>
<li><p><span class="math inline">(v \mid \mathcal{D}_t) \sim \mathcal{IG}\left( \tfrac{n_t}{2}, \tfrac{s_t}{2}\right )</span></p>
<ul>
<li>with</li>
<li><span class="math inline">n_t = n_{t-1} + 1</span> <span id="eq-NDLM-unknown-variance-filtering"><span class="math display">
s_t = s_{t-1} + \frac{s_{t-1}}{n_t} \left ( \frac{e^2_t}{q^*_t} - 1 \right ),
\tag{96.3}</span></span></li>
</ul>
<p>here <span class="math inline">e_t = y_t - f_t</span></p></li>
<li><p><span class="math inline">(\theta_t \mid D_t, v) \sim N (m_t, vC^*_t)</span>,</p>
<ul>
<li>with
<ul>
<li><span class="math inline">m_t = a_t + A_t e_t</span>, and</li>
<li><span class="math inline">C^*_t = R^*_t - A_t A'_t q^*_t</span>.</li>
</ul></li>
</ul></li>
</ul>
<p>Similarly, unconditional on <span class="math inline">\nu</span> we have</p>
<ul>
<li><span class="math inline">(\boldsymbol{\theta}_t\mid \mathcal{D}_t) \sim T_{n_t} (\mathbf{m}_t, \mathbf{C}_t)</span>
<ul>
<li>with
<ul>
<li><span class="math inline">\mathbf{C}_t = s_t \mathbf{C}^*_t</span></li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="forecasting" class="level3" data-number="96.1.3">
<h3 data-number="96.1.3" class="anchored" data-anchor-id="forecasting"><span class="header-section-number">96.1.3</span> Forecasting</h3>
<p>Similarly, we have the forecasting distributions:</p>
<ul>
<li><p><span class="math inline">(\boldsymbol{\theta}_{t+h} \mid \mathcal{D}_t) \sim T_{n_t} (\mathbf{a}_{t}(h), \mathbf{R}_{t}(h))</span>,</p></li>
<li><p><span class="math inline">(y_{t+h} \mid \mathcal{D}_t) \sim T_{n_t} (f_{t}(h), q_{t}(h))</span>,</p></li>
<li><p>with</p>
<ul>
<li><span class="math inline">\mathbf{a}_{t}(h) = \mathbf{G}_{t+h} \mathbf{a}_{t}(h-1)</span>,</li>
<li><span class="math inline">\mathbf{a}_{t}(0) = \mathbf{m}_t</span>, and</li>
</ul></li>
</ul>
<p><span class="math display">
\begin{aligned}
  \mathbf{R}_{t}(h) &amp;= \mathbf{G}_{t+h} \mathbf{R}_{t}(h-1) \mathbf{G}'_{t+h} + \mathbf{W}_{t+h} \\
  \mathbf{R}_{t}(0) &amp;= \mathbf{C}_t
\end{aligned}
</span></p>
<p><span class="math display">
f_{t}(h) = \mathbf{F}'_{t+h} \mathbf{a}_{t}(h) \qquad q_{t}(h) = \mathbf{F}'_{t+h} \mathbf{R}_{t}(h) \mathbf{F}_{t+h} + s_{t}
</span></p>
</section>
<section id="smoothing" class="level3" data-number="96.1.4">
<h3 data-number="96.1.4" class="anchored" data-anchor-id="smoothing"><span class="header-section-number">96.1.4</span> Smoothing</h3>
<p>Finally, the smoothing distributions have the form:</p>
<p><span class="math display">
(\boldsymbol{\theta}_t \mid \mathcal{D}_T) \sim T_{n_T} (a_T (t - T), R_T (t - T) s_T / s_t)
</span></p>
<ul>
<li>where -<span class="math inline">a_T (t - T)</span> and <span class="math inline">R_T (t - T)</span> with <span class="math display">
a_T (t - T) = m_T - B_T [a_{T+1} - a_T (t - T + 1)]
</span></li>
</ul>
<p><span class="math display">
R_T (t - T) = C_T - B_T [R_{T+1} - R_T (t - T + 1)] B'_T
</span></p>
<p>with</p>
<p><span class="math display">
B_T = C_T G'_{T+1} R^{-1}_{T+1}, \quad a_T (0) = m_T , \quad R_T (0) = C_T.
</span></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Video Transcript
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>[MUSIC] We will now discuss the filtering, and smoothing, and forecasting distributions. In the case of the normal dynamic linear model, where we assume that the observational variance is constant over time. So we’re going to call that variance v and so vt is equal to v for all t, but v is unknown. So we’re going to place a prior distribution on that variance. We are going to write down the model in terms of again, an observation equation and a system equation. The observation equation has the same form that we discussed before. We’re now the observational variance vt is changed to be always v, but now v is unknown. And then the system equation we are going to write down as an equation that is conditional on the variance v. So we have that say theta t is equal to Gt theta t minus one plus the system noise. And we are assuming that this is normally distributed with mean zero and now the variance co-variance matrix is v times Wt star. So here we assume then that Wt star is a known quantity for all the times t from one and so on. And then we’re also assuming that Ft and Gt are given. So what kind of prior distribution can we use now? The structure of the prior in this case that is conjugated with the model that we are proposing is a normal inverse gamma prior that means for theta zero given the zero we condition on v. We’re going to use a normal prior distribution with mean m0 and variance co-variance matrix v times C0 star. And then the distribution for v given D0 is an inverse gamma with parameters n0 half and d0 half. d0 can be written in terms of n0 times s0, so here n0 is the degrees of freedom parameter. So the higher the value of the degrees of freedom is the more information you are inputting in this prior. And then s0 is a prior estimate of the variance v before you obtain any observations, so this is how you can view the prior. So this is a conditional prior structure, if you use this prior structure, you can obtain the filtering equations in closed form. The smoothing equations also in closed form. So we are going to discuss those equations now, so again, we are assuming that at time t- 1. We have this conditional structure in which the prior the posterior at time t -1, given the t -1, and v has this normal structure conditional on v. And then we given the t minus one, has this inverse gamma structure. Now, my parameters are indexed it in time, do I have nt- 1/2, and dt- 1/2, and the dt- 1 has the same structure, nt- 1 times St- 1. So, if I have this condition structure, we can show, and this structure, as we said, is true for t = 0, as we wrote down before. We can show that the prior distribution at time t given Dt- 1 and conditional on v is a normal at vRt star. And now I have equations just to compute the value of the mean at is Gt * mt- 1. So this is exactly the same equation we had before when we were discussing the case of the DLM with known variances at both the observational and system level. And now we have thi Rt star that has the structure Gt Ct- 1, Gt transpose plus Wt star. And then we can obtained as well the one step ahead forecast distribution for yt given Dt- 1, conditional on v is given by this equation here. It’s a normal Ft vqt star, where Ft is Ft transports t, and qt star is Ft transpose, t, Rt star Ft + 1. So we have again, conditional structures on v and then we can obtain the posterior distribution for the variance after I get my first observation, yt. And this is going to be given in terms of an inverse gamma nt over to dt Over two. And the degrees of freedom parameter is updated in such a way that it was the number of degrees of freedom you had at step t- 1 + 1. This plus one has to do with the observation you just collected. And then you can compute the dt as nt * St where St is given by this equation here, so it depends on St- 1. It depends on the number of degrees of freedom, it depends on et which is the given by yt- ft, so that’s the prediction error. So yt is the new observation you just obtained and then qt is st- 1qt star. Finally, you can then obtain the posterior distribution for thetat given Dt conditional on v that’s a normal mt vCt star. And you can obtain the equations for the moments of that normal distribution using this equation for the mean. And then we have Ct star this is the equation that allows us to update the co-variance matrix. So this is the distributions we have conditional on v for theta t and yt. We can also write down, we can integrate out the variance here. And when we integrate out the variance, given that the variance has an inverse gamma distribution, we obtain for theta t now unconditional on v. So it only depends on the information up to t- 1, that’s a student t distribution with nt- 1 degrees of freedom and at and Rt are. The location and scale parameters for that distribution, so Rt is St- 1Rt star. Similarly, we get students distributions for the one step ahead prediction distribution for yt given Dt- 1 and for theta t given Dt the posterior for theta t at time, t is a student T nt mt Ct. So we can just write everything conditional on v as we did before. Or if we want to just look at the marginal distributions and conditional on v, we obtained student t distributions. We now discuss the smoothing equations in the case of the unknown variance at the observational level. So we have the same type of notation we’re assuming here we’re looking at the distribution of theta t given D capital T. So capital T here is greater or equal than the lower case t. And before we have a normal distribution now we’re going to have a student T distribution. The number of degrees of freedom is going to be n, capital T. And then we’re going to have mean a capital T, lowercase t- capital T. And there is going to be a recursion for the means of this distribution. And then we have for the scale parameter here we have R capital T(t- T). And then that’s multiplied by s capital T, divided by s lower case t. So in this case we have if you recall this is going to be the estimate that we’re going to get for the variance after receiving capital T observations. While this one is the estimate for the observational variance that we get from the model after receiving lower case t observations. So the recursions are going to work in the same way. I’m not writing down the equations, they are just exactly the equations that we had before. And then for forecasting if I want to look at the distribution of theta t + h. So h here is greater equal than zero given the information up to Dt, that one is going to be a student T with nt degrees of freedom. And then I have my recursions also for at(h) and Rt(h) as we had before. So as in the case with the known observational variance, we are going to need the Gt + h here for all the values of h to compute these moments and also the Wt + h for all the values of h. So we need to specify those matrices in there. Everything else stays the same, and now we have that for the predictive distribution for h steps ahead for yt. Given Dt is also now a student T with nt degrees of freedom, we have ft(h) and qt(h). The ft(h) is as before, the qt(h) is slightly different now because we don’t have vt + h. We’re assuming that v is constant and unknown. So what goes in here, you can see is the estimate that we have for that variance v at time t. So this allows us to compute the forecasting distributions.</p>
</div>
</div>
</div>
</section>
</section>
<section id="summary-of-filtering-smoothing-and-forecasting-distributions-ndlm-unknown-observational-variance" class="level2" data-number="96.2">
<h2 data-number="96.2" class="anchored" data-anchor-id="summary-of-filtering-smoothing-and-forecasting-distributions-ndlm-unknown-observational-variance"><span class="header-section-number">96.2</span> Summary of Filtering, Smoothing and Forecasting Distributions, NDLM unknown observational variance <span class="emoji" data-emoji="spiral_notepad">🗒️</span></h2>
</section>
<section id="specifying-the-system-covariance-matrix-via-discount-factors" class="level2" data-number="96.3">
<h2 data-number="96.3" class="anchored" data-anchor-id="specifying-the-system-covariance-matrix-via-discount-factors"><span class="header-section-number">96.3</span> Specifying the system covariance matrix via discount factors <span class="emoji" data-emoji="movie_camera">🎥</span></h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Video Transcript
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>We have discussed different cases in terms of the specification of the vt, the observational variance. Now, I will talk about how to specify the system variance, assuming that that system variance is not known just to recall the cases we have discussed, suppose that we have a DLM. That looks like this, so we have talked about the case in which vt and Wt, the observation and system variances are known for all the values of t. And we said that we can perform filtering and smoothing in that case using a normal prior distribution. We get results that are for the filtering distributions, we also get normal distributions for the smoothing distribution, we get normal distributions as well. Then we also discussed the case in which, so I guess, let me just clarify here, so we’ve done vt and Wt known for all t. Okay, we also said discussed the case in which we assume that vt is v, so it’s constant over time v known and sorry, v unknown and Wt known for all t. Again, we can use a conjugated structure for v unknown, we impose a normal inverse gamma prior structure. And then we can obtain closed form filtering equations and smoothing equations in that particular case. But we’re assuming here that all the Wts, the system covariance matrices are unknown. Now we are going to discuss the case in which the Wt is unknown, so how do we deal with this? So I’ll begin with assuming that vt is known for all t and we will discuss then what happens if the vt is unknown and now I want to specify my Wt. So if you recall when we were working with the equations of the normal dynamic linear model. There was the variance of the state vector theta_t that the given the information we have up to t- 1. And if you remember the equations, we had two components in here, we had called that Rt and that Rt has Gt, Ct- 1, Gt transpose plus Wt. I’m going to call this first component here in this nation, I’m going to call it Pt and I can think of this Pt as the variance, the prior variance of theta_t given Dt- 1. If I were to consider a model in which this Wt is just zero, in other words, a model in which there is no additional stochastic component in each time at the system level. So in this case, if I call Pt ,Gt, Ct- 1, Gt transpose corresponds to the prior variance in a model of the form Ft, Gt, vt and then I have a zero here. So there is no so fast, there are no stochastic changes which is equivalent to saying that there are no changes over time in the parameters of the model. In the state, parameters of the model. A way to specify then my WT here, which is what I want to do in this particular case is to assume that my Rt, my prior variance in the general model. The variance of theta_t given Dt-1 is this Pt component but I’m going to increase the uncertainty when I think about that variance. So I’m going to say that my Rt is just going to be Pt divided by delta with delta. some factor here that I’m going to call discount factor that is between zero and one. And I’m including the one here when delta is exactly one, what I’m doing is I’m saying there is no stochastic component. I’m going to be having essentially my variance for theta_t given Dt-1 corresponds to the variance of model that looks like this. And in that case, the parameters of the model are not changing over time, I don’t have any changes over time, every, all the parameters stay the same over time. That’s the case in which delta is equal to one and if delta is smaller than one, what I’m doing here by dividing by this delta factor is. I am increasing the uncertainty with respect to whatever I had in t- 1, so the closer delta is to zero the more uncertainty I’m going to have. And therefore the more variation I’m going to have in the parameters of the model, the closer delta is to one, the less variation I’m going to have in the model parameters. So if I were to now combine this expression with also this expression, right, what I get, so if I say Rt is Pt plus Wt but it’s also Pt divided by delta. What I get here is that Wt is fully specified as 1 minus delta divided by delta Pt, so I have an expression now for Wt that is given in terms of this discount factor and my Pt. If you look at the expression for Pt, Pt always depends on Gt Ct-1 and Gt transpose here, so you only need the Gt and Ct-1. The first time you compute that is when you consider P1, which is just, you’re going to use your G1, your C0, which is your prior variance for the state vector. And that one you provide and this is something that the modeler provides, the user provides and then you have the G. So once you have this P1, you plug it in here and you’re going to have the W1 and you can continue going through this process, you continue with your filtering equations. All you need is this C0 and the discount factor to fully specify the Wt, in the case, so this is again for the case in which Vt is known for all time t, for all the times t. And you are specifying wt in this way, you can also consider the case in which the W, the vt is constant and unknown. So there is the case in which vt is v with v unknown and the structure in this case for the model is going to be very similar, you can just specify the discount factor in the same way. Now, instead of having Wt, if you go back to the equations that we discussed, you’re going to have a Wtstar. And the Wt star, you can write down in terms of a P star, where the P star is going to be Gt, Ct minus one star Gt. So again, everything comes here with a star, that is just writing that model in terms of the conjugate structure as we described before. So, here, you can fully specify Wt star as one minus delta, divided by delta and then you have that Pt star with and Pt star is going to be given by Gt, Ct- 1 star, Gt transpose. And again, this provides the structure for the Wt star, now, you write down your model, your equations conditional on v. You have the normal distributions for the state vector and then you also impose a prior distribution of v that is an inverse comma. And then go through your equations again for the filtering and smoothing and as we described before. So once again, all you need here is you need your CO star and your discount factor and you have your specification for the Wt star. So how do we choose that discount factor in practice, we have delta in (0,1], so that’s what the theory says and I have to pick a particular value in practice. How do we proceed if I have a model and what is the ideal discount factor value that I can use to specify that Wt matrix. Again, in practice, the first thing that happens is we usually consider discount factor values that are above .8. So usually we just work, it’s not always the case but usually we consider discount factor values that are above .8. So you can think of just considering a grid of values in the interval .8 to 1, including the one and then find a method that allows you to pick that value optimally. You could use different kinds of properties of the model to do this. In particular, you can use the one step ahead predictive distributions to give you an idea of what is the best discount factor value you can take. So you can write down if you think about the predictive distributions, you can write down p.&nbsp;So you have all your data here and then you have the information at, time zero and then you have specified a particular DLM with an Ft, Gt and so on. And then when you write this down, you can write this down as a product of those one step ahead densities here. So if you take the log and this, let me just write down that this is also going to depend on whatever discount factor you have for that particular model specification. So if I take the log of this and you can write this p here inside as a product of the individual wise. And so when you take the log, you’re going to have the sum of the logs from one or 2 capital T of the log of these p, yt, Dt minus one. And then this also depends on delta, so this is the one step ahead predictive distribution. So you have those densities and it’s going to be a function of delta in the case of a model in which you know, vt and Wt for all the values of t. You know that those are normal in the case here, we’re specifying Wt using a discount factor, so I’m going to have a normal density if I have vt known. So I can look at this as a function of, let’s call it l of delta as a function of delta and I can view this as a likelihood function for delta, so if I evaluate this in a grid of values. I can pick the so called optimal delta by maximizing and depending on whether or not you’re using a model with the vt known or a model in which vt is v. But v is unknown and you have the conjugate prior structure, you’re going to have normal distributions in the first case here and students distributions in the second case. But you can compute this for each value of delta, if you have a grid of values, you just pick the optimal delta to be this, the one that maximizes this function. This is not the only function you could use, you could also consider other alternatives, you could consider, so this is one option. You have another option in which you can write down a mean square error again as a function of the discount factor for each model that you specify. And you can write down this as, over T, so here, I’m writing et as you remember, it’s just that whatever you observe minus the prediction you get from your model is usually ft. But that prediction depends on delta, so that’s why I’m writing down et as a function of this delta. So here you could pick the optimal discount factor by minimizing this mean square error, so here the optimal delta is chosen by minimizing this function of delta. You could also use other measurements, like the mean absolute deviation and then again minimize this. There are other approaches that could be using practice, you could consider that delta is another parameter in your model. You could put a prior on the delta and you can try to get inference on that value and then again, another thing you could do is if you have multiple components in your model. You could use a discount factor that is dependent on the components, so you could have as many discount factors as components in your model. And use the same idea to specify the W matrix in this block diagonal form, if you were to do that instead of having a function that is just, is univariant on delta. You will have multiple deltas and you will have to pick the optimal values by maximizing that function. Or in the case of the MSE, you will have to pick the optimal values of those deltas by minimizing these functions, so there is multiple alternatives. In this course, we are going to be working only with a single discount factor and we can pick the optimal either using this method or this other method that I just described.</p>
</div>
</div>
</div>
</section>
<section id="ndlm-unknown-observational-variance-example" class="level2" data-number="96.4">
<h2 data-number="96.4" class="anchored" data-anchor-id="ndlm-unknown-observational-variance-example"><span class="header-section-number">96.4</span> NDLM, Unknown Observational Variance: Example <span class="emoji" data-emoji="movie_camera">🎥</span></h2>
<p>This is a walk though of the R code in <a href="#lst-NDLM-unknown-variance" class="quarto-xref">Listing&nbsp;<span>96.1</span></a></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Video Transcript
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>We now discuss and illustrate some R code that allows you to obtain the filtering, smoothing, and forecasting distributions of a normal dynamic linear model that assumes that the observational variance is unknown. We call that V and the system covariance matrix Wt is assumed either known or specified using a discount factor. The code allows you to consider both options. The code also allows you to work with time-varying Fts and Gts, and state parameters that incorporate different components such as polynomial trends, regression, periodic components via Fourier representations, and so on. I’m going to go first through the functions, and then we will illustrate these analyzing a dataset that is available in R. As before, I’m putting all the functions into a single file that you can source. The first function that we have is a function that setups the DLM matrices that you specify, assuming that the observational variances is unknown, so you can pass Ft and Gt for all the times that you are considering. Then you have the option also of passing Wt_star, which is just in the case where you assume that you are going to specify the structure of the covariance of the noise at the system level, then you would pass this Wt_star. If you don’t pass it, then the function assumes that you’re working with a discount factor. Here, the function just returns, puts all those matrices into a single object. Similarly, there is a function that puts all the prior parameters into a single list. This is again an object that you can then pass to the filtering, smoothing, and forecasting functions. Here, if you remember the conjugate structure conditional on the observational on variance V, the state vector, Theta0 is distributed as normal m0, vC0*. Then the prior distribution for the variance has a degrees of freedom parameter that we call in n0, and then you have these S0 that you can think of as an initial estimate for the variance. This is just a structure of the prior distribution that completes this normal inverse Gamma structure. Then you have the forward filtering function. Again, here you pass the data, the matrices that define the structure of the model, the initial states that you created with these functions. Then you have the option of passing a Delta or a grid of values. We will also talk about this, but this is just a value Delta for the discount factor. If you don’t specify the Delta, the function assumes that you are working with a case in which you know the structure of the Wt_ star. If you pass the Delta, then the function assumes that you are using a discount factor to specify that Wt matrix. If you look into the function, you can see that it has a similar structure to the functions we have discussed before now, the Fts are allowed to be time-varying. Then you have a different prior structure, and then you can obtain the moments for the prior distribution of Theta t given Dt minus 1. There are two options if you look into the Code, one for the case in which you don’t have a discount factor and one for the case in which you have a discount factor. Then you can continue with the moments of the one-step ahead forecast. Again, these are the equations and the moments of the posterior distribution for Theta t given Dt. The function returns an object that contains not only mt, Ct, at, Rt, ft, Qt and et, as we had before, it also has the degrees of freedom parameters and the Sts for each time t. All these is contained into this object that the function returns. Then there is a function to compute the smoothing distributions, the function receives as input, the data, the matrices that define the model structure, and this object that is the posterior states. You first have to run the filtering function, keep whatever the function returns into an object and then pass that object. This is the posterior states object. Then again, you have the option of providing a discount factor or not. If you look into the equations, you will see again, that you have the smoothing equations are updated in terms of the equations we discussed for the case in which there is no delta. Then in that case, we are assuming that the Wt structure is provided by the user, and in the case in which a discount factor is specified. Then we have also the list that returns. Essentially this function returns a list with the moments for the smoothing distribution of the state parameter vector, and also for the mean response. We also have then a function that allows you to compute the k steps ahead forecast distribution. The function receives the posterior states. k here is the number of steps ahead you want to compute. You have the matrices and then again, you may or may not have a delta, which is a discount factor. It computes the moments of that forecast distribution and it returns the moments for, again, at and Rt that correspond to the state vector, and then for the mean response or the k steps ahead, forecast function here. Going now to the example, I’m going to show you how to use these functions using a dataset that R provides. We will first source the functions that we just discussed and then we’re going to use these dataset that I’m plotting right here. This corresponds to 100 observations. They are annual measurements of the Nile river level in a particular location. The units are 10^8 square meters in a period of time that goes from 1871-1970. We’re going to use our first order polynomial DLM, which is a structure that we have used before. But now we are going to assume that the variance of the observational level is unknown, and constant over time. We’re going to also estimate this variance. The data contains 100 observations. We’re going to break these into two components. We are going to use 95 observations to fit the model, and then we’re going to predict the last five observations and see what we obtain. Here we’re just specifying the data, what I call the test data here it shows what you want to forecast. We set up the matrices for the first order polynomial. You notice here that I’m defining arrays that have the dimension of whatever is the model that you are using. In this case, a first order polynomial model has only one parameter. We have to specify Ft for all the values of t. Here, n is the total number of observations. I have to specify that for all the time points that I’m going to use to fit the model, and then also the ones that I’m going to predict the five last observations. That’s why the dimension is n, the Gt in the first order polynomial is constant equal to one. We specify that. Then we have this Wt star that I’m going to assume is just also one for all the values of t. After that we can specify the prior parameters for theta0 given V and D0. Here I’m assuming a priori, the mean level is 800 and the C0star is 10. The degrees of freedom parameter, I’m setting it to be one, and then the initial estimate for the observational variance is 10. Once I define this structure, I use those functions to set up all these matrices and initial parameters in terms of objects to pass through the filtering distribution, this smoothing distributions and so on. Here the first thing, we compute the moments of the forward filtering distributions, assuming that V is unknown, so we pass the data, the matrices, and the initial states. We can also compute 95 percent credible intervals for the state vectors. In this case is a one-dimensional vector so we just pass the results that we obtain using the filtering equations. These are the moments, the expected value of the distribution, and the variance of that distribution as well as the degrees of freedom parameter. Remember that when we integrate out V, assuming this distributional structure that we have for V, we obtain that the distribution of Thetat given Dt is a student t-distribution, so you have to pass the degrees of freedom parameter here. We then can proceed with the smoothing. The smoothing function is going to use the data, the matrices, and the object that contains all the filtering results in here. Again, we can compute credible intervals for, now it would be the distribution of the state parameter vector at each time t, considering that we have received capital T observations. We then proceed with the one step ahead or k steps ahead forecast. In this case, k is going to be equal to 5. Then again, I can compute credible intervals for the distribution of yt plus k given Dt, in this case the ts we’re going to go all the way to capital T. We then plot the results. Here we first plot the dots here correspond to the actual observations and then the first thing that I’m going to plot is the filtering distribution, meaning the mean of the filtering distribution as well as the 95 percent credible interval. This corresponds to Theta t given Dt as I receive observations here. Then you can plot also the smoothing distribution so once you compute the filtering, you are going to go and revisit these distributions. You can see that the mean of this distribution is smoother than the one we computed with the filtering equations. Also you can see the uncertainty here also is smaller, so these are the smooth distributions. Because this is a first-order polynomial, if we think about the forecast function is going to be constant after that last data point, capital T so it’s going to have that structure over time. Then I can also compute credible intervals associated to that distribution. You can see that the pattern that as the number of steps ahead increases, the uncertainty increases. This results in the the posterior distributions again for filtering distributions for Theta t given Dt and then the smoothing distributions and the forecast distributions.</p>
</div>
</div>
</div>
</section>
<section id="code-ndlm-unknown-observational-variance-example-mathcalr" class="level2" data-number="96.5">
<h2 data-number="96.5" class="anchored" data-anchor-id="code-ndlm-unknown-observational-variance-example-mathcalr"><span class="header-section-number">96.5</span> code: NDLM, Unknown Observational Variance Example <span class="emoji" data-emoji="spiral_notepad">🗒️</span> <span class="math inline">\mathcal{R}</span></h2>
<p>This code allows time-varying <span class="math inline">F_t</span>, <span class="math inline">G_t</span> and <span class="math inline">W_t</span> matrices and assumes an unknown but constant <span class="math inline">\nu</span>. It also allows the user to specify <span class="math inline">W_t</span> using a discount factor <span class="math inline">\delta \in (0,1]</span> or assume <span class="math inline">W_t</span> known.</p>
<div class="cell">
<div id="lst-NDLM-unknown-variance" class="r cell-code listing quarto-float quarto-figure quarto-figure-left anchored">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-NDLM-unknown-variance-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;96.1: NDLM, Unknown Observational Variance Example
</figcaption>
<div aria-describedby="lst-NDLM-unknown-variance-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="do">## create list for matrices</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>set_up_dlm_matrices_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  Ft, Gt, Wt_star){</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.array</span>(Gt)){</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Stop</span>(<span class="st">"Gt and Ft should be array"</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">missing</span>(Wt_star)){</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">Ft=</span>Ft, <span class="at">Gt=</span>Gt))</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">Ft=</span>Ft, <span class="at">Gt=</span>Gt, <span class="at">Wt_star=</span>Wt_star))</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="do">## create list for initial states</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>set_up_initial_states_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  m0, C0_star, n0, S0){</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">m0=</span>m0, <span class="at">C0_star=</span>C0_star, <span class="at">n0=</span>n0, <span class="at">S0=</span>S0))</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>forward_filter_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  data, matrices, initial_states, delta){</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve dataset</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  yt <span class="ot">&lt;-</span> data<span class="sc">$</span>yt</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  T<span class="ot">&lt;-</span> <span class="fu">length</span>(yt)</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>  Ft <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Ft</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>  Gt <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Gt</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    Wt_star <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Wt_star</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve initial state</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>  m0 <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>m0</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>  C0_star <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>C0_star</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>  n0 <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>n0</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>  S0 <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>S0</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>  C0 <span class="ot">&lt;-</span> S0<span class="sc">*</span>C0_star</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>  <span class="do">## create placeholder for results</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">dim</span>(Gt)[<span class="dv">1</span>]</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span>T, <span class="at">ncol=</span>d)</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>  Rt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, T))</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>  ft <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>  Qt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>  mt <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span>T, <span class="at">ncol=</span>d)</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>  Ct <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, T))</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>  et <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>  nt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>  St <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># moments of priors at t</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T){</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> Gt[, , i] <span class="sc">%*%</span> m0</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>      Pt <span class="ot">&lt;-</span> Gt[, , i] <span class="sc">%*%</span> C0 <span class="sc">%*%</span> <span class="fu">t</span>(Gt[, , i])</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>      Pt <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Pt <span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Pt)</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>        Wt <span class="ot">&lt;-</span> Wt_star[, , i]<span class="sc">*</span>S0</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Pt <span class="sc">+</span> Wt</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>        Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Pt<span class="sc">/</span>delta</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>        Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> Gt[, , i] <span class="sc">%*%</span> <span class="fu">t</span>(mt[i<span class="dv">-1</span>, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>      Pt <span class="ot">&lt;-</span> Gt[, , i] <span class="sc">%*%</span> Ct[, , i<span class="dv">-1</span>] <span class="sc">%*%</span> <span class="fu">t</span>(Gt[, , i])</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>        Wt <span class="ot">&lt;-</span> Wt_star[, , i] <span class="sc">*</span> St[i<span class="dv">-1</span>]</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Pt <span class="sc">+</span> Wt</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>        Rt[,,i]<span class="ot">=</span><span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Pt<span class="sc">/</span>delta</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>        Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments of one-step forecast:</span></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>    ft[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , i]) <span class="sc">%*%</span> <span class="fu">t</span>(at[i, , <span class="at">drop=</span><span class="cn">FALSE</span>]) </span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>    Qt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , i]) <span class="sc">%*%</span> Rt[, , i] <span class="sc">%*%</span> Ft[, , i] <span class="sc">+</span> </span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(i<span class="sc">==</span><span class="dv">1</span>, S0, St[i<span class="dv">-1</span>])</span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>    et[i] <span class="ot">&lt;-</span> yt[i] <span class="sc">-</span> ft[i]</span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>    nt[i] <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(i<span class="sc">==</span><span class="dv">1</span>, n0, nt[i<span class="dv">-1</span>]) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>    St[i] <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(i<span class="sc">==</span><span class="dv">1</span>, S0, </span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>                    St[i<span class="dv">-1</span>])<span class="sc">*</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>nt[i]<span class="sc">*</span>(et[i]<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span>Qt[i]<span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments of posterior at t:</span></span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>    At <span class="ot">&lt;-</span> Rt[, , i] <span class="sc">%*%</span> Ft[, , i] <span class="sc">/</span> Qt[i]</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>    mt[i, ] <span class="ot">&lt;-</span> at[i, ] <span class="sc">+</span> <span class="fu">t</span>(At) <span class="sc">*</span> et[i]</span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>    Ct[, , i] <span class="ot">&lt;-</span> St[i]<span class="sc">/</span><span class="fu">ifelse</span>(i<span class="sc">==</span><span class="dv">1</span>, S0, </span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>                  St[i<span class="dv">-1</span>])<span class="sc">*</span>(Rt[, , i] <span class="sc">-</span> Qt[i] <span class="sc">*</span> At <span class="sc">%*%</span> <span class="fu">t</span>(At))</span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>    Ct[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Ct[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Ct[,,i])</span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Forward filtering is completed!</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mt =</span> mt, <span class="at">Ct =</span> Ct,  <span class="at">at =</span> at, <span class="at">Rt =</span> Rt, </span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>              <span class="at">ft =</span> ft, <span class="at">Qt =</span> Qt,  <span class="at">et =</span> et, </span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>              <span class="at">nt =</span> nt, <span class="at">St =</span> St))</span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a><span class="do">### smoothing function </span><span class="al">###</span></span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>backward_smoothing_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(data, matrices, </span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>                                posterior_states,delta){</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve data </span></span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>  yt <span class="ot">&lt;-</span> data<span class="sc">$</span>yt</span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> <span class="fu">length</span>(yt) </span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>  Ft <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Ft</span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>  Gt <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Gt</span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>  mt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>mt</span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>  Ct <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>Ct</span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>  Rt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>Rt</span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a>  nt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>nt</span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a>  St <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>St</span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>at</span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>  <span class="do">## create placeholder for posterior moments </span></span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a>  mnt <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">dim</span>(mt)[<span class="dv">1</span>], <span class="at">ncol =</span> <span class="fu">dim</span>(mt)[<span class="dv">2</span>])</span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a>  Cnt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">dim</span>(Ct))</span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a>  fnt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a>  Qnt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> T<span class="sc">:</span><span class="dv">1</span>){</span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> T){</span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a>      mnt[i, ] <span class="ot">&lt;-</span> mt[i, ]</span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a>      Cnt[, , i] <span class="ot">&lt;-</span> Ct[, , i]</span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a>        inv_Rtp1 <span class="ot">&lt;-</span> <span class="fu">chol2inv</span>(<span class="fu">chol</span>(Rt[, , i<span class="sc">+</span><span class="dv">1</span>]))</span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a>        Bt <span class="ot">&lt;-</span> Ct[, , i] <span class="sc">%*%</span> <span class="fu">t</span>(Gt[, , i<span class="sc">+</span><span class="dv">1</span>]) <span class="sc">%*%</span> inv_Rtp1</span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a>        mnt[i, ] <span class="ot">&lt;-</span> mt[i, ] <span class="sc">+</span> Bt <span class="sc">%*%</span> (mnt[i<span class="sc">+</span><span class="dv">1</span>, ] <span class="sc">-</span> at[i<span class="sc">+</span><span class="dv">1</span>, ])</span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a>        Cnt[, , i] <span class="ot">&lt;-</span> Ct[, , i] <span class="sc">+</span> Bt <span class="sc">%*%</span> (Cnt[, , i<span class="sc">+</span><span class="dv">1</span>] <span class="sc">-</span> </span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a>                                    Rt[, , i<span class="sc">+</span><span class="dv">1</span>]) <span class="sc">%*%</span> <span class="fu">t</span>(Bt)</span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true" tabindex="-1"></a>        Cnt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Cnt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Cnt[,,i])</span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true" tabindex="-1"></a>        inv_Gt <span class="ot">&lt;-</span> <span class="fu">solve</span>(Gt[, , i<span class="sc">+</span><span class="dv">1</span>])</span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true" tabindex="-1"></a>        mnt[i, ] <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">-</span>delta)<span class="sc">*</span>mt[i, ] <span class="sc">+</span> </span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true" tabindex="-1"></a>                delta<span class="sc">*</span>inv_Gt <span class="sc">%*%</span> <span class="fu">t</span>(mnt[i<span class="sc">+</span><span class="dv">1</span>, ,<span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true" tabindex="-1"></a>        Cnt[, , i] <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">-</span>delta)<span class="sc">*</span>Ct[, , i] <span class="sc">+</span> </span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true" tabindex="-1"></a>                delta<span class="sc">^</span><span class="dv">2</span><span class="sc">*</span>inv_Gt <span class="sc">%*%</span> Cnt[, , i <span class="sc">+</span> <span class="dv">1</span>]  <span class="sc">%*%</span> <span class="fu">t</span>(inv_Gt)</span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true" tabindex="-1"></a>        Cnt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Cnt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Cnt[,,i])</span>
<span id="cb1-150"><a href="#cb1-150" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb1-151"><a href="#cb1-151" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-152"><a href="#cb1-152" aria-hidden="true" tabindex="-1"></a>    fnt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , i]) <span class="sc">%*%</span> <span class="fu">t</span>(mnt[i, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb1-153"><a href="#cb1-153" aria-hidden="true" tabindex="-1"></a>    Qnt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , i]) <span class="sc">%*%</span> <span class="fu">t</span>(Cnt[, , i]) <span class="sc">%*%</span> Ft[, , i]</span>
<span id="cb1-154"><a href="#cb1-154" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-155"><a href="#cb1-155" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T){</span>
<span id="cb1-156"><a href="#cb1-156" aria-hidden="true" tabindex="-1"></a>     Cnt[,,i]<span class="ot">=</span>St[T]<span class="sc">*</span>Cnt[,,i]<span class="sc">/</span>St[i] </span>
<span id="cb1-157"><a href="#cb1-157" aria-hidden="true" tabindex="-1"></a>     Qnt[i]<span class="ot">=</span>St[T]<span class="sc">*</span>Qnt[i]<span class="sc">/</span>St[i]</span>
<span id="cb1-158"><a href="#cb1-158" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-159"><a href="#cb1-159" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Backward smoothing is completed!</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb1-160"><a href="#cb1-160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mnt =</span> mnt, <span class="at">Cnt =</span> Cnt, <span class="at">fnt=</span>fnt, <span class="at">Qnt=</span>Qnt))</span>
<span id="cb1-161"><a href="#cb1-161" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-162"><a href="#cb1-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-163"><a href="#cb1-163" aria-hidden="true" tabindex="-1"></a><span class="do">## Forecast Distribution for k step</span></span>
<span id="cb1-164"><a href="#cb1-164" aria-hidden="true" tabindex="-1"></a>forecast_function_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(posterior_states, k, </span>
<span id="cb1-165"><a href="#cb1-165" aria-hidden="true" tabindex="-1"></a>                                        matrices, delta){</span>
<span id="cb1-166"><a href="#cb1-166" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-167"><a href="#cb1-167" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb1-168"><a href="#cb1-168" aria-hidden="true" tabindex="-1"></a>  Ft <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Ft</span>
<span id="cb1-169"><a href="#cb1-169" aria-hidden="true" tabindex="-1"></a>  Gt <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Gt</span>
<span id="cb1-170"><a href="#cb1-170" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb1-171"><a href="#cb1-171" aria-hidden="true" tabindex="-1"></a>    Wt_star <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Wt_star</span>
<span id="cb1-172"><a href="#cb1-172" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-173"><a href="#cb1-173" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-174"><a href="#cb1-174" aria-hidden="true" tabindex="-1"></a>  mt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>mt</span>
<span id="cb1-175"><a href="#cb1-175" aria-hidden="true" tabindex="-1"></a>  Ct <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>Ct</span>
<span id="cb1-176"><a href="#cb1-176" aria-hidden="true" tabindex="-1"></a>  St <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>St</span>
<span id="cb1-177"><a href="#cb1-177" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>at</span>
<span id="cb1-178"><a href="#cb1-178" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-179"><a href="#cb1-179" aria-hidden="true" tabindex="-1"></a>  <span class="do">## set up matrices</span></span>
<span id="cb1-180"><a href="#cb1-180" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> <span class="fu">dim</span>(mt)[<span class="dv">1</span>] <span class="co"># time points</span></span>
<span id="cb1-181"><a href="#cb1-181" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">dim</span>(mt)[<span class="dv">2</span>] <span class="co"># dimension of state parameter vector</span></span>
<span id="cb1-182"><a href="#cb1-182" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-183"><a href="#cb1-183" aria-hidden="true" tabindex="-1"></a>  <span class="do">## placeholder for results</span></span>
<span id="cb1-184"><a href="#cb1-184" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> k, <span class="at">ncol =</span> d)</span>
<span id="cb1-185"><a href="#cb1-185" aria-hidden="true" tabindex="-1"></a>  Rt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, k))</span>
<span id="cb1-186"><a href="#cb1-186" aria-hidden="true" tabindex="-1"></a>  ft <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k)</span>
<span id="cb1-187"><a href="#cb1-187" aria-hidden="true" tabindex="-1"></a>  Qt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k)</span>
<span id="cb1-188"><a href="#cb1-188" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-189"><a href="#cb1-189" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k){</span>
<span id="cb1-190"><a href="#cb1-190" aria-hidden="true" tabindex="-1"></a>    <span class="do">## moments of state distribution</span></span>
<span id="cb1-191"><a href="#cb1-191" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb1-192"><a href="#cb1-192" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> <span class="fu">t</span>(mt[T, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb1-193"><a href="#cb1-193" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-194"><a href="#cb1-194" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb1-195"><a href="#cb1-195" aria-hidden="true" tabindex="-1"></a>       Rt[, , i] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> Ct[, , T] <span class="sc">%*%</span> </span>
<span id="cb1-196"><a href="#cb1-196" aria-hidden="true" tabindex="-1"></a>         <span class="fu">t</span>(Gt[, , T<span class="sc">+</span>i]) <span class="sc">+</span> St[T]<span class="sc">*</span>Wt_star[, , T<span class="sc">+</span>i]</span>
<span id="cb1-197"><a href="#cb1-197" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb1-198"><a href="#cb1-198" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> Ct[, , T] <span class="sc">%*%</span> </span>
<span id="cb1-199"><a href="#cb1-199" aria-hidden="true" tabindex="-1"></a>          <span class="fu">t</span>(Gt[, , T<span class="sc">+</span>i])<span class="sc">/</span>delta</span>
<span id="cb1-200"><a href="#cb1-200" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb1-201"><a href="#cb1-201" aria-hidden="true" tabindex="-1"></a>      Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb1-202"><a href="#cb1-202" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-203"><a href="#cb1-203" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb1-204"><a href="#cb1-204" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> <span class="fu">t</span>(at[i<span class="dv">-1</span>, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb1-205"><a href="#cb1-205" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb1-206"><a href="#cb1-206" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> Rt[, , i<span class="dv">-1</span>] <span class="sc">%*%</span> </span>
<span id="cb1-207"><a href="#cb1-207" aria-hidden="true" tabindex="-1"></a>          <span class="fu">t</span>(Gt[, , T<span class="sc">+</span>i]) <span class="sc">+</span> St[T]<span class="sc">*</span>Wt_star[, , T <span class="sc">+</span> i]</span>
<span id="cb1-208"><a href="#cb1-208" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb1-209"><a href="#cb1-209" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> Rt[, , i<span class="dv">-1</span>] <span class="sc">%*%</span> </span>
<span id="cb1-210"><a href="#cb1-210" aria-hidden="true" tabindex="-1"></a>          <span class="fu">t</span>(Gt[, , T<span class="sc">+</span>i])<span class="sc">/</span>delta</span>
<span id="cb1-211"><a href="#cb1-211" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb1-212"><a href="#cb1-212" aria-hidden="true" tabindex="-1"></a>      Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb1-213"><a href="#cb1-213" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-214"><a href="#cb1-214" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-215"><a href="#cb1-215" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-216"><a href="#cb1-216" aria-hidden="true" tabindex="-1"></a>    <span class="do">## moments of forecast distribution</span></span>
<span id="cb1-217"><a href="#cb1-217" aria-hidden="true" tabindex="-1"></a>    ft[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , T<span class="sc">+</span>i]) <span class="sc">%*%</span> <span class="fu">t</span>(at[i, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb1-218"><a href="#cb1-218" aria-hidden="true" tabindex="-1"></a>    Qt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , T<span class="sc">+</span>i]) <span class="sc">%*%</span> Rt[, , i] <span class="sc">%*%</span> Ft[, , T<span class="sc">+</span>i] <span class="sc">+</span> </span>
<span id="cb1-219"><a href="#cb1-219" aria-hidden="true" tabindex="-1"></a>      St[T]</span>
<span id="cb1-220"><a href="#cb1-220" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-221"><a href="#cb1-221" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Forecasting is completed!</span><span class="sc">\n</span><span class="st">"</span>) <span class="co"># indicator of completion</span></span>
<span id="cb1-222"><a href="#cb1-222" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">at=</span>at, <span class="at">Rt=</span>Rt, <span class="at">ft=</span>ft, <span class="at">Qt=</span>Qt))</span>
<span id="cb1-223"><a href="#cb1-223" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-224"><a href="#cb1-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-225"><a href="#cb1-225" aria-hidden="true" tabindex="-1"></a><span class="do">## obtain 95% credible interval</span></span>
<span id="cb1-226"><a href="#cb1-226" aria-hidden="true" tabindex="-1"></a>get_credible_interval_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(ft, Qt, nt, </span>
<span id="cb1-227"><a href="#cb1-227" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">quantile =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)){</span>
<span id="cb1-228"><a href="#cb1-228" aria-hidden="true" tabindex="-1"></a>  bound <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span><span class="fu">length</span>(ft), <span class="at">ncol=</span><span class="dv">2</span>)</span>
<span id="cb1-229"><a href="#cb1-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-230"><a href="#cb1-230" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((<span class="fu">length</span>(nt)<span class="sc">==</span><span class="dv">1</span>)){</span>
<span id="cb1-231"><a href="#cb1-231" aria-hidden="true" tabindex="-1"></a>   <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(ft)){</span>
<span id="cb1-232"><a href="#cb1-232" aria-hidden="true" tabindex="-1"></a>      t_quantile <span class="ot">&lt;-</span> <span class="fu">qt</span>(quantile[<span class="dv">1</span>], <span class="at">df =</span> nt)</span>
<span id="cb1-233"><a href="#cb1-233" aria-hidden="true" tabindex="-1"></a>      bound[t, <span class="dv">1</span>] <span class="ot">&lt;-</span> ft[t] <span class="sc">+</span> t_quantile<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(Qt[t])) </span>
<span id="cb1-234"><a href="#cb1-234" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-235"><a href="#cb1-235" aria-hidden="true" tabindex="-1"></a>  <span class="co"># upper bound of 95% credible interval</span></span>
<span id="cb1-236"><a href="#cb1-236" aria-hidden="true" tabindex="-1"></a>      t_quantile <span class="ot">&lt;-</span> <span class="fu">qt</span>(quantile[<span class="dv">2</span>], <span class="at">df =</span> nt)</span>
<span id="cb1-237"><a href="#cb1-237" aria-hidden="true" tabindex="-1"></a>      bound[t, <span class="dv">2</span>] <span class="ot">&lt;-</span> ft[t] <span class="sc">+</span> </span>
<span id="cb1-238"><a href="#cb1-238" aria-hidden="true" tabindex="-1"></a>        t_quantile<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(Qt[t]))}</span>
<span id="cb1-239"><a href="#cb1-239" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb1-240"><a href="#cb1-240" aria-hidden="true" tabindex="-1"></a>  <span class="co"># lower bound of 95% credible interval</span></span>
<span id="cb1-241"><a href="#cb1-241" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(ft)){</span>
<span id="cb1-242"><a href="#cb1-242" aria-hidden="true" tabindex="-1"></a>      t_quantile <span class="ot">&lt;-</span> <span class="fu">qt</span>(quantile[<span class="dv">1</span>], <span class="at">df =</span> nt[t])</span>
<span id="cb1-243"><a href="#cb1-243" aria-hidden="true" tabindex="-1"></a>      bound[t, <span class="dv">1</span>] <span class="ot">&lt;-</span> ft[t] <span class="sc">+</span> </span>
<span id="cb1-244"><a href="#cb1-244" aria-hidden="true" tabindex="-1"></a>        t_quantile<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(Qt[t])) </span>
<span id="cb1-245"><a href="#cb1-245" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-246"><a href="#cb1-246" aria-hidden="true" tabindex="-1"></a>  <span class="co"># upper bound of 95% credible interval</span></span>
<span id="cb1-247"><a href="#cb1-247" aria-hidden="true" tabindex="-1"></a>      t_quantile <span class="ot">&lt;-</span> <span class="fu">qt</span>(quantile[<span class="dv">2</span>], <span class="at">df =</span> nt[t])</span>
<span id="cb1-248"><a href="#cb1-248" aria-hidden="true" tabindex="-1"></a>      bound[t, <span class="dv">2</span>] <span class="ot">&lt;-</span> ft[t] <span class="sc">+</span> </span>
<span id="cb1-249"><a href="#cb1-249" aria-hidden="true" tabindex="-1"></a>        t_quantile<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(Qt[t]))}</span>
<span id="cb1-250"><a href="#cb1-250" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-251"><a href="#cb1-251" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(bound)</span>
<span id="cb1-252"><a href="#cb1-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-253"><a href="#cb1-253" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
</div>
<section id="nile-river-level-filtering-smoothing-and-forecasting-example" class="level3" data-number="96.5.1">
<h3 data-number="96.5.1" class="anchored" data-anchor-id="nile-river-level-filtering-smoothing-and-forecasting-example"><span class="header-section-number">96.5.1</span> Nile River Level Filtering Smoothing and Forecasting Example</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Example: Nile River Level (in 10^8 m^3), 1871-1970 </span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Model: First order polynomial DLM</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(Nile) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="C4-L09_files/figure-html/unnamed-chunk-2-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="C4-L09_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>n<span class="ot">=</span><span class="fu">length</span>(Nile) <span class="co">#n=100 observations </span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>k<span class="ot">=</span><span class="dv">5</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>T<span class="ot">=</span>n<span class="sc">-</span>k</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>data_T<span class="ot">=</span>Nile[<span class="dv">1</span><span class="sc">:</span>T]</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>test_data<span class="ot">=</span>Nile[(T<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>n]</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>data<span class="ot">=</span><span class="fu">list</span>(<span class="at">yt =</span> data_T)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="do">## set up matrices for first order polynomial model </span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>Ft<span class="ot">=</span><span class="fu">array</span>(<span class="dv">1</span>, <span class="at">dim =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, n))</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>Gt<span class="ot">=</span><span class="fu">array</span>(<span class="dv">1</span>, <span class="at">dim =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, n))</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>Wt_star<span class="ot">=</span><span class="fu">array</span>(<span class="dv">1</span>, <span class="at">dim =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, n))</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>m0<span class="ot">=</span><span class="fu">as.matrix</span>(<span class="dv">800</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>C0_star<span class="ot">=</span><span class="fu">as.matrix</span>(<span class="dv">10</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>n0<span class="ot">=</span><span class="dv">1</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>S0<span class="ot">=</span><span class="dv">10</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="do">## wrap up all matrices and initial values</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>matrices <span class="ot">=</span> <span class="fu">set_up_dlm_matrices_unknown_v</span>(Ft, Gt, Wt_star)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>initial_states <span class="ot">=</span> <span class="fu">set_up_initial_states_unknown_v</span>(m0, </span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>                                      C0_star, n0, S0)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="do">## filtering </span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>results_filtered <span class="ot">=</span> <span class="fu">forward_filter_unknown_v</span>(data, matrices, </span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>                                            initial_states)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Forward filtering is completed!</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>ci_filtered<span class="ot">=</span><span class="fu">get_credible_interval_unknown_v</span>(results_filtered<span class="sc">$</span>mt, </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>                                    results_filtered<span class="sc">$</span>Ct, </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>                                     results_filtered<span class="sc">$</span>nt)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="do">## smoothing</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>results_smoothed<span class="ot">=</span><span class="fu">backward_smoothing_unknown_v</span>(data, matrices, </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>                                             results_filtered)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Backward smoothing is completed!</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>ci_smoothed<span class="ot">=</span><span class="fu">get_credible_interval_unknown_v</span>(results_smoothed<span class="sc">$</span>mnt, </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>                                         results_smoothed<span class="sc">$</span>Cnt, </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>                                         results_filtered<span class="sc">$</span>nt[T])</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="do">## one-step ahead forecasting</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>results_forecast<span class="ot">=</span><span class="fu">forecast_function_unknown_v</span>(results_filtered, </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>                                                k,  matrices)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Forecasting is completed!</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>ci_forecast<span class="ot">=</span><span class="fu">get_credible_interval_unknown_v</span>(results_forecast<span class="sc">$</span>ft, </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>                                          results_forecast<span class="sc">$</span>Qt, </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>                                     results_filtered<span class="sc">$</span>nt[T])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="do">## plot results</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>index<span class="ot">=</span><span class="fu">seq</span>(<span class="dv">1871</span>, <span class="dv">1970</span>, <span class="at">length.out =</span> <span class="fu">length</span>(Nile))</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>index_filt<span class="ot">=</span>index[<span class="dv">1</span><span class="sc">:</span>T]</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>index_forecast<span class="ot">=</span>index[(T<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(T<span class="sc">+</span>k)]</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(index, Nile, <span class="at">main =</span> <span class="st">"Nile River Level "</span>,<span class="at">type=</span><span class="st">'l'</span>,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"time"</span>,<span class="at">ylab=</span><span class="st">"feet"</span>,<span class="at">lty=</span><span class="dv">3</span>,<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">400</span>,<span class="dv">1500</span>))</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(index,Nile,<span class="at">pch=</span><span class="dv">20</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt,results_filtered<span class="sc">$</span>mt, <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'red'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt,ci_filtered[, <span class="dv">1</span>], <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'red'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt,ci_filtered[, <span class="dv">2</span>], <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'red'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt,results_smoothed<span class="sc">$</span>mnt, <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'blue'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, ci_smoothed[, <span class="dv">1</span>], <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'blue'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, ci_smoothed[, <span class="dv">2</span>], <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'blue'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_forecast, results_forecast<span class="sc">$</span>ft, <span class="at">type=</span><span class="st">'l'</span>, </span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'green'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_forecast, ci_forecast[, <span class="dv">1</span>], <span class="at">type=</span><span class="st">'l'</span>, </span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'green'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_forecast, ci_forecast[, <span class="dv">2</span>], <span class="at">type=</span><span class="st">'l'</span>, </span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'green'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topright"</span>,</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>       <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"Observed"</span>, <span class="st">"Filtered mean"</span>, <span class="st">"Filtered CI"</span>, </span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"Smoothed mean"</span>, <span class="st">"Smoothed CI"</span>, </span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"Forecast mean"</span>, <span class="st">"Forecast CI"</span>),</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"red"</span>, <span class="st">"red"</span>, <span class="st">"blue"</span>, <span class="st">"blue"</span>, <span class="st">"green"</span>, <span class="st">"green"</span>),</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>       <span class="at">lty =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>),</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>       <span class="at">pch =</span> <span class="fu">c</span>(<span class="dv">20</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>),</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>       <span class="at">lwd =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>),</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>       <span class="at">bty =</span> <span class="st">"n"</span>,</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>       <span class="at">ncol =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-NDLM-unknown-variance-nile-data" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-NDLM-unknown-variance-nile-data-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="C4-L09_files/figure-html/fig-NDLM-unknown-variance-nile-data-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Figure&nbsp;96.1: Nile River Level Filtering, Smoothing and Forecasting Results"><img src="C4-L09_files/figure-html/fig-NDLM-unknown-variance-nile-data-1.png" class="img-fluid figure-img" width="672"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-NDLM-unknown-variance-nile-data-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;96.1: Nile River Level Filtering, Smoothing and Forecasting Results
</figcaption>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Overthinking the Nile River Data
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<p>We use the Nile dataset throughout the course, despite the Nile data being notorious for having long term dependencies and being highly non-linear, which might present many challenges for the NDLM framework. c.f. the joint work of two giants <a href="https://en.wikipedia.org/wiki/Benoit_Mandelbrot">Benoit Mandelbrot</a> and <a href="https://en.wikipedia.org/wiki/Harold_Edwin_Hurst">Harold Edwin Hurst</a>. Which led to the development of the Hurst exponent and the <a href="https://en.wikipedia.org/wiki/Fractional_Brownian_motion">fractional Brownian motion</a>, i.e.&nbsp;fractional Gaussian noise and fractional ARIMA <a href="https://en.wikipedia.org/wiki/Autoregressive_fractionally_integrated_moving_average">ARFIMA</a> which are more suitable for modeling the Nile data but not covered in this course.</p>
<p>Just a couple of concepts here:</p>
<p>In Fractional Brownian Motion (fBm) draws from the Normal need not be independent. With the concept of Hurst exponent <span class="math inline">H</span> which is a measure of the long-term memory of a time series. The Hurst exponent is defined as follows: <span id="eq-fbm-autocovariance"><span class="math display">
\mathbb{E}[B_{H}(t)B_{H}(s)]={\tfrac {1}{2}}(|t|^{2H}+|s|^{2H}-|t-s|^{2H}),
\tag{96.4}</span></span></p>
<ul>
<li>where:
<ul>
<li><span class="math inline">B_{H}(t)</span> is the fractional Brownian motion, and</li>
<li><span class="math inline">H</span> is the Hurst exponent.</li>
</ul></li>
</ul>
<ol start="2" type="1">
<li>in ARFIMA, the autocovariance we allow the exponent of the lag <span class="math inline">k</span> to be a real number <span class="math inline">d</span> rather than an integer, i.e.&nbsp;we allow for fractional differencing via a formal binomial series expansion of the form:</li>
</ol>
<p><span id="eq-ARFIMA"><span class="math display">\begin{array}{c} {\displaystyle {\begin{aligned}(1-B)^{d}&amp;=\sum _{k=0}^{\infty }\;{d \choose k}\;(-B)^{k}\\&amp;=\sum _{k=0}^{\infty }\;{\frac {\prod _{a=0}^{k-1}(d-a)\ (-B)^{k}}{k!}}\\&amp;=1-dB+{\frac {d(d-1)}{2!}}B^{2}-\cdots \,.\end{aligned}}} \end{array}
\tag{96.5}</span></span></p>
</div>
</div>
</div>
</section>
</section>
<section id="section-NDLM-eeg" class="level2" data-number="96.6">
<h2 data-number="96.6" class="anchored" data-anchor-id="section-NDLM-eeg"><span class="header-section-number">96.6</span> Case Study EEG data <span class="emoji" data-emoji="movie_camera">🎥</span></h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Video Transcript
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>We know discuss our first case study type of example. In this case, we’re going to use a time-varying autoregressive model to analyze some EEG data. EEG stands for electroencephalogram data. This is a brain signal of a particular channel that was recorded on a subject that received electroconvulsive therapy. It’s just an electroencephalogram recorded at a particular location of the patient’s scalp. There is a lot of information that you can get about these data. This dataset was recorded at Duke University. There are multiple papers where we analyze these data. You can also look at a full analysis and discussions and references to the papers in the book, Prado Ferreira and West 2021. The idea here is also to provide a little bit of comparison and relationship between what we are learning here with dynamic linear models and what we learned earlier in the course with autoregressive processes. Let me just show you the data. Then before we do that, we will need here the file that contains all the functions to compute the filtering, smoothing, and forecasting distributions using an unknown v at the observational level. Then I’m putting all the functions to compute the optimal discount factor also in this other file that you will have to source this. If you open this file, you will see that it contains the functions we described before to obtain the optimal discount factors. Let’s just source those in. Here I’m providing the EEG data. It corresponds to the middle portion of an EEG that was recorded at a sampling rate of 256 hertz or 256 observations per second. The data was subsampled every fifth observation to make it a little smaller. Here I’m just plotting that dataset. What you look at here is the voltage level for the EEG data. We have these 3,600 observations. We’re going to use a model that is a time-varying autoregressive model, meaning you have an autoregressive structure in terms of a particular model order. Here we’re going to use a model order of 12. We’re going to regress yt on the 12th past values, of yt. What happens here is the AR coefficients are going to be time-varying. That’s why we are using a dynamic linear model for this particular example. The total number of observations is 3,600, I’m just going to do the analysis with the first 3,200 only and then we’ll see what the results are. I’m just going to use this first portion here of this EEG. When you look at the picture of the data, again, if you were to look at the characteristics in terms of the frequency and the amplitude, you would see that the data has a higher frequency or lower quasi-periodicity at the beginning and a higher quasi-periodicity towards the end. Then also the amplitude changes over time. Here we are just defining the data and now we are setting up the matrices. If you remember how we set up the matrices here, the Gt is an identity, and then the Ft is going to contain the past values of the yts. For each time t we are going to have 12 past values. We build that and get the Ft matrices over time and then the Gt matrix. The Gt is constant over time, the Ft changes over time. We set up the initial state matrices. The model order is 12, so we are going to have a distribution for the state parameter vector of dimension 12 that is a normal with m0 v times C0_star. Here we have just that matrix. Here this is a vector of zeros. I’m just setting everything at zero. Then the C_star matrix is a diagonal matrix of dimension 12 times 10. Each of the components has a variance of 10 here. This is conditional, again, this would be multiplied by v. The full covariance structure will be given by v times C0_star is a conditional structure. Then the parameters for the prior distribution, the number of degrees of freedom I’m assuming here is 1. Then the estimate, a priori for the observational variance is 100. We set up those. We also keep those in objects that then we can pass to the functions that compute the filtering, smoothing, and forecasting distributions. Here I’m going to specify the Wt using a discount factor so we are going to define a set of values here. I’m going to have a lower bound that is 0.95 and an upper bound that is one and then I’m going to have increments of 0.001 to define that grid of values. Just to compute the optimal discount factor. Then I’m going to use the mean square error as the measure to pick that optimal discount factor. We run this. It takes a little bit just because we have a fairly large range of grid of values. Once we compute the optimal discount factor, the function, if you remember, is going return the filtering moments or the moments for the filtering distribution, the moments for the smoothing distributions, as well as the forecasting distributions with the optimal value. If you change, you may choose a different measurement. There are, if you recall, four different measurements to compute the optimal value of the discount factor. Once this is done, I will show you the results of the analysis. Let me just show you here. The optimal discount factor that was selected here is 0.994. It’s a fairly large discount factor, meaning that the variations in the state parameters are occurring smoothly over time, but there are changes. We can now retrieve the results in terms of the filtering. distributions. We can compute the credible intervals for that. We can compute the results for the smoothing distributions and obtain credible intervals for that as well. I’m just going to plot here the results of these. This would be my data and these would be the blue that I superimpose on that, is just the mean of the smoothing distribution based on the model and this discount factor that we chose. It’s capturing the main characteristics of the data. But in this particular case, this information is not necessarily what we want to look at. We want to try to interpret what results this is giving us in terms of the time-frequency characteristics of the data. One way of obtaining that information is to think back in terms of the characteristic polynomial and the reciprocal roots of that characteristic polynomial. We are going to have a characteristic polynomial for each time t now, because we have AR coefficients that change over time. For each of those roots and for each polynomial we know that we can also obtain a spectral representation that changes over time. If you think about this spectral density that is associated to each of those autoregressive processes at time t, you can just represent that in terms of different spectral density. Let’s look at what the results are. The next piece of code is just computing those reciprocal roots of the characteristic polynomial at each time t. Then looking at what is the modulus of the reciprocal roots and what is the period of the reciprocal roots. Here we have a model order of 12. As you recall, you can have complex valued or real valued reciprocal roots, as we did in the case of the the standard auto-regressive model where the parameters are not changing over time. Because you can have a different number of roots in terms of how many pairs of complex roots you have and how many real roots you have, this model is time-varying. You could potentially have also changing number of complex valued and real valued reciprocal roots. What I’m going to plot here, is I’m going to look at the root that has the largest modulus. So the reciprocal rule that has the largest modulus over time. Then you will see here that root happens to be complex so you do get a pair of complex valued roots. There is a period that is associated to that dominant root in terms of the modulus. I’m going to plot the modulus of that root and also the periodicity. What you see here, once you run the code. This is that trajectory based on the mean of this smooth distribution for the state parameter vector. The AR coefficients at each time t here. You can see it starts very high, is very persistent at the beginning of the time period and then it oscillates essentially between 0.9. One, and you can see that it decreases towards the end of the seizure here or towards the end of the EEG recording. But this is a fairly persistent group. When you look at the corresponding frequency, and here I’m plotting that frequency in a scale that is hertz, so if you remember the original data was recorded at 256 hertz, but it was sub-sampled every fifth observation. So if I want to plot the results in terms of hertz here for that corresponding frequency, I have to do this transformation. What you see here, is that this dominant quasiperiodic component has a frequency that starts a little bit higher than five hertz, and then it decreases towards the end of the EEG recording which is something we saw also when we were plotting the data. If you were to look at the data and zoom in into different portions at the beginning of the EEG and at the end you would see that this is consistent with that behavior. In particular, neuroscientists like to talk about different frequency bands in the brain, so we see here that this dominant component is mostly in the delta frequency band for the period of recording, at the beginning is in the Theta frequency band. At the beginning, when the seizure is starting, it begins in the Theta band and it decreases to the delta band. Just to again, remind you of how this works, if I think about the spectral representation of this process over time, you can specify some time points here, and then look at what is the estimate of the spectral density that corresponds to that autoregressive process for that particular time. I’m just going to use the function, arma.spec from the library astsa, we have used this function before, and I’m just going to plot. Here we’re just plotting the spectral density estimated using again the results from the smooth distribution, so this is based on that mean of the smooth distribution at each time t, and we’re going to use the estimate of the observational variance that we get after fitting the entire data set. What we get from the dynamic linear model. Here the results, so this corresponds to just one spectral density, you see that if you were to translate this, so now the frequency appears plotted between 0.5, if you were to do the transformation to the original scale, you would see that the peak of these spectral density is precisely at that value that was around those that went from essentially five hertz down towards the end of the seizure. We can see, I’m now going to plot the different spectral densities here, so just going back just to show you the plot a little bit larger here, so I’m picking again different times during the EEG recordings, so this corresponds to the 1.96 seconds, 9.77 seconds and so on, so this is towards the beginning of the recording, and then this is towards the end of the recording. You can see that at the beginning of the recording, I have a power that is dominated mostly by a single quasiperiodic component, that is that one that we just plotted at the beginning, that begins in the Theta band. Then if you look at the location of the peak, you see that the location of this dominant peak is decreasing, so the frequency is decreasing towards the end of the recording. Also, we see that the power of these spectral densities tends to decrease also as the recording gets to the end. There are other components that are also contributing in terms of the spectral characteristics. This is the nice feature of using a time-varying autoregressive model. You can capture what’s happening with the data and what is the spectral representation, and what is the interpretation that we can give to these analyses in terms of something that neuroscientists can understand.</p>
</div>
</div>
</div>
</section>
<section id="section-NDLM-google-trends" class="level2" data-number="96.7">
<h2 data-number="96.7" class="anchored" data-anchor-id="section-NDLM-google-trends"><span class="header-section-number">96.7</span> Case Study: Google Trends <span class="emoji" data-emoji="movie_camera">🎥</span></h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-8-contents" aria-controls="callout-8" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Video Transcript
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-8" class="callout-8-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>[MUSIC] So in this example we are going to use a dynamic linear model to analyze some data that we are downloading from Google Trends. So you have two ways of downloading the data in Google Trends you can go to the website and download the data on your own for a particular query. So the idea here is you’re going to look for how many times or a proxy for how many times people search for a particular term or you can use the library gtrendsR just to download the data directly from R. So this is what I’m going to do here, I’m just going to use the library and then we will talk a little bit about the structure of the dynamic linear model and proceed with the model fitting and smoothing and all the components here. So just to illustrate first how you can download data from Google Trends here using the function gtrends and there is the help in R provides. All you need to do in terms of just specifying the time framework that you want to use the location in the world that you want to use. So in this example that I have here, I’m looking at the two terms, one is the term NFL how many searches for NFL there were and then the other one is the term NBA and then I’m using two different locations. One is California only and the other one is the US, but you can specify the entire world or any other location and during a particular time period. So here if I run this and I plot the data, you can see a time series in this case the line corresponds to the term nba. The queries or the search hits for that particular term in the US and then you have this nfl only in California. So this is just to illustrate how you can look at these different data sets. I’m going to show you the example with the terms time series and we’re going to use the time framework for just the entire time that google has data available for this. So here I’m interested in thinking about the time series of the searches for the term time series in Google. So I download the data, plot the data here. Takes a little bit and here is my data set. You have the observed time series here for the term time series over the world. If you were to zoom a little bit you will see that the interest over time in terms of the hits is a time series that presents a couple of main features. One feature is we can see a decreasing trend from the beginning that occurs in the year 2004. So this is monthly data and then we’re going to see an increase after that initial period and the largest peak here corresponds to 2018. And then the other component that we see here or the other feature that is important in this data set is that it has some periodicity. So it looks like the data is presenting a periodic behavior. You would see that the larger peaks every year occur in November, which coincides with the US Elections and then there is a smaller peak that occurs in the Spring. So that also has to do with the elections. So just to try to build a model around this, I’m going to fit a model that has two components. One component is a polynomial trend model of order two. You can incorporate higher orders for the polynomial trend if you think that this should be quadratic or cubic or so on. Here, I’m assuming that in terms of the forecast function, I’m going to have a linear trend that allows me to capture either increasing or decreasing linear trends and they change over time. So the model would adapt to those changing structures and then I’m going to use a Fourier representation with a fundamental period of 12 to fit this data and I’m not going to use all the harmonics. We’re going to use a subset of the harmonics. Just in terms of the data, the data provides the interests over time, interest by countries. So if you want to look at other components for this data the entire dataset provides that we are just going to be modeling the hits. So I define the data in terms of the hits and in terms of defining my structure for the dynamic linear model, you can specify the structure by just using defining the matrices yourself or you can use the DLM package that has built in functions to specify these components. So here I am using the DLM package again, you can use any, you can just write down the matrices and specify the matrices on your own. So as I said, the model is going to have two components, is going to have a trend component model using polynomial model of order 2 by default. That’s the model order and just specifying here, that is an order-2 and then also specifying here the m0 for that component. So the mean level here I’m assuming is a priori is 40 for the level and then 0 for the rate of change. The other components in the model are not going to be, we’re not going to use them and am just defining some of those but because we are going to use our code to fit these models and we’re going to also use the discount factor. The only important components here is just the matrices and the prior distributions. So I’ll talk about this a little bit. So the model, the seasonal component, we are using this dlmModTrig, which allows us to specify the Fourier representation of dynamic linear model where the fundamental period here is 12. We’re going to only use the first four harmonics, we’re going to include only before the first four harmonics in the model. And then again you can put the variance for the component and the W for that component, you can specify them. I’m just setting them to these values, but as you will see in a minute we are not going to use that specification, we only care about the F, the G and the prior parameters. So let me just go ahead here I’m changing the model. You can do things like add before we go into to prior, you can add the two components. They are additive and then you have a model that has all this structure into a single object. So you have an m0, a C0 an F, a V, a G, a W and these Js are just for the cases in which the F or the G are changing over time, which is not going to be the case for this particular model. So I’m going to change, you can do things then like change the C0 by specifying a particular value or you can pass that value also through the dlmModPoly either way is possible. So I’m setting up the n0 and S0 that I’m going to use for the prior. We’re going to assume that we have a degrees of freedom of one and the initial estimate for the observational variance is 10. The model, it’s going to have, so if you think about what I’m building here, I’m using a seasonal model with period 12, I’m using the first four harmonics. Each harmonic in this case is going to require a vector of dimension 2 in terms of the state space representation. So, if I have four of those, I’m going to have eight components that are needed for the seasonal component of the model and then for the polynomial trend, my dimension is 2. So the dimension of the resulting final State Parameter vector is going to be 10. So, I now extract the F, the G from that model structure that I defined using the DLM package and then I’m going to pass that structure to my functions that the functions that we’ve been using, just setting up the matrices. So I’m calling here all the code that we need. So the matrices are going to be my Ft Gt. I’m not specifying a Wt_star because I’m going to use the discount factor to specify the Wt structure. And then for the initial states, I’m just passing the m0, that C0 is that we are passing corresponds to the C0 star in this function and then I have n0 and S0. Now, I specify a range for the discount factor. So I’m going to use discount factors that are between 0.9 and 1 and then we’re going to go by increments of 0.005 to define that grid of values. So once I do that, I’m also going to choose the optimal model order using the mean square error. And once I run this function adaptive_dlm with the structure of the DLM that we built the initial values for the prior distributions and the data in that grid of values it returns the optimal discount factor. In this case, it’s selecting a discount factor of 0.94. So we’re going to use a single discount factor for specifying the structure for all the components of the model. And then once we do that we can retrieve the results corresponding to the filtering distributions, the smoothing distributions and you may also do forecasting if you want. So here we are just retrieving those and computing 95% credible intervals and I’m going to go ahead and plot the results of this. The dotted line corresponds to the data here the blue line corresponds to the mean of the smoothing distribution for the mean response here. So that’s what we obtain and then the credible intervals the 95% credible intervals are that that are illustrated with a dotted blue lines here. So the model is capturing the structure of the time series here. We can then isolate different components. So as we said, we have a trend component and we have a seasonal component in the model and the seasonal component has multiple components in terms of the different frequencies associated to those four harmonics that we included. So you can plot the contribution of each of those components. So if I think about the smoothing distributions and I look at the first component of the smoothing distribution, that is the estimate for that baseline. So the grey dots correspond to the data and you can see how this is capturing that trend that we described in the data that decrease at the beginning of the time period, then it increases and then decreases a little bit and then continues increasing towards the end. I can also plot because this is the second order polynomial model, I can also plot the second component of the state vector. So here the second component would be the rate of change and if I look at the smooth distributions for the rate of change parameter, you can see here that this rate of change is kind of decreasing towards the beginning. So it’s just the rate of change here, you have to compare this with 0. So it’s below 0 for this period corresponding to decreasing in the trend and then it goes above 0 for this period and the rest of the period just corresponding to increasing trends and then it’s close to 0 here. Just indicating that there aren’t too many changes in that trend. You can then plot the seasonal components and the first two components of the state vector are corresponding to the second order polynomial trend. And then components 3, 5, 7 and 9 are the components that correspond to each of the harmonics with the fundamental frequency of 12. So monthly period, so every 12 observations you’re going to have a period and then the remaining harmonic. So let me just plot those and show you. So I’m again plotting only the results based on the mean of the smooth distribution here. So you can see how these components are capturing again those characteristics that we observed in the data. So first there is a this is the component that corresponds to period 12. So we see that there is a variation in the amplitude with the largest variation occurring in year 2018. That corresponds to the presidential US election in the the fall of 2018. Same thing happens with the period six and the period four and the period three. So you can see that the components contribute differently to the main seasonality that we observed in the data. Finally we can also get estimates and we can actually get some samples from the posterior distribution of the variance given all the data here, I’m just going to plot just going to show you what is the estimate that we obtained here for these filtering distribution. So this is about 18.76 is the estimate of the variance at the observation level based on this model, using this particular discount factor and this model structure. So you can also plot the forecasting distributions for whatever number of steps ahead. You can do just using the functions as we did before. So this illustrates how again you can analyze data from different sources. Just here is an example with Google Trends data with a model that has different kinds of component. [MUSIC]</p>
</div>
</div>
</div>


<!-- -->

</section>

</main> <!-- /main -->
<script type="text/javascript">

// replace cmd keyboard shortcut w/ control on non-Mac platforms
const kPlatformMac = typeof navigator !== 'undefined' ? /Mac/.test(navigator.platform) : false;
if (!kPlatformMac) {
   var kbds = document.querySelectorAll("kbd")
   kbds.forEach(function(kbd) {
      kbd.innerHTML = kbd.innerHTML.replace(/⌘/g, '⌃');
   });
}

// tweak headings in pymd
document.querySelectorAll(".pymd span.co").forEach(el => {
   if (!el.innerText.startsWith("#|")) {
      el.style.fontWeight = 1000;
   }
});

</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
        for (let i=0; i<annoteTargets.length; i++) {
          const annoteTarget = annoteTargets[i];
          const targetCell = annoteTarget.getAttribute("data-target-cell");
          const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
          const contentFn = () => {
            const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
            if (content) {
              const tipContent = content.cloneNode(true);
              tipContent.classList.add("code-annotation-tip-content");
              return tipContent.outerHTML;
            }
          }
          const config = {
            allowHTML: true,
            content: contentFn,
            onShow: (instance) => {
              selectCodeLines(instance.reference);
              instance.reference.classList.add('code-annotation-active');
              window.tippy.hideAll();
            },
            onHide: (instance) => {
              unselectCodeLines();
              instance.reference.classList.remove('code-annotation-active');
            },
            maxWidth: 300,
            delay: [50, 0],
            duration: [200, 0],
            offset: [5, 10],
            arrow: true,
            appendTo: function(el) {
              return el.parentElement.parentElement.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'quarto',
            placement: 'right',
            popperOptions: {
              modifiers: [
              {
                name: 'flip',
                options: {
                  flipVariations: false, // true by default
                  allowedAutoPlacements: ['right'],
                  fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
                },
              },
              {
                name: 'preventOverflow',
                options: {
                  mainAxis: false,
                  altAxis: false
                }
              }
              ]        
            }      
          };
          window.tippy(annoteTarget, config); 
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./C4-L08.html" class="pagination-link" aria-label="Seasonal NDLMs M4L8">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">95</span>&nbsp; <span class="chapter-title">Seasonal NDLMs M4L8</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./C4-L09-Ex1.html" class="pagination-link" aria-label="Practice Graded Assignment: NDLM data analysis - M4L9">
        <span class="nav-page-text"><span class="chapter-number">97</span>&nbsp; <span class="chapter-title">Practice Graded Assignment: NDLM data analysis - M4L9</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb11" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2024-11-09</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Bayesian Inference in the NDLM: Part 2 - M4L9"</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> Time Series Analysis</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> "Normal Dynamic Linear Models (NDLMs) are a class of models used for time series analysis that allow for flexible modeling of temporal dependencies."</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span><span class="co"> </span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">  - Bayesian Statistics</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co">  - Time Series</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="an">keywords:</span><span class="co"> </span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co">  - Time series</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co">  - Filtering</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="co">  - Smoothing</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co">  - NDLM</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co">  - Normal Dynamic Linear Models</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="co">  - Seasonal NDLM</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="co">  - Superposition Principle</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="co">  - R code</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="an">fig-caption:</span><span class="co"> Notes about ... Bayesian Statistics</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="an">title-block-banner:</span><span class="co"> images/banner_deep.jpg</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="fu">## Filtering, Smoothing and Forecasting: Unknown observational variance  :movie_camera: {#section-NDLM-unknown-variance}</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>::: {.callout-caution collapse="true"}</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a><span class="fu">## Bumpy ride ahead! {.unnumbered}</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>This material seems unnecessarily complicated:</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>This section seems like a lots of mathematical gobbledygook without any context of motivation for application for each of the equations being presented.</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>After writing everything out and reviewing it multiple times, I began to develop a purely mathematical intuition i.e. I can relate them to the the general Bayesian inference framework,</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>I can't however say I am much closer to using them in engineering solution based on this mathematics.</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>I doubt that doing a single capstone project will make much of a difference.</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>While we will see three application in this module, (Nile river data, google trends, and EEG data). However, what I need to understand for each of these filtering, smoothing and forecasting distributions why are they useful rather than the original ones. I mean when we use to solve a specific challenge, for a dataset. </span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Perhaps the root cause here is that this course fails to acknowledge the connection of NDLM to the Kalman Filters and the much wider literature on Kalman Filters than NDLM. It appears to me that in the first course of the Kalman filtering specialization (KF bootcamp) there are a number of application that are presented each with a different requirements and that if we map the different challenges to the NDLM framework we should be able to navigate the math more easily.</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Anyhow a lookup indicates that this model is called in the state-space modeling terminology as **local level model** for local level or trend filtering, such as in structural time series models, and in the  Kalman filtering  terminology as a KF with variance learning.</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>In the case of the NDLM, where we **assume** That the observational variance $\nu_t=v$ i.e. is constant over time.</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a><span class="fu">### Inference in the NDLM with unknown constant observational variance:</span></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>Let $\nu_t = v\ \forall t$ with $\nu$ unknown and consider a DLM with the following structure:</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>  y_t &amp;= \mathbf{F}_t' \boldsymbol{\theta}_t + \nu_t,                </span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>      &amp;\nu_t &amp;\sim \mathcal{N} (0, \nu) </span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>      &amp;\text{(obs)}<span class="sc">\\</span></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>  \boldsymbol{\theta}_t &amp;= \mathbf{G}_t \boldsymbol{\theta}_{t-1} + \boldsymbol{\omega}_t, </span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>      &amp; \boldsymbol{\omega}_t </span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>      &amp;\sim \mathcal{N} (0, \nu \mathbf{W}^*_t) </span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>      &amp;\text{(sys)}</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>$$ {#eq-NDLM-unknown-variance}</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>where we have the usual suspects:</span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>the first equation is the observation equation, that relates the hidden state $\theta_t$ to the observation and the observation level noise $\nu_t$, (perhaps in our sensors)</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>the second equation is the state equation, which describes how the hidden state $\theta_t$ evolves over time with the system noise $\boldsymbol{\omega}_t$. perhaps (due to an approximation in the system dynamics).</span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>$\mathbf{F}_t$  is a known observation matrix,</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a><span class="ss">  -  </span>$\mathbf{G}_t$ is a known state transition matrix,</span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>$\boldsymbol{\theta}_t$ is the state vector, and </span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>$\boldsymbol{\omega}_t$ is the system noise.</span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>$\mathbf{W}_t$ is a the known covariance matrix, for system noise which is assumed to be known for all time t</span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>::: {.callout-important collapse="False"}</span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a><span class="fu">## Question: why does $\nu$ appear in the $w_t$ distribution equation? {.unnumbered}</span></span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>Prado says is also **assuming** that the system noise is conditional on the variance $\nu$.</span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>Yet this seems to be an assumption that should be justified.</span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a>In fact, What we are missing is a logical Model for this model i.e. simple use case</span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a>with conjugate prior distributions:</span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a>(\boldsymbol{\theta}_0 \mid \mathcal{D}_0, \nu) &amp;\sim \mathcal{N} (\mathbf{m}_0, \nu\ \mathbf{C}^*_0) <span class="sc">\\</span> (\nu \mid \mathcal{D}_0) &amp;\sim \mathcal{IG}\left(\frac{n_0}{2}, \frac{d_0}{2}\right ) <span class="sc">\\</span></span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a> d_0 &amp;= n_0 s_0</span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a>$$ {#eq-NDLM-unknown-variance-priors}</span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a><span class="fu">### Filtering</span></span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a>Assuming $(\boldsymbol{\theta}_{t-1} \mid \mathcal{D}_{t-1}, \nu) \sim \mathcal{N} (\mathbf{m}_{t-1}, \nu\ \mathbf{C}^*_{t-1})$, we have the following results:</span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$(\boldsymbol{\theta}_t \mid \mathcal{D}_{t-1}, \nu) \sim \mathcal{N} (\mathbf{a}_t, \nu \mathbf{R}^*_t)$ </span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>with </span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>$\mathbf{a}_t = \mathbf{G}_t \mathbf{m}_{t-1}$ </span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>$\mathbf{R}^*_t = \mathbf{G}_t \mathbf{C}^*_{t-1} \mathbf{G}'_t + \mathbf{W}^*_t$, </span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a>and unconditional on $\nu$, we have </span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$(\boldsymbol{\theta}_t \mid \mathcal{D}_{t-1}) \sim T_{n_{t-1}} (\mathbf{a}_t, \mathbf{R}_t)$</span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>with </span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>$\mathbf{R}_t = s_{t-1} \mathbf{R}^*_t$</span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>$s_t\ \forall t$ given in @eq-NDLM-unknown-variance-filtering.</span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$(y_t \mid \mathcal{D}_{t-1}, \nu) \sim \mathcal{N} (f_t, \nu q^*_t)$</span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>with </span>
<span id="cb11-105"><a href="#cb11-105" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>$f_t = F'_t \mathbf{a}_t$ </span>
<span id="cb11-106"><a href="#cb11-106" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>$q^*_t = (1 + F'_t \mathbf{R}^*_t F_t)$ </span>
<span id="cb11-107"><a href="#cb11-107" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-108"><a href="#cb11-108" aria-hidden="true" tabindex="-1"></a>and unconditional on $\nu$ we have </span>
<span id="cb11-109"><a href="#cb11-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-110"><a href="#cb11-110" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$(y_t \mid \mathcal{D}_{t-1}) \sim T_{n_{t-1}} (f_t, q_t)$</span>
<span id="cb11-111"><a href="#cb11-111" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>with </span>
<span id="cb11-112"><a href="#cb11-112" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>$q_t = s_{t-1} q^*_t$</span>
<span id="cb11-113"><a href="#cb11-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-114"><a href="#cb11-114" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$(v \mid \mathcal{D}_t) \sim \mathcal{IG}\left( \tfrac{n_t}{2}, \tfrac{s_t}{2}\right )$</span>
<span id="cb11-115"><a href="#cb11-115" aria-hidden="true" tabindex="-1"></a><span class="ss">  -  </span>with</span>
<span id="cb11-116"><a href="#cb11-116" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>$n_t = n_{t-1} + 1$</span>
<span id="cb11-117"><a href="#cb11-117" aria-hidden="true" tabindex="-1"></a>  $$ </span>
<span id="cb11-118"><a href="#cb11-118" aria-hidden="true" tabindex="-1"></a>  s_t = s_{t-1} + \frac{s_{t-1}}{n_t} \left ( \frac{e^2_t}{q^*_t} - 1 \right ), </span>
<span id="cb11-119"><a href="#cb11-119" aria-hidden="true" tabindex="-1"></a>  $$ {#eq-NDLM-unknown-variance-filtering}</span>
<span id="cb11-120"><a href="#cb11-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-121"><a href="#cb11-121" aria-hidden="true" tabindex="-1"></a>  here $e_t = y_t - f_t$</span>
<span id="cb11-122"><a href="#cb11-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-123"><a href="#cb11-123" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$(\theta_t \mid D_t, v) \sim N (m_t, vC^*_t)$, </span>
<span id="cb11-124"><a href="#cb11-124" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>with</span>
<span id="cb11-125"><a href="#cb11-125" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>$m_t = a_t + A_t e_t$, and </span>
<span id="cb11-126"><a href="#cb11-126" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>$C^*_t = R^*_t - A_t A'_t q^*_t$.</span>
<span id="cb11-127"><a href="#cb11-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-128"><a href="#cb11-128" aria-hidden="true" tabindex="-1"></a>Similarly, unconditional on $\nu$ we have</span>
<span id="cb11-129"><a href="#cb11-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-130"><a href="#cb11-130" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$(\boldsymbol{\theta}_t\mid \mathcal{D}_t) \sim T_{n_t} (\mathbf{m}_t, \mathbf{C}_t)$</span>
<span id="cb11-131"><a href="#cb11-131" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>with </span>
<span id="cb11-132"><a href="#cb11-132" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>$\mathbf{C}_t = s_t \mathbf{C}^*_t$</span>
<span id="cb11-133"><a href="#cb11-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-134"><a href="#cb11-134" aria-hidden="true" tabindex="-1"></a><span class="fu">### Forecasting</span></span>
<span id="cb11-135"><a href="#cb11-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-136"><a href="#cb11-136" aria-hidden="true" tabindex="-1"></a>Similarly, we have the forecasting distributions:</span>
<span id="cb11-137"><a href="#cb11-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-138"><a href="#cb11-138" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$(\boldsymbol{\theta}_{t+h} \mid \mathcal{D}_t) \sim T_{n_t} (\mathbf{a}_{t}(h), \mathbf{R}_{t}(h))$,</span>
<span id="cb11-139"><a href="#cb11-139" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$(y_{t+h} \mid \mathcal{D}_t) \sim T_{n_t} (f_{t}(h), q_{t}(h))$,</span>
<span id="cb11-140"><a href="#cb11-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-141"><a href="#cb11-141" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>with</span>
<span id="cb11-142"><a href="#cb11-142" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>$\mathbf{a}_{t}(h) = \mathbf{G}_{t+h} \mathbf{a}_{t}(h-1)$,</span>
<span id="cb11-143"><a href="#cb11-143" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>$\mathbf{a}_{t}(0) = \mathbf{m}_t$, and</span>
<span id="cb11-144"><a href="#cb11-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-145"><a href="#cb11-145" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb11-146"><a href="#cb11-146" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb11-147"><a href="#cb11-147" aria-hidden="true" tabindex="-1"></a>  \mathbf{R}_{t}(h) &amp;= \mathbf{G}_{t+h} \mathbf{R}_{t}(h-1) \mathbf{G}'_{t+h} + \mathbf{W}_{t+h} <span class="sc">\\</span></span>
<span id="cb11-148"><a href="#cb11-148" aria-hidden="true" tabindex="-1"></a>  \mathbf{R}_{t}(0) &amp;= \mathbf{C}_t</span>
<span id="cb11-149"><a href="#cb11-149" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb11-150"><a href="#cb11-150" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb11-151"><a href="#cb11-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-152"><a href="#cb11-152" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb11-153"><a href="#cb11-153" aria-hidden="true" tabindex="-1"></a>f_{t}(h) = \mathbf{F}'_{t+h} \mathbf{a}_{t}(h) \qquad q_{t}(h) = \mathbf{F}'_{t+h} \mathbf{R}_{t}(h) \mathbf{F}_{t+h} + s_{t}</span>
<span id="cb11-154"><a href="#cb11-154" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb11-155"><a href="#cb11-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-156"><a href="#cb11-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-157"><a href="#cb11-157" aria-hidden="true" tabindex="-1"></a><span class="fu">### Smoothing</span></span>
<span id="cb11-158"><a href="#cb11-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-159"><a href="#cb11-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-160"><a href="#cb11-160" aria-hidden="true" tabindex="-1"></a>Finally, the smoothing distributions have the form:</span>
<span id="cb11-161"><a href="#cb11-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-162"><a href="#cb11-162" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb11-163"><a href="#cb11-163" aria-hidden="true" tabindex="-1"></a>(\boldsymbol{\theta}_t \mid \mathcal{D}_T) \sim T_{n_T} (a_T (t - T), R_T (t - T) s_T / s_t)</span>
<span id="cb11-164"><a href="#cb11-164" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb11-165"><a href="#cb11-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-166"><a href="#cb11-166" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>where</span>
<span id="cb11-167"><a href="#cb11-167" aria-hidden="true" tabindex="-1"></a>  -$a_T (t - T)$ and $R_T (t - T)$ </span>
<span id="cb11-168"><a href="#cb11-168" aria-hidden="true" tabindex="-1"></a>with</span>
<span id="cb11-169"><a href="#cb11-169" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb11-170"><a href="#cb11-170" aria-hidden="true" tabindex="-1"></a>a_T (t - T) = m_T - B_T [a_{T+1} - a_T (t - T + 1)]</span>
<span id="cb11-171"><a href="#cb11-171" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb11-172"><a href="#cb11-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-173"><a href="#cb11-173" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb11-174"><a href="#cb11-174" aria-hidden="true" tabindex="-1"></a>R_T (t - T) = C_T - B_T <span class="co">[</span><span class="ot">R_{T+1} - R_T (t - T + 1)</span><span class="co">]</span> B'_T</span>
<span id="cb11-175"><a href="#cb11-175" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb11-176"><a href="#cb11-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-177"><a href="#cb11-177" aria-hidden="true" tabindex="-1"></a>with </span>
<span id="cb11-178"><a href="#cb11-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-179"><a href="#cb11-179" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb11-180"><a href="#cb11-180" aria-hidden="true" tabindex="-1"></a>B_T = C_T G'_{T+1} R^{-1}_{T+1}, \quad a_T (0) = m_T , \quad R_T (0) = C_T.</span>
<span id="cb11-181"><a href="#cb11-181" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb11-182"><a href="#cb11-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-183"><a href="#cb11-183" aria-hidden="true" tabindex="-1"></a>::: {.callout-note collapse="true"}</span>
<span id="cb11-184"><a href="#cb11-184" aria-hidden="true" tabindex="-1"></a><span class="fu">## Video Transcript {.unnumbered}</span></span>
<span id="cb11-185"><a href="#cb11-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-186"><a href="#cb11-186" aria-hidden="true" tabindex="-1"></a>{{&lt; include transcripts/c4/04_week-4-normal-dynamic-linear-models-part-ii/02_bayesian-inference-in-the-ndlm-part-ii/01_filtering-smoothing-and-forecasting-unknown-observational-variance.en.txt &gt;}}</span>
<span id="cb11-187"><a href="#cb11-187" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb11-188"><a href="#cb11-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-189"><a href="#cb11-189" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary of Filtering, Smoothing and Forecasting Distributions, NDLM unknown observational variance  :spiral_notepad: </span></span>
<span id="cb11-190"><a href="#cb11-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-191"><a href="#cb11-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-192"><a href="#cb11-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-193"><a href="#cb11-193" aria-hidden="true" tabindex="-1"></a><span class="fu">## Specifying the system covariance matrix via discount factors  :movie_camera: </span></span>
<span id="cb11-194"><a href="#cb11-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-195"><a href="#cb11-195" aria-hidden="true" tabindex="-1"></a>::: {.callout-note collapse="true"}</span>
<span id="cb11-196"><a href="#cb11-196" aria-hidden="true" tabindex="-1"></a><span class="fu">## Video Transcript {.unnumbered}</span></span>
<span id="cb11-197"><a href="#cb11-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-198"><a href="#cb11-198" aria-hidden="true" tabindex="-1"></a>{{&lt; include transcripts/c4/04_week-4-normal-dynamic-linear-models-part-ii/02_bayesian-inference-in-the-ndlm-part-ii/03_specifying-the-system-covariance-matrix-via-discount-factors.en.txt &gt;}}</span>
<span id="cb11-199"><a href="#cb11-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-200"><a href="#cb11-200" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb11-201"><a href="#cb11-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-202"><a href="#cb11-202" aria-hidden="true" tabindex="-1"></a><span class="fu">## NDLM, Unknown Observational Variance: Example  :movie_camera: </span></span>
<span id="cb11-203"><a href="#cb11-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-204"><a href="#cb11-204" aria-hidden="true" tabindex="-1"></a>This is a walk though of the R code in @lst-NDLM-unknown-variance</span>
<span id="cb11-205"><a href="#cb11-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-206"><a href="#cb11-206" aria-hidden="true" tabindex="-1"></a>::: {.callout-note collapse="true"}</span>
<span id="cb11-207"><a href="#cb11-207" aria-hidden="true" tabindex="-1"></a><span class="fu">## Video Transcript {.unnumbered}</span></span>
<span id="cb11-208"><a href="#cb11-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-209"><a href="#cb11-209" aria-hidden="true" tabindex="-1"></a>{{&lt; include transcripts/c4/04_week-4-normal-dynamic-linear-models-part-ii/02_bayesian-inference-in-the-ndlm-part-ii/04_ndlm-unknown-observational-variance-example.en.txt &gt;}}</span>
<span id="cb11-210"><a href="#cb11-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-211"><a href="#cb11-211" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb11-212"><a href="#cb11-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-213"><a href="#cb11-213" aria-hidden="true" tabindex="-1"></a><span class="fu">## code: NDLM, Unknown Observational Variance Example  :spiral_notepad: $\mathcal{R}$</span></span>
<span id="cb11-214"><a href="#cb11-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-215"><a href="#cb11-215" aria-hidden="true" tabindex="-1"></a>This code allows time-varying $F_t$, $G_t$ and $W_t$ matrices and assumes an unknown but constant $\nu$. </span>
<span id="cb11-216"><a href="#cb11-216" aria-hidden="true" tabindex="-1"></a>It also allows the user to specify $W_t$ using a discount factor $\delta \in (0,1]$ or assume $W_t$  known.</span>
<span id="cb11-217"><a href="#cb11-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-220"><a href="#cb11-220" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb11-221"><a href="#cb11-221" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: lst-NDLM-unknown-variance</span></span>
<span id="cb11-222"><a href="#cb11-222" aria-hidden="true" tabindex="-1"></a><span class="co">#| lst-label: lst-NDLM-unknown-variance</span></span>
<span id="cb11-223"><a href="#cb11-223" aria-hidden="true" tabindex="-1"></a><span class="co">#| lst-cap: NDLM, Unknown Observational Variance Example</span></span>
<span id="cb11-224"><a href="#cb11-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-225"><a href="#cb11-225" aria-hidden="true" tabindex="-1"></a><span class="do">## create list for matrices</span></span>
<span id="cb11-226"><a href="#cb11-226" aria-hidden="true" tabindex="-1"></a>set_up_dlm_matrices_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb11-227"><a href="#cb11-227" aria-hidden="true" tabindex="-1"></a>  Ft, Gt, Wt_star){</span>
<span id="cb11-228"><a href="#cb11-228" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.array</span>(Gt)){</span>
<span id="cb11-229"><a href="#cb11-229" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Stop</span>(<span class="st">"Gt and Ft should be array"</span>)</span>
<span id="cb11-230"><a href="#cb11-230" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-231"><a href="#cb11-231" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">missing</span>(Wt_star)){</span>
<span id="cb11-232"><a href="#cb11-232" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">Ft=</span>Ft, <span class="at">Gt=</span>Gt))</span>
<span id="cb11-233"><a href="#cb11-233" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb11-234"><a href="#cb11-234" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">Ft=</span>Ft, <span class="at">Gt=</span>Gt, <span class="at">Wt_star=</span>Wt_star))</span>
<span id="cb11-235"><a href="#cb11-235" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-236"><a href="#cb11-236" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-237"><a href="#cb11-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-238"><a href="#cb11-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-239"><a href="#cb11-239" aria-hidden="true" tabindex="-1"></a><span class="do">## create list for initial states</span></span>
<span id="cb11-240"><a href="#cb11-240" aria-hidden="true" tabindex="-1"></a>set_up_initial_states_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb11-241"><a href="#cb11-241" aria-hidden="true" tabindex="-1"></a>  m0, C0_star, n0, S0){</span>
<span id="cb11-242"><a href="#cb11-242" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">m0=</span>m0, <span class="at">C0_star=</span>C0_star, <span class="at">n0=</span>n0, <span class="at">S0=</span>S0))</span>
<span id="cb11-243"><a href="#cb11-243" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-244"><a href="#cb11-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-245"><a href="#cb11-245" aria-hidden="true" tabindex="-1"></a>forward_filter_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb11-246"><a href="#cb11-246" aria-hidden="true" tabindex="-1"></a>  data, matrices, initial_states, delta){</span>
<span id="cb11-247"><a href="#cb11-247" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve dataset</span></span>
<span id="cb11-248"><a href="#cb11-248" aria-hidden="true" tabindex="-1"></a>  yt <span class="ot">&lt;-</span> data<span class="sc">$</span>yt</span>
<span id="cb11-249"><a href="#cb11-249" aria-hidden="true" tabindex="-1"></a>  T<span class="ot">&lt;-</span> <span class="fu">length</span>(yt)</span>
<span id="cb11-250"><a href="#cb11-250" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-251"><a href="#cb11-251" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb11-252"><a href="#cb11-252" aria-hidden="true" tabindex="-1"></a>  Ft <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Ft</span>
<span id="cb11-253"><a href="#cb11-253" aria-hidden="true" tabindex="-1"></a>  Gt <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Gt</span>
<span id="cb11-254"><a href="#cb11-254" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb11-255"><a href="#cb11-255" aria-hidden="true" tabindex="-1"></a>    Wt_star <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Wt_star</span>
<span id="cb11-256"><a href="#cb11-256" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-257"><a href="#cb11-257" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-258"><a href="#cb11-258" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve initial state</span></span>
<span id="cb11-259"><a href="#cb11-259" aria-hidden="true" tabindex="-1"></a>  m0 <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>m0</span>
<span id="cb11-260"><a href="#cb11-260" aria-hidden="true" tabindex="-1"></a>  C0_star <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>C0_star</span>
<span id="cb11-261"><a href="#cb11-261" aria-hidden="true" tabindex="-1"></a>  n0 <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>n0</span>
<span id="cb11-262"><a href="#cb11-262" aria-hidden="true" tabindex="-1"></a>  S0 <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>S0</span>
<span id="cb11-263"><a href="#cb11-263" aria-hidden="true" tabindex="-1"></a>  C0 <span class="ot">&lt;-</span> S0<span class="sc">*</span>C0_star</span>
<span id="cb11-264"><a href="#cb11-264" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-265"><a href="#cb11-265" aria-hidden="true" tabindex="-1"></a>  <span class="do">## create placeholder for results</span></span>
<span id="cb11-266"><a href="#cb11-266" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">dim</span>(Gt)[<span class="dv">1</span>]</span>
<span id="cb11-267"><a href="#cb11-267" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span>T, <span class="at">ncol=</span>d)</span>
<span id="cb11-268"><a href="#cb11-268" aria-hidden="true" tabindex="-1"></a>  Rt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, T))</span>
<span id="cb11-269"><a href="#cb11-269" aria-hidden="true" tabindex="-1"></a>  ft <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb11-270"><a href="#cb11-270" aria-hidden="true" tabindex="-1"></a>  Qt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb11-271"><a href="#cb11-271" aria-hidden="true" tabindex="-1"></a>  mt <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span>T, <span class="at">ncol=</span>d)</span>
<span id="cb11-272"><a href="#cb11-272" aria-hidden="true" tabindex="-1"></a>  Ct <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, T))</span>
<span id="cb11-273"><a href="#cb11-273" aria-hidden="true" tabindex="-1"></a>  et <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb11-274"><a href="#cb11-274" aria-hidden="true" tabindex="-1"></a>  nt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb11-275"><a href="#cb11-275" aria-hidden="true" tabindex="-1"></a>  St <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb11-276"><a href="#cb11-276" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb11-277"><a href="#cb11-277" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-278"><a href="#cb11-278" aria-hidden="true" tabindex="-1"></a>  <span class="co"># moments of priors at t</span></span>
<span id="cb11-279"><a href="#cb11-279" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T){</span>
<span id="cb11-280"><a href="#cb11-280" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb11-281"><a href="#cb11-281" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> Gt[, , i] <span class="sc">%*%</span> m0</span>
<span id="cb11-282"><a href="#cb11-282" aria-hidden="true" tabindex="-1"></a>      Pt <span class="ot">&lt;-</span> Gt[, , i] <span class="sc">%*%</span> C0 <span class="sc">%*%</span> <span class="fu">t</span>(Gt[, , i])</span>
<span id="cb11-283"><a href="#cb11-283" aria-hidden="true" tabindex="-1"></a>      Pt <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Pt <span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Pt)</span>
<span id="cb11-284"><a href="#cb11-284" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb11-285"><a href="#cb11-285" aria-hidden="true" tabindex="-1"></a>        Wt <span class="ot">&lt;-</span> Wt_star[, , i]<span class="sc">*</span>S0</span>
<span id="cb11-286"><a href="#cb11-286" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Pt <span class="sc">+</span> Wt</span>
<span id="cb11-287"><a href="#cb11-287" aria-hidden="true" tabindex="-1"></a>        Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb11-288"><a href="#cb11-288" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb11-289"><a href="#cb11-289" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Pt<span class="sc">/</span>delta</span>
<span id="cb11-290"><a href="#cb11-290" aria-hidden="true" tabindex="-1"></a>        Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb11-291"><a href="#cb11-291" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb11-292"><a href="#cb11-292" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb11-293"><a href="#cb11-293" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb11-294"><a href="#cb11-294" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> Gt[, , i] <span class="sc">%*%</span> <span class="fu">t</span>(mt[i<span class="dv">-1</span>, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb11-295"><a href="#cb11-295" aria-hidden="true" tabindex="-1"></a>      Pt <span class="ot">&lt;-</span> Gt[, , i] <span class="sc">%*%</span> Ct[, , i<span class="dv">-1</span>] <span class="sc">%*%</span> <span class="fu">t</span>(Gt[, , i])</span>
<span id="cb11-296"><a href="#cb11-296" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb11-297"><a href="#cb11-297" aria-hidden="true" tabindex="-1"></a>        Wt <span class="ot">&lt;-</span> Wt_star[, , i] <span class="sc">*</span> St[i<span class="dv">-1</span>]</span>
<span id="cb11-298"><a href="#cb11-298" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Pt <span class="sc">+</span> Wt</span>
<span id="cb11-299"><a href="#cb11-299" aria-hidden="true" tabindex="-1"></a>        Rt[,,i]<span class="ot">=</span><span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb11-300"><a href="#cb11-300" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb11-301"><a href="#cb11-301" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Pt<span class="sc">/</span>delta</span>
<span id="cb11-302"><a href="#cb11-302" aria-hidden="true" tabindex="-1"></a>        Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb11-303"><a href="#cb11-303" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb11-304"><a href="#cb11-304" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-305"><a href="#cb11-305" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-306"><a href="#cb11-306" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments of one-step forecast:</span></span>
<span id="cb11-307"><a href="#cb11-307" aria-hidden="true" tabindex="-1"></a>    ft[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , i]) <span class="sc">%*%</span> <span class="fu">t</span>(at[i, , <span class="at">drop=</span><span class="cn">FALSE</span>]) </span>
<span id="cb11-308"><a href="#cb11-308" aria-hidden="true" tabindex="-1"></a>    Qt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , i]) <span class="sc">%*%</span> Rt[, , i] <span class="sc">%*%</span> Ft[, , i] <span class="sc">+</span> </span>
<span id="cb11-309"><a href="#cb11-309" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(i<span class="sc">==</span><span class="dv">1</span>, S0, St[i<span class="dv">-1</span>])</span>
<span id="cb11-310"><a href="#cb11-310" aria-hidden="true" tabindex="-1"></a>    et[i] <span class="ot">&lt;-</span> yt[i] <span class="sc">-</span> ft[i]</span>
<span id="cb11-311"><a href="#cb11-311" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-312"><a href="#cb11-312" aria-hidden="true" tabindex="-1"></a>    nt[i] <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(i<span class="sc">==</span><span class="dv">1</span>, n0, nt[i<span class="dv">-1</span>]) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb11-313"><a href="#cb11-313" aria-hidden="true" tabindex="-1"></a>    St[i] <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(i<span class="sc">==</span><span class="dv">1</span>, S0, </span>
<span id="cb11-314"><a href="#cb11-314" aria-hidden="true" tabindex="-1"></a>                    St[i<span class="dv">-1</span>])<span class="sc">*</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>nt[i]<span class="sc">*</span>(et[i]<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span>Qt[i]<span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb11-315"><a href="#cb11-315" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-316"><a href="#cb11-316" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments of posterior at t:</span></span>
<span id="cb11-317"><a href="#cb11-317" aria-hidden="true" tabindex="-1"></a>    At <span class="ot">&lt;-</span> Rt[, , i] <span class="sc">%*%</span> Ft[, , i] <span class="sc">/</span> Qt[i]</span>
<span id="cb11-318"><a href="#cb11-318" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-319"><a href="#cb11-319" aria-hidden="true" tabindex="-1"></a>    mt[i, ] <span class="ot">&lt;-</span> at[i, ] <span class="sc">+</span> <span class="fu">t</span>(At) <span class="sc">*</span> et[i]</span>
<span id="cb11-320"><a href="#cb11-320" aria-hidden="true" tabindex="-1"></a>    Ct[, , i] <span class="ot">&lt;-</span> St[i]<span class="sc">/</span><span class="fu">ifelse</span>(i<span class="sc">==</span><span class="dv">1</span>, S0, </span>
<span id="cb11-321"><a href="#cb11-321" aria-hidden="true" tabindex="-1"></a>                  St[i<span class="dv">-1</span>])<span class="sc">*</span>(Rt[, , i] <span class="sc">-</span> Qt[i] <span class="sc">*</span> At <span class="sc">%*%</span> <span class="fu">t</span>(At))</span>
<span id="cb11-322"><a href="#cb11-322" aria-hidden="true" tabindex="-1"></a>    Ct[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Ct[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Ct[,,i])</span>
<span id="cb11-323"><a href="#cb11-323" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-324"><a href="#cb11-324" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Forward filtering is completed!</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-325"><a href="#cb11-325" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mt =</span> mt, <span class="at">Ct =</span> Ct,  <span class="at">at =</span> at, <span class="at">Rt =</span> Rt, </span>
<span id="cb11-326"><a href="#cb11-326" aria-hidden="true" tabindex="-1"></a>              <span class="at">ft =</span> ft, <span class="at">Qt =</span> Qt,  <span class="at">et =</span> et, </span>
<span id="cb11-327"><a href="#cb11-327" aria-hidden="true" tabindex="-1"></a>              <span class="at">nt =</span> nt, <span class="at">St =</span> St))</span>
<span id="cb11-328"><a href="#cb11-328" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-329"><a href="#cb11-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-330"><a href="#cb11-330" aria-hidden="true" tabindex="-1"></a><span class="do">### smoothing function </span><span class="al">###</span></span>
<span id="cb11-331"><a href="#cb11-331" aria-hidden="true" tabindex="-1"></a>backward_smoothing_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(data, matrices, </span>
<span id="cb11-332"><a href="#cb11-332" aria-hidden="true" tabindex="-1"></a>                                posterior_states,delta){</span>
<span id="cb11-333"><a href="#cb11-333" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve data </span></span>
<span id="cb11-334"><a href="#cb11-334" aria-hidden="true" tabindex="-1"></a>  yt <span class="ot">&lt;-</span> data<span class="sc">$</span>yt</span>
<span id="cb11-335"><a href="#cb11-335" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> <span class="fu">length</span>(yt) </span>
<span id="cb11-336"><a href="#cb11-336" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-337"><a href="#cb11-337" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb11-338"><a href="#cb11-338" aria-hidden="true" tabindex="-1"></a>  Ft <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Ft</span>
<span id="cb11-339"><a href="#cb11-339" aria-hidden="true" tabindex="-1"></a>  Gt <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Gt</span>
<span id="cb11-340"><a href="#cb11-340" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-341"><a href="#cb11-341" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb11-342"><a href="#cb11-342" aria-hidden="true" tabindex="-1"></a>  mt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>mt</span>
<span id="cb11-343"><a href="#cb11-343" aria-hidden="true" tabindex="-1"></a>  Ct <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>Ct</span>
<span id="cb11-344"><a href="#cb11-344" aria-hidden="true" tabindex="-1"></a>  Rt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>Rt</span>
<span id="cb11-345"><a href="#cb11-345" aria-hidden="true" tabindex="-1"></a>  nt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>nt</span>
<span id="cb11-346"><a href="#cb11-346" aria-hidden="true" tabindex="-1"></a>  St <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>St</span>
<span id="cb11-347"><a href="#cb11-347" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>at</span>
<span id="cb11-348"><a href="#cb11-348" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-349"><a href="#cb11-349" aria-hidden="true" tabindex="-1"></a>  <span class="do">## create placeholder for posterior moments </span></span>
<span id="cb11-350"><a href="#cb11-350" aria-hidden="true" tabindex="-1"></a>  mnt <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">dim</span>(mt)[<span class="dv">1</span>], <span class="at">ncol =</span> <span class="fu">dim</span>(mt)[<span class="dv">2</span>])</span>
<span id="cb11-351"><a href="#cb11-351" aria-hidden="true" tabindex="-1"></a>  Cnt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">dim</span>(Ct))</span>
<span id="cb11-352"><a href="#cb11-352" aria-hidden="true" tabindex="-1"></a>  fnt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb11-353"><a href="#cb11-353" aria-hidden="true" tabindex="-1"></a>  Qnt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb11-354"><a href="#cb11-354" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-355"><a href="#cb11-355" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> T<span class="sc">:</span><span class="dv">1</span>){</span>
<span id="cb11-356"><a href="#cb11-356" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> T){</span>
<span id="cb11-357"><a href="#cb11-357" aria-hidden="true" tabindex="-1"></a>      mnt[i, ] <span class="ot">&lt;-</span> mt[i, ]</span>
<span id="cb11-358"><a href="#cb11-358" aria-hidden="true" tabindex="-1"></a>      Cnt[, , i] <span class="ot">&lt;-</span> Ct[, , i]</span>
<span id="cb11-359"><a href="#cb11-359" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb11-360"><a href="#cb11-360" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb11-361"><a href="#cb11-361" aria-hidden="true" tabindex="-1"></a>        inv_Rtp1 <span class="ot">&lt;-</span> <span class="fu">chol2inv</span>(<span class="fu">chol</span>(Rt[, , i<span class="sc">+</span><span class="dv">1</span>]))</span>
<span id="cb11-362"><a href="#cb11-362" aria-hidden="true" tabindex="-1"></a>        Bt <span class="ot">&lt;-</span> Ct[, , i] <span class="sc">%*%</span> <span class="fu">t</span>(Gt[, , i<span class="sc">+</span><span class="dv">1</span>]) <span class="sc">%*%</span> inv_Rtp1</span>
<span id="cb11-363"><a href="#cb11-363" aria-hidden="true" tabindex="-1"></a>        mnt[i, ] <span class="ot">&lt;-</span> mt[i, ] <span class="sc">+</span> Bt <span class="sc">%*%</span> (mnt[i<span class="sc">+</span><span class="dv">1</span>, ] <span class="sc">-</span> at[i<span class="sc">+</span><span class="dv">1</span>, ])</span>
<span id="cb11-364"><a href="#cb11-364" aria-hidden="true" tabindex="-1"></a>        Cnt[, , i] <span class="ot">&lt;-</span> Ct[, , i] <span class="sc">+</span> Bt <span class="sc">%*%</span> (Cnt[, , i<span class="sc">+</span><span class="dv">1</span>] <span class="sc">-</span> </span>
<span id="cb11-365"><a href="#cb11-365" aria-hidden="true" tabindex="-1"></a>                                    Rt[, , i<span class="sc">+</span><span class="dv">1</span>]) <span class="sc">%*%</span> <span class="fu">t</span>(Bt)</span>
<span id="cb11-366"><a href="#cb11-366" aria-hidden="true" tabindex="-1"></a>        Cnt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Cnt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Cnt[,,i])</span>
<span id="cb11-367"><a href="#cb11-367" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb11-368"><a href="#cb11-368" aria-hidden="true" tabindex="-1"></a>        inv_Gt <span class="ot">&lt;-</span> <span class="fu">solve</span>(Gt[, , i<span class="sc">+</span><span class="dv">1</span>])</span>
<span id="cb11-369"><a href="#cb11-369" aria-hidden="true" tabindex="-1"></a>        mnt[i, ] <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">-</span>delta)<span class="sc">*</span>mt[i, ] <span class="sc">+</span> </span>
<span id="cb11-370"><a href="#cb11-370" aria-hidden="true" tabindex="-1"></a>                delta<span class="sc">*</span>inv_Gt <span class="sc">%*%</span> <span class="fu">t</span>(mnt[i<span class="sc">+</span><span class="dv">1</span>, ,<span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb11-371"><a href="#cb11-371" aria-hidden="true" tabindex="-1"></a>        Cnt[, , i] <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">-</span>delta)<span class="sc">*</span>Ct[, , i] <span class="sc">+</span> </span>
<span id="cb11-372"><a href="#cb11-372" aria-hidden="true" tabindex="-1"></a>                delta<span class="sc">^</span><span class="dv">2</span><span class="sc">*</span>inv_Gt <span class="sc">%*%</span> Cnt[, , i <span class="sc">+</span> <span class="dv">1</span>]  <span class="sc">%*%</span> <span class="fu">t</span>(inv_Gt)</span>
<span id="cb11-373"><a href="#cb11-373" aria-hidden="true" tabindex="-1"></a>        Cnt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Cnt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Cnt[,,i])</span>
<span id="cb11-374"><a href="#cb11-374" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb11-375"><a href="#cb11-375" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-376"><a href="#cb11-376" aria-hidden="true" tabindex="-1"></a>    fnt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , i]) <span class="sc">%*%</span> <span class="fu">t</span>(mnt[i, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb11-377"><a href="#cb11-377" aria-hidden="true" tabindex="-1"></a>    Qnt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , i]) <span class="sc">%*%</span> <span class="fu">t</span>(Cnt[, , i]) <span class="sc">%*%</span> Ft[, , i]</span>
<span id="cb11-378"><a href="#cb11-378" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-379"><a href="#cb11-379" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T){</span>
<span id="cb11-380"><a href="#cb11-380" aria-hidden="true" tabindex="-1"></a>     Cnt[,,i]<span class="ot">=</span>St[T]<span class="sc">*</span>Cnt[,,i]<span class="sc">/</span>St[i] </span>
<span id="cb11-381"><a href="#cb11-381" aria-hidden="true" tabindex="-1"></a>     Qnt[i]<span class="ot">=</span>St[T]<span class="sc">*</span>Qnt[i]<span class="sc">/</span>St[i]</span>
<span id="cb11-382"><a href="#cb11-382" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-383"><a href="#cb11-383" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Backward smoothing is completed!</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-384"><a href="#cb11-384" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mnt =</span> mnt, <span class="at">Cnt =</span> Cnt, <span class="at">fnt=</span>fnt, <span class="at">Qnt=</span>Qnt))</span>
<span id="cb11-385"><a href="#cb11-385" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-386"><a href="#cb11-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-387"><a href="#cb11-387" aria-hidden="true" tabindex="-1"></a><span class="do">## Forecast Distribution for k step</span></span>
<span id="cb11-388"><a href="#cb11-388" aria-hidden="true" tabindex="-1"></a>forecast_function_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(posterior_states, k, </span>
<span id="cb11-389"><a href="#cb11-389" aria-hidden="true" tabindex="-1"></a>                                        matrices, delta){</span>
<span id="cb11-390"><a href="#cb11-390" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-391"><a href="#cb11-391" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb11-392"><a href="#cb11-392" aria-hidden="true" tabindex="-1"></a>  Ft <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Ft</span>
<span id="cb11-393"><a href="#cb11-393" aria-hidden="true" tabindex="-1"></a>  Gt <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Gt</span>
<span id="cb11-394"><a href="#cb11-394" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb11-395"><a href="#cb11-395" aria-hidden="true" tabindex="-1"></a>    Wt_star <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Wt_star</span>
<span id="cb11-396"><a href="#cb11-396" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-397"><a href="#cb11-397" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-398"><a href="#cb11-398" aria-hidden="true" tabindex="-1"></a>  mt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>mt</span>
<span id="cb11-399"><a href="#cb11-399" aria-hidden="true" tabindex="-1"></a>  Ct <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>Ct</span>
<span id="cb11-400"><a href="#cb11-400" aria-hidden="true" tabindex="-1"></a>  St <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>St</span>
<span id="cb11-401"><a href="#cb11-401" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>at</span>
<span id="cb11-402"><a href="#cb11-402" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-403"><a href="#cb11-403" aria-hidden="true" tabindex="-1"></a>  <span class="do">## set up matrices</span></span>
<span id="cb11-404"><a href="#cb11-404" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> <span class="fu">dim</span>(mt)[<span class="dv">1</span>] <span class="co"># time points</span></span>
<span id="cb11-405"><a href="#cb11-405" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">dim</span>(mt)[<span class="dv">2</span>] <span class="co"># dimension of state parameter vector</span></span>
<span id="cb11-406"><a href="#cb11-406" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-407"><a href="#cb11-407" aria-hidden="true" tabindex="-1"></a>  <span class="do">## placeholder for results</span></span>
<span id="cb11-408"><a href="#cb11-408" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> k, <span class="at">ncol =</span> d)</span>
<span id="cb11-409"><a href="#cb11-409" aria-hidden="true" tabindex="-1"></a>  Rt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, k))</span>
<span id="cb11-410"><a href="#cb11-410" aria-hidden="true" tabindex="-1"></a>  ft <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k)</span>
<span id="cb11-411"><a href="#cb11-411" aria-hidden="true" tabindex="-1"></a>  Qt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k)</span>
<span id="cb11-412"><a href="#cb11-412" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-413"><a href="#cb11-413" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k){</span>
<span id="cb11-414"><a href="#cb11-414" aria-hidden="true" tabindex="-1"></a>    <span class="do">## moments of state distribution</span></span>
<span id="cb11-415"><a href="#cb11-415" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb11-416"><a href="#cb11-416" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> <span class="fu">t</span>(mt[T, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb11-417"><a href="#cb11-417" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb11-418"><a href="#cb11-418" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb11-419"><a href="#cb11-419" aria-hidden="true" tabindex="-1"></a>       Rt[, , i] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> Ct[, , T] <span class="sc">%*%</span> </span>
<span id="cb11-420"><a href="#cb11-420" aria-hidden="true" tabindex="-1"></a>         <span class="fu">t</span>(Gt[, , T<span class="sc">+</span>i]) <span class="sc">+</span> St[T]<span class="sc">*</span>Wt_star[, , T<span class="sc">+</span>i]</span>
<span id="cb11-421"><a href="#cb11-421" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb11-422"><a href="#cb11-422" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> Ct[, , T] <span class="sc">%*%</span> </span>
<span id="cb11-423"><a href="#cb11-423" aria-hidden="true" tabindex="-1"></a>          <span class="fu">t</span>(Gt[, , T<span class="sc">+</span>i])<span class="sc">/</span>delta</span>
<span id="cb11-424"><a href="#cb11-424" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb11-425"><a href="#cb11-425" aria-hidden="true" tabindex="-1"></a>      Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb11-426"><a href="#cb11-426" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb11-427"><a href="#cb11-427" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb11-428"><a href="#cb11-428" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> <span class="fu">t</span>(at[i<span class="dv">-1</span>, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb11-429"><a href="#cb11-429" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb11-430"><a href="#cb11-430" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> Rt[, , i<span class="dv">-1</span>] <span class="sc">%*%</span> </span>
<span id="cb11-431"><a href="#cb11-431" aria-hidden="true" tabindex="-1"></a>          <span class="fu">t</span>(Gt[, , T<span class="sc">+</span>i]) <span class="sc">+</span> St[T]<span class="sc">*</span>Wt_star[, , T <span class="sc">+</span> i]</span>
<span id="cb11-432"><a href="#cb11-432" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb11-433"><a href="#cb11-433" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> Rt[, , i<span class="dv">-1</span>] <span class="sc">%*%</span> </span>
<span id="cb11-434"><a href="#cb11-434" aria-hidden="true" tabindex="-1"></a>          <span class="fu">t</span>(Gt[, , T<span class="sc">+</span>i])<span class="sc">/</span>delta</span>
<span id="cb11-435"><a href="#cb11-435" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb11-436"><a href="#cb11-436" aria-hidden="true" tabindex="-1"></a>      Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb11-437"><a href="#cb11-437" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-438"><a href="#cb11-438" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-439"><a href="#cb11-439" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-440"><a href="#cb11-440" aria-hidden="true" tabindex="-1"></a>    <span class="do">## moments of forecast distribution</span></span>
<span id="cb11-441"><a href="#cb11-441" aria-hidden="true" tabindex="-1"></a>    ft[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , T<span class="sc">+</span>i]) <span class="sc">%*%</span> <span class="fu">t</span>(at[i, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb11-442"><a href="#cb11-442" aria-hidden="true" tabindex="-1"></a>    Qt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , T<span class="sc">+</span>i]) <span class="sc">%*%</span> Rt[, , i] <span class="sc">%*%</span> Ft[, , T<span class="sc">+</span>i] <span class="sc">+</span> </span>
<span id="cb11-443"><a href="#cb11-443" aria-hidden="true" tabindex="-1"></a>      St[T]</span>
<span id="cb11-444"><a href="#cb11-444" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-445"><a href="#cb11-445" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Forecasting is completed!</span><span class="sc">\n</span><span class="st">"</span>) <span class="co"># indicator of completion</span></span>
<span id="cb11-446"><a href="#cb11-446" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">at=</span>at, <span class="at">Rt=</span>Rt, <span class="at">ft=</span>ft, <span class="at">Qt=</span>Qt))</span>
<span id="cb11-447"><a href="#cb11-447" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-448"><a href="#cb11-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-449"><a href="#cb11-449" aria-hidden="true" tabindex="-1"></a><span class="do">## obtain 95% credible interval</span></span>
<span id="cb11-450"><a href="#cb11-450" aria-hidden="true" tabindex="-1"></a>get_credible_interval_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(ft, Qt, nt, </span>
<span id="cb11-451"><a href="#cb11-451" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">quantile =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)){</span>
<span id="cb11-452"><a href="#cb11-452" aria-hidden="true" tabindex="-1"></a>  bound <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span><span class="fu">length</span>(ft), <span class="at">ncol=</span><span class="dv">2</span>)</span>
<span id="cb11-453"><a href="#cb11-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-454"><a href="#cb11-454" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((<span class="fu">length</span>(nt)<span class="sc">==</span><span class="dv">1</span>)){</span>
<span id="cb11-455"><a href="#cb11-455" aria-hidden="true" tabindex="-1"></a>   <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(ft)){</span>
<span id="cb11-456"><a href="#cb11-456" aria-hidden="true" tabindex="-1"></a>      t_quantile <span class="ot">&lt;-</span> <span class="fu">qt</span>(quantile[<span class="dv">1</span>], <span class="at">df =</span> nt)</span>
<span id="cb11-457"><a href="#cb11-457" aria-hidden="true" tabindex="-1"></a>      bound[t, <span class="dv">1</span>] <span class="ot">&lt;-</span> ft[t] <span class="sc">+</span> t_quantile<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(Qt[t])) </span>
<span id="cb11-458"><a href="#cb11-458" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-459"><a href="#cb11-459" aria-hidden="true" tabindex="-1"></a>  <span class="co"># upper bound of 95% credible interval</span></span>
<span id="cb11-460"><a href="#cb11-460" aria-hidden="true" tabindex="-1"></a>      t_quantile <span class="ot">&lt;-</span> <span class="fu">qt</span>(quantile[<span class="dv">2</span>], <span class="at">df =</span> nt)</span>
<span id="cb11-461"><a href="#cb11-461" aria-hidden="true" tabindex="-1"></a>      bound[t, <span class="dv">2</span>] <span class="ot">&lt;-</span> ft[t] <span class="sc">+</span> </span>
<span id="cb11-462"><a href="#cb11-462" aria-hidden="true" tabindex="-1"></a>        t_quantile<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(Qt[t]))}</span>
<span id="cb11-463"><a href="#cb11-463" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb11-464"><a href="#cb11-464" aria-hidden="true" tabindex="-1"></a>  <span class="co"># lower bound of 95% credible interval</span></span>
<span id="cb11-465"><a href="#cb11-465" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(ft)){</span>
<span id="cb11-466"><a href="#cb11-466" aria-hidden="true" tabindex="-1"></a>      t_quantile <span class="ot">&lt;-</span> <span class="fu">qt</span>(quantile[<span class="dv">1</span>], <span class="at">df =</span> nt[t])</span>
<span id="cb11-467"><a href="#cb11-467" aria-hidden="true" tabindex="-1"></a>      bound[t, <span class="dv">1</span>] <span class="ot">&lt;-</span> ft[t] <span class="sc">+</span> </span>
<span id="cb11-468"><a href="#cb11-468" aria-hidden="true" tabindex="-1"></a>        t_quantile<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(Qt[t])) </span>
<span id="cb11-469"><a href="#cb11-469" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-470"><a href="#cb11-470" aria-hidden="true" tabindex="-1"></a>  <span class="co"># upper bound of 95% credible interval</span></span>
<span id="cb11-471"><a href="#cb11-471" aria-hidden="true" tabindex="-1"></a>      t_quantile <span class="ot">&lt;-</span> <span class="fu">qt</span>(quantile[<span class="dv">2</span>], <span class="at">df =</span> nt[t])</span>
<span id="cb11-472"><a href="#cb11-472" aria-hidden="true" tabindex="-1"></a>      bound[t, <span class="dv">2</span>] <span class="ot">&lt;-</span> ft[t] <span class="sc">+</span> </span>
<span id="cb11-473"><a href="#cb11-473" aria-hidden="true" tabindex="-1"></a>        t_quantile<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(Qt[t]))}</span>
<span id="cb11-474"><a href="#cb11-474" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-475"><a href="#cb11-475" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(bound)</span>
<span id="cb11-476"><a href="#cb11-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-477"><a href="#cb11-477" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-478"><a href="#cb11-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-479"><a href="#cb11-479" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-480"><a href="#cb11-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-481"><a href="#cb11-481" aria-hidden="true" tabindex="-1"></a><span class="fu">### Nile River Level Filtering Smoothing and Forecasting Example</span></span>
<span id="cb11-482"><a href="#cb11-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-485"><a href="#cb11-485" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb11-486"><a href="#cb11-486" aria-hidden="true" tabindex="-1"></a><span class="do">## Example: Nile River Level (in 10^8 m^3), 1871-1970 </span></span>
<span id="cb11-487"><a href="#cb11-487" aria-hidden="true" tabindex="-1"></a><span class="do">## Model: First order polynomial DLM</span></span>
<span id="cb11-488"><a href="#cb11-488" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(Nile) </span>
<span id="cb11-489"><a href="#cb11-489" aria-hidden="true" tabindex="-1"></a>n<span class="ot">=</span><span class="fu">length</span>(Nile) <span class="co">#n=100 observations </span></span>
<span id="cb11-490"><a href="#cb11-490" aria-hidden="true" tabindex="-1"></a>k<span class="ot">=</span><span class="dv">5</span></span>
<span id="cb11-491"><a href="#cb11-491" aria-hidden="true" tabindex="-1"></a>T<span class="ot">=</span>n<span class="sc">-</span>k</span>
<span id="cb11-492"><a href="#cb11-492" aria-hidden="true" tabindex="-1"></a>data_T<span class="ot">=</span>Nile[<span class="dv">1</span><span class="sc">:</span>T]</span>
<span id="cb11-493"><a href="#cb11-493" aria-hidden="true" tabindex="-1"></a>test_data<span class="ot">=</span>Nile[(T<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>n]</span>
<span id="cb11-494"><a href="#cb11-494" aria-hidden="true" tabindex="-1"></a>data<span class="ot">=</span><span class="fu">list</span>(<span class="at">yt =</span> data_T)</span>
<span id="cb11-495"><a href="#cb11-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-496"><a href="#cb11-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-497"><a href="#cb11-497" aria-hidden="true" tabindex="-1"></a><span class="do">## set up matrices for first order polynomial model </span></span>
<span id="cb11-498"><a href="#cb11-498" aria-hidden="true" tabindex="-1"></a>Ft<span class="ot">=</span><span class="fu">array</span>(<span class="dv">1</span>, <span class="at">dim =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, n))</span>
<span id="cb11-499"><a href="#cb11-499" aria-hidden="true" tabindex="-1"></a>Gt<span class="ot">=</span><span class="fu">array</span>(<span class="dv">1</span>, <span class="at">dim =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, n))</span>
<span id="cb11-500"><a href="#cb11-500" aria-hidden="true" tabindex="-1"></a>Wt_star<span class="ot">=</span><span class="fu">array</span>(<span class="dv">1</span>, <span class="at">dim =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, n))</span>
<span id="cb11-501"><a href="#cb11-501" aria-hidden="true" tabindex="-1"></a>m0<span class="ot">=</span><span class="fu">as.matrix</span>(<span class="dv">800</span>)</span>
<span id="cb11-502"><a href="#cb11-502" aria-hidden="true" tabindex="-1"></a>C0_star<span class="ot">=</span><span class="fu">as.matrix</span>(<span class="dv">10</span>)</span>
<span id="cb11-503"><a href="#cb11-503" aria-hidden="true" tabindex="-1"></a>n0<span class="ot">=</span><span class="dv">1</span></span>
<span id="cb11-504"><a href="#cb11-504" aria-hidden="true" tabindex="-1"></a>S0<span class="ot">=</span><span class="dv">10</span></span>
<span id="cb11-505"><a href="#cb11-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-506"><a href="#cb11-506" aria-hidden="true" tabindex="-1"></a><span class="do">## wrap up all matrices and initial values</span></span>
<span id="cb11-507"><a href="#cb11-507" aria-hidden="true" tabindex="-1"></a>matrices <span class="ot">=</span> <span class="fu">set_up_dlm_matrices_unknown_v</span>(Ft, Gt, Wt_star)</span>
<span id="cb11-508"><a href="#cb11-508" aria-hidden="true" tabindex="-1"></a>initial_states <span class="ot">=</span> <span class="fu">set_up_initial_states_unknown_v</span>(m0, </span>
<span id="cb11-509"><a href="#cb11-509" aria-hidden="true" tabindex="-1"></a>                                      C0_star, n0, S0)</span>
<span id="cb11-510"><a href="#cb11-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-511"><a href="#cb11-511" aria-hidden="true" tabindex="-1"></a><span class="do">## filtering </span></span>
<span id="cb11-512"><a href="#cb11-512" aria-hidden="true" tabindex="-1"></a>results_filtered <span class="ot">=</span> <span class="fu">forward_filter_unknown_v</span>(data, matrices, </span>
<span id="cb11-513"><a href="#cb11-513" aria-hidden="true" tabindex="-1"></a>                                            initial_states)</span>
<span id="cb11-514"><a href="#cb11-514" aria-hidden="true" tabindex="-1"></a>ci_filtered<span class="ot">=</span><span class="fu">get_credible_interval_unknown_v</span>(results_filtered<span class="sc">$</span>mt, </span>
<span id="cb11-515"><a href="#cb11-515" aria-hidden="true" tabindex="-1"></a>                                    results_filtered<span class="sc">$</span>Ct, </span>
<span id="cb11-516"><a href="#cb11-516" aria-hidden="true" tabindex="-1"></a>                                     results_filtered<span class="sc">$</span>nt)</span>
<span id="cb11-517"><a href="#cb11-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-518"><a href="#cb11-518" aria-hidden="true" tabindex="-1"></a><span class="do">## smoothing</span></span>
<span id="cb11-519"><a href="#cb11-519" aria-hidden="true" tabindex="-1"></a>results_smoothed<span class="ot">=</span><span class="fu">backward_smoothing_unknown_v</span>(data, matrices, </span>
<span id="cb11-520"><a href="#cb11-520" aria-hidden="true" tabindex="-1"></a>                                             results_filtered)</span>
<span id="cb11-521"><a href="#cb11-521" aria-hidden="true" tabindex="-1"></a>ci_smoothed<span class="ot">=</span><span class="fu">get_credible_interval_unknown_v</span>(results_smoothed<span class="sc">$</span>mnt, </span>
<span id="cb11-522"><a href="#cb11-522" aria-hidden="true" tabindex="-1"></a>                                         results_smoothed<span class="sc">$</span>Cnt, </span>
<span id="cb11-523"><a href="#cb11-523" aria-hidden="true" tabindex="-1"></a>                                         results_filtered<span class="sc">$</span>nt[T])</span>
<span id="cb11-524"><a href="#cb11-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-525"><a href="#cb11-525" aria-hidden="true" tabindex="-1"></a><span class="do">## one-step ahead forecasting</span></span>
<span id="cb11-526"><a href="#cb11-526" aria-hidden="true" tabindex="-1"></a>results_forecast<span class="ot">=</span><span class="fu">forecast_function_unknown_v</span>(results_filtered, </span>
<span id="cb11-527"><a href="#cb11-527" aria-hidden="true" tabindex="-1"></a>                                                k,  matrices)</span>
<span id="cb11-528"><a href="#cb11-528" aria-hidden="true" tabindex="-1"></a>ci_forecast<span class="ot">=</span><span class="fu">get_credible_interval_unknown_v</span>(results_forecast<span class="sc">$</span>ft, </span>
<span id="cb11-529"><a href="#cb11-529" aria-hidden="true" tabindex="-1"></a>                                          results_forecast<span class="sc">$</span>Qt, </span>
<span id="cb11-530"><a href="#cb11-530" aria-hidden="true" tabindex="-1"></a>                                     results_filtered<span class="sc">$</span>nt[T])</span>
<span id="cb11-531"><a href="#cb11-531" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-532"><a href="#cb11-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-535"><a href="#cb11-535" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb11-536"><a href="#cb11-536" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-NDLM-unknown-variance-nile-data</span></span>
<span id="cb11-537"><a href="#cb11-537" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Nile River Level Filtering, Smoothing and Forecasting Results</span></span>
<span id="cb11-538"><a href="#cb11-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-539"><a href="#cb11-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-540"><a href="#cb11-540" aria-hidden="true" tabindex="-1"></a><span class="do">## plot results</span></span>
<span id="cb11-541"><a href="#cb11-541" aria-hidden="true" tabindex="-1"></a>index<span class="ot">=</span><span class="fu">seq</span>(<span class="dv">1871</span>, <span class="dv">1970</span>, <span class="at">length.out =</span> <span class="fu">length</span>(Nile))</span>
<span id="cb11-542"><a href="#cb11-542" aria-hidden="true" tabindex="-1"></a>index_filt<span class="ot">=</span>index[<span class="dv">1</span><span class="sc">:</span>T]</span>
<span id="cb11-543"><a href="#cb11-543" aria-hidden="true" tabindex="-1"></a>index_forecast<span class="ot">=</span>index[(T<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(T<span class="sc">+</span>k)]</span>
<span id="cb11-544"><a href="#cb11-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-545"><a href="#cb11-545" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(index, Nile, <span class="at">main =</span> <span class="st">"Nile River Level "</span>,<span class="at">type=</span><span class="st">'l'</span>,</span>
<span id="cb11-546"><a href="#cb11-546" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"time"</span>,<span class="at">ylab=</span><span class="st">"feet"</span>,<span class="at">lty=</span><span class="dv">3</span>,<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">400</span>,<span class="dv">1500</span>))</span>
<span id="cb11-547"><a href="#cb11-547" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(index,Nile,<span class="at">pch=</span><span class="dv">20</span>)</span>
<span id="cb11-548"><a href="#cb11-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-549"><a href="#cb11-549" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt,results_filtered<span class="sc">$</span>mt, <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'red'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb11-550"><a href="#cb11-550" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt,ci_filtered[, <span class="dv">1</span>], <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'red'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb11-551"><a href="#cb11-551" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt,ci_filtered[, <span class="dv">2</span>], <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'red'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb11-552"><a href="#cb11-552" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt,results_smoothed<span class="sc">$</span>mnt, <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'blue'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb11-553"><a href="#cb11-553" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, ci_smoothed[, <span class="dv">1</span>], <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'blue'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb11-554"><a href="#cb11-554" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, ci_smoothed[, <span class="dv">2</span>], <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'blue'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb11-555"><a href="#cb11-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-556"><a href="#cb11-556" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_forecast, results_forecast<span class="sc">$</span>ft, <span class="at">type=</span><span class="st">'l'</span>, </span>
<span id="cb11-557"><a href="#cb11-557" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'green'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb11-558"><a href="#cb11-558" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_forecast, ci_forecast[, <span class="dv">1</span>], <span class="at">type=</span><span class="st">'l'</span>, </span>
<span id="cb11-559"><a href="#cb11-559" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'green'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb11-560"><a href="#cb11-560" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_forecast, ci_forecast[, <span class="dv">2</span>], <span class="at">type=</span><span class="st">'l'</span>, </span>
<span id="cb11-561"><a href="#cb11-561" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'green'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb11-562"><a href="#cb11-562" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topright"</span>,</span>
<span id="cb11-563"><a href="#cb11-563" aria-hidden="true" tabindex="-1"></a>       <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"Observed"</span>, <span class="st">"Filtered mean"</span>, <span class="st">"Filtered CI"</span>, </span>
<span id="cb11-564"><a href="#cb11-564" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"Smoothed mean"</span>, <span class="st">"Smoothed CI"</span>, </span>
<span id="cb11-565"><a href="#cb11-565" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"Forecast mean"</span>, <span class="st">"Forecast CI"</span>),</span>
<span id="cb11-566"><a href="#cb11-566" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"red"</span>, <span class="st">"red"</span>, <span class="st">"blue"</span>, <span class="st">"blue"</span>, <span class="st">"green"</span>, <span class="st">"green"</span>),</span>
<span id="cb11-567"><a href="#cb11-567" aria-hidden="true" tabindex="-1"></a>       <span class="at">lty =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>),</span>
<span id="cb11-568"><a href="#cb11-568" aria-hidden="true" tabindex="-1"></a>       <span class="at">pch =</span> <span class="fu">c</span>(<span class="dv">20</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>),</span>
<span id="cb11-569"><a href="#cb11-569" aria-hidden="true" tabindex="-1"></a>       <span class="at">lwd =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>),</span>
<span id="cb11-570"><a href="#cb11-570" aria-hidden="true" tabindex="-1"></a>       <span class="at">bty =</span> <span class="st">"n"</span>,</span>
<span id="cb11-571"><a href="#cb11-571" aria-hidden="true" tabindex="-1"></a>       <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb11-572"><a href="#cb11-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-573"><a href="#cb11-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-574"><a href="#cb11-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-575"><a href="#cb11-575" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-576"><a href="#cb11-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-577"><a href="#cb11-577" aria-hidden="true" tabindex="-1"></a>::: {.callout-note collapse="false"}</span>
<span id="cb11-578"><a href="#cb11-578" aria-hidden="true" tabindex="-1"></a><span class="fu">## Overthinking the Nile River Data {.unnumbered}</span></span>
<span id="cb11-579"><a href="#cb11-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-580"><a href="#cb11-580" aria-hidden="true" tabindex="-1"></a>We use the Nile dataset throughout the course, despite the Nile data being notorious for having long term dependencies and being highly non-linear, which might present many challenges for the NDLM framework. c.f. the joint work of two giants <span class="co">[</span><span class="ot">Benoit Mandelbrot</span><span class="co">](https://en.wikipedia.org/wiki/Benoit_Mandelbrot)</span> and <span class="co">[</span><span class="ot">Harold Edwin Hurst</span><span class="co">](https://en.wikipedia.org/wiki/Harold_Edwin_Hurst)</span>.</span>
<span id="cb11-581"><a href="#cb11-581" aria-hidden="true" tabindex="-1"></a>Which led to the development of the Hurst exponent and the <span class="co">[</span><span class="ot">fractional Brownian motion</span><span class="co">](https://en.wikipedia.org/wiki/Fractional_Brownian_motion)</span>, i.e. fractional Gaussian noise and fractional ARIMA <span class="co">[</span><span class="ot">ARFIMA</span><span class="co">](https://en.wikipedia.org/wiki/Autoregressive_fractionally_integrated_moving_average)</span> which are more suitable for modeling the Nile data but not covered in this course.</span>
<span id="cb11-582"><a href="#cb11-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-583"><a href="#cb11-583" aria-hidden="true" tabindex="-1"></a>Just a couple of concepts here:</span>
<span id="cb11-584"><a href="#cb11-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-585"><a href="#cb11-585" aria-hidden="true" tabindex="-1"></a>In Fractional Brownian Motion (fBm) draws from the Normal need not be independent. With the concept of Hurst exponent $H$ which is a measure of the long-term memory of a time series. The Hurst exponent is defined as follows:</span>
<span id="cb11-586"><a href="#cb11-586" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb11-587"><a href="#cb11-587" aria-hidden="true" tabindex="-1"></a>\mathbb{E}<span class="co">[</span><span class="ot">B_{H}(t)B_{H}(s)</span><span class="co">]</span>={\tfrac {1}{2}}(|t|^{2H}+|s|^{2H}-|t-s|^{2H}),</span>
<span id="cb11-588"><a href="#cb11-588" aria-hidden="true" tabindex="-1"></a>$$ {#eq-fbm-autocovariance}</span>
<span id="cb11-589"><a href="#cb11-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-590"><a href="#cb11-590" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>where:</span>
<span id="cb11-591"><a href="#cb11-591" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>$B_{H}(t)$ is the fractional Brownian motion, and</span>
<span id="cb11-592"><a href="#cb11-592" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>$H$ is the Hurst exponent.</span>
<span id="cb11-593"><a href="#cb11-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-594"><a href="#cb11-594" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>in ARFIMA, the autocovariance we allow the exponent of the lag $k$ to be a real number $d$ rather than an integer, i.e. we allow for fractional differencing via a formal binomial series expansion of the form:</span>
<span id="cb11-595"><a href="#cb11-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-596"><a href="#cb11-596" aria-hidden="true" tabindex="-1"></a>$$\begin{array}{c} {\displaystyle {\begin{aligned}(1-B)^{d}&amp;=\sum _{k=0}^{\infty }\;{d \choose k}\;(-B)^{k}<span class="sc">\\</span>&amp;=\sum _{k=0}^{\infty }\;{\frac {\prod _{a=0}^{k-1}(d-a)\ (-B)^{k}}{k!}}<span class="sc">\\</span>&amp;=1-dB+{\frac {d(d-1)}{2!}}B^{2}-\cdots \,.\end{aligned}}} \end{array}</span>
<span id="cb11-597"><a href="#cb11-597" aria-hidden="true" tabindex="-1"></a>$$ {#eq-ARFIMA}</span>
<span id="cb11-598"><a href="#cb11-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-599"><a href="#cb11-599" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb11-600"><a href="#cb11-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-601"><a href="#cb11-601" aria-hidden="true" tabindex="-1"></a><span class="fu">## Case Study EEG data  :movie_camera:   {#section-NDLM-eeg}</span></span>
<span id="cb11-602"><a href="#cb11-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-603"><a href="#cb11-603" aria-hidden="true" tabindex="-1"></a>::: {.callout-note collapse="true"}</span>
<span id="cb11-604"><a href="#cb11-604" aria-hidden="true" tabindex="-1"></a><span class="fu">## Video Transcript</span></span>
<span id="cb11-605"><a href="#cb11-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-606"><a href="#cb11-606" aria-hidden="true" tabindex="-1"></a>{{&lt; include transcripts/c4/04_week-4-normal-dynamic-linear-models-part-ii/03_case-studies/01_eeg-data.en.txt &gt;}}</span>
<span id="cb11-607"><a href="#cb11-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-608"><a href="#cb11-608" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb11-609"><a href="#cb11-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-610"><a href="#cb11-610" aria-hidden="true" tabindex="-1"></a><span class="fu">## Case Study: Google Trends  :movie_camera:  {#section-NDLM-google-trends}</span></span>
<span id="cb11-611"><a href="#cb11-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-612"><a href="#cb11-612" aria-hidden="true" tabindex="-1"></a>::: {.callout-note collapse="true"}</span>
<span id="cb11-613"><a href="#cb11-613" aria-hidden="true" tabindex="-1"></a><span class="fu">## Video Transcript</span></span>
<span id="cb11-614"><a href="#cb11-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-615"><a href="#cb11-615" aria-hidden="true" tabindex="-1"></a>{{&lt; include transcripts/c4/04_week-4-normal-dynamic-linear-models-part-ii/03_case-studies/02_google-trends.en.txt &gt;}}</span>
<span id="cb11-616"><a href="#cb11-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-617"><a href="#cb11-617" aria-hidden="true" tabindex="-1"></a>:::</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Copyright 2025, Oren Bochman</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>
<script>var lightboxQuarto = GLightbox({"closeEffect":"fade","descPosition":"bottom","loop":true,"openEffect":"fade","selector":".lightbox","skin":"my-css-class"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>