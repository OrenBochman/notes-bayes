<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.11">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Oren Bochman">
<meta name="dcterms.date" content="2024-10-26">
<meta name="keywords" content="Time series, Filtering, Smoothing, NDLM, Normal Dynamic Linear Models, Seasonal NDLM, Superposition Principle, R code">
<meta name="description" content="Normal Dynamic Linear Models (NDLMs) are a class of models used for time series analysis that allow for flexible modeling of temporal dependencies.">

<title>Normal Dynamic Linear Models, Part 2 – Bayesian Statistics</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-279bd408c6dfe7bd56e8b154fe269440.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-923206e44a13b4518db4dede9f4ebdc9.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-279bd408c6dfe7bd56e8b154fe269440.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-37379e3bbb48fc9e4c504b22bdb22879.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-e12ace95bce8268b44b48d9ebb190a16.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-37379e3bbb48fc9e4c504b22bdb22879.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>

      .quarto-title-block .quarto-title-banner {
        background-image: url(images/banner_deep.jpg);
background-size: cover;
      }
</style>

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css">

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar docked slimcontent quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const queryPrefersDark = window.matchMedia('(prefers-color-scheme: dark)');
    const darkModeDefault = queryPrefersDark.matches;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    queryPrefersDark.addEventListener("change", e => {
      if(window.localStorage.getItem("quarto-color-scheme") !== null)
        return;
      const alternate = e.matches
      toggleColorMode(alternate);
      localAlternateSentinel = e.matches ? 'alternate' : 'default'; // this is used alongside local storage!
      toggleGiscusIfUsed(alternate, darkModeDefault);
    });
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./C4-L00.html">4. Time series Models</a></li><li class="breadcrumb-item"><a href="./C4-L04.html">Normal Dynamic Linear Models, Part 2</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./C4-L00.html">4. Time series Models</a></li><li class="breadcrumb-item"><a href="./C4-L04.html">Normal Dynamic Linear Models, Part 2</a></li></ol></nav>
      <div class="quarto-title-block"><div><h1 class="title">Normal Dynamic Linear Models, Part 2</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
            <p class="subtitle lead">Time Series Analysis</p>
                  <div>
        <div class="description">
          Normal Dynamic Linear Models (NDLMs) are a class of models used for time series analysis that allow for flexible modeling of temporal dependencies.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Bayesian Statistics</div>
                <div class="quarto-category">Time Series</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Oren Bochman </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">October 26, 2024</p>
      </div>
    </div>
    
      
    </div>
    

  <div>
    <div class="keywords">
      <div class="block-title">Keywords</div>
      <p>Time series, Filtering, Smoothing, NDLM, Normal Dynamic Linear Models, Seasonal NDLM, Superposition Principle, R code</p>
    </div>
  </div>
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Bayesian Statistics</a> 
        <div class="sidebar-tools-main">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Intro</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./about.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction to Bayesian Statistics</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">1. From Concept to Data Analysis</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Probability</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L01-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework on paradigms of probability</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayes’ Theorem</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L02-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Conditional Probability and Bayes’ Law</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L02-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Conditional Probability and Bayes’ Law</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Distributions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L03-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework on Random Variables</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L03-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework on Distributions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Frequentist Inference</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L04-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework - Frequentist MLE</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Inference</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L05-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework on Likelihoods and MLEs</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L05-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework on Bayesian Inference</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Priors</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L06-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework Posterior Probabilities</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L07.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Binomial Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L07-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework on Priors</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L08.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Poisson Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L08-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework on Poisson Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L08-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Honors Quiz - Beta Bernoulli</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L09.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Exponential Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L09-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework exponential data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Normally distributed Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L10-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework Normal data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Non-Informative Priors</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L11-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework Alternative Priors</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Brief Review of Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L12-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">—</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L12-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Honnors Homework On Regression</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">2. Techniques and Models</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Statistical Modeling and Monte Carlo estimation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Modeling</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Monte Carlo estimation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Metropolis-Hastings</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L04-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework on the Metropolis-Hastings algorithm</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Gibbs sampling</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L05-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">HW - Gibbs-Sampling algorithm</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Assessing Convergence</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L06-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework on the Gibbs-Sampling algorithm</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L06-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Honnors Homework on M-H algorithm</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L07.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Notes - Linear regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L07-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">HW on Linear Regression Model Part 1</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L07-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">HW - Deviance information criterion (DIC)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L08.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ANOVA</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L08-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">HW on ANOVA</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L08-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">HW+ - Multiple Factor ANOVA</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L09.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Logistic regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L09-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework on Logistic Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Poisson regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L10-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework on Poisson regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Hierarchical modeling</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L11-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework on Hierarchical Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L11-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework on Non-Normal Hierarchical Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Capstone Project</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L12-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework on Predictive distributions and mixture models</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">3. Mixture Models</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Basic Concepts of Mixture Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L01-Ex1-Basic-Definitions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Basic Concepts of Mixture Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L01-Ex2-Gaussian-mixtures.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Mixtures of Gaussians</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L01-Ex3-Zero-Inflated-distribution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Definition of Mixture Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L01-Ex4-Def-mixture-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Zero inflated distributions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L01-Ex5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Basic Concepts of Mixture Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L01-Ex6.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Basic Concepts of Mixture Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">The EM algorithm for zero-inflated mixtures</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L02-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">The EM algorithm for Zero-Inflated Mixtures</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L02-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">The EM algorithm for Mixture Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">MCMC for Mixture Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L03-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">The MCMC algorithm for Zero-Inflated Mixtures</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L03-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Markov chain Monte Carlo algorithms for Mixture Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Applications of Mixture Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L04-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Old Faithful eruptions density estimation with the EM algorithm</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L04-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Old Faithful eruptions density estimation with the MCMC algorithms</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L04-Ex3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Mixture Models for Classification of Banknotes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Practical Considerations</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L05-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Computational considerations for Mixture Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L05-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Information Criteria (BIC)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L05-Ex3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Estimating the number of components in Bayesian settings</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L05-Ex4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Estimating the partition structure in Bayesian models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L05-Ex5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">The MCMC algorithm for Zero-Inflated Mixtures</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">4. Time series Models</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C4-L00.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 0: Introductions to time series analysis and the AR(1) process</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C4-L01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introductions to Time Series analysis &amp; the AR(1) process</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C4-L02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">The AR(p) process</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C4-L03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Normal Dynamic Linear Models, Part 1</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C4-L04.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Normal Dynamic Linear Models, Part 2</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C4-L05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Final Project</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C4-L06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 0: Feyman Notebook on Bayesian Time Series Analysis</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">5. Capstone Project</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
 <span class="menu-text">C5-L01.qmd</span>
  </li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true">
 <span class="menu-text">6. Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Appendix: Notation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Appendix: Discrete Distributions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Appendix: Continuous Distributions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Appendix: Exponents &amp; Logarithms</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A07.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Appendix: The Law of Large Numbers</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A08.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Appendix: The Central Limit Theorem</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A09.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Appendix: Conjugate Priors</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Appendix: Link Function</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayes by backprop</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Books in R &amp; Python</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./summary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Summary</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#seasonal-ndlms" id="toc-seasonal-ndlms" class="nav-link active" data-scroll-target="#seasonal-ndlms"><span class="header-section-number">0.1</span> Seasonal NDLMs</a></li>
  <li><a href="#fourier-representation-video" id="toc-fourier-representation-video" class="nav-link" data-scroll-target="#fourier-representation-video"><span class="header-section-number">0.2</span> Fourier representation (Video)</a></li>
  <li><a href="#fourier-representation-example-1-reading" id="toc-fourier-representation-example-1-reading" class="nav-link" data-scroll-target="#fourier-representation-example-1-reading"><span class="header-section-number">0.3</span> Fourier Representation: Example 1 (Reading)</a>
  <ul class="collapse">
  <li><a href="#seasonal-models" id="toc-seasonal-models" class="nav-link" data-scroll-target="#seasonal-models"><span class="header-section-number">0.3.1</span> Seasonal Models</a></li>
  </ul></li>
  <li><a href="#building-ndlms-with-multiple-components-examples-video" id="toc-building-ndlms-with-multiple-components-examples-video" class="nav-link" data-scroll-target="#building-ndlms-with-multiple-components-examples-video"><span class="header-section-number">0.4</span> Building NDLMs with multiple components: Examples (Video)</a></li>
  <li><a href="#summary-dlm-fourier-representation-reading" id="toc-summary-dlm-fourier-representation-reading" class="nav-link" data-scroll-target="#summary-dlm-fourier-representation-reading"><span class="header-section-number">0.5</span> Summary: DLM Fourier representation (Reading)</a>
  <ul class="collapse">
  <li><a href="#seasonal-models-fourier-representation" id="toc-seasonal-models-fourier-representation" class="nav-link" data-scroll-target="#seasonal-models-fourier-representation"><span class="header-section-number">0.5.1</span> Seasonal Models: Fourier Representation</a></li>
  <li><a href="#case-p-2m---1-odd" id="toc-case-p-2m---1-odd" class="nav-link" data-scroll-target="#case-p-2m---1-odd"><span class="header-section-number">0.5.2</span> Case: <span class="math inline">p = 2m - 1</span> (odd)</a></li>
  <li><a href="#case-p-2m-even" id="toc-case-p-2m-even" class="nav-link" data-scroll-target="#case-p-2m-even"><span class="header-section-number">0.5.3</span> Case: <span class="math inline">p = 2m</span> (even)</a></li>
  </ul></li>
  <li><a href="#examples" id="toc-examples" class="nav-link" data-scroll-target="#examples"><span class="header-section-number">0.6</span> Examples</a>
  <ul class="collapse">
  <li><a href="#fourier-representation-p-12" id="toc-fourier-representation-p-12" class="nav-link" data-scroll-target="#fourier-representation-p-12"><span class="header-section-number">0.6.1</span> Fourier Representation, <span class="math inline">p = 12</span>:</a></li>
  <li><a href="#linear-trend-seasonal-component-with-p-4" id="toc-linear-trend-seasonal-component-with-p-4" class="nav-link" data-scroll-target="#linear-trend-seasonal-component-with-p-4"><span class="header-section-number">0.6.2</span> Linear Trend + Seasonal Component with <span class="math inline">p = 4</span></a></li>
  </ul></li>
  <li><a href="#quiz-seasonal-models-and-superposition" id="toc-quiz-seasonal-models-and-superposition" class="nav-link" data-scroll-target="#quiz-seasonal-models-and-superposition"><span class="header-section-number">0.7</span> Quiz: Seasonal Models and Superposition</a></li>
  <li><a href="#bayesian-inference-in-the-ndlm-part-2" id="toc-bayesian-inference-in-the-ndlm-part-2" class="nav-link" data-scroll-target="#bayesian-inference-in-the-ndlm-part-2"><span class="header-section-number">1</span> Bayesian Inference in the NDLM: Part 2</a>
  <ul class="collapse">
  <li><a href="#filtering-smoothing-and-forecasting-unknown-observational-variance-video" id="toc-filtering-smoothing-and-forecasting-unknown-observational-variance-video" class="nav-link" data-scroll-target="#filtering-smoothing-and-forecasting-unknown-observational-variance-video"><span class="header-section-number">1.1</span> Filtering, Smoothing and Forecasting: Unknown observational variance (Video)</a>
  <ul class="collapse">
  <li><a href="#filtering" id="toc-filtering" class="nav-link" data-scroll-target="#filtering"><span class="header-section-number">1.1.1</span> Filtering</a></li>
  </ul></li>
  <li><a href="#summary-of-filtering-smoothing-and-forecasting-distributions-ndlm-unknown-observational-variance-reading" id="toc-summary-of-filtering-smoothing-and-forecasting-distributions-ndlm-unknown-observational-variance-reading" class="nav-link" data-scroll-target="#summary-of-filtering-smoothing-and-forecasting-distributions-ndlm-unknown-observational-variance-reading"><span class="header-section-number">1.2</span> Summary of Filtering, Smoothing and Forecasting Distributions, NDLM unknown observational variance (Reading)</a></li>
  <li><a href="#specifying-the-system-covariance-matrix-via-discount-factors-video" id="toc-specifying-the-system-covariance-matrix-via-discount-factors-video" class="nav-link" data-scroll-target="#specifying-the-system-covariance-matrix-via-discount-factors-video"><span class="header-section-number">1.3</span> Specifying the system covariance matrix via discount factors (Video)</a></li>
  <li><a href="#ndlm-unknown-observational-variance-example-video" id="toc-ndlm-unknown-observational-variance-example-video" class="nav-link" data-scroll-target="#ndlm-unknown-observational-variance-example-video"><span class="header-section-number">1.4</span> NDLM, Unknown Observational Variance: Example (Video)</a></li>
  <li><a href="#rcode-ndlm-unknown-observational-variance-example-reading" id="toc-rcode-ndlm-unknown-observational-variance-example-reading" class="nav-link" data-scroll-target="#rcode-ndlm-unknown-observational-variance-example-reading"><span class="header-section-number">1.5</span> Rcode: NDLM, Unknown Observational Variance Example (Reading)</a></li>
  <li><a href="#practice-graded-assignment-ndlm-data-analysis" id="toc-practice-graded-assignment-ndlm-data-analysis" class="nav-link" data-scroll-target="#practice-graded-assignment-ndlm-data-analysis"><span class="header-section-number">1.6</span> Practice Graded Assignment: NDLM data analysis</a>
  <ul class="collapse">
  <li><a href="#all-dlm-functions-unknown-v" id="toc-all-dlm-functions-unknown-v" class="nav-link" data-scroll-target="#all-dlm-functions-unknown-v"><span class="header-section-number">1.6.1</span> All dlm functions unknown v</a></li>
  <li><a href="#discount-factor-selection-functions" id="toc-discount-factor-selection-functions" class="nav-link" data-scroll-target="#discount-factor-selection-functions"><span class="header-section-number">1.6.2</span> Discount factor selection functions</a></li>
  <li><a href="#grading-criteria" id="toc-grading-criteria" class="nav-link" data-scroll-target="#grading-criteria"><span class="header-section-number">1.6.3</span> Grading Criteria</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#case-studies" id="toc-case-studies" class="nav-link" data-scroll-target="#case-studies"><span class="header-section-number">2</span> Case Studies</a>
  <ul class="collapse">
  <li><a href="#eeg-data" id="toc-eeg-data" class="nav-link" data-scroll-target="#eeg-data"><span class="header-section-number">2.1</span> EEG data</a></li>
  <li><a href="#google-trends" id="toc-google-trends" class="nav-link" data-scroll-target="#google-trends"><span class="header-section-number">2.2</span> Google Trends</a></li>
  </ul></li>
  <li><a href="#quiz---ndlm-part-ii" id="toc-quiz---ndlm-part-ii" class="nav-link" data-scroll-target="#quiz---ndlm-part-ii"><span class="header-section-number">3</span> Quiz - NDLM, Part II</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">






<section id="seasonal-ndlms" class="level2" data-number="0.1">
<h2 data-number="0.1" class="anchored" data-anchor-id="seasonal-ndlms"><span class="header-section-number">0.1</span> Seasonal NDLMs</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Learning Objectives
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul class="task-list">
<li><label><input type="checkbox">Use R for analysis and forecasting of time series using the NDLM (cases of known or unknown observational variance and unknown system variance specified using a discount factor)</label></li>
<li><label><input type="checkbox">Derive the equations to obtain posterior inference and forecasting in the NDLM with unknown observational variance and system variance specified via discount factors</label></li>
<li><label><input type="checkbox">Define seasonal NDLMs</label></li>
<li><label><input type="checkbox">Apply the NDLM superposition principle and explain the role of the forecast function</label></li>
</ul>
</div>
</div>
</div>
</section>
<section id="fourier-representation-video" class="level2 page-columns page-full" data-number="0.2">
<h2 data-number="0.2" class="anchored" data-anchor-id="fourier-representation-video"><span class="header-section-number">0.2</span> Fourier representation (Video)</h2>
<p>Transcript:</p>
<blockquote class="blockquote page-columns page-full">
<div class="page-columns page-full"><p>I will now describe <mark>how to incorporate seasonal components in a normal dynamic linear model</mark>. What we will do is we will first talk about the so-called single Fourier component representation . Just in case you have a single frequency and how to incorporate that single frequency in your model for the seasonality. Then using the superposition principle, you can incorporate several frequencies or a single frequency and the corresponding harmonics in your model.</p><div class="no-row-height column-margin column-container"><span class=""><strong>single Fourier component representation</strong></span></div></div>
<p>There are other seasonal representations as well <span class="cn">clarification needed</span>. We will focus on the Fourier representation as is is flexible without needing too many parameters. E.g. if you want to consider, a fundamental frequency but you don’t want all the harmonics of that frequency. The Fourier representation, if you happen to have a single frequency.</p>
<p>We will discuss two cases with different component representations:</p>
<ol type="1">
<li><span class="math inline">\omega \in (0,\pi)</span></li>
<li><span class="math inline">\omega = \pi \implies \{ 1,1,\cdot, \cdot\}</span></li>
</ol>
<p>In the case of any frequency <span class="math inline">\omega \in (0,\pi)</span>, we will have a DLM that has this structure:</p>
</blockquote>
<p><span id="eq-fourier-1"><span class="math display">\{ \underbrace {E_2}_{F},  \underbrace {J_2(1,\omega)}_{G}, \underbrace{\cdot}_{v_t}, \underbrace{\cdot}_{W_t}\}
\tag{1}</span></span></p>
<p>We will have the <span class="math inline">F</span> vector the 2-dimensional vector: <span id="eq-fourier-2"><span class="math display">
E_2=(1,0)'
\tag{2}</span></span></p>
<p>As usual and the <span class="math inline">G</span> matrix will be the 2 by 2 matrix:</p>
<p><span id="eq-fourier-3"><span class="math display">
J_2(1, \omega) =
\begin{pmatrix}
\cos(\omega) &amp; \sin(\omega) \\
-\sin(\omega) &amp; \cos(\omega)
\end{pmatrix},
\tag{3}</span></span></p>
<p>where <span class="math inline">\omega</span> is the frequency that we are considering.</p>
<p>Since this is a 2 by 2 matrix the our state parameter vector will also be a vector of dimension 2.</p>
<p>If we think about the forecast function, <span class="math inline">f_t(h)</span> h-steps ahead, (you are at time <span class="math inline">t</span> and you want to look for <span class="math inline">h</span> steps ahead).</p>
<p>Let’s recall: the way we work with this is <span class="math inline">F* G^h * a_t</span></p>
<p>going to be your <span class="math inline">E_2'</span>, then you have to take this G matrix, which is just this <span class="math inline">J_2(1,\omega)^h</span>, and then you have a vector, I’m going to call <span class="math inline">a_t</span> and <span class="math inline">b_t</span>, which is just going to be this vector value of your Theta t vector given the information up to the time t. It’s going to have two components, I’m just going to generically call them <span class="math inline">a_t</span> and <span class="math inline">b_t</span>. When you take this to the power of h using just trigonometric results, you’re going to get that <span class="math inline">J_2(1,\omega)^h</span>, is just going to give you cosine of Omega h sine of Omega h minus sine of Omega h cosine of Omega h. When you look at this expression, you get something that looks like this, and then you have, again, times these <span class="math inline">a_t</span>, <span class="math inline">b_t</span>.</p>
<p><span id="eq-seasonal-forecast-function"><span class="math display">
\begin{aligned}
f_t(h) &amp;= E_2' [J_2(1, \omega)]^h \underbrace{\begin{pmatrix} a_t \\ b_t \end{pmatrix}}_{\mathbb{E}[\theta\mid \mathcal{D}]} \\
&amp;= (1,0) \begin{pmatrix} \cos(\omega h) &amp; \sin(\omega h) \\ -\sin(\omega h) &amp; \cos(\omega h) \end{pmatrix} \begin{pmatrix} a_t \\ b_t \end{pmatrix} \\
&amp;= a_t \cos(\omega h) + b_t \sin(\omega h) \\
&amp;= A_t \cos(\omega h + B_t).
\end{aligned}
\tag{4}</span></span></p>
<blockquote class="blockquote">
<p>You’re going to have the cosine and sine only multiplied by this. In the end, you’re going to have something that looks like this.</p>
<p>You have this sinusoidal form with the period Omega in your forecast function. You can also write this down in terms of an amplitude that I’m going to call A_t and then a phase that is B_t. Here again, you have your periodicity that appears in this cosine wave. This is again for the case in which you have a single frequency and the frequencies in this range. There was a second case that I mentioned, and that case is the case in which the Omega is exactly Pi. In this case, your Fourier representation is going to be your model that has a state vector that is just one dimensional. In the case where Omega is between zero and Pi, you have a two-dimensional state, vector here you’re going to have a one-dimensional state vector.</p>
<p>This is going to be your <span class="math inline">F</span> and your <span class="math inline">G</span>. Then you have again whatever you want to put here as your <span class="math inline">v_t</span> and <span class="math inline">W_t</span>. This gives me, if I think about the forecast function, h steps ahead is just going to be something that has the form <span class="math inline">-1^h \times a_t</span>. Now I have a single component here, is uni-dimensional. This is going to have an oscillatory behavior between <span class="math inline">a_t</span> and <span class="math inline">-a_t</span> if I were to look <span class="math inline">h</span> steps ahead forward when I’m at time <span class="math inline">t</span>. These two forms give me the single component Fourier representation and using the superposition principle, we will see that we can combine a single frequency and the corresponding harmonics or several different frequencies just using the superposition principle in the normal dynamic linear model. You can also incorporate more than one component in a full Fourier representation. Usually the way this works is you have a fundamental period, let’s say p.&nbsp;For example, if you are recording monthly data, p could be 12 and then you are going to incorporate in the model the fundamental frequency, and then all the harmonics that go with that fundamental frequency related to the period p.</p>
</blockquote>

<div class="no-row-height column-margin column-container"><div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="images/m4_0001.png" class="lightbox" data-gallery="slides" title="slide 1"><img src="images/m4_0001.png" class="img-fluid figure-img" width="200" alt="slide 1"></a></p>
<figcaption>slide 1</figcaption>
</figure>
</div></div><blockquote class="blockquote">
<p>Here <span class="math inline">p</span>, is the period and in this case, we are going to discuss essentially two different situations. One is when p is an odd number, the other one is when p is an even number. Let’s begin with the case of p is odd and in this particular scenario, we can write down p as 2 times m minus 1 for some value of m. This gives me a period that is odd. How many frequencies I’m going to incorporate in this model? I’m going to be able to write down <span class="math inline">\omega_j = 2 \pi \times j / p</span>, which is the fundamental period. j here goes from one all the way to m minus 1. Now we can use the superposition principle thinking we have a component DLM representation for each of these frequencies. They are all going to be between 0 and Pi. For each of them I’m going to have that two-dimensional DLM representation in terms of the state vector and then I can use the superposition principle to concatenate them all and get a model that has all these frequencies, the one related to the fundamental period and all the harmonics for that. Again, if I think about what is my <span class="math inline">F</span> and my <span class="math inline">G</span> here, I’m not writing down the t because both F and G are going to be constant over time. So my <span class="math inline">F</span> is going to be again, I concatenate as many <span class="math inline">E_2</span> as I have frequencies in here. I’m going to have <span class="math inline">E_2</span> transpose and so on and I’m going to have m minus one of those. Times 2 gives me the dimension of <span class="math inline">\theta_t</span>. The vector here is 2 times m minus 1 dimensional vector.</p>
<p>My G is going to have that block diagonal structure where we are going to just have all those <span class="math inline">J_{2,1} \omega_1</span>, all the way down to the last harmonic. Each of these blocks is a two-by-two matrix and I’m going to put them together in a block diagonal form. This gives me the representation when the period is odd, what is the structure of the forecast function? Again, using the superposition principle, the forecast function is going to be just the sum of m minus 1 components, where each of those components is going to have an individual forecast function that has that cosine wave representation that we discussed before. Again, if I think about the forecast function at time t h steps ahead, I will be able to write it down like this.</p>
<p>This should be a B. <span class="math inline">B_{t,j}</span>. Again here, I have an amplitude for each of the components and a phase for each of the components so it depends on time but does not depend on h. The h enters here, and this is my forecast function. In the case of P even the situation is slightly different. But again, it’s the same in terms of using the superposition principle. In this case, we can write down P as 2 times m because it’s an even number. Now I can write down these Omega j’s as a function of the fundamental period. Again, this goes from 1 up to m minus 1. But there is a last frequency here. When j is equal to m, this simplifies to be the <strong>Nyquist frequency</strong>. In this case, I have my Omega is equal to Pi. In this particular case, when I concatenate everything, I’m going to have again an F and a G that look like this. Once again, I concatenate all of these up to the component m minus 1. Then I have this 1 for the last frequency. Then my G is going to be the block diagonal.</p>
<p>For the last frequency I have that minus 1. This determines the dimension of the state vector, in this case I’m going to have 2 times m minus 1 plus 1.</p>
<p>My f function, my forecast function, is again a function of the number of steps ahead. I’m going to have the same structure I had before for the m minus 1 components. Then I have to add one more component that corresponds to the frequency Pi. This one appears with the power of h. As you can see, I’m using once again the superposition principle to go from component representation to the full Fourier representation. In practice, once we set the period, we can use a model that has the fundamental period and all the harmonics related to that fundamental period. We could also use, discard some of those harmonics and use a subset of them. This is one of the things that the Fourier representation allows. It allows you to be flexible in terms of how many components you want to add in this model. There are other representations that are also used in practice. One of them is the seasonal factors representation. In that case, you’re going to have a model in which the state vector has dimension p for a given period. It uses a G matrix that is a permutation matrix. There is a correspondence between this parameterization using the Fourier representation and that other parameterization. If you want to use that parameterization, the way to interpret the components of this state vector, since you have P of those, is going to be a representation in terms of factors. For example, if you think about monthly data, you will have the say January factor, February factor, March factor, and so on. You could think about those effects and do a correspondence with this particular model. We will always work in this class with these representations because it’s more flexible. But again, you can go back and forth between one and the other.</p>
</blockquote>

<div class="no-row-height column-margin column-container"><div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="images/m4_0002.png" class="lightbox" data-gallery="slides" title="slide 2"><img src="images/m4_0002.png" class="img-fluid figure-img" width="200" alt="slide 2"></a></p>
<figcaption>slide 2</figcaption>
</figure>
</div></div></section>
<section id="fourier-representation-example-1-reading" class="level2" data-number="0.3">
<h2 data-number="0.3" class="anchored" data-anchor-id="fourier-representation-example-1-reading"><span class="header-section-number">0.3</span> Fourier Representation: Example 1 (Reading)</h2>
<section id="seasonal-models" class="level3" data-number="0.3.1">
<h3 data-number="0.3.1" class="anchored" data-anchor-id="seasonal-models"><span class="header-section-number">0.3.1</span> Seasonal Models</h3>
<p>Example: Full Fourier Model with <span class="math inline">p=5</span></p>
<p>In this case the Fourier frequencies are</p>
<ul>
<li><span class="math inline">ω_1 = 2π/5</span> and</li>
<li><span class="math inline">ω_2 = 4π/5</span> and so</li>
<li><span class="math inline">p = 2 × 3 − 1</span>. Then,</li>
<li><span class="math inline">m = 3</span> and</li>
<li><span class="math inline">\theta_t = (\theta_{t,1}, \ldots , \theta_{t,4})′</span>,</li>
<li><span class="math inline">F = (1, 0, 1, 0)</span>,</li>
<li><span class="math inline">G</span> is given by:</li>
</ul>
<p><span class="math display">
G = \begin{bmatrix}
\cos(2\pi/5) &amp; \sin(2\pi/5) &amp; 0 &amp; 0 \\
\cos(4\pi/5) &amp; \sin(4\pi/5) &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; \cos(2\pi/5) &amp; \sin(2\pi/5) \\
0 &amp; 0 &amp; \cos(4\pi/5) &amp; \sin(4\pi/5) \\
0 &amp; 0 &amp; 0 &amp; 0
\end{bmatrix}
</span></p>
<p>and the forecast function is:</p>
<p><span id="eq-forecast-function"><span class="math display">
f_t(h) = A_{t,1} \cos(2\pi h/5 + \gamma_t) + A_{t,2} \cos(4\pi h /5 + \gamma_{t,2}) \qquad
\tag{5}</span></span></p>
</section>
</section>
<section id="building-ndlms-with-multiple-components-examples-video" class="level2 page-columns page-full" data-number="0.4">
<h2 data-number="0.4" class="anchored" data-anchor-id="building-ndlms-with-multiple-components-examples-video"><span class="header-section-number">0.4</span> Building NDLMs with multiple components: Examples (Video)</h2>

<div class="no-row-height column-margin column-container"><div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="images/m4_0011.png" class="lightbox" data-gallery="slides" title="two component model"><img src="images/m4_0011.png" class="img-fluid figure-img" width="200" alt="two component model"></a></p>
<figcaption>two component model</figcaption>
</figure>
</div></div><blockquote class="blockquote">
<p><mark>In this second example, we are going to have two components; a linear trend plus a seasonal component where the fundamental period is four. The way to build this model, again, is using the superposition principle.</mark></p>
<p>First we need to think “what <em>structure</em> do we need, to get a <em>linear trend</em> in the <strong>forecast function</strong>?”</p>
<p>The linear trend is a linear function on the number of steps ahead.</p>
<p>Whenever you have that structure, you will get a DLM that is the so-called <strong>polynomial model of order 2</strong>. So let’s discuss first the linear. Let’s say the linear trend part, and in this case, we have an <span class="math inline">F</span> and a <span class="math inline">G</span>, I’m going to call them 1, <span class="math inline">F_1</span> and <span class="math inline">G_1</span> to denote that this is the first component in the model.</p>
<p><span class="math inline">F_1</span> is just going to be 1, 0 transpose, and the <span class="math inline">G_1</span> is that upper triangular matrix, it’s a 2 by 2 matrix that has 1, 1 in the first row, 0, 1 in the second row, so this gives me a linear trend.</p>
<p>My forecast function, let’s call it <span class="math inline">f_{1,t}</span> in terms of the number of steps ahead is just a linear function on h, is a linear polynomial order 1. Let’s say it’s a constant of <span class="math inline">K</span> but depends on t0 plus <span class="math inline">K_{t_1}^h</span>. This is the structure of the first component. Then I have to think about the seasonal component with period of four. If we are going to incorporate all the harmonics, we have to think again, is this an even period or a not period? In this example, this is an even period. I can write p, which is 4, as 2 times 2, so this gives me that m. I’m going to have one frequency, the first one, Omega 1, is related to the fundamental period of 4, so is 2 Pi over 4, which I can simplify and write down this as Pi over 2. This is the first frequency. The last one is going to correspond to the Nyquist.</p>
<p>We could obtain that doing 4Pi over 4, which is just Pi. As you remember, this component is going to require a two-dimensional DLM component model, this one is going to require a one-dimensional DLM component model in terms of the dimension here is the dimension of the state vectors. When we build this concatenating these components, we are going to have, again, let’s call it F_2 and G_2 for this particular component. I had called this here a, let’s call this b. My F_2 has that E_2 transpose and a 1, which gives me just 1, 0, 1. My G matrix is going to be a 3 by 3 matrix. The first component is</p>
<p>the component associated to that fundamental period. It’s a block diagonal again, and I’m going to have that J_2, 1 Omega 1, and then I have my minus 1 here. What this means is if I write this down as a matrix, let me write it here, G_2 is going to be cosine of that Pi halves,</p>
<p>and then I have zeros here, I have my minus 1 here, 0, and 0. I can further simplify these to have this structure. The cosine of Pi halves is 0, the sine is 1, so I can write this down as 0, 1, 0, minus 1, 0, 0, and 0, 0 minus 1. Now if I want to go back to just having a model that has both components, I use the superposition principle again and combine this component with this component. The linear plus seasonal</p>
<p>is a model that is going to have the representation <span class="math inline">F</span>, <span class="math inline">G</span>, with <span class="math inline">F</span> is going to be just concatenate <span class="math inline">F_1</span> and <span class="math inline">F_2</span>. <span class="math inline">G</span> now has that block diagonal form again.</p>
<p>If I look at what I have, I have this block that is a 2 by 2, this block that is a 3 by 3. Therefore my model is going to be a five-dimensional model in terms of the state parameter vector, so this G is a 5 by 5, and this one is also a five-dimensional vector. Finally, if I think about the forecast function in this case, if I call here the forecast function <span class="math inline">f_{2,t}</span> for the component that is seasonal, I’m going to have my A_t1 cosine of Pi halves h plus <span class="math inline">B_{t,1}</span>, and then I have my <span class="math inline">A_{t,2}</span> minus 1^h. My forecast function for the final model is going to be just the sum of these two components.</p>
<p>You can see how I can now put together all these blocks, so I have a block that is seasonal and a block that is a linear polynomial model, and I can put them together in a single model just to create a more flexible structure. You could add regression components, you could add autoregressive components and put together as many components as you need for the forecast function to have the form that you expect it to have. All of these models are using, again, the superposition principle and the fact that we’re working with a linear and Gaussian structure in terms of doing the posterior inference later.</p>
</blockquote>
</section>
<section id="summary-dlm-fourier-representation-reading" class="level2" data-number="0.5">
<h2 data-number="0.5" class="anchored" data-anchor-id="summary-dlm-fourier-representation-reading"><span class="header-section-number">0.5</span> Summary: DLM Fourier representation (Reading)</h2>
<section id="seasonal-models-fourier-representation" class="level3" data-number="0.5.1">
<h3 data-number="0.5.1" class="anchored" data-anchor-id="seasonal-models-fourier-representation"><span class="header-section-number">0.5.1</span> Seasonal Models: Fourier Representation</h3>
<p>For any frequency <span class="math inline">\omega \in (0, \pi)</span>, a model of the form <span class="math inline">\{E_2, J_2(1, \omega), \cdot, \cdot\}</span> with a 2-dimensional state vector <span class="math inline">\theta_t = (\theta_{t,1}, \theta_{t,2})'</span> and</p>
<p><span class="math display">
J_2(1, \omega) =
\begin{pmatrix}
\cos(\omega) &amp; \sin(\omega) \\
-\sin(\omega) &amp; \cos(\omega)
\end{pmatrix},
</span></p>
<p>has a forecast function</p>
<p><span class="math display">
\begin{aligned}
f_t(h) &amp;= (1, 0) J_2^h(1, \omega) (a_t, b_t) \\
       &amp;= a_t \cos(\omega h) + b_t \sin(\omega h) \\
       &amp;= A_t \cos(\omega h + B_t).
\end{aligned}
</span></p>
<p>For <span class="math inline">\omega = \pi</span>, the NDLM is <span class="math inline">\{1, -1, \cdot, \cdot\}</span> and has a forecast function of the form</p>
<p><span class="math display">
f_t(h) = (-1)^h m_t
</span></p>
<p>These are component Fourier models. Now, for a given period <span class="math inline">p</span>, we can build a model that contains components for the fundamental period and all the harmonics of such a period using the superposition principle as follows:</p>
</section>
<section id="case-p-2m---1-odd" class="level3" data-number="0.5.2">
<h3 data-number="0.5.2" class="anchored" data-anchor-id="case-p-2m---1-odd"><span class="header-section-number">0.5.2</span> Case: <span class="math inline">p = 2m - 1</span> (odd)</h3>
<p>Let <span class="math inline">\omega_j = 2\pi j / p</span> for <span class="math inline">j = 1 : (m - 1)</span>, <span class="math inline">F</span> a <span class="math inline">(p - 1)</span>-dimensional vector, or equivalently, a <span class="math inline">2(m - 1)</span>-dimensional vector, and <span class="math inline">G</span> a <span class="math inline">(p - 1) \times (p - 1)</span> matrix with <span class="math inline">F = (E_2', E_2', \dots, E_2')'</span>,</p>
<p><span class="math display">
G = \text{blockdiag}[J_2(1, \omega_1), \dots, J_2(1, \omega_{m-1})].
</span></p>
</section>
<section id="case-p-2m-even" class="level3" data-number="0.5.3">
<h3 data-number="0.5.3" class="anchored" data-anchor-id="case-p-2m-even"><span class="header-section-number">0.5.3</span> Case: <span class="math inline">p = 2m</span> (even)</h3>
<p>In this case, <span class="math inline">F</span> is again a <span class="math inline">(p - 1)</span>-dimensional vector (or equivalently a <span class="math inline">(2m - 1)</span>-dimensional vector), and <span class="math inline">G</span> is a <span class="math inline">(p - 1) \times (p - 1)</span> matrix such that <span class="math inline">F = (E_2', \dots, E_2', 1)'</span> and</p>
<p><span class="math display">
G = \text{blockdiag}[J_2(1, \omega_1), \dots, J_2(1, \omega_{m-1}), -1].
</span></p>
<p>In both cases, the forecast function has the general form:</p>
<p><span class="math display">
f_t(h) = \sum_{j=1}^{m-1} A_{t,j} \cos(\omega_j h + \gamma_{t,j}) + (-1)^h A_{t,m},
</span></p>
<p>with <span class="math inline">A_{t,m} = 0</span> if <span class="math inline">p</span> is odd.</p>
</section>
</section>
<section id="examples" class="level2" data-number="0.6">
<h2 data-number="0.6" class="anchored" data-anchor-id="examples"><span class="header-section-number">0.6</span> Examples</h2>
<section id="fourier-representation-p-12" class="level3" data-number="0.6.1">
<h3 data-number="0.6.1" class="anchored" data-anchor-id="fourier-representation-p-12"><span class="header-section-number">0.6.1</span> Fourier Representation, <span class="math inline">p = 12</span>:</h3>
<p>In this case, <span class="math inline">p = 2 \times 6</span> so <span class="math inline">\theta_t</span> is an 11-dimensional state vector,</p>
<p><span class="math display">
F = (1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1)',
</span></p>
<p>the Fourier frequencies are <span class="math inline">\omega_1 = 2\pi/12</span>, <span class="math inline">\omega_2 = 4\pi/12 = 2\pi/6</span>, <span class="math inline">\omega_3 = 6\pi/12 = 2\pi/4</span>, <span class="math inline">\omega_4 = 8\pi/12 = 2\pi/3</span>, <span class="math inline">\omega_5 = 10\pi/12 = 5\pi/6</span>, and <span class="math inline">\omega_6 = 12\pi/12 = \pi</span> (the Nyquist frequency).</p>
<p><span class="math display">
G = \text{blockdiag}(J_2(1, \omega_1), \dots, J_2(1, \omega_5), 1)
</span></p>
<p>and the forecast function is given by:</p>
<p><span class="math display">
f_t(h) = \sum_{j=1}^{5} A_{t,j} \cos(2\pi j / 12 + \gamma_{t,j}) + (-1)^h A_{t,6}.
</span></p>
</section>
<section id="linear-trend-seasonal-component-with-p-4" class="level3" data-number="0.6.2">
<h3 data-number="0.6.2" class="anchored" data-anchor-id="linear-trend-seasonal-component-with-p-4"><span class="header-section-number">0.6.2</span> Linear Trend + Seasonal Component with <span class="math inline">p = 4</span></h3>
<p>We can use the superposition principle to build more sophisticated models. For instance, assume that we want a model with the following 2 components:</p>
<ul>
<li><strong>Linear trend</strong>: <span class="math inline">\{F_1, G_1, \cdot, \cdot\}</span> with <span class="math inline">F_1 = (1, 0)'</span>,</li>
</ul>
<p><span class="math display">
G_1 = J_2(1) =
\begin{pmatrix}
1 &amp; 1 \\
0 &amp; 1
\end{pmatrix}.
</span></p>
<ul>
<li><strong>Full seasonal model with <span class="math inline">p = 4</span></strong>: <span class="math inline">\{F_2, G_2, \cdot, \cdot\}</span>, <span class="math inline">p = 2 \times 2</span> so <span class="math inline">m = 2</span> and <span class="math inline">\omega = 2\pi / 4 = \pi / 2</span>,</li>
</ul>
<p><span class="math display">
F_2 = (1, 0, 1)',
</span></p>
<p>and</p>
<p><span class="math display">
G_2 =
\begin{pmatrix}
\cos(\pi / 2) &amp; \sin(\pi / 2) &amp; 0 \\
-\sin(\pi / 2) &amp; \cos(\pi / 2) &amp; 0 \\
0 &amp; 0 &amp; -1
\end{pmatrix}
=
\begin{pmatrix}
0 &amp; 1 &amp; 0 \\
-1 &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; -1
\end{pmatrix}.
</span></p>
<p>The resulting DLM is a 5-dimensional model <span class="math inline">\{F, G, \cdot, \cdot\}</span> with</p>
<p><span class="math display">
F = (1, 0, 1, 0, 1)',
</span></p>
<p>and</p>
<p><span class="math display">
G =
\begin{pmatrix}
1 &amp; 1 &amp; 0 &amp; 0 &amp; 0 \\
0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; 0 &amp; 1 &amp; 0 \\
0 &amp; 0 &amp; -1 &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; 0 &amp; 0 &amp; -1
\end{pmatrix}.
</span></p>
<p>The forecast function is:</p>
<p><span class="math display">
f_t(h) = (k_{t,1} + k_{t,2} h) + k_{t,3} \cos(\pi h / 2) + k_{t,4} \sin(\pi h / 2) + k_{t,5} (-1)^h.
</span></p>
</section>
</section>
<section id="quiz-seasonal-models-and-superposition" class="level2" data-number="0.7">
<h2 data-number="0.7" class="anchored" data-anchor-id="quiz-seasonal-models-and-superposition"><span class="header-section-number">0.7</span> Quiz: Seasonal Models and Superposition</h2>
<p>This is omitted due to the Coursera honor code.</p>
</section>
<section id="bayesian-inference-in-the-ndlm-part-2" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Bayesian Inference in the NDLM: Part 2</h1>
<section id="filtering-smoothing-and-forecasting-unknown-observational-variance-video" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="filtering-smoothing-and-forecasting-unknown-observational-variance-video"><span class="header-section-number">1.1</span> Filtering, Smoothing and Forecasting: Unknown observational variance (Video)</h2>
<p>In this video we cover the following material aslo provided as a handout:</p>
<p>Inference in the NDLM with unknown but constant observational variance:</p>
<p>Let <span class="math inline">v_t = v</span> for all <span class="math inline">t</span>, with <span class="math inline">v</span> unknown and consider a DLM with the following structure: <span id="eq-NDLM-unknown-variance"><span class="math display">
\begin{aligned}
y_t &amp;= \mathbf{F}_t' \mathbf{\theta}_t + \nu_t, &amp;\nu_t &amp;\sim N (0, v)\\
\mathbf{\theta}_t &amp;= \mathbf{G}_t \mathbf{\theta}_{t-1} + \mathbf{\omega}_t, &amp; \mathbf{\omega}_t &amp;\sim N (0, v \mathbf{W}^*_t)
\end{aligned}
\tag{6}</span></span></p>
<p>with conjugate prior distributions: <span id="eq-NDLM-unknown-variance-priors"><span class="math display">
(\mathbf{\theta}_0 \mid D_0, v) \sim N (\mathbf{m}_0, v\mathbf{C}^*_0), \qquad (v \mid D_0) \sim IG(\frac{n_0}{2}, \frac{d_0}{2}),
\tag{7}</span></span> and <span class="math inline">d_0 = n_0s_0</span></p>
<section id="filtering" class="level3" data-number="1.1.1">
<h3 data-number="1.1.1" class="anchored" data-anchor-id="filtering"><span class="header-section-number">1.1.1</span> Filtering</h3>
<p>Assuming <span class="math inline">(\theta_{t-1} \mid D_{t-1}, v) \sim N (m_{t-1}, vC^*_{t-1})</span>, we have the following results:</p>
<ul>
<li><p><span class="math inline">(\theta_t \mid D_{t-1}, v) \sim N (a_t, vR^*_t)</span> with <span class="math inline">a_t = G_t m_{t-1}</span> and <span class="math inline">R^*_t = G_t C^*_{t-1} G'_t + W^*_t</span>, and unconditional on <span class="math inline">v</span>, <span class="math inline">(\theta_t \mid D_{t-1}) \sim T_{n_{t-1}} (a_t, R_t)</span>, with <span class="math inline">R_t = s_{t-1} R^*_t</span>. The expression for <span class="math inline">s_t</span> for all <span class="math inline">t</span> is given below.</p></li>
<li><p><span class="math inline">(y_t \mid D_{t-1}, v) \sim N (f_t, vq^*_t)</span>, with <span class="math inline">f_t = F'_t a_t</span>, and <span class="math inline">q^*_t = (1 + F'_t R^*_t F_t)</span> and unconditional on <span class="math inline">v</span> we have <span class="math inline">(y_t \mid D_{t-1}) \sim T_{n_{t-1}} (f_t, q_t)</span>, with <span class="math inline">q_t = s_{t-1} q^*_t</span>.</p></li>
<li><p><span class="math inline">(v \mid D_t) \sim IG(n_t/2, s_t/2)</span>, with <span class="math inline">n_t = n_{t-1} + 1</span> and <span id="eq-NDLM-unknown-variance-filtering"><span class="math display">
s_t = s_{t-1} + \frac{s_{t-1}}{n_t} \left ( \frac{e^2_t}{q^*_t} - 1 \right ),
\tag{8}</span></span></p>
<p>where <span class="math inline">e_t = y_t - f_t</span></p></li>
<li><p>θt|Dt, v) ∼ N (mt, vC∗ t ), with mt = at + Atet, and C∗ t = R∗ t − AtA′ tq∗ t . Similarly, unconditional on v we have (θt|Dt) ∼ Tnt (mt, Ct), with Ct = stC∗ t</p></li>
</ul>
</section>
</section>
<section id="summary-of-filtering-smoothing-and-forecasting-distributions-ndlm-unknown-observational-variance-reading" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="summary-of-filtering-smoothing-and-forecasting-distributions-ndlm-unknown-observational-variance-reading"><span class="header-section-number">1.2</span> Summary of Filtering, Smoothing and Forecasting Distributions, NDLM unknown observational variance (Reading)</h2>
</section>
<section id="specifying-the-system-covariance-matrix-via-discount-factors-video" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="specifying-the-system-covariance-matrix-via-discount-factors-video"><span class="header-section-number">1.3</span> Specifying the system covariance matrix via discount factors (Video)</h2>
</section>
<section id="ndlm-unknown-observational-variance-example-video" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="ndlm-unknown-observational-variance-example-video"><span class="header-section-number">1.4</span> NDLM, Unknown Observational Variance: Example (Video)</h2>
<p>This is a walk though of the R code for the example bellow.</p>
</section>
<section id="rcode-ndlm-unknown-observational-variance-example-reading" class="level2" data-number="1.5">
<h2 data-number="1.5" class="anchored" data-anchor-id="rcode-ndlm-unknown-observational-variance-example-reading"><span class="header-section-number">1.5</span> Rcode: NDLM, Unknown Observational Variance Example (Reading)</h2>
<p>This code allows time-varying <span class="math inline">F_t</span>, <span class="math inline">G_t</span> and <span class="math inline">W_t</span> matrices and assumes an unknown but constant <span class="math inline">\nu</span>. It also allows the user to specify <span class="math inline">W_t</span> using a discount factor <span class="math inline">\delta \in (0,1]</span> or assume <span class="math inline">W_t</span> known.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="do">## create list for matrices</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>set_up_dlm_matrices_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(Ft, Gt, Wt_star){</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.array</span>(Gt)){</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Stop</span>(<span class="st">"Gt and Ft should be array"</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">missing</span>(Wt_star)){</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">Ft=</span>Ft, <span class="at">Gt=</span>Gt))</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">Ft=</span>Ft, <span class="at">Gt=</span>Gt, <span class="at">Wt_star=</span>Wt_star))</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="do">## create list for initial states</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>set_up_initial_states_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(m0, C0_star, n0, S0){</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">m0=</span>m0, <span class="at">C0_star=</span>C0_star, <span class="at">n0=</span>n0, <span class="at">S0=</span>S0))</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>forward_filter_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(data, matrices, </span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>                              initial_states, delta){</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve dataset</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  yt <span class="ot">&lt;-</span> data<span class="sc">$</span>yt</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>  T<span class="ot">&lt;-</span> <span class="fu">length</span>(yt)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>  Ft <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Ft</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>  Gt <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Gt</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    Wt_star <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Wt_star</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve initial state</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>  m0 <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>m0</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>  C0_star <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>C0_star</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>  n0 <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>n0</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>  S0 <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>S0</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>  C0 <span class="ot">&lt;-</span> S0<span class="sc">*</span>C0_star</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>  <span class="do">## create placeholder for results</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">dim</span>(Gt)[<span class="dv">1</span>]</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span>T, <span class="at">ncol=</span>d)</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>  Rt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, T))</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>  ft <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>  Qt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>  mt <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span>T, <span class="at">ncol=</span>d)</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>  Ct <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, T))</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>  et <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>  nt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>  St <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># moments of priors at t</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T){</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> Gt[, , i] <span class="sc">%*%</span> m0</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>      Pt <span class="ot">&lt;-</span> Gt[, , i] <span class="sc">%*%</span> C0 <span class="sc">%*%</span> <span class="fu">t</span>(Gt[, , i])</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>      Pt <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Pt <span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Pt)</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>        Wt <span class="ot">&lt;-</span> Wt_star[, , i]<span class="sc">*</span>S0</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Pt <span class="sc">+</span> Wt</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>        Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Pt<span class="sc">/</span>delta</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>        Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> Gt[, , i] <span class="sc">%*%</span> <span class="fu">t</span>(mt[i<span class="dv">-1</span>, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>      Pt <span class="ot">&lt;-</span> Gt[, , i] <span class="sc">%*%</span> Ct[, , i<span class="dv">-1</span>] <span class="sc">%*%</span> <span class="fu">t</span>(Gt[, , i])</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>        Wt <span class="ot">&lt;-</span> Wt_star[, , i] <span class="sc">*</span> St[i<span class="dv">-1</span>]</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Pt <span class="sc">+</span> Wt</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>        Rt[,,i]<span class="ot">=</span><span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Pt<span class="sc">/</span>delta</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>        Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments of one-step forecast:</span></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>    ft[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , i]) <span class="sc">%*%</span> <span class="fu">t</span>(at[i, , <span class="at">drop=</span><span class="cn">FALSE</span>]) </span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>    Qt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , i]) <span class="sc">%*%</span> Rt[, , i] <span class="sc">%*%</span> Ft[, , i] <span class="sc">+</span> </span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(i<span class="sc">==</span><span class="dv">1</span>, S0, St[i<span class="dv">-1</span>])</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>    et[i] <span class="ot">&lt;-</span> yt[i] <span class="sc">-</span> ft[i]</span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>    nt[i] <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(i<span class="sc">==</span><span class="dv">1</span>, n0, nt[i<span class="dv">-1</span>]) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>    St[i] <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(i<span class="sc">==</span><span class="dv">1</span>, S0, </span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>                    St[i<span class="dv">-1</span>])<span class="sc">*</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>nt[i]<span class="sc">*</span>(et[i]<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span>Qt[i]<span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments of posterior at t:</span></span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>    At <span class="ot">&lt;-</span> Rt[, , i] <span class="sc">%*%</span> Ft[, , i] <span class="sc">/</span> Qt[i]</span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>    mt[i, ] <span class="ot">&lt;-</span> at[i, ] <span class="sc">+</span> <span class="fu">t</span>(At) <span class="sc">*</span> et[i]</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>    Ct[, , i] <span class="ot">&lt;-</span> St[i]<span class="sc">/</span><span class="fu">ifelse</span>(i<span class="sc">==</span><span class="dv">1</span>, S0, </span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>                  St[i<span class="dv">-1</span>])<span class="sc">*</span>(Rt[, , i] <span class="sc">-</span> Qt[i] <span class="sc">*</span> At <span class="sc">%*%</span> <span class="fu">t</span>(At))</span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>    Ct[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Ct[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Ct[,,i])</span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Forward filtering is completed!</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mt =</span> mt, <span class="at">Ct =</span> Ct,  <span class="at">at =</span> at, <span class="at">Rt =</span> Rt, </span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>              <span class="at">ft =</span> ft, <span class="at">Qt =</span> Qt,  <span class="at">et =</span> et, </span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>              <span class="at">nt =</span> nt, <span class="at">St =</span> St))</span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a><span class="do">### smoothing function </span><span class="al">###</span></span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>backward_smoothing_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(data, matrices, </span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>                                posterior_states,delta){</span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve data </span></span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>  yt <span class="ot">&lt;-</span> data<span class="sc">$</span>yt</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> <span class="fu">length</span>(yt) </span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>  Ft <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Ft</span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>  Gt <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Gt</span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>  mt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>mt</span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>  Ct <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>Ct</span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>  Rt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>Rt</span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>  nt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>nt</span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>  St <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>St</span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>at</span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a>  <span class="do">## create placeholder for posterior moments </span></span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a>  mnt <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">dim</span>(mt)[<span class="dv">1</span>], <span class="at">ncol =</span> <span class="fu">dim</span>(mt)[<span class="dv">2</span>])</span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>  Cnt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">dim</span>(Ct))</span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a>  fnt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a>  Qnt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> T<span class="sc">:</span><span class="dv">1</span>){</span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> T){</span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a>      mnt[i, ] <span class="ot">&lt;-</span> mt[i, ]</span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a>      Cnt[, , i] <span class="ot">&lt;-</span> Ct[, , i]</span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a>        inv_Rtp1 <span class="ot">&lt;-</span> <span class="fu">chol2inv</span>(<span class="fu">chol</span>(Rt[, , i<span class="sc">+</span><span class="dv">1</span>]))</span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a>        Bt <span class="ot">&lt;-</span> Ct[, , i] <span class="sc">%*%</span> <span class="fu">t</span>(Gt[, , i<span class="sc">+</span><span class="dv">1</span>]) <span class="sc">%*%</span> inv_Rtp1</span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a>        mnt[i, ] <span class="ot">&lt;-</span> mt[i, ] <span class="sc">+</span> Bt <span class="sc">%*%</span> (mnt[i<span class="sc">+</span><span class="dv">1</span>, ] <span class="sc">-</span> at[i<span class="sc">+</span><span class="dv">1</span>, ])</span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a>        Cnt[, , i] <span class="ot">&lt;-</span> Ct[, , i] <span class="sc">+</span> Bt <span class="sc">%*%</span> (Cnt[, , i<span class="sc">+</span><span class="dv">1</span>] <span class="sc">-</span> </span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a>                                    Rt[, , i<span class="sc">+</span><span class="dv">1</span>]) <span class="sc">%*%</span> <span class="fu">t</span>(Bt)</span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a>        Cnt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Cnt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Cnt[,,i])</span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true" tabindex="-1"></a>        inv_Gt <span class="ot">&lt;-</span> <span class="fu">solve</span>(Gt[, , i<span class="sc">+</span><span class="dv">1</span>])</span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true" tabindex="-1"></a>        mnt[i, ] <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">-</span>delta)<span class="sc">*</span>mt[i, ] <span class="sc">+</span> </span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true" tabindex="-1"></a>                delta<span class="sc">*</span>inv_Gt <span class="sc">%*%</span> <span class="fu">t</span>(mnt[i<span class="sc">+</span><span class="dv">1</span>, ,<span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true" tabindex="-1"></a>        Cnt[, , i] <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">-</span>delta)<span class="sc">*</span>Ct[, , i] <span class="sc">+</span> </span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true" tabindex="-1"></a>                delta<span class="sc">^</span><span class="dv">2</span><span class="sc">*</span>inv_Gt <span class="sc">%*%</span> Cnt[, , i <span class="sc">+</span> <span class="dv">1</span>]  <span class="sc">%*%</span> <span class="fu">t</span>(inv_Gt)</span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true" tabindex="-1"></a>        Cnt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Cnt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Cnt[,,i])</span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-150"><a href="#cb1-150" aria-hidden="true" tabindex="-1"></a>    fnt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , i]) <span class="sc">%*%</span> <span class="fu">t</span>(mnt[i, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb1-151"><a href="#cb1-151" aria-hidden="true" tabindex="-1"></a>    Qnt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , i]) <span class="sc">%*%</span> <span class="fu">t</span>(Cnt[, , i]) <span class="sc">%*%</span> Ft[, , i]</span>
<span id="cb1-152"><a href="#cb1-152" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-153"><a href="#cb1-153" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T){</span>
<span id="cb1-154"><a href="#cb1-154" aria-hidden="true" tabindex="-1"></a>     Cnt[,,i]<span class="ot">=</span>St[T]<span class="sc">*</span>Cnt[,,i]<span class="sc">/</span>St[i] </span>
<span id="cb1-155"><a href="#cb1-155" aria-hidden="true" tabindex="-1"></a>     Qnt[i]<span class="ot">=</span>St[T]<span class="sc">*</span>Qnt[i]<span class="sc">/</span>St[i]</span>
<span id="cb1-156"><a href="#cb1-156" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-157"><a href="#cb1-157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Backward smoothing is completed!</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb1-158"><a href="#cb1-158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mnt =</span> mnt, <span class="at">Cnt =</span> Cnt, <span class="at">fnt=</span>fnt, <span class="at">Qnt=</span>Qnt))</span>
<span id="cb1-159"><a href="#cb1-159" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-160"><a href="#cb1-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-161"><a href="#cb1-161" aria-hidden="true" tabindex="-1"></a><span class="do">## Forecast Distribution for k step</span></span>
<span id="cb1-162"><a href="#cb1-162" aria-hidden="true" tabindex="-1"></a>forecast_function_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(posterior_states, k, </span>
<span id="cb1-163"><a href="#cb1-163" aria-hidden="true" tabindex="-1"></a>                                        matrices, delta){</span>
<span id="cb1-164"><a href="#cb1-164" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-165"><a href="#cb1-165" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb1-166"><a href="#cb1-166" aria-hidden="true" tabindex="-1"></a>  Ft <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Ft</span>
<span id="cb1-167"><a href="#cb1-167" aria-hidden="true" tabindex="-1"></a>  Gt <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Gt</span>
<span id="cb1-168"><a href="#cb1-168" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb1-169"><a href="#cb1-169" aria-hidden="true" tabindex="-1"></a>    Wt_star <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Wt_star</span>
<span id="cb1-170"><a href="#cb1-170" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-171"><a href="#cb1-171" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-172"><a href="#cb1-172" aria-hidden="true" tabindex="-1"></a>  mt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>mt</span>
<span id="cb1-173"><a href="#cb1-173" aria-hidden="true" tabindex="-1"></a>  Ct <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>Ct</span>
<span id="cb1-174"><a href="#cb1-174" aria-hidden="true" tabindex="-1"></a>  St <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>St</span>
<span id="cb1-175"><a href="#cb1-175" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>at</span>
<span id="cb1-176"><a href="#cb1-176" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-177"><a href="#cb1-177" aria-hidden="true" tabindex="-1"></a>  <span class="do">## set up matrices</span></span>
<span id="cb1-178"><a href="#cb1-178" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> <span class="fu">dim</span>(mt)[<span class="dv">1</span>] <span class="co"># time points</span></span>
<span id="cb1-179"><a href="#cb1-179" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">dim</span>(mt)[<span class="dv">2</span>] <span class="co"># dimension of state parameter vector</span></span>
<span id="cb1-180"><a href="#cb1-180" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-181"><a href="#cb1-181" aria-hidden="true" tabindex="-1"></a>  <span class="do">## placeholder for results</span></span>
<span id="cb1-182"><a href="#cb1-182" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> k, <span class="at">ncol =</span> d)</span>
<span id="cb1-183"><a href="#cb1-183" aria-hidden="true" tabindex="-1"></a>  Rt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, k))</span>
<span id="cb1-184"><a href="#cb1-184" aria-hidden="true" tabindex="-1"></a>  ft <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k)</span>
<span id="cb1-185"><a href="#cb1-185" aria-hidden="true" tabindex="-1"></a>  Qt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k)</span>
<span id="cb1-186"><a href="#cb1-186" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-187"><a href="#cb1-187" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k){</span>
<span id="cb1-188"><a href="#cb1-188" aria-hidden="true" tabindex="-1"></a>    <span class="do">## moments of state distribution</span></span>
<span id="cb1-189"><a href="#cb1-189" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb1-190"><a href="#cb1-190" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> <span class="fu">t</span>(mt[T, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb1-191"><a href="#cb1-191" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-192"><a href="#cb1-192" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb1-193"><a href="#cb1-193" aria-hidden="true" tabindex="-1"></a>       Rt[, , i] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> Ct[, , T] <span class="sc">%*%</span> </span>
<span id="cb1-194"><a href="#cb1-194" aria-hidden="true" tabindex="-1"></a>         <span class="fu">t</span>(Gt[, , T<span class="sc">+</span>i]) <span class="sc">+</span> St[T]<span class="sc">*</span>Wt_star[, , T<span class="sc">+</span>i]</span>
<span id="cb1-195"><a href="#cb1-195" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb1-196"><a href="#cb1-196" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> Ct[, , T] <span class="sc">%*%</span> </span>
<span id="cb1-197"><a href="#cb1-197" aria-hidden="true" tabindex="-1"></a>          <span class="fu">t</span>(Gt[, , T<span class="sc">+</span>i])<span class="sc">/</span>delta</span>
<span id="cb1-198"><a href="#cb1-198" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb1-199"><a href="#cb1-199" aria-hidden="true" tabindex="-1"></a>      Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb1-200"><a href="#cb1-200" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-201"><a href="#cb1-201" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb1-202"><a href="#cb1-202" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> <span class="fu">t</span>(at[i<span class="dv">-1</span>, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb1-203"><a href="#cb1-203" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb1-204"><a href="#cb1-204" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> Rt[, , i<span class="dv">-1</span>] <span class="sc">%*%</span> </span>
<span id="cb1-205"><a href="#cb1-205" aria-hidden="true" tabindex="-1"></a>          <span class="fu">t</span>(Gt[, , T<span class="sc">+</span>i]) <span class="sc">+</span> St[T]<span class="sc">*</span>Wt_star[, , T <span class="sc">+</span> i]</span>
<span id="cb1-206"><a href="#cb1-206" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb1-207"><a href="#cb1-207" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> Rt[, , i<span class="dv">-1</span>] <span class="sc">%*%</span> </span>
<span id="cb1-208"><a href="#cb1-208" aria-hidden="true" tabindex="-1"></a>          <span class="fu">t</span>(Gt[, , T<span class="sc">+</span>i])<span class="sc">/</span>delta</span>
<span id="cb1-209"><a href="#cb1-209" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb1-210"><a href="#cb1-210" aria-hidden="true" tabindex="-1"></a>      Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb1-211"><a href="#cb1-211" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-212"><a href="#cb1-212" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-213"><a href="#cb1-213" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-214"><a href="#cb1-214" aria-hidden="true" tabindex="-1"></a>    <span class="do">## moments of forecast distribution</span></span>
<span id="cb1-215"><a href="#cb1-215" aria-hidden="true" tabindex="-1"></a>    ft[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , T<span class="sc">+</span>i]) <span class="sc">%*%</span> <span class="fu">t</span>(at[i, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb1-216"><a href="#cb1-216" aria-hidden="true" tabindex="-1"></a>    Qt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , T<span class="sc">+</span>i]) <span class="sc">%*%</span> Rt[, , i] <span class="sc">%*%</span> Ft[, , T<span class="sc">+</span>i] <span class="sc">+</span> </span>
<span id="cb1-217"><a href="#cb1-217" aria-hidden="true" tabindex="-1"></a>      St[T]</span>
<span id="cb1-218"><a href="#cb1-218" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-219"><a href="#cb1-219" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Forecasting is completed!</span><span class="sc">\n</span><span class="st">"</span>) <span class="co"># indicator of completion</span></span>
<span id="cb1-220"><a href="#cb1-220" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">at=</span>at, <span class="at">Rt=</span>Rt, <span class="at">ft=</span>ft, <span class="at">Qt=</span>Qt))</span>
<span id="cb1-221"><a href="#cb1-221" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-222"><a href="#cb1-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-223"><a href="#cb1-223" aria-hidden="true" tabindex="-1"></a><span class="do">## obtain 95% credible interval</span></span>
<span id="cb1-224"><a href="#cb1-224" aria-hidden="true" tabindex="-1"></a>get_credible_interval_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(ft, Qt, nt, </span>
<span id="cb1-225"><a href="#cb1-225" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">quantile =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)){</span>
<span id="cb1-226"><a href="#cb1-226" aria-hidden="true" tabindex="-1"></a>  bound <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span><span class="fu">length</span>(ft), <span class="at">ncol=</span><span class="dv">2</span>)</span>
<span id="cb1-227"><a href="#cb1-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-228"><a href="#cb1-228" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((<span class="fu">length</span>(nt)<span class="sc">==</span><span class="dv">1</span>)){</span>
<span id="cb1-229"><a href="#cb1-229" aria-hidden="true" tabindex="-1"></a>   <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(ft)){</span>
<span id="cb1-230"><a href="#cb1-230" aria-hidden="true" tabindex="-1"></a>      t_quantile <span class="ot">&lt;-</span> <span class="fu">qt</span>(quantile[<span class="dv">1</span>], <span class="at">df =</span> nt)</span>
<span id="cb1-231"><a href="#cb1-231" aria-hidden="true" tabindex="-1"></a>      bound[t, <span class="dv">1</span>] <span class="ot">&lt;-</span> ft[t] <span class="sc">+</span> t_quantile<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(Qt[t])) </span>
<span id="cb1-232"><a href="#cb1-232" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-233"><a href="#cb1-233" aria-hidden="true" tabindex="-1"></a>  <span class="co"># upper bound of 95% credible interval</span></span>
<span id="cb1-234"><a href="#cb1-234" aria-hidden="true" tabindex="-1"></a>      t_quantile <span class="ot">&lt;-</span> <span class="fu">qt</span>(quantile[<span class="dv">2</span>], <span class="at">df =</span> nt)</span>
<span id="cb1-235"><a href="#cb1-235" aria-hidden="true" tabindex="-1"></a>      bound[t, <span class="dv">2</span>] <span class="ot">&lt;-</span> ft[t] <span class="sc">+</span> </span>
<span id="cb1-236"><a href="#cb1-236" aria-hidden="true" tabindex="-1"></a>        t_quantile<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(Qt[t]))}</span>
<span id="cb1-237"><a href="#cb1-237" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb1-238"><a href="#cb1-238" aria-hidden="true" tabindex="-1"></a>  <span class="co"># lower bound of 95% credible interval</span></span>
<span id="cb1-239"><a href="#cb1-239" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(ft)){</span>
<span id="cb1-240"><a href="#cb1-240" aria-hidden="true" tabindex="-1"></a>      t_quantile <span class="ot">&lt;-</span> <span class="fu">qt</span>(quantile[<span class="dv">1</span>], <span class="at">df =</span> nt[t])</span>
<span id="cb1-241"><a href="#cb1-241" aria-hidden="true" tabindex="-1"></a>      bound[t, <span class="dv">1</span>] <span class="ot">&lt;-</span> ft[t] <span class="sc">+</span> </span>
<span id="cb1-242"><a href="#cb1-242" aria-hidden="true" tabindex="-1"></a>        t_quantile<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(Qt[t])) </span>
<span id="cb1-243"><a href="#cb1-243" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-244"><a href="#cb1-244" aria-hidden="true" tabindex="-1"></a>  <span class="co"># upper bound of 95% credible interval</span></span>
<span id="cb1-245"><a href="#cb1-245" aria-hidden="true" tabindex="-1"></a>      t_quantile <span class="ot">&lt;-</span> <span class="fu">qt</span>(quantile[<span class="dv">2</span>], <span class="at">df =</span> nt[t])</span>
<span id="cb1-246"><a href="#cb1-246" aria-hidden="true" tabindex="-1"></a>      bound[t, <span class="dv">2</span>] <span class="ot">&lt;-</span> ft[t] <span class="sc">+</span> </span>
<span id="cb1-247"><a href="#cb1-247" aria-hidden="true" tabindex="-1"></a>        t_quantile<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(Qt[t]))}</span>
<span id="cb1-248"><a href="#cb1-248" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-249"><a href="#cb1-249" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(bound)</span>
<span id="cb1-250"><a href="#cb1-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-251"><a href="#cb1-251" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-252"><a href="#cb1-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-253"><a href="#cb1-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-254"><a href="#cb1-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-255"><a href="#cb1-255" aria-hidden="true" tabindex="-1"></a><span class="do">## Example: Nile River Level (in 10^8 m^3), 1871-1970 </span></span>
<span id="cb1-256"><a href="#cb1-256" aria-hidden="true" tabindex="-1"></a><span class="do">## Model: First order polynomial DLM</span></span>
<span id="cb1-257"><a href="#cb1-257" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(Nile) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="C4-L04_files/figure-html/code-NDLM-unknown-variance-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="C4-L04_files/figure-html/code-NDLM-unknown-variance-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>n<span class="ot">=</span><span class="fu">length</span>(Nile) <span class="co">#n=100 observations </span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>k<span class="ot">=</span><span class="dv">5</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>T<span class="ot">=</span>n<span class="sc">-</span>k</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>data_T<span class="ot">=</span>Nile[<span class="dv">1</span><span class="sc">:</span>T]</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>test_data<span class="ot">=</span>Nile[(T<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>n]</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>data<span class="ot">=</span><span class="fu">list</span>(<span class="at">yt =</span> data_T)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="do">## set up matrices for first order polynomial model </span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>Ft<span class="ot">=</span><span class="fu">array</span>(<span class="dv">1</span>, <span class="at">dim =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, n))</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>Gt<span class="ot">=</span><span class="fu">array</span>(<span class="dv">1</span>, <span class="at">dim =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, n))</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>Wt_star<span class="ot">=</span><span class="fu">array</span>(<span class="dv">1</span>, <span class="at">dim =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, n))</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>m0<span class="ot">=</span><span class="fu">as.matrix</span>(<span class="dv">800</span>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>C0_star<span class="ot">=</span><span class="fu">as.matrix</span>(<span class="dv">10</span>)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>n0<span class="ot">=</span><span class="dv">1</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>S0<span class="ot">=</span><span class="dv">10</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="do">## wrap up all matrices and initial values</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>matrices <span class="ot">=</span> <span class="fu">set_up_dlm_matrices_unknown_v</span>(Ft, Gt, Wt_star)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>initial_states <span class="ot">=</span> <span class="fu">set_up_initial_states_unknown_v</span>(m0, </span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>                                      C0_star, n0, S0)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="do">## filtering </span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>results_filtered <span class="ot">=</span> <span class="fu">forward_filter_unknown_v</span>(data, matrices, </span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>                                            initial_states)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Forward filtering is completed!</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>ci_filtered<span class="ot">=</span><span class="fu">get_credible_interval_unknown_v</span>(results_filtered<span class="sc">$</span>mt, </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>                                    results_filtered<span class="sc">$</span>Ct, </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                                     results_filtered<span class="sc">$</span>nt)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="do">## smoothing</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>results_smoothed<span class="ot">=</span><span class="fu">backward_smoothing_unknown_v</span>(data, matrices, </span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>                                             results_filtered)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Backward smoothing is completed!</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>ci_smoothed<span class="ot">=</span><span class="fu">get_credible_interval_unknown_v</span>(results_smoothed<span class="sc">$</span>mnt, </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>                                         results_smoothed<span class="sc">$</span>Cnt, </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                                         results_filtered<span class="sc">$</span>nt[T])</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="do">## one-step ahead forecasting</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>results_forecast<span class="ot">=</span><span class="fu">forecast_function_unknown_v</span>(results_filtered, </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>                                                k,  matrices)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Forecasting is completed!</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>ci_forecast<span class="ot">=</span><span class="fu">get_credible_interval_unknown_v</span>(results_forecast<span class="sc">$</span>ft, </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>                                          results_forecast<span class="sc">$</span>Qt, </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>                                     results_filtered<span class="sc">$</span>nt[T])</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="do">## plot results</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>index<span class="ot">=</span><span class="fu">seq</span>(<span class="dv">1871</span>, <span class="dv">1970</span>, <span class="at">length.out =</span> <span class="fu">length</span>(Nile))</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>index_filt<span class="ot">=</span>index[<span class="dv">1</span><span class="sc">:</span>T]</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>index_forecast<span class="ot">=</span>index[(T<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(T<span class="sc">+</span>k)]</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(index, Nile, <span class="at">main =</span> <span class="st">"Nile River Level "</span>,<span class="at">type=</span><span class="st">'l'</span>,</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"time"</span>,<span class="at">ylab=</span><span class="st">"feet"</span>,<span class="at">lty=</span><span class="dv">3</span>,<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">400</span>,<span class="dv">1500</span>))</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(index,Nile,<span class="at">pch=</span><span class="dv">20</span>)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt,results_filtered<span class="sc">$</span>mt, <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'red'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt,ci_filtered[, <span class="dv">1</span>], <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'red'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt,ci_filtered[, <span class="dv">2</span>], <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'red'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt,results_smoothed<span class="sc">$</span>mnt, <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'blue'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, ci_smoothed[, <span class="dv">1</span>], <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'blue'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, ci_smoothed[, <span class="dv">2</span>], <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'blue'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_forecast, results_forecast<span class="sc">$</span>ft, <span class="at">type=</span><span class="st">'l'</span>, </span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'green'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_forecast, ci_forecast[, <span class="dv">1</span>], <span class="at">type=</span><span class="st">'l'</span>, </span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'green'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_forecast, ci_forecast[, <span class="dv">2</span>], <span class="at">type=</span><span class="st">'l'</span>, </span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'green'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="C4-L04_files/figure-html/code-NDLM-unknown-variance-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="C4-L04_files/figure-html/code-NDLM-unknown-variance-2.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="practice-graded-assignment-ndlm-data-analysis" class="level2" data-number="1.6">
<h2 data-number="1.6" class="anchored" data-anchor-id="practice-graded-assignment-ndlm-data-analysis"><span class="header-section-number">1.6</span> Practice Graded Assignment: NDLM data analysis</h2>
<p>This peer-reviewed activity is highly recommended. It does not figure into your grade for this course, but it does provide you with the opportunity to apply what you’ve learned in R and prepare you for your data analysis project in week 5.</p>
<p>The R code below fits a Normal Dynamic Linear Model to the monthly time series of Google trends “hits” for the term “time series”. The model has two components: (a) a polynomial model of order 2 and (b) a seasonal component with 4 frequencies: <span class="math inline">ω_1=2π/12</span>, (annual cycle) <span class="math inline">ω_2=2π/6</span> (6 months cycle), <span class="math inline">ω_3=2π/4</span> and <span class="math inline">ω_4=2π/3.</span> The model assumes that the observational variance <span class="math inline">v</span> is unknown and the system variance-covariance matrix <span class="math inline">W_t</span> is specified using a single discount factor. The discount factor is chosen using an optimality criterion as explained in the course.</p>
<p>You will be asked to modify the code in order to consider a DLM with two components: (a) a polynomial model of order 1 and (b) a seasonal component that contains a fundamental period of <span class="math inline">p = 12</span> and 2 additional harmonics for a total of 3 frequencies: <span class="math inline">ω1=2π/12</span>, <span class="math inline">ω2=2π/6</span> and <span class="math inline">ω3=2π/4</span>. You will also need to optimize the choice of the discount factor for this model. You will be asked to upload pictures summarizing your results.</p>
<p>R code to fit the model: requires R packages <code>gtrends</code>,and <code>dlm</code> as well as the files “all_dlm_functions_unknown_v.R” and “discountfactor_selection_functions.R” also provided below.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: code-gtrendsR-data-analysis</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># download data </span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gtrendsR)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>timeseries_data <span class="ot">&lt;-</span> <span class="fu">gtrends</span>(<span class="st">"time series"</span>,<span class="at">time=</span><span class="st">"all"</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(timeseries_data)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(timeseries_data)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>timeseries_data<span class="ot">=</span>timeseries_data<span class="sc">$</span>interest_over_time</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>data<span class="ot">=</span><span class="fu">list</span>(<span class="at">yt=</span>timeseries_data<span class="sc">$</span>hits)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dlm)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>model_seasonal<span class="ot">=</span><span class="fu">dlmModTrig</span>(<span class="at">s=</span><span class="dv">12</span>,<span class="at">q=</span><span class="dv">4</span>,<span class="at">dV=</span><span class="dv">0</span>,<span class="at">dW=</span><span class="dv">1</span>)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>model_trend<span class="ot">=</span><span class="fu">dlmModPoly</span>(<span class="at">order=</span><span class="dv">2</span>,<span class="at">dV=</span><span class="dv">10</span>,<span class="at">dW=</span><span class="fu">rep</span>(<span class="dv">1</span>,<span class="dv">2</span>),<span class="at">m0=</span><span class="fu">c</span>(<span class="dv">40</span>,<span class="dv">0</span>))</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>model<span class="ot">=</span>model_trend<span class="sc">+</span>model_seasonal</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>model<span class="sc">$</span>C0<span class="ot">=</span><span class="dv">10</span><span class="sc">*</span><span class="fu">diag</span>(<span class="dv">10</span>)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>n0<span class="ot">=</span><span class="dv">1</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>S0<span class="ot">=</span><span class="dv">10</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>k<span class="ot">=</span><span class="fu">length</span>(model<span class="sc">$</span>m0)</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>T<span class="ot">=</span><span class="fu">length</span>(data<span class="sc">$</span>yt)</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>Ft<span class="ot">=</span><span class="fu">array</span>(<span class="dv">0</span>,<span class="fu">c</span>(<span class="dv">1</span>,k,T))</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>Gt<span class="ot">=</span><span class="fu">array</span>(<span class="dv">0</span>,<span class="fu">c</span>(k,k,T))</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T){</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>   Ft[,,t]<span class="ot">=</span>model<span class="sc">$</span>FF</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>   Gt[,,t]<span class="ot">=</span>model<span class="sc">$</span>GG</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">'all_dlm_functions_unknown_v.R'</span>)</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">'discountfactor_selection_functions.R'</span>)</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>matrices<span class="ot">=</span><span class="fu">set_up_dlm_matrices_unknown_v</span>(<span class="at">Ft=</span>Ft,<span class="at">Gt=</span>Gt)</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>initial_states<span class="ot">=</span><span class="fu">set_up_initial_states_unknown_v</span>(model<span class="sc">$</span>m0,</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>                                               model<span class="sc">$</span>C0,n0,S0)</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>df_range<span class="ot">=</span><span class="fu">seq</span>(<span class="fl">0.9</span>,<span class="dv">1</span>,<span class="at">by=</span><span class="fl">0.005</span>)</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a><span class="do">## fit discount DLM</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a><span class="do">## MSE</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>results_MSE <span class="ot">&lt;-</span> <span class="fu">adaptive_dlm</span>(data, matrices, </span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>               initial_states, df_range,<span class="st">"MSE"</span>,<span class="at">forecast=</span><span class="cn">FALSE</span>)</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a><span class="do">## print selected discount factor</span></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"The selected discount factor:"</span>,results_MSE<span class="sc">$</span>df_opt))</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a><span class="do">## retrieve filtered results</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>results_filtered <span class="ot">&lt;-</span> results_MSE<span class="sc">$</span>results_filtered</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>ci_filtered <span class="ot">&lt;-</span> <span class="fu">get_credible_interval_unknown_v</span>(</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>  results_filtered<span class="sc">$</span>ft,results_filtered<span class="sc">$</span>Qt,results_filtered<span class="sc">$</span>nt)</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a><span class="do">## retrieve smoothed results</span></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>results_smoothed <span class="ot">&lt;-</span> results_MSE<span class="sc">$</span>results_smoothed</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>ci_smoothed <span class="ot">&lt;-</span> <span class="fu">get_credible_interval_unknown_v</span>(</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>  results_smoothed<span class="sc">$</span>fnt, results_smoothed<span class="sc">$</span>Qnt, </span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>  results_filtered<span class="sc">$</span>nt[<span class="fu">length</span>(results_smoothed<span class="sc">$</span>fnt)])</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a><span class="do">## plot smoothing results </span></span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>index <span class="ot">&lt;-</span> timeseries_data<span class="sc">$</span>date</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(index, data<span class="sc">$</span>yt, <span class="at">ylab=</span><span class="st">'Google hits'</span>,</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Google Trends: time series"</span>, <span class="at">type =</span> <span class="st">'l'</span>,</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">'time'</span>, <span class="at">lty=</span><span class="dv">3</span>,<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">100</span>))</span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index, results_smoothed<span class="sc">$</span>fnt, <span class="at">type =</span> <span class="st">'l'</span>, <span class="at">col=</span><span class="st">'blue'</span>, </span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>      <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index, ci_smoothed[, <span class="dv">1</span>], <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'blue'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index, ci_smoothed[, <span class="dv">2</span>], <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'blue'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot trend and rate of change </span></span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">1</span>))</span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(index,data<span class="sc">$</span>yt,<span class="at">pch=</span><span class="dv">19</span>,<span class="at">cex=</span><span class="fl">0.3</span>,<span class="at">col=</span><span class="st">'lightgray'</span>,<span class="at">xlab=</span><span class="st">"time"</span>,</span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab=</span><span class="st">"Google hits"</span>,<span class="at">main=</span><span class="st">"trend"</span>)</span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index,results_smoothed<span class="sc">$</span>mnt[,<span class="dv">1</span>],<span class="at">lwd=</span><span class="dv">2</span>,<span class="at">col=</span><span class="st">'magenta'</span>)</span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(index,results_smoothed<span class="sc">$</span>mnt[,<span class="dv">2</span>],<span class="at">col=</span><span class="st">'darkblue'</span>,<span class="at">lwd=</span><span class="dv">2</span>,</span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a>     <span class="at">type=</span><span class="st">'l'</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.6</span>,<span class="fl">0.6</span>), <span class="at">xlab=</span><span class="st">"time"</span>,</span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab=</span><span class="st">"rate of change"</span>)</span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h=</span><span class="dv">0</span>,<span class="at">col=</span><span class="st">'red'</span>,<span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot seasonal components </span></span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(index,results_smoothed<span class="sc">$</span>mnt[,<span class="dv">3</span>],<span class="at">lwd=</span><span class="dv">2</span>,<span class="at">col=</span><span class="st">"darkgreen"</span>,</span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a>     <span class="at">type=</span><span class="st">'l'</span>, <span class="at">xlab=</span><span class="st">"time"</span>,<span class="at">ylab=</span><span class="st">""</span>,<span class="at">main=</span><span class="st">"period=12"</span>,</span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">12</span>,<span class="dv">12</span>))</span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(index,results_smoothed<span class="sc">$</span>mnt[,<span class="dv">5</span>],<span class="at">lwd=</span><span class="dv">2</span>,<span class="at">col=</span><span class="st">"darkgreen"</span>,</span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a>     <span class="at">type=</span><span class="st">'l'</span>,<span class="at">xlab=</span><span class="st">"time"</span>,<span class="at">ylab=</span><span class="st">""</span>,<span class="at">main=</span><span class="st">"period=6"</span>,</span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">12</span>,<span class="dv">12</span>))</span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(index,results_smoothed<span class="sc">$</span>mnt[,<span class="dv">7</span>],<span class="at">lwd=</span><span class="dv">2</span>,<span class="at">col=</span><span class="st">"darkgreen"</span>,</span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a>     <span class="at">type=</span><span class="st">'l'</span>, <span class="at">xlab=</span><span class="st">"time"</span>,<span class="at">ylab=</span><span class="st">""</span>,<span class="at">main=</span><span class="st">"period=4"</span>,</span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">12</span>,<span class="dv">12</span>))</span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(index,results_smoothed<span class="sc">$</span>mnt[,<span class="dv">9</span>],<span class="at">lwd=</span><span class="dv">2</span>,<span class="at">col=</span><span class="st">"darkgreen"</span>,</span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a>     <span class="at">type=</span><span class="st">'l'</span>, <span class="at">xlab=</span><span class="st">"time"</span>,<span class="at">ylab=</span><span class="st">""</span>,<span class="at">main=</span><span class="st">"period=3"</span>,</span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">12</span>,<span class="dv">12</span>))</span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true" tabindex="-1"></a><span class="co">#Estimate for the observational variance: St[T]</span></span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true" tabindex="-1"></a>results_filtered<span class="sc">$</span>St[T]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="all-dlm-functions-unknown-v" class="level3" data-number="1.6.1">
<h3 data-number="1.6.1" class="anchored" data-anchor-id="all-dlm-functions-unknown-v"><span class="header-section-number">1.6.1</span> All dlm functions unknown v</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="do">## create list for matrices</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>set_up_dlm_matrices_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(Ft, Gt, Wt_star){</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.array</span>(Gt)){</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Stop</span>(<span class="st">"Gt and Ft should be array"</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">missing</span>(Wt_star)){</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">Ft=</span>Ft, <span class="at">Gt=</span>Gt))</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">Ft=</span>Ft, <span class="at">Gt=</span>Gt, <span class="at">Wt_star=</span>Wt_star))</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="do">## create list for initial states</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>set_up_initial_states_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(m0, C0_star, n0, S0){</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">m0=</span>m0, <span class="at">C0_star=</span>C0_star, <span class="at">n0=</span>n0, <span class="at">S0=</span>S0))</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>forward_filter_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(data, matrices, </span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>                              initial_states, delta){</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve dataset</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>  yt <span class="ot">&lt;-</span> data<span class="sc">$</span>yt</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>  T<span class="ot">&lt;-</span> <span class="fu">length</span>(yt)</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>  Ft <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Ft</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>  Gt <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Gt</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    Wt_star <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Wt_star</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve initial state</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>  m0 <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>m0</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>  C0_star <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>C0_star</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>  n0 <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>n0</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>  S0 <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>S0</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>  C0 <span class="ot">&lt;-</span> S0<span class="sc">*</span>C0_star</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>  <span class="do">## create placeholder for results</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">dim</span>(Gt)[<span class="dv">1</span>]</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span>T, <span class="at">ncol=</span>d)</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>  Rt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, T))</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>  ft <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>  Qt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>  mt <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span>T, <span class="at">ncol=</span>d)</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>  Ct <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, T))</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>  et <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>  nt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>  St <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># moments of priors at t</span></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T){</span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> Gt[, , i] <span class="sc">%*%</span> m0</span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>      Pt <span class="ot">&lt;-</span> Gt[, , i] <span class="sc">%*%</span> C0 <span class="sc">%*%</span> <span class="fu">t</span>(Gt[, , i])</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>      Pt <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Pt <span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Pt)</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>        Wt <span class="ot">&lt;-</span> Wt_star[, , i]<span class="sc">*</span>S0</span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Pt <span class="sc">+</span> Wt</span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>        Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Pt<span class="sc">/</span>delta</span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>        Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> Gt[, , i] <span class="sc">%*%</span> <span class="fu">t</span>(mt[i<span class="dv">-1</span>, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>      Pt <span class="ot">&lt;-</span> Gt[, , i] <span class="sc">%*%</span> Ct[, , i<span class="dv">-1</span>] <span class="sc">%*%</span> <span class="fu">t</span>(Gt[, , i])</span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>        Wt <span class="ot">&lt;-</span> Wt_star[, , i] <span class="sc">*</span> St[i<span class="dv">-1</span>]</span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Pt <span class="sc">+</span> Wt</span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>        Rt[,,i]<span class="ot">=</span><span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Pt<span class="sc">/</span>delta</span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a>        Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments of one-step forecast:</span></span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a>    ft[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , i]) <span class="sc">%*%</span> <span class="fu">t</span>(at[i, , <span class="at">drop=</span><span class="cn">FALSE</span>]) </span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a>    Qt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , i]) <span class="sc">%*%</span> Rt[, , i] <span class="sc">%*%</span> Ft[, , i] <span class="sc">+</span> </span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(i<span class="sc">==</span><span class="dv">1</span>, S0, St[i<span class="dv">-1</span>])</span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a>    et[i] <span class="ot">&lt;-</span> yt[i] <span class="sc">-</span> ft[i]</span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a>    nt[i] <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(i<span class="sc">==</span><span class="dv">1</span>, n0, nt[i<span class="dv">-1</span>]) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a>    St[i] <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(i<span class="sc">==</span><span class="dv">1</span>, S0, </span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a>                    St[i<span class="dv">-1</span>])<span class="sc">*</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>nt[i]<span class="sc">*</span>(et[i]<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span>Qt[i]<span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments of posterior at t:</span></span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true" tabindex="-1"></a>    At <span class="ot">&lt;-</span> Rt[, , i] <span class="sc">%*%</span> Ft[, , i] <span class="sc">/</span> Qt[i]</span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-93"><a href="#cb10-93" aria-hidden="true" tabindex="-1"></a>    mt[i, ] <span class="ot">&lt;-</span> at[i, ] <span class="sc">+</span> <span class="fu">t</span>(At) <span class="sc">*</span> et[i]</span>
<span id="cb10-94"><a href="#cb10-94" aria-hidden="true" tabindex="-1"></a>    Ct[, , i] <span class="ot">&lt;-</span> St[i]<span class="sc">/</span><span class="fu">ifelse</span>(i<span class="sc">==</span><span class="dv">1</span>, S0, </span>
<span id="cb10-95"><a href="#cb10-95" aria-hidden="true" tabindex="-1"></a>                  St[i<span class="dv">-1</span>])<span class="sc">*</span>(Rt[, , i] <span class="sc">-</span> Qt[i] <span class="sc">*</span> At <span class="sc">%*%</span> <span class="fu">t</span>(At))</span>
<span id="cb10-96"><a href="#cb10-96" aria-hidden="true" tabindex="-1"></a>    Ct[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Ct[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Ct[,,i])</span>
<span id="cb10-97"><a href="#cb10-97" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-98"><a href="#cb10-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Forward filtering is completed!</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb10-99"><a href="#cb10-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mt =</span> mt, <span class="at">Ct =</span> Ct,  <span class="at">at =</span> at, <span class="at">Rt =</span> Rt, </span>
<span id="cb10-100"><a href="#cb10-100" aria-hidden="true" tabindex="-1"></a>              <span class="at">ft =</span> ft, <span class="at">Qt =</span> Qt,  <span class="at">et =</span> et, </span>
<span id="cb10-101"><a href="#cb10-101" aria-hidden="true" tabindex="-1"></a>              <span class="at">nt =</span> nt, <span class="at">St =</span> St))</span>
<span id="cb10-102"><a href="#cb10-102" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-103"><a href="#cb10-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-104"><a href="#cb10-104" aria-hidden="true" tabindex="-1"></a><span class="do">### smoothing function </span><span class="al">###</span></span>
<span id="cb10-105"><a href="#cb10-105" aria-hidden="true" tabindex="-1"></a>backward_smoothing_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(data, matrices, </span>
<span id="cb10-106"><a href="#cb10-106" aria-hidden="true" tabindex="-1"></a>                                posterior_states,delta){</span>
<span id="cb10-107"><a href="#cb10-107" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve data </span></span>
<span id="cb10-108"><a href="#cb10-108" aria-hidden="true" tabindex="-1"></a>  yt <span class="ot">&lt;-</span> data<span class="sc">$</span>yt</span>
<span id="cb10-109"><a href="#cb10-109" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> <span class="fu">length</span>(yt) </span>
<span id="cb10-110"><a href="#cb10-110" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-111"><a href="#cb10-111" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb10-112"><a href="#cb10-112" aria-hidden="true" tabindex="-1"></a>  Ft <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Ft</span>
<span id="cb10-113"><a href="#cb10-113" aria-hidden="true" tabindex="-1"></a>  Gt <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Gt</span>
<span id="cb10-114"><a href="#cb10-114" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-115"><a href="#cb10-115" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb10-116"><a href="#cb10-116" aria-hidden="true" tabindex="-1"></a>  mt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>mt</span>
<span id="cb10-117"><a href="#cb10-117" aria-hidden="true" tabindex="-1"></a>  Ct <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>Ct</span>
<span id="cb10-118"><a href="#cb10-118" aria-hidden="true" tabindex="-1"></a>  Rt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>Rt</span>
<span id="cb10-119"><a href="#cb10-119" aria-hidden="true" tabindex="-1"></a>  nt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>nt</span>
<span id="cb10-120"><a href="#cb10-120" aria-hidden="true" tabindex="-1"></a>  St <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>St</span>
<span id="cb10-121"><a href="#cb10-121" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>at</span>
<span id="cb10-122"><a href="#cb10-122" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-123"><a href="#cb10-123" aria-hidden="true" tabindex="-1"></a>  <span class="do">## create placeholder for posterior moments </span></span>
<span id="cb10-124"><a href="#cb10-124" aria-hidden="true" tabindex="-1"></a>  mnt <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">dim</span>(mt)[<span class="dv">1</span>], <span class="at">ncol =</span> <span class="fu">dim</span>(mt)[<span class="dv">2</span>])</span>
<span id="cb10-125"><a href="#cb10-125" aria-hidden="true" tabindex="-1"></a>  Cnt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">dim</span>(Ct))</span>
<span id="cb10-126"><a href="#cb10-126" aria-hidden="true" tabindex="-1"></a>  fnt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb10-127"><a href="#cb10-127" aria-hidden="true" tabindex="-1"></a>  Qnt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb10-128"><a href="#cb10-128" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-129"><a href="#cb10-129" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> T<span class="sc">:</span><span class="dv">1</span>){</span>
<span id="cb10-130"><a href="#cb10-130" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> T){</span>
<span id="cb10-131"><a href="#cb10-131" aria-hidden="true" tabindex="-1"></a>      mnt[i, ] <span class="ot">&lt;-</span> mt[i, ]</span>
<span id="cb10-132"><a href="#cb10-132" aria-hidden="true" tabindex="-1"></a>      Cnt[, , i] <span class="ot">&lt;-</span> Ct[, , i]</span>
<span id="cb10-133"><a href="#cb10-133" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb10-134"><a href="#cb10-134" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb10-135"><a href="#cb10-135" aria-hidden="true" tabindex="-1"></a>        inv_Rtp1 <span class="ot">&lt;-</span> <span class="fu">chol2inv</span>(<span class="fu">chol</span>(Rt[, , i<span class="sc">+</span><span class="dv">1</span>]))</span>
<span id="cb10-136"><a href="#cb10-136" aria-hidden="true" tabindex="-1"></a>        Bt <span class="ot">&lt;-</span> Ct[, , i] <span class="sc">%*%</span> <span class="fu">t</span>(Gt[, , i<span class="sc">+</span><span class="dv">1</span>]) <span class="sc">%*%</span> inv_Rtp1</span>
<span id="cb10-137"><a href="#cb10-137" aria-hidden="true" tabindex="-1"></a>        mnt[i, ] <span class="ot">&lt;-</span> mt[i, ] <span class="sc">+</span> Bt <span class="sc">%*%</span> (mnt[i<span class="sc">+</span><span class="dv">1</span>, ] <span class="sc">-</span> at[i<span class="sc">+</span><span class="dv">1</span>, ])</span>
<span id="cb10-138"><a href="#cb10-138" aria-hidden="true" tabindex="-1"></a>        Cnt[, , i] <span class="ot">&lt;-</span> Ct[, , i] <span class="sc">+</span> Bt <span class="sc">%*%</span> (Cnt[, , i<span class="sc">+</span><span class="dv">1</span>] <span class="sc">-</span> </span>
<span id="cb10-139"><a href="#cb10-139" aria-hidden="true" tabindex="-1"></a>                                    Rt[, , i<span class="sc">+</span><span class="dv">1</span>]) <span class="sc">%*%</span> <span class="fu">t</span>(Bt)</span>
<span id="cb10-140"><a href="#cb10-140" aria-hidden="true" tabindex="-1"></a>        Cnt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Cnt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Cnt[,,i])</span>
<span id="cb10-141"><a href="#cb10-141" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb10-142"><a href="#cb10-142" aria-hidden="true" tabindex="-1"></a>        inv_Gt <span class="ot">&lt;-</span> <span class="fu">solve</span>(Gt[, , i<span class="sc">+</span><span class="dv">1</span>])</span>
<span id="cb10-143"><a href="#cb10-143" aria-hidden="true" tabindex="-1"></a>        mnt[i, ] <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">-</span>delta)<span class="sc">*</span>mt[i, ] <span class="sc">+</span> </span>
<span id="cb10-144"><a href="#cb10-144" aria-hidden="true" tabindex="-1"></a>                delta<span class="sc">*</span>inv_Gt <span class="sc">%*%</span> <span class="fu">t</span>(mnt[i<span class="sc">+</span><span class="dv">1</span>, ,<span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb10-145"><a href="#cb10-145" aria-hidden="true" tabindex="-1"></a>        Cnt[, , i] <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">-</span>delta)<span class="sc">*</span>Ct[, , i] <span class="sc">+</span> </span>
<span id="cb10-146"><a href="#cb10-146" aria-hidden="true" tabindex="-1"></a>                delta<span class="sc">^</span><span class="dv">2</span><span class="sc">*</span>inv_Gt <span class="sc">%*%</span> Cnt[, , i <span class="sc">+</span> <span class="dv">1</span>]  <span class="sc">%*%</span> <span class="fu">t</span>(inv_Gt)</span>
<span id="cb10-147"><a href="#cb10-147" aria-hidden="true" tabindex="-1"></a>        Cnt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Cnt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Cnt[,,i])</span>
<span id="cb10-148"><a href="#cb10-148" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb10-149"><a href="#cb10-149" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-150"><a href="#cb10-150" aria-hidden="true" tabindex="-1"></a>    fnt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , i]) <span class="sc">%*%</span> <span class="fu">t</span>(mnt[i, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb10-151"><a href="#cb10-151" aria-hidden="true" tabindex="-1"></a>    Qnt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , i]) <span class="sc">%*%</span> <span class="fu">t</span>(Cnt[, , i]) <span class="sc">%*%</span> Ft[, , i]</span>
<span id="cb10-152"><a href="#cb10-152" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-153"><a href="#cb10-153" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T){</span>
<span id="cb10-154"><a href="#cb10-154" aria-hidden="true" tabindex="-1"></a>     Cnt[,,i]<span class="ot">=</span>St[T]<span class="sc">*</span>Cnt[,,i]<span class="sc">/</span>St[i] </span>
<span id="cb10-155"><a href="#cb10-155" aria-hidden="true" tabindex="-1"></a>     Qnt[i]<span class="ot">=</span>St[T]<span class="sc">*</span>Qnt[i]<span class="sc">/</span>St[i]</span>
<span id="cb10-156"><a href="#cb10-156" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-157"><a href="#cb10-157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Backward smoothing is completed!</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb10-158"><a href="#cb10-158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mnt =</span> mnt, <span class="at">Cnt =</span> Cnt, <span class="at">fnt=</span>fnt, <span class="at">Qnt=</span>Qnt))</span>
<span id="cb10-159"><a href="#cb10-159" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-160"><a href="#cb10-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-161"><a href="#cb10-161" aria-hidden="true" tabindex="-1"></a><span class="do">## Forecast Distribution for k step</span></span>
<span id="cb10-162"><a href="#cb10-162" aria-hidden="true" tabindex="-1"></a>forecast_function_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(posterior_states, k, </span>
<span id="cb10-163"><a href="#cb10-163" aria-hidden="true" tabindex="-1"></a>                                        matrices, delta){</span>
<span id="cb10-164"><a href="#cb10-164" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-165"><a href="#cb10-165" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb10-166"><a href="#cb10-166" aria-hidden="true" tabindex="-1"></a>  Ft <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Ft</span>
<span id="cb10-167"><a href="#cb10-167" aria-hidden="true" tabindex="-1"></a>  Gt <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Gt</span>
<span id="cb10-168"><a href="#cb10-168" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb10-169"><a href="#cb10-169" aria-hidden="true" tabindex="-1"></a>    Wt_star <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Wt_star</span>
<span id="cb10-170"><a href="#cb10-170" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-171"><a href="#cb10-171" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-172"><a href="#cb10-172" aria-hidden="true" tabindex="-1"></a>  mt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>mt</span>
<span id="cb10-173"><a href="#cb10-173" aria-hidden="true" tabindex="-1"></a>  Ct <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>Ct</span>
<span id="cb10-174"><a href="#cb10-174" aria-hidden="true" tabindex="-1"></a>  St <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>St</span>
<span id="cb10-175"><a href="#cb10-175" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>at</span>
<span id="cb10-176"><a href="#cb10-176" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-177"><a href="#cb10-177" aria-hidden="true" tabindex="-1"></a>  <span class="do">## set up matrices</span></span>
<span id="cb10-178"><a href="#cb10-178" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> <span class="fu">dim</span>(mt)[<span class="dv">1</span>] <span class="co"># time points</span></span>
<span id="cb10-179"><a href="#cb10-179" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">dim</span>(mt)[<span class="dv">2</span>] <span class="co"># dimension of state parameter vector</span></span>
<span id="cb10-180"><a href="#cb10-180" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-181"><a href="#cb10-181" aria-hidden="true" tabindex="-1"></a>  <span class="do">## placeholder for results</span></span>
<span id="cb10-182"><a href="#cb10-182" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> k, <span class="at">ncol =</span> d)</span>
<span id="cb10-183"><a href="#cb10-183" aria-hidden="true" tabindex="-1"></a>  Rt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, k))</span>
<span id="cb10-184"><a href="#cb10-184" aria-hidden="true" tabindex="-1"></a>  ft <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k)</span>
<span id="cb10-185"><a href="#cb10-185" aria-hidden="true" tabindex="-1"></a>  Qt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k)</span>
<span id="cb10-186"><a href="#cb10-186" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-187"><a href="#cb10-187" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k){</span>
<span id="cb10-188"><a href="#cb10-188" aria-hidden="true" tabindex="-1"></a>    <span class="do">## moments of state distribution</span></span>
<span id="cb10-189"><a href="#cb10-189" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb10-190"><a href="#cb10-190" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> <span class="fu">t</span>(mt[T, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb10-191"><a href="#cb10-191" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb10-192"><a href="#cb10-192" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb10-193"><a href="#cb10-193" aria-hidden="true" tabindex="-1"></a>       Rt[, , i] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> Ct[, , T] <span class="sc">%*%</span> </span>
<span id="cb10-194"><a href="#cb10-194" aria-hidden="true" tabindex="-1"></a>         <span class="fu">t</span>(Gt[, , T<span class="sc">+</span>i]) <span class="sc">+</span> St[T]<span class="sc">*</span>Wt_star[, , T<span class="sc">+</span>i]</span>
<span id="cb10-195"><a href="#cb10-195" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb10-196"><a href="#cb10-196" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> Ct[, , T] <span class="sc">%*%</span> </span>
<span id="cb10-197"><a href="#cb10-197" aria-hidden="true" tabindex="-1"></a>          <span class="fu">t</span>(Gt[, , T<span class="sc">+</span>i])<span class="sc">/</span>delta</span>
<span id="cb10-198"><a href="#cb10-198" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb10-199"><a href="#cb10-199" aria-hidden="true" tabindex="-1"></a>      Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb10-200"><a href="#cb10-200" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb10-201"><a href="#cb10-201" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb10-202"><a href="#cb10-202" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> <span class="fu">t</span>(at[i<span class="dv">-1</span>, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb10-203"><a href="#cb10-203" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb10-204"><a href="#cb10-204" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> Rt[, , i<span class="dv">-1</span>] <span class="sc">%*%</span> </span>
<span id="cb10-205"><a href="#cb10-205" aria-hidden="true" tabindex="-1"></a>          <span class="fu">t</span>(Gt[, , T<span class="sc">+</span>i]) <span class="sc">+</span> St[T]<span class="sc">*</span>Wt_star[, , T <span class="sc">+</span> i]</span>
<span id="cb10-206"><a href="#cb10-206" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb10-207"><a href="#cb10-207" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> Rt[, , i<span class="dv">-1</span>] <span class="sc">%*%</span> </span>
<span id="cb10-208"><a href="#cb10-208" aria-hidden="true" tabindex="-1"></a>          <span class="fu">t</span>(Gt[, , T<span class="sc">+</span>i])<span class="sc">/</span>delta</span>
<span id="cb10-209"><a href="#cb10-209" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb10-210"><a href="#cb10-210" aria-hidden="true" tabindex="-1"></a>      Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb10-211"><a href="#cb10-211" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-212"><a href="#cb10-212" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-213"><a href="#cb10-213" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-214"><a href="#cb10-214" aria-hidden="true" tabindex="-1"></a>    <span class="do">## moments of forecast distribution</span></span>
<span id="cb10-215"><a href="#cb10-215" aria-hidden="true" tabindex="-1"></a>    ft[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , T<span class="sc">+</span>i]) <span class="sc">%*%</span> <span class="fu">t</span>(at[i, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb10-216"><a href="#cb10-216" aria-hidden="true" tabindex="-1"></a>    Qt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , T<span class="sc">+</span>i]) <span class="sc">%*%</span> Rt[, , i] <span class="sc">%*%</span> Ft[, , T<span class="sc">+</span>i] <span class="sc">+</span> </span>
<span id="cb10-217"><a href="#cb10-217" aria-hidden="true" tabindex="-1"></a>      St[T]</span>
<span id="cb10-218"><a href="#cb10-218" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-219"><a href="#cb10-219" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Forecasting is completed!</span><span class="sc">\n</span><span class="st">"</span>) <span class="co"># indicator of completion</span></span>
<span id="cb10-220"><a href="#cb10-220" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">at=</span>at, <span class="at">Rt=</span>Rt, <span class="at">ft=</span>ft, <span class="at">Qt=</span>Qt))</span>
<span id="cb10-221"><a href="#cb10-221" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-222"><a href="#cb10-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-223"><a href="#cb10-223" aria-hidden="true" tabindex="-1"></a><span class="do">## obtain 95% credible interval</span></span>
<span id="cb10-224"><a href="#cb10-224" aria-hidden="true" tabindex="-1"></a>get_credible_interval_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(ft, Qt, nt, </span>
<span id="cb10-225"><a href="#cb10-225" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">quantile =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)){</span>
<span id="cb10-226"><a href="#cb10-226" aria-hidden="true" tabindex="-1"></a>  bound <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span><span class="fu">length</span>(ft), <span class="at">ncol=</span><span class="dv">2</span>)</span>
<span id="cb10-227"><a href="#cb10-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-228"><a href="#cb10-228" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((<span class="fu">length</span>(nt)<span class="sc">==</span><span class="dv">1</span>)){</span>
<span id="cb10-229"><a href="#cb10-229" aria-hidden="true" tabindex="-1"></a>   <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(ft)){</span>
<span id="cb10-230"><a href="#cb10-230" aria-hidden="true" tabindex="-1"></a>      t_quantile <span class="ot">&lt;-</span> <span class="fu">qt</span>(quantile[<span class="dv">1</span>], <span class="at">df =</span> nt)</span>
<span id="cb10-231"><a href="#cb10-231" aria-hidden="true" tabindex="-1"></a>      bound[t, <span class="dv">1</span>] <span class="ot">&lt;-</span> ft[t] <span class="sc">+</span> t_quantile<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(Qt[t])) </span>
<span id="cb10-232"><a href="#cb10-232" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-233"><a href="#cb10-233" aria-hidden="true" tabindex="-1"></a>  <span class="co"># upper bound of 95% credible interval</span></span>
<span id="cb10-234"><a href="#cb10-234" aria-hidden="true" tabindex="-1"></a>      t_quantile <span class="ot">&lt;-</span> <span class="fu">qt</span>(quantile[<span class="dv">2</span>], <span class="at">df =</span> nt)</span>
<span id="cb10-235"><a href="#cb10-235" aria-hidden="true" tabindex="-1"></a>      bound[t, <span class="dv">2</span>] <span class="ot">&lt;-</span> ft[t] <span class="sc">+</span> </span>
<span id="cb10-236"><a href="#cb10-236" aria-hidden="true" tabindex="-1"></a>        t_quantile<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(Qt[t]))}</span>
<span id="cb10-237"><a href="#cb10-237" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb10-238"><a href="#cb10-238" aria-hidden="true" tabindex="-1"></a>  <span class="co"># lower bound of 95% credible interval</span></span>
<span id="cb10-239"><a href="#cb10-239" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(ft)){</span>
<span id="cb10-240"><a href="#cb10-240" aria-hidden="true" tabindex="-1"></a>      t_quantile <span class="ot">&lt;-</span> <span class="fu">qt</span>(quantile[<span class="dv">1</span>], <span class="at">df =</span> nt[t])</span>
<span id="cb10-241"><a href="#cb10-241" aria-hidden="true" tabindex="-1"></a>      bound[t, <span class="dv">1</span>] <span class="ot">&lt;-</span> ft[t] <span class="sc">+</span> </span>
<span id="cb10-242"><a href="#cb10-242" aria-hidden="true" tabindex="-1"></a>        t_quantile<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(Qt[t])) </span>
<span id="cb10-243"><a href="#cb10-243" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-244"><a href="#cb10-244" aria-hidden="true" tabindex="-1"></a>  <span class="co"># upper bound of 95% credible interval</span></span>
<span id="cb10-245"><a href="#cb10-245" aria-hidden="true" tabindex="-1"></a>      t_quantile <span class="ot">&lt;-</span> <span class="fu">qt</span>(quantile[<span class="dv">2</span>], <span class="at">df =</span> nt[t])</span>
<span id="cb10-246"><a href="#cb10-246" aria-hidden="true" tabindex="-1"></a>      bound[t, <span class="dv">2</span>] <span class="ot">&lt;-</span> ft[t] <span class="sc">+</span> </span>
<span id="cb10-247"><a href="#cb10-247" aria-hidden="true" tabindex="-1"></a>        t_quantile<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(Qt[t]))}</span>
<span id="cb10-248"><a href="#cb10-248" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-249"><a href="#cb10-249" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(bound)</span>
<span id="cb10-250"><a href="#cb10-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-251"><a href="#cb10-251" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="discount-factor-selection-functions" class="level3" data-number="1.6.2">
<h3 data-number="1.6.2" class="anchored" data-anchor-id="discount-factor-selection-functions"><span class="header-section-number">1.6.2</span> Discount factor selection functions</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="do">##################################################</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="do">##### using discount factor ##########</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="do">##################################################</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="do">## compute measures of forecasting accuracy</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="do">## MAD: mean absolute deviation</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="do">## MSE: mean square error</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="do">## MAPE: mean absolute percentage error</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="do">## Neg LL: Negative log-likelihood of disc,</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="do">##         based on the one step ahead forecast distribution</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>measure_forecast_accuracy <span class="ot">&lt;-</span> <span class="cf">function</span>(et, yt, <span class="at">Qt=</span><span class="cn">NA</span>, <span class="at">nt=</span><span class="cn">NA</span>, type){</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(type <span class="sc">==</span> <span class="st">"MAD"</span>){</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    measure <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">abs</span>(et))</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span> <span class="cf">if</span>(type <span class="sc">==</span> <span class="st">"MSE"</span>){</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    measure <span class="ot">&lt;-</span> <span class="fu">mean</span>(et<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span> <span class="cf">if</span>(type <span class="sc">==</span> <span class="st">"MAPE"</span>){</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    measure <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">abs</span>(et)<span class="sc">/</span>yt)</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span> <span class="cf">if</span>(type <span class="sc">==</span> <span class="st">"NLL"</span>){</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    measure <span class="ot">&lt;-</span> <span class="fu">log_likelihood_one_step_ahead</span>(et, Qt, nt)</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Wrong type!"</span>)</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(measure)</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a><span class="do">## compute log likelihood of one step ahead forecast function</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>log_likelihood_one_step_ahead <span class="ot">&lt;-</span> <span class="cf">function</span>(et, Qt, nt){</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>  <span class="do">## et:the one-step-ahead error</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Qt: variance of one-step-ahead forecast function</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>  <span class="do">## nt: degrees freedom of t distribution</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> <span class="fu">length</span>(et)</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>  aux<span class="ot">=</span><span class="dv">0</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T){</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    zt<span class="ot">=</span>et[t]<span class="sc">/</span><span class="fu">sqrt</span>(Qt[t])</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    aux<span class="ot">=</span>(<span class="fu">dt</span>(zt,<span class="at">df=</span>nt[t],<span class="at">log=</span><span class="cn">TRUE</span>)<span class="sc">-</span><span class="fu">log</span>(<span class="fu">sqrt</span>(Qt[t]))) <span class="sc">+</span> aux </span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>  } </span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="sc">-</span>aux)</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a><span class="do">## Maximize log density of one-step-ahead forecast function to select discount factor</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>adaptive_dlm <span class="ot">&lt;-</span> <span class="cf">function</span>(data, matrices, initial_states, df_range, type, </span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>                         <span class="at">forecast=</span><span class="cn">TRUE</span>){</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>  measure_best <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>  measure <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">length</span>(df_range))</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>  valid_data <span class="ot">&lt;-</span> data<span class="sc">$</span>valid_data</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>  df_opt <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>  j <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>  <span class="do">## find the optimal discount factor</span></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> df_range){</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>    j <span class="ot">&lt;-</span> j <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>    results_tmp <span class="ot">&lt;-</span> <span class="fu">forward_filter_unknown_v</span>(data, matrices, initial_states, i)</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>    measure[j] <span class="ot">&lt;-</span> <span class="fu">measure_forecast_accuracy</span>(<span class="at">et=</span>results_tmp<span class="sc">$</span>et, <span class="at">yt=</span>data<span class="sc">$</span>yt,</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">Qt=</span>results_tmp<span class="sc">$</span>Qt, </span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">nt=</span><span class="fu">c</span>(initial_states<span class="sc">$</span>n0,results_tmp<span class="sc">$</span>nt), <span class="at">type=</span>type)</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(j <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>      measure_best <span class="ot">&lt;-</span> measure[j]</span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>      results_filtered <span class="ot">&lt;-</span> results_tmp</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>      df_opt <span class="ot">&lt;-</span> i</span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span> <span class="cf">if</span>(measure[j] <span class="sc">&lt;</span> measure_best){</span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>      measure_best <span class="ot">&lt;-</span> measure[j]</span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>      results_filtered <span class="ot">&lt;-</span> results_tmp</span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>      df_opt <span class="ot">&lt;-</span> i</span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a>  results_smoothed <span class="ot">&lt;-</span> <span class="fu">backward_smoothing_unknown_v</span>(data, matrices, results_filtered, <span class="at">delta =</span> df_opt)</span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(forecast){</span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>    results_forecast <span class="ot">&lt;-</span> <span class="fu">forecast_function</span>(results_filtered, <span class="fu">length</span>(valid_data), </span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>                                          matrices, df_opt)</span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">results_filtered=</span>results_filtered, </span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a>                <span class="at">results_smoothed=</span>results_smoothed, </span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a>                <span class="at">results_forecast=</span>results_forecast, </span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a>                <span class="at">df_opt =</span> df_opt, <span class="at">measure=</span>measure))</span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">results_filtered=</span>results_filtered, </span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a>                <span class="at">results_smoothed=</span>results_smoothed, </span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a>                <span class="at">df_opt =</span> df_opt, <span class="at">measure=</span>measure))</span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="grading-criteria" class="level3 callout-info" data-number="1.6.3">
<h3 data-number="1.6.3" class="anchored" data-anchor-id="grading-criteria"><span class="header-section-number">1.6.3</span> Grading Criteria</h3>
<p>The assignment will be graded based on the uploaded pictures summarizing the results. Estimates of some of the model parameters and additional discussion will also be requested.</p>
</section>
</section>
</section>
<section id="case-studies" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Case Studies</h1>
<section id="eeg-data" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="eeg-data"><span class="header-section-number">2.1</span> EEG data</h2>
</section>
<section id="google-trends" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="google-trends"><span class="header-section-number">2.2</span> Google Trends</h2>
</section>
</section>
<section id="quiz---ndlm-part-ii" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Quiz - NDLM, Part II</h1>
<p>This is omitted due to the Coursera honor code.</p>


<!-- -->

</section>

</main> <!-- /main -->
<script type="text/javascript">

// replace cmd keyboard shortcut w/ control on non-Mac platforms
const kPlatformMac = typeof navigator !== 'undefined' ? /Mac/.test(navigator.platform) : false;
if (!kPlatformMac) {
   var kbds = document.querySelectorAll("kbd")
   kbds.forEach(function(kbd) {
      kbd.innerHTML = kbd.innerHTML.replace(/⌘/g, '⌃');
   });
}

// tweak headings in pymd
document.querySelectorAll(".pymd span.co").forEach(el => {
   if (!el.innerText.startsWith("#|")) {
      el.style.fontWeight = 1000;
   }
});

</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb12" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2024-10-26</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Normal Dynamic Linear Models, Part 2"</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> Time Series Analysis</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> "Normal Dynamic Linear Models (NDLMs) are a class of models used for time series analysis that allow for flexible modeling of temporal dependencies."</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span><span class="co"> </span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">  - Bayesian Statistics</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co">  - Time Series</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="an">keywords:</span><span class="co"> </span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co">  - Time series</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co">  - Filtering</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co">  - Smoothing</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="co">  - NDLM</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="co">  - Normal Dynamic Linear Models</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="co">  - Seasonal NDLM</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="co">  - Superposition Principle</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="co">  - R code</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> course-banner.png</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="an">fig-caption:</span><span class="co"> Notes about ... Bayesian Statistics</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="an">title-block-banner:</span><span class="co"> images/banner_deep.jpg</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="fu">## Seasonal NDLMs</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>:::{.callout-note collapse="true"}</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a><span class="fu">## Learning Objectives {.unnumbered}</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Use R for analysis and forecasting of time series using the NDLM (cases of known or unknown observational variance and unknown system variance specified using a discount factor)</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Derive the equations to obtain posterior inference and forecasting in the NDLM with unknown observational variance and system variance specified via discount factors</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Define seasonal NDLMs</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Apply the NDLM superposition principle and explain the role of the forecast function</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a><span class="fu">## Fourier representation (Video)</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>Transcript:</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; I will now describe </span><span class="co">[</span><span class="ot">how to incorporate seasonal components in a normal dynamic linear model</span><span class="co">]</span><span class="at">{.mark}. What we will do is we will first talk about the so-called single Fourier component representation </span><span class="co">[</span><span class="ot">**single Fourier component representation**</span><span class="co">]</span><span class="at">{.column-margin}. Just in case you have a single frequency and how to incorporate that single frequency in your model for the seasonality. Then using the superposition principle, you can incorporate several frequencies or a single frequency and the corresponding harmonics in your model.</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;</span></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; There are other seasonal representations as well </span><span class="co">[</span><span class="ot">clarification needed</span><span class="co">]</span><span class="at">{.cn}. </span></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; We will focus on the Fourier representation as is is flexible without needing too many parameters. E.g. if you want to consider, a fundamental frequency but you don't want all the harmonics of that frequency. The Fourier representation, if you happen to have a single frequency. </span></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;</span></span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; We will discuss two cases with different component representations:</span></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;</span></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a><span class="ss">  1. </span>$\omega \in (0,\pi)$ </span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a><span class="ss">  1. </span>$\omega = \pi \implies <span class="sc">\{</span> 1,1,\cdot, \cdot<span class="sc">\}</span>$ </span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;</span></span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; In the case of any frequency $\omega \in (0,\pi)$, we will have a DLM that has this structure: </span></span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>$$<span class="sc">\{</span> \underbrace {E_2}_{F},  \underbrace {J_2(1,\omega)}_{G}, \underbrace{\cdot}_{v_t}, \underbrace{\cdot}_{W_t}<span class="sc">\}</span></span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>$$ {#eq-fourier-1}</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>We will have the $F$ vector the 2-dimensional vector:</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>E_2=(1,0)'</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>$$ {#eq-fourier-2}</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>As usual and the $G$ matrix will be the 2 by 2 matrix:</span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>J_2(1, \omega) = </span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a>\begin{pmatrix}</span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a>\cos(\omega) &amp; \sin(\omega) <span class="sc">\\</span></span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>-\sin(\omega) &amp; \cos(\omega)</span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>\end{pmatrix},</span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a>$$ {#eq-fourier-3}</span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a>where $\omega$ is the frequency that we are considering.</span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a>Since this is a 2 by 2 matrix the our state parameter vector will also be a vector of dimension 2. </span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a>If we think about the forecast function, $f_t(h)$  h-steps ahead, (you are at time $t$ and you want to look for $h$ steps ahead). </span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a>Let's recall: the way we work with this is  $F* G^h * a_t$</span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a>going to be your $E_2'$, then you have to take this G matrix, which is just this $J_2(1,\omega)^h$, and then you have a vector, I'm going to call $a_t$ and $b_t$, which is just going to be this vector value of your Theta t vector given the information up to the time t. It's going to have two components, I'm just going to generically call them $a_t$ and $b_t$. When you take this to the power of h using just trigonometric results, you're going to get that $J_2(1,\omega)^h$, is just going to give you cosine of Omega h sine of Omega h minus sine of Omega h cosine of Omega h. When you look at this expression, you get something that looks like this, and then you have, again, times these $a_t$, $b_t$.</span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true" tabindex="-1"></a>f_t(h) &amp;= E_2' <span class="co">[</span><span class="ot">J_2(1, \omega)</span><span class="co">]</span>^h \underbrace{\begin{pmatrix} a_t <span class="sc">\\</span> b_t \end{pmatrix}}_{\mathbb{E}<span class="co">[</span><span class="ot">\theta\mid \mathcal{D}</span><span class="co">]</span>} <span class="sc">\\</span></span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true" tabindex="-1"></a>&amp;= (1,0) \begin{pmatrix} \cos(\omega h) &amp; \sin(\omega h) <span class="sc">\\</span> -\sin(\omega h) &amp; \cos(\omega h) \end{pmatrix} \begin{pmatrix} a_t <span class="sc">\\</span> b_t \end{pmatrix} <span class="sc">\\</span></span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true" tabindex="-1"></a>&amp;= a_t \cos(\omega h) + b_t \sin(\omega h) <span class="sc">\\</span></span>
<span id="cb12-87"><a href="#cb12-87" aria-hidden="true" tabindex="-1"></a>&amp;= A_t \cos(\omega h + B_t).</span>
<span id="cb12-88"><a href="#cb12-88" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb12-89"><a href="#cb12-89" aria-hidden="true" tabindex="-1"></a>$$ {#eq-seasonal-forecast-function}</span>
<span id="cb12-90"><a href="#cb12-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-91"><a href="#cb12-91" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;</span></span>
<span id="cb12-92"><a href="#cb12-92" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; You're going to have the cosine and sine only multiplied by this. In the end, you're going to have something that looks like this.</span></span>
<span id="cb12-93"><a href="#cb12-93" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;</span></span>
<span id="cb12-94"><a href="#cb12-94" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; You have this sinusoidal form with the period Omega in your forecast function. You can also write this down in terms of an amplitude that I'm going to call A_t and then a phase that is B_t. Here again, you have your periodicity that appears in this cosine wave. This is again for the case in which you have a single frequency and the frequencies in this range. There was a second case that I mentioned, and that case is the case in which the Omega is exactly Pi. In this case, your Fourier representation is going to be your model that has a state vector that is just one dimensional. In the case where Omega is between zero and Pi, you have a two-dimensional state, vector here you're going to have a one-dimensional state vector.</span></span>
<span id="cb12-95"><a href="#cb12-95" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;</span></span>
<span id="cb12-96"><a href="#cb12-96" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; This is going to be your $F$ and your $G$. Then you have again whatever you want to put here as your $v_t$ and $W_t$. This gives me, if I think about the forecast function, h steps ahead is just going to be something that has the form $-1^h \times a_t$. Now I have a single component here, is uni-dimensional. This is going to have an oscillatory behavior between $a_t$ and $-a_t$ if I were to look $h$ steps ahead forward when I'm at time $t$. These two forms give me the single component Fourier representation and using the superposition principle, we will see that we can combine a single frequency and the corresponding harmonics or several different frequencies just using the superposition principle in the normal dynamic linear model. You can also incorporate more than one component in a full Fourier representation. Usually the way this works is you have a fundamental period, let's say p. For example, if you are recording monthly data, p could be 12 and then you are going to incorporate in the model the fundamental frequency, and then all the harmonics that go with that fundamental frequency related to the period p.</span></span>
<span id="cb12-97"><a href="#cb12-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-98"><a href="#cb12-98" aria-hidden="true" tabindex="-1"></a><span class="al">![slide 1](images/m4_0001.png)</span>{.column-margin  group="slides" width="200px"}</span>
<span id="cb12-99"><a href="#cb12-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-100"><a href="#cb12-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-101"><a href="#cb12-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-102"><a href="#cb12-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-103"><a href="#cb12-103" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;</span></span>
<span id="cb12-104"><a href="#cb12-104" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Here $p$, is the period and in this case, we are going to discuss essentially two different situations. One is when p is an odd number, the other one is when p is an even number. Let's begin with the case of p is odd and in this particular scenario, we can write down p as 2 times m minus 1 for some value of m. This gives me a period that is odd. How many frequencies I'm going to incorporate in this model? I'm going to be able to write down $\omega_j = 2 \pi \times j / p$, which is the fundamental period. j here goes from one all the way to m minus 1. Now we can use the superposition principle thinking we have a component DLM representation for each of these frequencies. They are all going to be between 0 and Pi. For each of them I'm going to have that two-dimensional DLM representation in terms of the state vector and then I can use the superposition principle to concatenate them all and get a model that has all these frequencies, the one related to the fundamental period and all the harmonics for that. Again, if I think about what is my $F$ and my $G$ here, I'm not writing down the t because both F and G are going to be constant over time. So my $F$ is going to be again, I concatenate as many $E_2$ as I have frequencies in here. I'm going to have $E_2$ transpose and so on and I'm going to have m minus one of those. Times 2 gives me the dimension of $\theta_t$. The vector here is 2 times m minus 1 dimensional vector.</span></span>
<span id="cb12-105"><a href="#cb12-105" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;</span></span>
<span id="cb12-106"><a href="#cb12-106" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; My G is going to have that block diagonal structure where we are going to just have all those $J_{2,1} \omega_1$, all the way down to the last harmonic. Each of these blocks is a two-by-two matrix and I'm going to put them together in a block diagonal form. This gives me the representation when the period is odd, what is the structure of the forecast function? Again, using the superposition principle, the forecast function is going to be just the sum of m minus 1 components, where each of those components is going to have an individual forecast function that has that cosine wave representation that we discussed before. Again, if I think about the forecast function at time t h steps ahead, I will be able to write it down like this.</span></span>
<span id="cb12-107"><a href="#cb12-107" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;</span></span>
<span id="cb12-108"><a href="#cb12-108" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; This should be a B. $B_{t,j}$. Again here, I have an amplitude for each of the components and a phase for each of the components so it depends on time but does not depend on h. The h enters here, and this is my forecast function. In the case of P even the situation is slightly different. But again, it's the same in terms of using the superposition principle. In this case, we can write down P as 2 times m because it's an even number. Now I can write down these Omega j's as a function of the fundamental period. Again, this goes from 1 up to m minus 1. But there is a last frequency here. When j is equal to m, this simplifies to be the **Nyquist frequency**. In this case, I have my Omega is equal to Pi. In this particular case, when I concatenate everything, I'm going to have again an F and a G that look like this. Once again, I concatenate all of these up to the component m minus 1. Then I have this 1 for the last frequency. Then my G is going to be the block diagonal.</span></span>
<span id="cb12-109"><a href="#cb12-109" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;</span></span>
<span id="cb12-110"><a href="#cb12-110" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; For the last frequency I have that minus 1. This determines the dimension of the state vector, in this case I'm going to have 2 times m minus 1 plus 1.</span></span>
<span id="cb12-111"><a href="#cb12-111" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;</span></span>
<span id="cb12-112"><a href="#cb12-112" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; My f function, my forecast function, is again a function of the number of steps ahead. I'm going to have the same structure I had before for the m minus 1 components.</span></span>
<span id="cb12-113"><a href="#cb12-113" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Then I have to add one more component that corresponds to the frequency Pi.</span></span>
<span id="cb12-114"><a href="#cb12-114" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; This one appears with the power of h. As you can see, I'm using once again the superposition principle to go from component representation to the full Fourier representation. In practice, once we set the period, we can use a model that has the fundamental period and all the harmonics related to that fundamental period. We could also use, discard some of those harmonics and use a subset of them. This is one of the things that the Fourier representation allows. It allows you to be flexible in terms of how many components you want to add in this model. There are other representations that are also used in practice. One of them is the seasonal factors representation. In that case, you're going to have a model in which the state vector has dimension p for a given period. It uses a G matrix that is a permutation matrix. There is a correspondence between this parameterization using the Fourier representation and that other parameterization. If you want to use that parameterization, the way to interpret the components of this state vector, since you have P of those, is going to be a representation in terms of factors. For example, if you think about monthly data, you will have the say January factor, February factor, March factor, and so on. You could think about those effects and do a correspondence with this particular model. We will always work in this class with these representations because it's more flexible. But again, you can go back and forth between one and the other.</span></span>
<span id="cb12-115"><a href="#cb12-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-116"><a href="#cb12-116" aria-hidden="true" tabindex="-1"></a><span class="al">![slide 2](images/m4_0002.png)</span>{.column-margin group="slides" width="200px"}</span>
<span id="cb12-117"><a href="#cb12-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-118"><a href="#cb12-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-119"><a href="#cb12-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-120"><a href="#cb12-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-121"><a href="#cb12-121" aria-hidden="true" tabindex="-1"></a><span class="fu">## Fourier Representation: Example 1 (Reading)</span></span>
<span id="cb12-122"><a href="#cb12-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-123"><a href="#cb12-123" aria-hidden="true" tabindex="-1"></a><span class="fu">### Seasonal Models</span></span>
<span id="cb12-124"><a href="#cb12-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-125"><a href="#cb12-125" aria-hidden="true" tabindex="-1"></a>Example: Full Fourier Model with $p=5$</span>
<span id="cb12-126"><a href="#cb12-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-127"><a href="#cb12-127" aria-hidden="true" tabindex="-1"></a>In this case the Fourier frequencies are</span>
<span id="cb12-128"><a href="#cb12-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-129"><a href="#cb12-129" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$ω_1 = 2π/5$ and </span>
<span id="cb12-130"><a href="#cb12-130" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$ω_2 = 4π/5$ and so</span>
<span id="cb12-131"><a href="#cb12-131" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$p = 2 × 3 − 1$. Then, </span>
<span id="cb12-132"><a href="#cb12-132" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$m = 3$ and </span>
<span id="cb12-133"><a href="#cb12-133" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\theta_t = (\theta_{t,1}, \ldots , \theta_{t,4})′$, </span>
<span id="cb12-134"><a href="#cb12-134" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$F = (1, 0, 1, 0)$, </span>
<span id="cb12-135"><a href="#cb12-135" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$G$ is given by:</span>
<span id="cb12-136"><a href="#cb12-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-137"><a href="#cb12-137" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-138"><a href="#cb12-138" aria-hidden="true" tabindex="-1"></a>G = \begin{bmatrix}</span>
<span id="cb12-139"><a href="#cb12-139" aria-hidden="true" tabindex="-1"></a>\cos(2\pi/5) &amp; \sin(2\pi/5) &amp; 0 &amp; 0 <span class="sc">\\</span></span>
<span id="cb12-140"><a href="#cb12-140" aria-hidden="true" tabindex="-1"></a>\cos(4\pi/5) &amp; \sin(4\pi/5) &amp; 0 &amp; 0 <span class="sc">\\</span></span>
<span id="cb12-141"><a href="#cb12-141" aria-hidden="true" tabindex="-1"></a>0 &amp; 0 &amp; \cos(2\pi/5) &amp; \sin(2\pi/5) <span class="sc">\\</span></span>
<span id="cb12-142"><a href="#cb12-142" aria-hidden="true" tabindex="-1"></a>0 &amp; 0 &amp; \cos(4\pi/5) &amp; \sin(4\pi/5) <span class="sc">\\</span></span>
<span id="cb12-143"><a href="#cb12-143" aria-hidden="true" tabindex="-1"></a>0 &amp; 0 &amp; 0 &amp; 0</span>
<span id="cb12-144"><a href="#cb12-144" aria-hidden="true" tabindex="-1"></a>\end{bmatrix}</span>
<span id="cb12-145"><a href="#cb12-145" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-146"><a href="#cb12-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-147"><a href="#cb12-147" aria-hidden="true" tabindex="-1"></a>and the forecast function is:</span>
<span id="cb12-148"><a href="#cb12-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-149"><a href="#cb12-149" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-150"><a href="#cb12-150" aria-hidden="true" tabindex="-1"></a>f_t(h) = A_{t,1} \cos(2\pi h/5 + \gamma_t) + A_{t,2} \cos(4\pi h /5 + \gamma_{t,2}) \qquad</span>
<span id="cb12-151"><a href="#cb12-151" aria-hidden="true" tabindex="-1"></a>$$ {#eq-forecast-function}</span>
<span id="cb12-152"><a href="#cb12-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-153"><a href="#cb12-153" aria-hidden="true" tabindex="-1"></a><span class="fu">## Building NDLMs with multiple components: Examples (Video)</span></span>
<span id="cb12-154"><a href="#cb12-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-155"><a href="#cb12-155" aria-hidden="true" tabindex="-1"></a><span class="al">![two component model](images/m4_0011.png)</span>{.column-margin  group="slides" width="200px"}</span>
<span id="cb12-156"><a href="#cb12-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-157"><a href="#cb12-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-158"><a href="#cb12-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-159"><a href="#cb12-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-160"><a href="#cb12-160" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; [In this second example, we are going to have two components; a linear trend plus a seasonal component where the fundamental period is four.</span></span>
<span id="cb12-161"><a href="#cb12-161" aria-hidden="true" tabindex="-1"></a><span class="at">The way to build this model, again, is using the superposition principle.]{.mark} </span></span>
<span id="cb12-162"><a href="#cb12-162" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;</span></span>
<span id="cb12-163"><a href="#cb12-163" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; First we need to think "what *structure* do we need, to get a *linear trend* in the **forecast function**?" </span></span>
<span id="cb12-164"><a href="#cb12-164" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;</span></span>
<span id="cb12-165"><a href="#cb12-165" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;The linear trend is a linear function on the number of steps ahead. </span></span>
<span id="cb12-166"><a href="#cb12-166" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;</span></span>
<span id="cb12-167"><a href="#cb12-167" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Whenever you have that structure, you will get a DLM that is the so-called **polynomial model of order 2**. So let's discuss first the linear. Let's say the linear trend part, and in this case, we have an $F$ and a $G$, I'm going to call them 1, $F_1$ and $G_1$ to denote that this is the first component in the model.</span></span>
<span id="cb12-168"><a href="#cb12-168" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;</span></span>
<span id="cb12-169"><a href="#cb12-169" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;</span></span>
<span id="cb12-170"><a href="#cb12-170" aria-hidden="true" tabindex="-1"></a><span class="at">$F_1$ is just going to be 1, 0 transpose, and the $G_1$ is that upper triangular matrix, it's a 2 by 2 matrix that has 1, 1 in the first row, 0, 1 in the second row, so this gives me a linear trend. </span></span>
<span id="cb12-171"><a href="#cb12-171" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;</span></span>
<span id="cb12-172"><a href="#cb12-172" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; My forecast function, let's call it $f_{1,t}$ in terms of the number of steps ahead is just a linear function on h, is a linear polynomial order 1. Let's say it's a constant of $K$ but depends on t0 plus $K_{t_1}^h$. This is the structure of the first component. Then I have to think about the seasonal component with period of four. If we are going to incorporate all the harmonics, we have to think again, is this an even period or a not period? In this example, this is an even period. I can write p, which is 4, as 2 times 2, so this gives me that m. I'm going to have one frequency, the first one, Omega 1, is related to the fundamental period of 4, so is 2 Pi over 4, which I can simplify and write down this as Pi over 2. This is the first frequency. The last one is going to correspond to the Nyquist.</span></span>
<span id="cb12-173"><a href="#cb12-173" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;</span></span>
<span id="cb12-174"><a href="#cb12-174" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; We could obtain that doing 4Pi over 4, which is just Pi. As you remember, this component is going to require a two-dimensional DLM component model, this one is going to require a one-dimensional DLM component model in terms of the dimension here is the dimension of the state vectors. When we build this concatenating these components, we are going to have, again, let's call it F_2 and G_2 for this particular component. I had called this here a, let's call this b. My F_2 has that E_2 transpose and a 1, which gives me just 1, 0, 1. My G matrix is going to be a 3 by 3 matrix. The first component is</span></span>
<span id="cb12-175"><a href="#cb12-175" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;</span></span>
<span id="cb12-176"><a href="#cb12-176" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;the component associated to that fundamental period. It's a block diagonal again, and I'm going to have that J_2, 1 Omega 1, and then I have my minus 1 here. What this means is if I write this down as a matrix, let me write it here, G_2 is going to be cosine of that Pi halves,</span></span>
<span id="cb12-177"><a href="#cb12-177" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;</span></span>
<span id="cb12-178"><a href="#cb12-178" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;and then I have zeros here, I have my minus 1 here, 0, and 0. I can further simplify these to have this structure. The cosine of Pi halves is 0, the sine is 1, so I can write this down as 0, 1, 0, minus 1, 0, 0, and 0, 0 minus 1. Now if I want to go back to just having a model that has both components, I use the superposition principle again and combine this component with this component. The linear plus seasonal</span></span>
<span id="cb12-179"><a href="#cb12-179" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;</span></span>
<span id="cb12-180"><a href="#cb12-180" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;</span></span>
<span id="cb12-181"><a href="#cb12-181" aria-hidden="true" tabindex="-1"></a><span class="at">is a model that is going to have the representation $F$, $G$, with $F$ is going to be just concatenate $F_1$ and $F_2$. $G$ now has that block diagonal form again.</span></span>
<span id="cb12-182"><a href="#cb12-182" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;</span></span>
<span id="cb12-183"><a href="#cb12-183" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;If I look at what I have, I have this block that is a 2 by 2, this block that is a 3 by 3. Therefore my model is going to be a five-dimensional model in terms of the state parameter vector, so this G is a 5 by 5, and this one is also a five-dimensional vector. Finally, if I think about the forecast function in this case, if I call here the forecast function $f_{2,t}$ for the component that is seasonal, I'm going to have my A_t1 cosine of Pi halves h plus $B_{t,1}$, and then I have my $A_{t,2}$ minus 1^h. My forecast function for the final model is going to be just the sum of these two components.</span></span>
<span id="cb12-184"><a href="#cb12-184" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;</span></span>
<span id="cb12-185"><a href="#cb12-185" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;You can see how I can now put together all these blocks, so I have a block that is seasonal and a block that is a linear polynomial model, and I can put them together in a single model just to create a more flexible structure. You could add regression components, you could add autoregressive components and put together as many components as you need for the forecast function to have the form that you expect it to have. All of these models are using, again, the superposition principle and the fact that we're working with a linear and Gaussian structure in terms of doing the posterior inference later.</span></span>
<span id="cb12-186"><a href="#cb12-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-187"><a href="#cb12-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-188"><a href="#cb12-188" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary: DLM Fourier representation (Reading)</span></span>
<span id="cb12-189"><a href="#cb12-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-190"><a href="#cb12-190" aria-hidden="true" tabindex="-1"></a><span class="fu">### Seasonal Models: Fourier Representation</span></span>
<span id="cb12-191"><a href="#cb12-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-192"><a href="#cb12-192" aria-hidden="true" tabindex="-1"></a>For any frequency $\omega \in (0, \pi)$, a model of the form $<span class="sc">\{</span>E_2, J_2(1, \omega), \cdot, \cdot<span class="sc">\}</span>$ with a 2-dimensional state vector $\theta_t = (\theta_{t,1}, \theta_{t,2})'$ and</span>
<span id="cb12-193"><a href="#cb12-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-194"><a href="#cb12-194" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-195"><a href="#cb12-195" aria-hidden="true" tabindex="-1"></a>J_2(1, \omega) = </span>
<span id="cb12-196"><a href="#cb12-196" aria-hidden="true" tabindex="-1"></a>\begin{pmatrix}</span>
<span id="cb12-197"><a href="#cb12-197" aria-hidden="true" tabindex="-1"></a>\cos(\omega) &amp; \sin(\omega) <span class="sc">\\</span></span>
<span id="cb12-198"><a href="#cb12-198" aria-hidden="true" tabindex="-1"></a>-\sin(\omega) &amp; \cos(\omega)</span>
<span id="cb12-199"><a href="#cb12-199" aria-hidden="true" tabindex="-1"></a>\end{pmatrix},</span>
<span id="cb12-200"><a href="#cb12-200" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-201"><a href="#cb12-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-202"><a href="#cb12-202" aria-hidden="true" tabindex="-1"></a>has a forecast function</span>
<span id="cb12-203"><a href="#cb12-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-204"><a href="#cb12-204" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-205"><a href="#cb12-205" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb12-206"><a href="#cb12-206" aria-hidden="true" tabindex="-1"></a>f_t(h) &amp;= (1, 0) J_2^h(1, \omega) (a_t, b_t) <span class="sc">\\</span></span>
<span id="cb12-207"><a href="#cb12-207" aria-hidden="true" tabindex="-1"></a>       &amp;= a_t \cos(\omega h) + b_t \sin(\omega h) <span class="sc">\\</span></span>
<span id="cb12-208"><a href="#cb12-208" aria-hidden="true" tabindex="-1"></a>       &amp;= A_t \cos(\omega h + B_t).</span>
<span id="cb12-209"><a href="#cb12-209" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb12-210"><a href="#cb12-210" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-211"><a href="#cb12-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-212"><a href="#cb12-212" aria-hidden="true" tabindex="-1"></a>For $\omega = \pi$, the NDLM is $<span class="sc">\{</span>1, -1, \cdot, \cdot<span class="sc">\}</span>$ and has a forecast function of the form</span>
<span id="cb12-213"><a href="#cb12-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-214"><a href="#cb12-214" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-215"><a href="#cb12-215" aria-hidden="true" tabindex="-1"></a>f_t(h) = (-1)^h m_t</span>
<span id="cb12-216"><a href="#cb12-216" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb12-217"><a href="#cb12-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-218"><a href="#cb12-218" aria-hidden="true" tabindex="-1"></a>These are component Fourier models. Now, for a given period $p$, we can build a model that contains components for the fundamental period and all the harmonics of such a period using the superposition principle as follows:</span>
<span id="cb12-219"><a href="#cb12-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-220"><a href="#cb12-220" aria-hidden="true" tabindex="-1"></a><span class="fu">### Case: $p = 2m - 1$ (odd)</span></span>
<span id="cb12-221"><a href="#cb12-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-222"><a href="#cb12-222" aria-hidden="true" tabindex="-1"></a>Let $\omega_j = 2\pi j / p$ for $j = 1 : (m - 1)$, $F$ a $(p - 1)$-dimensional vector, or equivalently, a $2(m - 1)$-dimensional vector, and $G$ a $(p - 1) \times (p - 1)$ matrix with $F = (E_2', E_2', \dots, E_2')'$, </span>
<span id="cb12-223"><a href="#cb12-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-224"><a href="#cb12-224" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-225"><a href="#cb12-225" aria-hidden="true" tabindex="-1"></a>G = \text{blockdiag}<span class="co">[</span><span class="ot">J_2(1, \omega_1), \dots, J_2(1, \omega_{m-1})</span><span class="co">]</span>.</span>
<span id="cb12-226"><a href="#cb12-226" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-227"><a href="#cb12-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-228"><a href="#cb12-228" aria-hidden="true" tabindex="-1"></a><span class="fu">### Case: $p = 2m$ (even)</span></span>
<span id="cb12-229"><a href="#cb12-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-230"><a href="#cb12-230" aria-hidden="true" tabindex="-1"></a>In this case, $F$ is again a $(p - 1)$-dimensional vector (or equivalently a $(2m - 1)$-dimensional vector), and $G$ is a $(p - 1) \times (p - 1)$ matrix such that $F = (E_2', \dots, E_2', 1)'$ and </span>
<span id="cb12-231"><a href="#cb12-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-232"><a href="#cb12-232" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-233"><a href="#cb12-233" aria-hidden="true" tabindex="-1"></a>G = \text{blockdiag}<span class="co">[</span><span class="ot">J_2(1, \omega_1), \dots, J_2(1, \omega_{m-1}), -1</span><span class="co">]</span>.</span>
<span id="cb12-234"><a href="#cb12-234" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-235"><a href="#cb12-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-236"><a href="#cb12-236" aria-hidden="true" tabindex="-1"></a>In both cases, the forecast function has the general form:</span>
<span id="cb12-237"><a href="#cb12-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-238"><a href="#cb12-238" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-239"><a href="#cb12-239" aria-hidden="true" tabindex="-1"></a>f_t(h) = \sum_{j=1}^{m-1} A_{t,j} \cos(\omega_j h + \gamma_{t,j}) + (-1)^h A_{t,m},</span>
<span id="cb12-240"><a href="#cb12-240" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-241"><a href="#cb12-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-242"><a href="#cb12-242" aria-hidden="true" tabindex="-1"></a>with $A_{t,m} = 0$ if $p$ is odd.</span>
<span id="cb12-243"><a href="#cb12-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-244"><a href="#cb12-244" aria-hidden="true" tabindex="-1"></a><span class="fu">## Examples</span></span>
<span id="cb12-245"><a href="#cb12-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-246"><a href="#cb12-246" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fourier Representation, $p = 12$:</span></span>
<span id="cb12-247"><a href="#cb12-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-248"><a href="#cb12-248" aria-hidden="true" tabindex="-1"></a>In this case, $p = 2 \times 6$ so $\theta_t$ is an 11-dimensional state vector, </span>
<span id="cb12-249"><a href="#cb12-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-250"><a href="#cb12-250" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-251"><a href="#cb12-251" aria-hidden="true" tabindex="-1"></a>F = (1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1)',</span>
<span id="cb12-252"><a href="#cb12-252" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb12-253"><a href="#cb12-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-254"><a href="#cb12-254" aria-hidden="true" tabindex="-1"></a>the Fourier frequencies are $\omega_1 = 2\pi/12$, $\omega_2 = 4\pi/12 = 2\pi/6$, $\omega_3 = 6\pi/12 = 2\pi/4$, $\omega_4 = 8\pi/12 = 2\pi/3$, $\omega_5 = 10\pi/12 = 5\pi/6$, and $\omega_6 = 12\pi/12 = \pi$ (the Nyquist frequency). </span>
<span id="cb12-255"><a href="#cb12-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-256"><a href="#cb12-256" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-257"><a href="#cb12-257" aria-hidden="true" tabindex="-1"></a>G = \text{blockdiag}(J_2(1, \omega_1), \dots, J_2(1, \omega_5), 1)</span>
<span id="cb12-258"><a href="#cb12-258" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-259"><a href="#cb12-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-260"><a href="#cb12-260" aria-hidden="true" tabindex="-1"></a>and the forecast function is given by:</span>
<span id="cb12-261"><a href="#cb12-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-262"><a href="#cb12-262" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-263"><a href="#cb12-263" aria-hidden="true" tabindex="-1"></a>f_t(h) = \sum_{j=1}^{5} A_{t,j} \cos(2\pi j / 12 + \gamma_{t,j}) + (-1)^h A_{t,6}.</span>
<span id="cb12-264"><a href="#cb12-264" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-265"><a href="#cb12-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-266"><a href="#cb12-266" aria-hidden="true" tabindex="-1"></a><span class="fu">### Linear Trend + Seasonal Component with $p = 4$</span></span>
<span id="cb12-267"><a href="#cb12-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-268"><a href="#cb12-268" aria-hidden="true" tabindex="-1"></a>We can use the superposition principle to build more sophisticated models. For instance, assume that we want a model with the following 2 components:</span>
<span id="cb12-269"><a href="#cb12-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-270"><a href="#cb12-270" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Linear trend**: $<span class="sc">\{</span>F_1, G_1, \cdot, \cdot<span class="sc">\}</span>$ with $F_1 = (1, 0)'$,</span>
<span id="cb12-271"><a href="#cb12-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-272"><a href="#cb12-272" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-273"><a href="#cb12-273" aria-hidden="true" tabindex="-1"></a>G_1 = J_2(1) = </span>
<span id="cb12-274"><a href="#cb12-274" aria-hidden="true" tabindex="-1"></a>\begin{pmatrix}</span>
<span id="cb12-275"><a href="#cb12-275" aria-hidden="true" tabindex="-1"></a>1 &amp; 1 <span class="sc">\\</span></span>
<span id="cb12-276"><a href="#cb12-276" aria-hidden="true" tabindex="-1"></a>0 &amp; 1</span>
<span id="cb12-277"><a href="#cb12-277" aria-hidden="true" tabindex="-1"></a>\end{pmatrix}.</span>
<span id="cb12-278"><a href="#cb12-278" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-279"><a href="#cb12-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-280"><a href="#cb12-280" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Full seasonal model with $p = 4$**: $<span class="sc">\{</span>F_2, G_2, \cdot, \cdot<span class="sc">\}</span>$, $p = 2 \times 2$ so $m = 2$ and $\omega = 2\pi / 4 = \pi / 2$, </span>
<span id="cb12-281"><a href="#cb12-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-282"><a href="#cb12-282" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-283"><a href="#cb12-283" aria-hidden="true" tabindex="-1"></a>F_2 = (1, 0, 1)',</span>
<span id="cb12-284"><a href="#cb12-284" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb12-285"><a href="#cb12-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-286"><a href="#cb12-286" aria-hidden="true" tabindex="-1"></a>and </span>
<span id="cb12-287"><a href="#cb12-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-288"><a href="#cb12-288" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-289"><a href="#cb12-289" aria-hidden="true" tabindex="-1"></a>G_2 = </span>
<span id="cb12-290"><a href="#cb12-290" aria-hidden="true" tabindex="-1"></a>\begin{pmatrix}</span>
<span id="cb12-291"><a href="#cb12-291" aria-hidden="true" tabindex="-1"></a>\cos(\pi / 2) &amp; \sin(\pi / 2) &amp; 0 <span class="sc">\\</span></span>
<span id="cb12-292"><a href="#cb12-292" aria-hidden="true" tabindex="-1"></a>-\sin(\pi / 2) &amp; \cos(\pi / 2) &amp; 0 <span class="sc">\\</span></span>
<span id="cb12-293"><a href="#cb12-293" aria-hidden="true" tabindex="-1"></a>0 &amp; 0 &amp; -1</span>
<span id="cb12-294"><a href="#cb12-294" aria-hidden="true" tabindex="-1"></a>\end{pmatrix}</span>
<span id="cb12-295"><a href="#cb12-295" aria-hidden="true" tabindex="-1"></a>= </span>
<span id="cb12-296"><a href="#cb12-296" aria-hidden="true" tabindex="-1"></a>\begin{pmatrix}</span>
<span id="cb12-297"><a href="#cb12-297" aria-hidden="true" tabindex="-1"></a>0 &amp; 1 &amp; 0 <span class="sc">\\</span></span>
<span id="cb12-298"><a href="#cb12-298" aria-hidden="true" tabindex="-1"></a>-1 &amp; 0 &amp; 0 <span class="sc">\\</span></span>
<span id="cb12-299"><a href="#cb12-299" aria-hidden="true" tabindex="-1"></a>0 &amp; 0 &amp; -1</span>
<span id="cb12-300"><a href="#cb12-300" aria-hidden="true" tabindex="-1"></a>\end{pmatrix}.</span>
<span id="cb12-301"><a href="#cb12-301" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-302"><a href="#cb12-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-303"><a href="#cb12-303" aria-hidden="true" tabindex="-1"></a>The resulting DLM is a 5-dimensional model $<span class="sc">\{</span>F, G, \cdot, \cdot<span class="sc">\}</span>$ with</span>
<span id="cb12-304"><a href="#cb12-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-305"><a href="#cb12-305" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-306"><a href="#cb12-306" aria-hidden="true" tabindex="-1"></a>F = (1, 0, 1, 0, 1)',</span>
<span id="cb12-307"><a href="#cb12-307" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb12-308"><a href="#cb12-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-309"><a href="#cb12-309" aria-hidden="true" tabindex="-1"></a>and </span>
<span id="cb12-310"><a href="#cb12-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-311"><a href="#cb12-311" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-312"><a href="#cb12-312" aria-hidden="true" tabindex="-1"></a>G = </span>
<span id="cb12-313"><a href="#cb12-313" aria-hidden="true" tabindex="-1"></a>\begin{pmatrix}</span>
<span id="cb12-314"><a href="#cb12-314" aria-hidden="true" tabindex="-1"></a>1 &amp; 1 &amp; 0 &amp; 0 &amp; 0 <span class="sc">\\</span></span>
<span id="cb12-315"><a href="#cb12-315" aria-hidden="true" tabindex="-1"></a>0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 <span class="sc">\\</span></span>
<span id="cb12-316"><a href="#cb12-316" aria-hidden="true" tabindex="-1"></a>0 &amp; 0 &amp; 0 &amp; 1 &amp; 0 <span class="sc">\\</span></span>
<span id="cb12-317"><a href="#cb12-317" aria-hidden="true" tabindex="-1"></a>0 &amp; 0 &amp; -1 &amp; 0 &amp; 0 <span class="sc">\\</span></span>
<span id="cb12-318"><a href="#cb12-318" aria-hidden="true" tabindex="-1"></a>0 &amp; 0 &amp; 0 &amp; 0 &amp; -1</span>
<span id="cb12-319"><a href="#cb12-319" aria-hidden="true" tabindex="-1"></a>\end{pmatrix}.</span>
<span id="cb12-320"><a href="#cb12-320" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-321"><a href="#cb12-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-322"><a href="#cb12-322" aria-hidden="true" tabindex="-1"></a>The forecast function is:</span>
<span id="cb12-323"><a href="#cb12-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-324"><a href="#cb12-324" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-325"><a href="#cb12-325" aria-hidden="true" tabindex="-1"></a>f_t(h) = (k_{t,1} + k_{t,2} h) + k_{t,3} \cos(\pi h / 2) + k_{t,4} \sin(\pi h / 2) + k_{t,5} (-1)^h.</span>
<span id="cb12-326"><a href="#cb12-326" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-327"><a href="#cb12-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-328"><a href="#cb12-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-329"><a href="#cb12-329" aria-hidden="true" tabindex="-1"></a><span class="fu">## Quiz: Seasonal Models and Superposition</span></span>
<span id="cb12-330"><a href="#cb12-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-331"><a href="#cb12-331" aria-hidden="true" tabindex="-1"></a>This is omitted due to the Coursera honor code.</span>
<span id="cb12-332"><a href="#cb12-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-333"><a href="#cb12-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-334"><a href="#cb12-334" aria-hidden="true" tabindex="-1"></a><span class="fu"># Bayesian Inference in the NDLM: Part 2</span></span>
<span id="cb12-335"><a href="#cb12-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-336"><a href="#cb12-336" aria-hidden="true" tabindex="-1"></a><span class="fu">## Filtering, Smoothing and Forecasting: Unknown observational variance (Video)</span></span>
<span id="cb12-337"><a href="#cb12-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-338"><a href="#cb12-338" aria-hidden="true" tabindex="-1"></a>In this video we cover the following material aslo provided as a handout:</span>
<span id="cb12-339"><a href="#cb12-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-340"><a href="#cb12-340" aria-hidden="true" tabindex="-1"></a>Inference in the NDLM with unknown but constant observational variance:</span>
<span id="cb12-341"><a href="#cb12-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-342"><a href="#cb12-342" aria-hidden="true" tabindex="-1"></a>Let $v_t = v$ for all $t$, with $v$ unknown and consider a DLM with the following</span>
<span id="cb12-343"><a href="#cb12-343" aria-hidden="true" tabindex="-1"></a>structure:</span>
<span id="cb12-344"><a href="#cb12-344" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-345"><a href="#cb12-345" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb12-346"><a href="#cb12-346" aria-hidden="true" tabindex="-1"></a>y_t &amp;= \mathbf{F}_t' \mathbf{\theta}_t + \nu_t, &amp;\nu_t &amp;\sim N (0, v)<span class="sc">\\</span></span>
<span id="cb12-347"><a href="#cb12-347" aria-hidden="true" tabindex="-1"></a>\mathbf{\theta}_t &amp;= \mathbf{G}_t \mathbf{\theta}_{t-1} + \mathbf{\omega}_t, &amp; \mathbf{\omega}_t &amp;\sim N (0, v \mathbf{W}^*_t)</span>
<span id="cb12-348"><a href="#cb12-348" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb12-349"><a href="#cb12-349" aria-hidden="true" tabindex="-1"></a>$$ {#eq-NDLM-unknown-variance}</span>
<span id="cb12-350"><a href="#cb12-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-351"><a href="#cb12-351" aria-hidden="true" tabindex="-1"></a>with conjugate prior distributions:</span>
<span id="cb12-352"><a href="#cb12-352" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-353"><a href="#cb12-353" aria-hidden="true" tabindex="-1"></a>(\mathbf{\theta}_0 \mid D_0, v) \sim N (\mathbf{m}_0, v\mathbf{C}^*_0), \qquad (v \mid D_0) \sim IG(\frac{n_0}{2}, \frac{d_0}{2}),</span>
<span id="cb12-354"><a href="#cb12-354" aria-hidden="true" tabindex="-1"></a>$$ {#eq-NDLM-unknown-variance-priors}</span>
<span id="cb12-355"><a href="#cb12-355" aria-hidden="true" tabindex="-1"></a>and $d_0 = n_0s_0$</span>
<span id="cb12-356"><a href="#cb12-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-357"><a href="#cb12-357" aria-hidden="true" tabindex="-1"></a><span class="fu">### Filtering</span></span>
<span id="cb12-358"><a href="#cb12-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-359"><a href="#cb12-359" aria-hidden="true" tabindex="-1"></a>Assuming $(\theta_{t-1} \mid D_{t-1}, v) \sim N (m_{t-1}, vC^*_{t-1})$, we have the following results:</span>
<span id="cb12-360"><a href="#cb12-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-361"><a href="#cb12-361" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$(\theta_t \mid D_{t-1}, v) \sim N (a_t, vR^*_t)$ with $a_t = G_t m_{t-1}$ and $R^*_t = G_t C^*_{t-1} G'_t + W^*_t$, and unconditional on $v$, $(\theta_t \mid D_{t-1}) \sim T_{n_{t-1}} (a_t, R_t)$, with $R_t = s_{t-1} R^*_t$. The expression for $s_t$ for all $t$ is given below.</span>
<span id="cb12-362"><a href="#cb12-362" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$(y_t \mid D_{t-1}, v) \sim N (f_t, vq^*_t)$, with $f_t = F'_t a_t$, and $q^*_t = (1 + F'_t R^*_t F_t)$ and unconditional on $v$ we have $(y_t \mid D_{t-1}) \sim T_{n_{t-1}} (f_t, q_t)$, with $q_t = s_{t-1} q^*_t$.</span>
<span id="cb12-363"><a href="#cb12-363" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$(v \mid D_t) \sim IG(n_t/2, s_t/2)$, with $n_t = n_{t-1} + 1$ and</span>
<span id="cb12-364"><a href="#cb12-364" aria-hidden="true" tabindex="-1"></a>  $$ </span>
<span id="cb12-365"><a href="#cb12-365" aria-hidden="true" tabindex="-1"></a>  s_t = s_{t-1} + \frac{s_{t-1}}{n_t} \left ( \frac{e^2_t}{q^*_t} - 1 \right ), </span>
<span id="cb12-366"><a href="#cb12-366" aria-hidden="true" tabindex="-1"></a>  $$ {#eq-NDLM-unknown-variance-filtering}</span>
<span id="cb12-367"><a href="#cb12-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-368"><a href="#cb12-368" aria-hidden="true" tabindex="-1"></a>  where $e_t = y_t - f_t$</span>
<span id="cb12-369"><a href="#cb12-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-370"><a href="#cb12-370" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>θt|Dt, v) ∼ N (mt, vC∗</span>
<span id="cb12-371"><a href="#cb12-371" aria-hidden="true" tabindex="-1"></a>t ), with mt = at + Atet, and C∗</span>
<span id="cb12-372"><a href="#cb12-372" aria-hidden="true" tabindex="-1"></a>t = R∗</span>
<span id="cb12-373"><a href="#cb12-373" aria-hidden="true" tabindex="-1"></a>t − AtA′</span>
<span id="cb12-374"><a href="#cb12-374" aria-hidden="true" tabindex="-1"></a>tq∗</span>
<span id="cb12-375"><a href="#cb12-375" aria-hidden="true" tabindex="-1"></a>t .</span>
<span id="cb12-376"><a href="#cb12-376" aria-hidden="true" tabindex="-1"></a>Similarly, unconditional on v we have</span>
<span id="cb12-377"><a href="#cb12-377" aria-hidden="true" tabindex="-1"></a>(θt|Dt) ∼ Tnt (mt, Ct),</span>
<span id="cb12-378"><a href="#cb12-378" aria-hidden="true" tabindex="-1"></a>with Ct = stC∗</span>
<span id="cb12-379"><a href="#cb12-379" aria-hidden="true" tabindex="-1"></a>t</span>
<span id="cb12-380"><a href="#cb12-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-381"><a href="#cb12-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-382"><a href="#cb12-382" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary of Filtering, Smoothing and Forecasting Distributions, NDLM unknown observational variance (Reading)</span></span>
<span id="cb12-383"><a href="#cb12-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-384"><a href="#cb12-384" aria-hidden="true" tabindex="-1"></a><span class="fu">## Specifying the system covariance matrix via discount factors (Video)</span></span>
<span id="cb12-385"><a href="#cb12-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-386"><a href="#cb12-386" aria-hidden="true" tabindex="-1"></a><span class="fu">## NDLM, Unknown Observational Variance: Example (Video)</span></span>
<span id="cb12-387"><a href="#cb12-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-388"><a href="#cb12-388" aria-hidden="true" tabindex="-1"></a>This is a walk though of the R code for the example bellow.</span>
<span id="cb12-389"><a href="#cb12-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-390"><a href="#cb12-390" aria-hidden="true" tabindex="-1"></a><span class="fu">## Rcode: NDLM, Unknown Observational Variance Example (Reading)</span></span>
<span id="cb12-391"><a href="#cb12-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-392"><a href="#cb12-392" aria-hidden="true" tabindex="-1"></a>This code allows time-varying $F_t$, $G_t$ and $W_t$  matrices and assumes an unknown but constant $\nu$. It also allows the user to specify $W_t$ using a discount factor $\delta \in (0,1]$ or assume $W_t$  known.</span>
<span id="cb12-393"><a href="#cb12-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-396"><a href="#cb12-396" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-397"><a href="#cb12-397" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: code-NDLM-unknown-variance</span></span>
<span id="cb12-398"><a href="#cb12-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-399"><a href="#cb12-399" aria-hidden="true" tabindex="-1"></a><span class="do">## create list for matrices</span></span>
<span id="cb12-400"><a href="#cb12-400" aria-hidden="true" tabindex="-1"></a>set_up_dlm_matrices_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(Ft, Gt, Wt_star){</span>
<span id="cb12-401"><a href="#cb12-401" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.array</span>(Gt)){</span>
<span id="cb12-402"><a href="#cb12-402" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Stop</span>(<span class="st">"Gt and Ft should be array"</span>)</span>
<span id="cb12-403"><a href="#cb12-403" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-404"><a href="#cb12-404" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">missing</span>(Wt_star)){</span>
<span id="cb12-405"><a href="#cb12-405" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">Ft=</span>Ft, <span class="at">Gt=</span>Gt))</span>
<span id="cb12-406"><a href="#cb12-406" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb12-407"><a href="#cb12-407" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">Ft=</span>Ft, <span class="at">Gt=</span>Gt, <span class="at">Wt_star=</span>Wt_star))</span>
<span id="cb12-408"><a href="#cb12-408" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-409"><a href="#cb12-409" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-410"><a href="#cb12-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-411"><a href="#cb12-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-412"><a href="#cb12-412" aria-hidden="true" tabindex="-1"></a><span class="do">## create list for initial states</span></span>
<span id="cb12-413"><a href="#cb12-413" aria-hidden="true" tabindex="-1"></a>set_up_initial_states_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(m0, C0_star, n0, S0){</span>
<span id="cb12-414"><a href="#cb12-414" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">m0=</span>m0, <span class="at">C0_star=</span>C0_star, <span class="at">n0=</span>n0, <span class="at">S0=</span>S0))</span>
<span id="cb12-415"><a href="#cb12-415" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-416"><a href="#cb12-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-417"><a href="#cb12-417" aria-hidden="true" tabindex="-1"></a>forward_filter_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(data, matrices, </span>
<span id="cb12-418"><a href="#cb12-418" aria-hidden="true" tabindex="-1"></a>                              initial_states, delta){</span>
<span id="cb12-419"><a href="#cb12-419" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve dataset</span></span>
<span id="cb12-420"><a href="#cb12-420" aria-hidden="true" tabindex="-1"></a>  yt <span class="ot">&lt;-</span> data<span class="sc">$</span>yt</span>
<span id="cb12-421"><a href="#cb12-421" aria-hidden="true" tabindex="-1"></a>  T<span class="ot">&lt;-</span> <span class="fu">length</span>(yt)</span>
<span id="cb12-422"><a href="#cb12-422" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-423"><a href="#cb12-423" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb12-424"><a href="#cb12-424" aria-hidden="true" tabindex="-1"></a>  Ft <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Ft</span>
<span id="cb12-425"><a href="#cb12-425" aria-hidden="true" tabindex="-1"></a>  Gt <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Gt</span>
<span id="cb12-426"><a href="#cb12-426" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb12-427"><a href="#cb12-427" aria-hidden="true" tabindex="-1"></a>    Wt_star <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Wt_star</span>
<span id="cb12-428"><a href="#cb12-428" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-429"><a href="#cb12-429" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-430"><a href="#cb12-430" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve initial state</span></span>
<span id="cb12-431"><a href="#cb12-431" aria-hidden="true" tabindex="-1"></a>  m0 <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>m0</span>
<span id="cb12-432"><a href="#cb12-432" aria-hidden="true" tabindex="-1"></a>  C0_star <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>C0_star</span>
<span id="cb12-433"><a href="#cb12-433" aria-hidden="true" tabindex="-1"></a>  n0 <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>n0</span>
<span id="cb12-434"><a href="#cb12-434" aria-hidden="true" tabindex="-1"></a>  S0 <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>S0</span>
<span id="cb12-435"><a href="#cb12-435" aria-hidden="true" tabindex="-1"></a>  C0 <span class="ot">&lt;-</span> S0<span class="sc">*</span>C0_star</span>
<span id="cb12-436"><a href="#cb12-436" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-437"><a href="#cb12-437" aria-hidden="true" tabindex="-1"></a>  <span class="do">## create placeholder for results</span></span>
<span id="cb12-438"><a href="#cb12-438" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">dim</span>(Gt)[<span class="dv">1</span>]</span>
<span id="cb12-439"><a href="#cb12-439" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span>T, <span class="at">ncol=</span>d)</span>
<span id="cb12-440"><a href="#cb12-440" aria-hidden="true" tabindex="-1"></a>  Rt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, T))</span>
<span id="cb12-441"><a href="#cb12-441" aria-hidden="true" tabindex="-1"></a>  ft <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb12-442"><a href="#cb12-442" aria-hidden="true" tabindex="-1"></a>  Qt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb12-443"><a href="#cb12-443" aria-hidden="true" tabindex="-1"></a>  mt <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span>T, <span class="at">ncol=</span>d)</span>
<span id="cb12-444"><a href="#cb12-444" aria-hidden="true" tabindex="-1"></a>  Ct <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, T))</span>
<span id="cb12-445"><a href="#cb12-445" aria-hidden="true" tabindex="-1"></a>  et <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb12-446"><a href="#cb12-446" aria-hidden="true" tabindex="-1"></a>  nt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb12-447"><a href="#cb12-447" aria-hidden="true" tabindex="-1"></a>  St <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb12-448"><a href="#cb12-448" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb12-449"><a href="#cb12-449" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-450"><a href="#cb12-450" aria-hidden="true" tabindex="-1"></a>  <span class="co"># moments of priors at t</span></span>
<span id="cb12-451"><a href="#cb12-451" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T){</span>
<span id="cb12-452"><a href="#cb12-452" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb12-453"><a href="#cb12-453" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> Gt[, , i] <span class="sc">%*%</span> m0</span>
<span id="cb12-454"><a href="#cb12-454" aria-hidden="true" tabindex="-1"></a>      Pt <span class="ot">&lt;-</span> Gt[, , i] <span class="sc">%*%</span> C0 <span class="sc">%*%</span> <span class="fu">t</span>(Gt[, , i])</span>
<span id="cb12-455"><a href="#cb12-455" aria-hidden="true" tabindex="-1"></a>      Pt <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Pt <span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Pt)</span>
<span id="cb12-456"><a href="#cb12-456" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb12-457"><a href="#cb12-457" aria-hidden="true" tabindex="-1"></a>        Wt <span class="ot">&lt;-</span> Wt_star[, , i]<span class="sc">*</span>S0</span>
<span id="cb12-458"><a href="#cb12-458" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Pt <span class="sc">+</span> Wt</span>
<span id="cb12-459"><a href="#cb12-459" aria-hidden="true" tabindex="-1"></a>        Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb12-460"><a href="#cb12-460" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb12-461"><a href="#cb12-461" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Pt<span class="sc">/</span>delta</span>
<span id="cb12-462"><a href="#cb12-462" aria-hidden="true" tabindex="-1"></a>        Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb12-463"><a href="#cb12-463" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb12-464"><a href="#cb12-464" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-465"><a href="#cb12-465" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb12-466"><a href="#cb12-466" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> Gt[, , i] <span class="sc">%*%</span> <span class="fu">t</span>(mt[i<span class="dv">-1</span>, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb12-467"><a href="#cb12-467" aria-hidden="true" tabindex="-1"></a>      Pt <span class="ot">&lt;-</span> Gt[, , i] <span class="sc">%*%</span> Ct[, , i<span class="dv">-1</span>] <span class="sc">%*%</span> <span class="fu">t</span>(Gt[, , i])</span>
<span id="cb12-468"><a href="#cb12-468" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb12-469"><a href="#cb12-469" aria-hidden="true" tabindex="-1"></a>        Wt <span class="ot">&lt;-</span> Wt_star[, , i] <span class="sc">*</span> St[i<span class="dv">-1</span>]</span>
<span id="cb12-470"><a href="#cb12-470" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Pt <span class="sc">+</span> Wt</span>
<span id="cb12-471"><a href="#cb12-471" aria-hidden="true" tabindex="-1"></a>        Rt[,,i]<span class="ot">=</span><span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb12-472"><a href="#cb12-472" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb12-473"><a href="#cb12-473" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Pt<span class="sc">/</span>delta</span>
<span id="cb12-474"><a href="#cb12-474" aria-hidden="true" tabindex="-1"></a>        Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb12-475"><a href="#cb12-475" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb12-476"><a href="#cb12-476" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-477"><a href="#cb12-477" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-478"><a href="#cb12-478" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments of one-step forecast:</span></span>
<span id="cb12-479"><a href="#cb12-479" aria-hidden="true" tabindex="-1"></a>    ft[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , i]) <span class="sc">%*%</span> <span class="fu">t</span>(at[i, , <span class="at">drop=</span><span class="cn">FALSE</span>]) </span>
<span id="cb12-480"><a href="#cb12-480" aria-hidden="true" tabindex="-1"></a>    Qt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , i]) <span class="sc">%*%</span> Rt[, , i] <span class="sc">%*%</span> Ft[, , i] <span class="sc">+</span> </span>
<span id="cb12-481"><a href="#cb12-481" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(i<span class="sc">==</span><span class="dv">1</span>, S0, St[i<span class="dv">-1</span>])</span>
<span id="cb12-482"><a href="#cb12-482" aria-hidden="true" tabindex="-1"></a>    et[i] <span class="ot">&lt;-</span> yt[i] <span class="sc">-</span> ft[i]</span>
<span id="cb12-483"><a href="#cb12-483" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-484"><a href="#cb12-484" aria-hidden="true" tabindex="-1"></a>    nt[i] <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(i<span class="sc">==</span><span class="dv">1</span>, n0, nt[i<span class="dv">-1</span>]) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb12-485"><a href="#cb12-485" aria-hidden="true" tabindex="-1"></a>    St[i] <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(i<span class="sc">==</span><span class="dv">1</span>, S0, </span>
<span id="cb12-486"><a href="#cb12-486" aria-hidden="true" tabindex="-1"></a>                    St[i<span class="dv">-1</span>])<span class="sc">*</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>nt[i]<span class="sc">*</span>(et[i]<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span>Qt[i]<span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb12-487"><a href="#cb12-487" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-488"><a href="#cb12-488" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments of posterior at t:</span></span>
<span id="cb12-489"><a href="#cb12-489" aria-hidden="true" tabindex="-1"></a>    At <span class="ot">&lt;-</span> Rt[, , i] <span class="sc">%*%</span> Ft[, , i] <span class="sc">/</span> Qt[i]</span>
<span id="cb12-490"><a href="#cb12-490" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-491"><a href="#cb12-491" aria-hidden="true" tabindex="-1"></a>    mt[i, ] <span class="ot">&lt;-</span> at[i, ] <span class="sc">+</span> <span class="fu">t</span>(At) <span class="sc">*</span> et[i]</span>
<span id="cb12-492"><a href="#cb12-492" aria-hidden="true" tabindex="-1"></a>    Ct[, , i] <span class="ot">&lt;-</span> St[i]<span class="sc">/</span><span class="fu">ifelse</span>(i<span class="sc">==</span><span class="dv">1</span>, S0, </span>
<span id="cb12-493"><a href="#cb12-493" aria-hidden="true" tabindex="-1"></a>                  St[i<span class="dv">-1</span>])<span class="sc">*</span>(Rt[, , i] <span class="sc">-</span> Qt[i] <span class="sc">*</span> At <span class="sc">%*%</span> <span class="fu">t</span>(At))</span>
<span id="cb12-494"><a href="#cb12-494" aria-hidden="true" tabindex="-1"></a>    Ct[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Ct[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Ct[,,i])</span>
<span id="cb12-495"><a href="#cb12-495" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-496"><a href="#cb12-496" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Forward filtering is completed!</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb12-497"><a href="#cb12-497" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mt =</span> mt, <span class="at">Ct =</span> Ct,  <span class="at">at =</span> at, <span class="at">Rt =</span> Rt, </span>
<span id="cb12-498"><a href="#cb12-498" aria-hidden="true" tabindex="-1"></a>              <span class="at">ft =</span> ft, <span class="at">Qt =</span> Qt,  <span class="at">et =</span> et, </span>
<span id="cb12-499"><a href="#cb12-499" aria-hidden="true" tabindex="-1"></a>              <span class="at">nt =</span> nt, <span class="at">St =</span> St))</span>
<span id="cb12-500"><a href="#cb12-500" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-501"><a href="#cb12-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-502"><a href="#cb12-502" aria-hidden="true" tabindex="-1"></a><span class="do">### smoothing function </span><span class="al">###</span></span>
<span id="cb12-503"><a href="#cb12-503" aria-hidden="true" tabindex="-1"></a>backward_smoothing_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(data, matrices, </span>
<span id="cb12-504"><a href="#cb12-504" aria-hidden="true" tabindex="-1"></a>                                posterior_states,delta){</span>
<span id="cb12-505"><a href="#cb12-505" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve data </span></span>
<span id="cb12-506"><a href="#cb12-506" aria-hidden="true" tabindex="-1"></a>  yt <span class="ot">&lt;-</span> data<span class="sc">$</span>yt</span>
<span id="cb12-507"><a href="#cb12-507" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> <span class="fu">length</span>(yt) </span>
<span id="cb12-508"><a href="#cb12-508" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-509"><a href="#cb12-509" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb12-510"><a href="#cb12-510" aria-hidden="true" tabindex="-1"></a>  Ft <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Ft</span>
<span id="cb12-511"><a href="#cb12-511" aria-hidden="true" tabindex="-1"></a>  Gt <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Gt</span>
<span id="cb12-512"><a href="#cb12-512" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-513"><a href="#cb12-513" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb12-514"><a href="#cb12-514" aria-hidden="true" tabindex="-1"></a>  mt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>mt</span>
<span id="cb12-515"><a href="#cb12-515" aria-hidden="true" tabindex="-1"></a>  Ct <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>Ct</span>
<span id="cb12-516"><a href="#cb12-516" aria-hidden="true" tabindex="-1"></a>  Rt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>Rt</span>
<span id="cb12-517"><a href="#cb12-517" aria-hidden="true" tabindex="-1"></a>  nt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>nt</span>
<span id="cb12-518"><a href="#cb12-518" aria-hidden="true" tabindex="-1"></a>  St <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>St</span>
<span id="cb12-519"><a href="#cb12-519" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>at</span>
<span id="cb12-520"><a href="#cb12-520" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-521"><a href="#cb12-521" aria-hidden="true" tabindex="-1"></a>  <span class="do">## create placeholder for posterior moments </span></span>
<span id="cb12-522"><a href="#cb12-522" aria-hidden="true" tabindex="-1"></a>  mnt <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">dim</span>(mt)[<span class="dv">1</span>], <span class="at">ncol =</span> <span class="fu">dim</span>(mt)[<span class="dv">2</span>])</span>
<span id="cb12-523"><a href="#cb12-523" aria-hidden="true" tabindex="-1"></a>  Cnt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">dim</span>(Ct))</span>
<span id="cb12-524"><a href="#cb12-524" aria-hidden="true" tabindex="-1"></a>  fnt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb12-525"><a href="#cb12-525" aria-hidden="true" tabindex="-1"></a>  Qnt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb12-526"><a href="#cb12-526" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-527"><a href="#cb12-527" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> T<span class="sc">:</span><span class="dv">1</span>){</span>
<span id="cb12-528"><a href="#cb12-528" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> T){</span>
<span id="cb12-529"><a href="#cb12-529" aria-hidden="true" tabindex="-1"></a>      mnt[i, ] <span class="ot">&lt;-</span> mt[i, ]</span>
<span id="cb12-530"><a href="#cb12-530" aria-hidden="true" tabindex="-1"></a>      Cnt[, , i] <span class="ot">&lt;-</span> Ct[, , i]</span>
<span id="cb12-531"><a href="#cb12-531" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb12-532"><a href="#cb12-532" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb12-533"><a href="#cb12-533" aria-hidden="true" tabindex="-1"></a>        inv_Rtp1 <span class="ot">&lt;-</span> <span class="fu">chol2inv</span>(<span class="fu">chol</span>(Rt[, , i<span class="sc">+</span><span class="dv">1</span>]))</span>
<span id="cb12-534"><a href="#cb12-534" aria-hidden="true" tabindex="-1"></a>        Bt <span class="ot">&lt;-</span> Ct[, , i] <span class="sc">%*%</span> <span class="fu">t</span>(Gt[, , i<span class="sc">+</span><span class="dv">1</span>]) <span class="sc">%*%</span> inv_Rtp1</span>
<span id="cb12-535"><a href="#cb12-535" aria-hidden="true" tabindex="-1"></a>        mnt[i, ] <span class="ot">&lt;-</span> mt[i, ] <span class="sc">+</span> Bt <span class="sc">%*%</span> (mnt[i<span class="sc">+</span><span class="dv">1</span>, ] <span class="sc">-</span> at[i<span class="sc">+</span><span class="dv">1</span>, ])</span>
<span id="cb12-536"><a href="#cb12-536" aria-hidden="true" tabindex="-1"></a>        Cnt[, , i] <span class="ot">&lt;-</span> Ct[, , i] <span class="sc">+</span> Bt <span class="sc">%*%</span> (Cnt[, , i<span class="sc">+</span><span class="dv">1</span>] <span class="sc">-</span> </span>
<span id="cb12-537"><a href="#cb12-537" aria-hidden="true" tabindex="-1"></a>                                    Rt[, , i<span class="sc">+</span><span class="dv">1</span>]) <span class="sc">%*%</span> <span class="fu">t</span>(Bt)</span>
<span id="cb12-538"><a href="#cb12-538" aria-hidden="true" tabindex="-1"></a>        Cnt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Cnt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Cnt[,,i])</span>
<span id="cb12-539"><a href="#cb12-539" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb12-540"><a href="#cb12-540" aria-hidden="true" tabindex="-1"></a>        inv_Gt <span class="ot">&lt;-</span> <span class="fu">solve</span>(Gt[, , i<span class="sc">+</span><span class="dv">1</span>])</span>
<span id="cb12-541"><a href="#cb12-541" aria-hidden="true" tabindex="-1"></a>        mnt[i, ] <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">-</span>delta)<span class="sc">*</span>mt[i, ] <span class="sc">+</span> </span>
<span id="cb12-542"><a href="#cb12-542" aria-hidden="true" tabindex="-1"></a>                delta<span class="sc">*</span>inv_Gt <span class="sc">%*%</span> <span class="fu">t</span>(mnt[i<span class="sc">+</span><span class="dv">1</span>, ,<span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb12-543"><a href="#cb12-543" aria-hidden="true" tabindex="-1"></a>        Cnt[, , i] <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">-</span>delta)<span class="sc">*</span>Ct[, , i] <span class="sc">+</span> </span>
<span id="cb12-544"><a href="#cb12-544" aria-hidden="true" tabindex="-1"></a>                delta<span class="sc">^</span><span class="dv">2</span><span class="sc">*</span>inv_Gt <span class="sc">%*%</span> Cnt[, , i <span class="sc">+</span> <span class="dv">1</span>]  <span class="sc">%*%</span> <span class="fu">t</span>(inv_Gt)</span>
<span id="cb12-545"><a href="#cb12-545" aria-hidden="true" tabindex="-1"></a>        Cnt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Cnt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Cnt[,,i])</span>
<span id="cb12-546"><a href="#cb12-546" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb12-547"><a href="#cb12-547" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-548"><a href="#cb12-548" aria-hidden="true" tabindex="-1"></a>    fnt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , i]) <span class="sc">%*%</span> <span class="fu">t</span>(mnt[i, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb12-549"><a href="#cb12-549" aria-hidden="true" tabindex="-1"></a>    Qnt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , i]) <span class="sc">%*%</span> <span class="fu">t</span>(Cnt[, , i]) <span class="sc">%*%</span> Ft[, , i]</span>
<span id="cb12-550"><a href="#cb12-550" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-551"><a href="#cb12-551" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T){</span>
<span id="cb12-552"><a href="#cb12-552" aria-hidden="true" tabindex="-1"></a>     Cnt[,,i]<span class="ot">=</span>St[T]<span class="sc">*</span>Cnt[,,i]<span class="sc">/</span>St[i] </span>
<span id="cb12-553"><a href="#cb12-553" aria-hidden="true" tabindex="-1"></a>     Qnt[i]<span class="ot">=</span>St[T]<span class="sc">*</span>Qnt[i]<span class="sc">/</span>St[i]</span>
<span id="cb12-554"><a href="#cb12-554" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-555"><a href="#cb12-555" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Backward smoothing is completed!</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb12-556"><a href="#cb12-556" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mnt =</span> mnt, <span class="at">Cnt =</span> Cnt, <span class="at">fnt=</span>fnt, <span class="at">Qnt=</span>Qnt))</span>
<span id="cb12-557"><a href="#cb12-557" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-558"><a href="#cb12-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-559"><a href="#cb12-559" aria-hidden="true" tabindex="-1"></a><span class="do">## Forecast Distribution for k step</span></span>
<span id="cb12-560"><a href="#cb12-560" aria-hidden="true" tabindex="-1"></a>forecast_function_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(posterior_states, k, </span>
<span id="cb12-561"><a href="#cb12-561" aria-hidden="true" tabindex="-1"></a>                                        matrices, delta){</span>
<span id="cb12-562"><a href="#cb12-562" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-563"><a href="#cb12-563" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb12-564"><a href="#cb12-564" aria-hidden="true" tabindex="-1"></a>  Ft <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Ft</span>
<span id="cb12-565"><a href="#cb12-565" aria-hidden="true" tabindex="-1"></a>  Gt <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Gt</span>
<span id="cb12-566"><a href="#cb12-566" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb12-567"><a href="#cb12-567" aria-hidden="true" tabindex="-1"></a>    Wt_star <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Wt_star</span>
<span id="cb12-568"><a href="#cb12-568" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-569"><a href="#cb12-569" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-570"><a href="#cb12-570" aria-hidden="true" tabindex="-1"></a>  mt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>mt</span>
<span id="cb12-571"><a href="#cb12-571" aria-hidden="true" tabindex="-1"></a>  Ct <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>Ct</span>
<span id="cb12-572"><a href="#cb12-572" aria-hidden="true" tabindex="-1"></a>  St <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>St</span>
<span id="cb12-573"><a href="#cb12-573" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>at</span>
<span id="cb12-574"><a href="#cb12-574" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-575"><a href="#cb12-575" aria-hidden="true" tabindex="-1"></a>  <span class="do">## set up matrices</span></span>
<span id="cb12-576"><a href="#cb12-576" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> <span class="fu">dim</span>(mt)[<span class="dv">1</span>] <span class="co"># time points</span></span>
<span id="cb12-577"><a href="#cb12-577" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">dim</span>(mt)[<span class="dv">2</span>] <span class="co"># dimension of state parameter vector</span></span>
<span id="cb12-578"><a href="#cb12-578" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-579"><a href="#cb12-579" aria-hidden="true" tabindex="-1"></a>  <span class="do">## placeholder for results</span></span>
<span id="cb12-580"><a href="#cb12-580" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> k, <span class="at">ncol =</span> d)</span>
<span id="cb12-581"><a href="#cb12-581" aria-hidden="true" tabindex="-1"></a>  Rt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, k))</span>
<span id="cb12-582"><a href="#cb12-582" aria-hidden="true" tabindex="-1"></a>  ft <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k)</span>
<span id="cb12-583"><a href="#cb12-583" aria-hidden="true" tabindex="-1"></a>  Qt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k)</span>
<span id="cb12-584"><a href="#cb12-584" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-585"><a href="#cb12-585" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k){</span>
<span id="cb12-586"><a href="#cb12-586" aria-hidden="true" tabindex="-1"></a>    <span class="do">## moments of state distribution</span></span>
<span id="cb12-587"><a href="#cb12-587" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb12-588"><a href="#cb12-588" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> <span class="fu">t</span>(mt[T, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb12-589"><a href="#cb12-589" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-590"><a href="#cb12-590" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb12-591"><a href="#cb12-591" aria-hidden="true" tabindex="-1"></a>       Rt[, , i] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> Ct[, , T] <span class="sc">%*%</span> </span>
<span id="cb12-592"><a href="#cb12-592" aria-hidden="true" tabindex="-1"></a>         <span class="fu">t</span>(Gt[, , T<span class="sc">+</span>i]) <span class="sc">+</span> St[T]<span class="sc">*</span>Wt_star[, , T<span class="sc">+</span>i]</span>
<span id="cb12-593"><a href="#cb12-593" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb12-594"><a href="#cb12-594" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> Ct[, , T] <span class="sc">%*%</span> </span>
<span id="cb12-595"><a href="#cb12-595" aria-hidden="true" tabindex="-1"></a>          <span class="fu">t</span>(Gt[, , T<span class="sc">+</span>i])<span class="sc">/</span>delta</span>
<span id="cb12-596"><a href="#cb12-596" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb12-597"><a href="#cb12-597" aria-hidden="true" tabindex="-1"></a>      Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb12-598"><a href="#cb12-598" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-599"><a href="#cb12-599" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb12-600"><a href="#cb12-600" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> <span class="fu">t</span>(at[i<span class="dv">-1</span>, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb12-601"><a href="#cb12-601" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb12-602"><a href="#cb12-602" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> Rt[, , i<span class="dv">-1</span>] <span class="sc">%*%</span> </span>
<span id="cb12-603"><a href="#cb12-603" aria-hidden="true" tabindex="-1"></a>          <span class="fu">t</span>(Gt[, , T<span class="sc">+</span>i]) <span class="sc">+</span> St[T]<span class="sc">*</span>Wt_star[, , T <span class="sc">+</span> i]</span>
<span id="cb12-604"><a href="#cb12-604" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb12-605"><a href="#cb12-605" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> Rt[, , i<span class="dv">-1</span>] <span class="sc">%*%</span> </span>
<span id="cb12-606"><a href="#cb12-606" aria-hidden="true" tabindex="-1"></a>          <span class="fu">t</span>(Gt[, , T<span class="sc">+</span>i])<span class="sc">/</span>delta</span>
<span id="cb12-607"><a href="#cb12-607" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb12-608"><a href="#cb12-608" aria-hidden="true" tabindex="-1"></a>      Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb12-609"><a href="#cb12-609" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-610"><a href="#cb12-610" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-611"><a href="#cb12-611" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-612"><a href="#cb12-612" aria-hidden="true" tabindex="-1"></a>    <span class="do">## moments of forecast distribution</span></span>
<span id="cb12-613"><a href="#cb12-613" aria-hidden="true" tabindex="-1"></a>    ft[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , T<span class="sc">+</span>i]) <span class="sc">%*%</span> <span class="fu">t</span>(at[i, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb12-614"><a href="#cb12-614" aria-hidden="true" tabindex="-1"></a>    Qt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , T<span class="sc">+</span>i]) <span class="sc">%*%</span> Rt[, , i] <span class="sc">%*%</span> Ft[, , T<span class="sc">+</span>i] <span class="sc">+</span> </span>
<span id="cb12-615"><a href="#cb12-615" aria-hidden="true" tabindex="-1"></a>      St[T]</span>
<span id="cb12-616"><a href="#cb12-616" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-617"><a href="#cb12-617" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Forecasting is completed!</span><span class="sc">\n</span><span class="st">"</span>) <span class="co"># indicator of completion</span></span>
<span id="cb12-618"><a href="#cb12-618" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">at=</span>at, <span class="at">Rt=</span>Rt, <span class="at">ft=</span>ft, <span class="at">Qt=</span>Qt))</span>
<span id="cb12-619"><a href="#cb12-619" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-620"><a href="#cb12-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-621"><a href="#cb12-621" aria-hidden="true" tabindex="-1"></a><span class="do">## obtain 95% credible interval</span></span>
<span id="cb12-622"><a href="#cb12-622" aria-hidden="true" tabindex="-1"></a>get_credible_interval_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(ft, Qt, nt, </span>
<span id="cb12-623"><a href="#cb12-623" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">quantile =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)){</span>
<span id="cb12-624"><a href="#cb12-624" aria-hidden="true" tabindex="-1"></a>  bound <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span><span class="fu">length</span>(ft), <span class="at">ncol=</span><span class="dv">2</span>)</span>
<span id="cb12-625"><a href="#cb12-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-626"><a href="#cb12-626" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((<span class="fu">length</span>(nt)<span class="sc">==</span><span class="dv">1</span>)){</span>
<span id="cb12-627"><a href="#cb12-627" aria-hidden="true" tabindex="-1"></a>   <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(ft)){</span>
<span id="cb12-628"><a href="#cb12-628" aria-hidden="true" tabindex="-1"></a>      t_quantile <span class="ot">&lt;-</span> <span class="fu">qt</span>(quantile[<span class="dv">1</span>], <span class="at">df =</span> nt)</span>
<span id="cb12-629"><a href="#cb12-629" aria-hidden="true" tabindex="-1"></a>      bound[t, <span class="dv">1</span>] <span class="ot">&lt;-</span> ft[t] <span class="sc">+</span> t_quantile<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(Qt[t])) </span>
<span id="cb12-630"><a href="#cb12-630" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-631"><a href="#cb12-631" aria-hidden="true" tabindex="-1"></a>  <span class="co"># upper bound of 95% credible interval</span></span>
<span id="cb12-632"><a href="#cb12-632" aria-hidden="true" tabindex="-1"></a>      t_quantile <span class="ot">&lt;-</span> <span class="fu">qt</span>(quantile[<span class="dv">2</span>], <span class="at">df =</span> nt)</span>
<span id="cb12-633"><a href="#cb12-633" aria-hidden="true" tabindex="-1"></a>      bound[t, <span class="dv">2</span>] <span class="ot">&lt;-</span> ft[t] <span class="sc">+</span> </span>
<span id="cb12-634"><a href="#cb12-634" aria-hidden="true" tabindex="-1"></a>        t_quantile<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(Qt[t]))}</span>
<span id="cb12-635"><a href="#cb12-635" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb12-636"><a href="#cb12-636" aria-hidden="true" tabindex="-1"></a>  <span class="co"># lower bound of 95% credible interval</span></span>
<span id="cb12-637"><a href="#cb12-637" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(ft)){</span>
<span id="cb12-638"><a href="#cb12-638" aria-hidden="true" tabindex="-1"></a>      t_quantile <span class="ot">&lt;-</span> <span class="fu">qt</span>(quantile[<span class="dv">1</span>], <span class="at">df =</span> nt[t])</span>
<span id="cb12-639"><a href="#cb12-639" aria-hidden="true" tabindex="-1"></a>      bound[t, <span class="dv">1</span>] <span class="ot">&lt;-</span> ft[t] <span class="sc">+</span> </span>
<span id="cb12-640"><a href="#cb12-640" aria-hidden="true" tabindex="-1"></a>        t_quantile<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(Qt[t])) </span>
<span id="cb12-641"><a href="#cb12-641" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-642"><a href="#cb12-642" aria-hidden="true" tabindex="-1"></a>  <span class="co"># upper bound of 95% credible interval</span></span>
<span id="cb12-643"><a href="#cb12-643" aria-hidden="true" tabindex="-1"></a>      t_quantile <span class="ot">&lt;-</span> <span class="fu">qt</span>(quantile[<span class="dv">2</span>], <span class="at">df =</span> nt[t])</span>
<span id="cb12-644"><a href="#cb12-644" aria-hidden="true" tabindex="-1"></a>      bound[t, <span class="dv">2</span>] <span class="ot">&lt;-</span> ft[t] <span class="sc">+</span> </span>
<span id="cb12-645"><a href="#cb12-645" aria-hidden="true" tabindex="-1"></a>        t_quantile<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(Qt[t]))}</span>
<span id="cb12-646"><a href="#cb12-646" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-647"><a href="#cb12-647" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(bound)</span>
<span id="cb12-648"><a href="#cb12-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-649"><a href="#cb12-649" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-650"><a href="#cb12-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-651"><a href="#cb12-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-652"><a href="#cb12-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-653"><a href="#cb12-653" aria-hidden="true" tabindex="-1"></a><span class="do">## Example: Nile River Level (in 10^8 m^3), 1871-1970 </span></span>
<span id="cb12-654"><a href="#cb12-654" aria-hidden="true" tabindex="-1"></a><span class="do">## Model: First order polynomial DLM</span></span>
<span id="cb12-655"><a href="#cb12-655" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(Nile) </span>
<span id="cb12-656"><a href="#cb12-656" aria-hidden="true" tabindex="-1"></a>n<span class="ot">=</span><span class="fu">length</span>(Nile) <span class="co">#n=100 observations </span></span>
<span id="cb12-657"><a href="#cb12-657" aria-hidden="true" tabindex="-1"></a>k<span class="ot">=</span><span class="dv">5</span></span>
<span id="cb12-658"><a href="#cb12-658" aria-hidden="true" tabindex="-1"></a>T<span class="ot">=</span>n<span class="sc">-</span>k</span>
<span id="cb12-659"><a href="#cb12-659" aria-hidden="true" tabindex="-1"></a>data_T<span class="ot">=</span>Nile[<span class="dv">1</span><span class="sc">:</span>T]</span>
<span id="cb12-660"><a href="#cb12-660" aria-hidden="true" tabindex="-1"></a>test_data<span class="ot">=</span>Nile[(T<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>n]</span>
<span id="cb12-661"><a href="#cb12-661" aria-hidden="true" tabindex="-1"></a>data<span class="ot">=</span><span class="fu">list</span>(<span class="at">yt =</span> data_T)</span>
<span id="cb12-662"><a href="#cb12-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-663"><a href="#cb12-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-664"><a href="#cb12-664" aria-hidden="true" tabindex="-1"></a><span class="do">## set up matrices for first order polynomial model </span></span>
<span id="cb12-665"><a href="#cb12-665" aria-hidden="true" tabindex="-1"></a>Ft<span class="ot">=</span><span class="fu">array</span>(<span class="dv">1</span>, <span class="at">dim =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, n))</span>
<span id="cb12-666"><a href="#cb12-666" aria-hidden="true" tabindex="-1"></a>Gt<span class="ot">=</span><span class="fu">array</span>(<span class="dv">1</span>, <span class="at">dim =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, n))</span>
<span id="cb12-667"><a href="#cb12-667" aria-hidden="true" tabindex="-1"></a>Wt_star<span class="ot">=</span><span class="fu">array</span>(<span class="dv">1</span>, <span class="at">dim =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, n))</span>
<span id="cb12-668"><a href="#cb12-668" aria-hidden="true" tabindex="-1"></a>m0<span class="ot">=</span><span class="fu">as.matrix</span>(<span class="dv">800</span>)</span>
<span id="cb12-669"><a href="#cb12-669" aria-hidden="true" tabindex="-1"></a>C0_star<span class="ot">=</span><span class="fu">as.matrix</span>(<span class="dv">10</span>)</span>
<span id="cb12-670"><a href="#cb12-670" aria-hidden="true" tabindex="-1"></a>n0<span class="ot">=</span><span class="dv">1</span></span>
<span id="cb12-671"><a href="#cb12-671" aria-hidden="true" tabindex="-1"></a>S0<span class="ot">=</span><span class="dv">10</span></span>
<span id="cb12-672"><a href="#cb12-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-673"><a href="#cb12-673" aria-hidden="true" tabindex="-1"></a><span class="do">## wrap up all matrices and initial values</span></span>
<span id="cb12-674"><a href="#cb12-674" aria-hidden="true" tabindex="-1"></a>matrices <span class="ot">=</span> <span class="fu">set_up_dlm_matrices_unknown_v</span>(Ft, Gt, Wt_star)</span>
<span id="cb12-675"><a href="#cb12-675" aria-hidden="true" tabindex="-1"></a>initial_states <span class="ot">=</span> <span class="fu">set_up_initial_states_unknown_v</span>(m0, </span>
<span id="cb12-676"><a href="#cb12-676" aria-hidden="true" tabindex="-1"></a>                                      C0_star, n0, S0)</span>
<span id="cb12-677"><a href="#cb12-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-678"><a href="#cb12-678" aria-hidden="true" tabindex="-1"></a><span class="do">## filtering </span></span>
<span id="cb12-679"><a href="#cb12-679" aria-hidden="true" tabindex="-1"></a>results_filtered <span class="ot">=</span> <span class="fu">forward_filter_unknown_v</span>(data, matrices, </span>
<span id="cb12-680"><a href="#cb12-680" aria-hidden="true" tabindex="-1"></a>                                            initial_states)</span>
<span id="cb12-681"><a href="#cb12-681" aria-hidden="true" tabindex="-1"></a>ci_filtered<span class="ot">=</span><span class="fu">get_credible_interval_unknown_v</span>(results_filtered<span class="sc">$</span>mt, </span>
<span id="cb12-682"><a href="#cb12-682" aria-hidden="true" tabindex="-1"></a>                                    results_filtered<span class="sc">$</span>Ct, </span>
<span id="cb12-683"><a href="#cb12-683" aria-hidden="true" tabindex="-1"></a>                                     results_filtered<span class="sc">$</span>nt)</span>
<span id="cb12-684"><a href="#cb12-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-685"><a href="#cb12-685" aria-hidden="true" tabindex="-1"></a><span class="do">## smoothing</span></span>
<span id="cb12-686"><a href="#cb12-686" aria-hidden="true" tabindex="-1"></a>results_smoothed<span class="ot">=</span><span class="fu">backward_smoothing_unknown_v</span>(data, matrices, </span>
<span id="cb12-687"><a href="#cb12-687" aria-hidden="true" tabindex="-1"></a>                                             results_filtered)</span>
<span id="cb12-688"><a href="#cb12-688" aria-hidden="true" tabindex="-1"></a>ci_smoothed<span class="ot">=</span><span class="fu">get_credible_interval_unknown_v</span>(results_smoothed<span class="sc">$</span>mnt, </span>
<span id="cb12-689"><a href="#cb12-689" aria-hidden="true" tabindex="-1"></a>                                         results_smoothed<span class="sc">$</span>Cnt, </span>
<span id="cb12-690"><a href="#cb12-690" aria-hidden="true" tabindex="-1"></a>                                         results_filtered<span class="sc">$</span>nt[T])</span>
<span id="cb12-691"><a href="#cb12-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-692"><a href="#cb12-692" aria-hidden="true" tabindex="-1"></a><span class="do">## one-step ahead forecasting</span></span>
<span id="cb12-693"><a href="#cb12-693" aria-hidden="true" tabindex="-1"></a>results_forecast<span class="ot">=</span><span class="fu">forecast_function_unknown_v</span>(results_filtered, </span>
<span id="cb12-694"><a href="#cb12-694" aria-hidden="true" tabindex="-1"></a>                                                k,  matrices)</span>
<span id="cb12-695"><a href="#cb12-695" aria-hidden="true" tabindex="-1"></a>ci_forecast<span class="ot">=</span><span class="fu">get_credible_interval_unknown_v</span>(results_forecast<span class="sc">$</span>ft, </span>
<span id="cb12-696"><a href="#cb12-696" aria-hidden="true" tabindex="-1"></a>                                          results_forecast<span class="sc">$</span>Qt, </span>
<span id="cb12-697"><a href="#cb12-697" aria-hidden="true" tabindex="-1"></a>                                     results_filtered<span class="sc">$</span>nt[T])</span>
<span id="cb12-698"><a href="#cb12-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-699"><a href="#cb12-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-700"><a href="#cb12-700" aria-hidden="true" tabindex="-1"></a><span class="do">## plot results</span></span>
<span id="cb12-701"><a href="#cb12-701" aria-hidden="true" tabindex="-1"></a>index<span class="ot">=</span><span class="fu">seq</span>(<span class="dv">1871</span>, <span class="dv">1970</span>, <span class="at">length.out =</span> <span class="fu">length</span>(Nile))</span>
<span id="cb12-702"><a href="#cb12-702" aria-hidden="true" tabindex="-1"></a>index_filt<span class="ot">=</span>index[<span class="dv">1</span><span class="sc">:</span>T]</span>
<span id="cb12-703"><a href="#cb12-703" aria-hidden="true" tabindex="-1"></a>index_forecast<span class="ot">=</span>index[(T<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(T<span class="sc">+</span>k)]</span>
<span id="cb12-704"><a href="#cb12-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-705"><a href="#cb12-705" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(index, Nile, <span class="at">main =</span> <span class="st">"Nile River Level "</span>,<span class="at">type=</span><span class="st">'l'</span>,</span>
<span id="cb12-706"><a href="#cb12-706" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"time"</span>,<span class="at">ylab=</span><span class="st">"feet"</span>,<span class="at">lty=</span><span class="dv">3</span>,<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">400</span>,<span class="dv">1500</span>))</span>
<span id="cb12-707"><a href="#cb12-707" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(index,Nile,<span class="at">pch=</span><span class="dv">20</span>)</span>
<span id="cb12-708"><a href="#cb12-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-709"><a href="#cb12-709" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt,results_filtered<span class="sc">$</span>mt, <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'red'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb12-710"><a href="#cb12-710" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt,ci_filtered[, <span class="dv">1</span>], <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'red'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb12-711"><a href="#cb12-711" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt,ci_filtered[, <span class="dv">2</span>], <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'red'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb12-712"><a href="#cb12-712" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt,results_smoothed<span class="sc">$</span>mnt, <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'blue'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb12-713"><a href="#cb12-713" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, ci_smoothed[, <span class="dv">1</span>], <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'blue'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb12-714"><a href="#cb12-714" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, ci_smoothed[, <span class="dv">2</span>], <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'blue'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb12-715"><a href="#cb12-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-716"><a href="#cb12-716" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_forecast, results_forecast<span class="sc">$</span>ft, <span class="at">type=</span><span class="st">'l'</span>, </span>
<span id="cb12-717"><a href="#cb12-717" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'green'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb12-718"><a href="#cb12-718" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_forecast, ci_forecast[, <span class="dv">1</span>], <span class="at">type=</span><span class="st">'l'</span>, </span>
<span id="cb12-719"><a href="#cb12-719" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'green'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb12-720"><a href="#cb12-720" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_forecast, ci_forecast[, <span class="dv">2</span>], <span class="at">type=</span><span class="st">'l'</span>, </span>
<span id="cb12-721"><a href="#cb12-721" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'green'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb12-722"><a href="#cb12-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-723"><a href="#cb12-723" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-724"><a href="#cb12-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-725"><a href="#cb12-725" aria-hidden="true" tabindex="-1"></a><span class="fu">## Practice Graded Assignment: NDLM data analysis</span></span>
<span id="cb12-726"><a href="#cb12-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-727"><a href="#cb12-727" aria-hidden="true" tabindex="-1"></a>This peer-reviewed activity is highly recommended. It does not figure into your grade for this course, but it does provide you with the opportunity to apply what you've learned in R and prepare you for your data analysis project in week 5. </span>
<span id="cb12-728"><a href="#cb12-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-729"><a href="#cb12-729" aria-hidden="true" tabindex="-1"></a>The R code below fits a Normal Dynamic Linear Model to the monthly time series of Google trends "hits" for the term "time series". The model has two components: (a) a polynomial model of order 2 and (b) a seasonal component with 4 frequencies:  $ω_1=2π/12$, (annual cycle) $ω_2=2π/6$ (6 months cycle), $ω_3=2π/4$ and $ω_4=2π/3.$ The model assumes that the observational variance $v$ is unknown and the system variance-covariance matrix $W_t$ is specified using a single discount factor. The discount factor is chosen using an optimality criterion as explained in the course. </span>
<span id="cb12-730"><a href="#cb12-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-731"><a href="#cb12-731" aria-hidden="true" tabindex="-1"></a>You will be asked to modify the code in order to consider a DLM with two components: (a) a polynomial model of order 1 and (b) a seasonal component that contains a fundamental period of $p = 12$ and 2 additional harmonics for a total of 3 frequencies: $ω1=2π/12$, $ω2=2π/6$ and $ω3=2π/4$. You will also need to optimize the choice of the discount factor for this model.  You will be asked to upload pictures summarizing your results. </span>
<span id="cb12-732"><a href="#cb12-732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-733"><a href="#cb12-733" aria-hidden="true" tabindex="-1"></a>R code to fit the model: requires R packages <span class="in">`gtrends`</span>,and <span class="in">`dlm`</span> as well as the files  "all_dlm_functions_unknown_v.R" and "discountfactor_selection_functions.R" also provided below. </span>
<span id="cb12-734"><a href="#cb12-734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-735"><a href="#cb12-735" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb12-736"><a href="#cb12-736" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: code-gtrendsR-data-analysis</span></span>
<span id="cb12-737"><a href="#cb12-737" aria-hidden="true" tabindex="-1"></a><span class="co"># download data </span></span>
<span id="cb12-738"><a href="#cb12-738" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gtrendsR)</span>
<span id="cb12-739"><a href="#cb12-739" aria-hidden="true" tabindex="-1"></a>timeseries_data <span class="ot">&lt;-</span> <span class="fu">gtrends</span>(<span class="st">"time series"</span>,<span class="at">time=</span><span class="st">"all"</span>)</span>
<span id="cb12-740"><a href="#cb12-740" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(timeseries_data)</span>
<span id="cb12-741"><a href="#cb12-741" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(timeseries_data)</span>
<span id="cb12-742"><a href="#cb12-742" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-743"><a href="#cb12-743" aria-hidden="true" tabindex="-1"></a>timeseries_data<span class="ot">=</span>timeseries_data<span class="sc">$</span>interest_over_time</span>
<span id="cb12-744"><a href="#cb12-744" aria-hidden="true" tabindex="-1"></a>data<span class="ot">=</span><span class="fu">list</span>(<span class="at">yt=</span>timeseries_data<span class="sc">$</span>hits)</span>
<span id="cb12-745"><a href="#cb12-745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-746"><a href="#cb12-746" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dlm)</span>
<span id="cb12-747"><a href="#cb12-747" aria-hidden="true" tabindex="-1"></a>model_seasonal<span class="ot">=</span><span class="fu">dlmModTrig</span>(<span class="at">s=</span><span class="dv">12</span>,<span class="at">q=</span><span class="dv">4</span>,<span class="at">dV=</span><span class="dv">0</span>,<span class="at">dW=</span><span class="dv">1</span>)</span>
<span id="cb12-748"><a href="#cb12-748" aria-hidden="true" tabindex="-1"></a>model_trend<span class="ot">=</span><span class="fu">dlmModPoly</span>(<span class="at">order=</span><span class="dv">2</span>,<span class="at">dV=</span><span class="dv">10</span>,<span class="at">dW=</span><span class="fu">rep</span>(<span class="dv">1</span>,<span class="dv">2</span>),<span class="at">m0=</span><span class="fu">c</span>(<span class="dv">40</span>,<span class="dv">0</span>))</span>
<span id="cb12-749"><a href="#cb12-749" aria-hidden="true" tabindex="-1"></a>model<span class="ot">=</span>model_trend<span class="sc">+</span>model_seasonal</span>
<span id="cb12-750"><a href="#cb12-750" aria-hidden="true" tabindex="-1"></a>model<span class="sc">$</span>C0<span class="ot">=</span><span class="dv">10</span><span class="sc">*</span><span class="fu">diag</span>(<span class="dv">10</span>)</span>
<span id="cb12-751"><a href="#cb12-751" aria-hidden="true" tabindex="-1"></a>n0<span class="ot">=</span><span class="dv">1</span></span>
<span id="cb12-752"><a href="#cb12-752" aria-hidden="true" tabindex="-1"></a>S0<span class="ot">=</span><span class="dv">10</span></span>
<span id="cb12-753"><a href="#cb12-753" aria-hidden="true" tabindex="-1"></a>k<span class="ot">=</span><span class="fu">length</span>(model<span class="sc">$</span>m0)</span>
<span id="cb12-754"><a href="#cb12-754" aria-hidden="true" tabindex="-1"></a>T<span class="ot">=</span><span class="fu">length</span>(data<span class="sc">$</span>yt)</span>
<span id="cb12-755"><a href="#cb12-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-756"><a href="#cb12-756" aria-hidden="true" tabindex="-1"></a>Ft<span class="ot">=</span><span class="fu">array</span>(<span class="dv">0</span>,<span class="fu">c</span>(<span class="dv">1</span>,k,T))</span>
<span id="cb12-757"><a href="#cb12-757" aria-hidden="true" tabindex="-1"></a>Gt<span class="ot">=</span><span class="fu">array</span>(<span class="dv">0</span>,<span class="fu">c</span>(k,k,T))</span>
<span id="cb12-758"><a href="#cb12-758" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T){</span>
<span id="cb12-759"><a href="#cb12-759" aria-hidden="true" tabindex="-1"></a>   Ft[,,t]<span class="ot">=</span>model<span class="sc">$</span>FF</span>
<span id="cb12-760"><a href="#cb12-760" aria-hidden="true" tabindex="-1"></a>   Gt[,,t]<span class="ot">=</span>model<span class="sc">$</span>GG</span>
<span id="cb12-761"><a href="#cb12-761" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-762"><a href="#cb12-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-763"><a href="#cb12-763" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">'all_dlm_functions_unknown_v.R'</span>)</span>
<span id="cb12-764"><a href="#cb12-764" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">'discountfactor_selection_functions.R'</span>)</span>
<span id="cb12-765"><a href="#cb12-765" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-766"><a href="#cb12-766" aria-hidden="true" tabindex="-1"></a>matrices<span class="ot">=</span><span class="fu">set_up_dlm_matrices_unknown_v</span>(<span class="at">Ft=</span>Ft,<span class="at">Gt=</span>Gt)</span>
<span id="cb12-767"><a href="#cb12-767" aria-hidden="true" tabindex="-1"></a>initial_states<span class="ot">=</span><span class="fu">set_up_initial_states_unknown_v</span>(model<span class="sc">$</span>m0,</span>
<span id="cb12-768"><a href="#cb12-768" aria-hidden="true" tabindex="-1"></a>                                               model<span class="sc">$</span>C0,n0,S0)</span>
<span id="cb12-769"><a href="#cb12-769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-770"><a href="#cb12-770" aria-hidden="true" tabindex="-1"></a>df_range<span class="ot">=</span><span class="fu">seq</span>(<span class="fl">0.9</span>,<span class="dv">1</span>,<span class="at">by=</span><span class="fl">0.005</span>)</span>
<span id="cb12-771"><a href="#cb12-771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-772"><a href="#cb12-772" aria-hidden="true" tabindex="-1"></a><span class="do">## fit discount DLM</span></span>
<span id="cb12-773"><a href="#cb12-773" aria-hidden="true" tabindex="-1"></a><span class="do">## MSE</span></span>
<span id="cb12-774"><a href="#cb12-774" aria-hidden="true" tabindex="-1"></a>results_MSE <span class="ot">&lt;-</span> <span class="fu">adaptive_dlm</span>(data, matrices, </span>
<span id="cb12-775"><a href="#cb12-775" aria-hidden="true" tabindex="-1"></a>               initial_states, df_range,<span class="st">"MSE"</span>,<span class="at">forecast=</span><span class="cn">FALSE</span>)</span>
<span id="cb12-776"><a href="#cb12-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-777"><a href="#cb12-777" aria-hidden="true" tabindex="-1"></a><span class="do">## print selected discount factor</span></span>
<span id="cb12-778"><a href="#cb12-778" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"The selected discount factor:"</span>,results_MSE<span class="sc">$</span>df_opt))</span>
<span id="cb12-779"><a href="#cb12-779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-780"><a href="#cb12-780" aria-hidden="true" tabindex="-1"></a><span class="do">## retrieve filtered results</span></span>
<span id="cb12-781"><a href="#cb12-781" aria-hidden="true" tabindex="-1"></a>results_filtered <span class="ot">&lt;-</span> results_MSE<span class="sc">$</span>results_filtered</span>
<span id="cb12-782"><a href="#cb12-782" aria-hidden="true" tabindex="-1"></a>ci_filtered <span class="ot">&lt;-</span> <span class="fu">get_credible_interval_unknown_v</span>(</span>
<span id="cb12-783"><a href="#cb12-783" aria-hidden="true" tabindex="-1"></a>  results_filtered<span class="sc">$</span>ft,results_filtered<span class="sc">$</span>Qt,results_filtered<span class="sc">$</span>nt)</span>
<span id="cb12-784"><a href="#cb12-784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-785"><a href="#cb12-785" aria-hidden="true" tabindex="-1"></a><span class="do">## retrieve smoothed results</span></span>
<span id="cb12-786"><a href="#cb12-786" aria-hidden="true" tabindex="-1"></a>results_smoothed <span class="ot">&lt;-</span> results_MSE<span class="sc">$</span>results_smoothed</span>
<span id="cb12-787"><a href="#cb12-787" aria-hidden="true" tabindex="-1"></a>ci_smoothed <span class="ot">&lt;-</span> <span class="fu">get_credible_interval_unknown_v</span>(</span>
<span id="cb12-788"><a href="#cb12-788" aria-hidden="true" tabindex="-1"></a>  results_smoothed<span class="sc">$</span>fnt, results_smoothed<span class="sc">$</span>Qnt, </span>
<span id="cb12-789"><a href="#cb12-789" aria-hidden="true" tabindex="-1"></a>  results_filtered<span class="sc">$</span>nt[<span class="fu">length</span>(results_smoothed<span class="sc">$</span>fnt)])</span>
<span id="cb12-790"><a href="#cb12-790" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-791"><a href="#cb12-791" aria-hidden="true" tabindex="-1"></a><span class="do">## plot smoothing results </span></span>
<span id="cb12-792"><a href="#cb12-792" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb12-793"><a href="#cb12-793" aria-hidden="true" tabindex="-1"></a>index <span class="ot">&lt;-</span> timeseries_data<span class="sc">$</span>date</span>
<span id="cb12-794"><a href="#cb12-794" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(index, data<span class="sc">$</span>yt, <span class="at">ylab=</span><span class="st">'Google hits'</span>,</span>
<span id="cb12-795"><a href="#cb12-795" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Google Trends: time series"</span>, <span class="at">type =</span> <span class="st">'l'</span>,</span>
<span id="cb12-796"><a href="#cb12-796" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">'time'</span>, <span class="at">lty=</span><span class="dv">3</span>,<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">100</span>))</span>
<span id="cb12-797"><a href="#cb12-797" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index, results_smoothed<span class="sc">$</span>fnt, <span class="at">type =</span> <span class="st">'l'</span>, <span class="at">col=</span><span class="st">'blue'</span>, </span>
<span id="cb12-798"><a href="#cb12-798" aria-hidden="true" tabindex="-1"></a>      <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb12-799"><a href="#cb12-799" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index, ci_smoothed[, <span class="dv">1</span>], <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'blue'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb12-800"><a href="#cb12-800" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index, ci_smoothed[, <span class="dv">2</span>], <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'blue'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb12-801"><a href="#cb12-801" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-802"><a href="#cb12-802" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot trend and rate of change </span></span>
<span id="cb12-803"><a href="#cb12-803" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">1</span>))</span>
<span id="cb12-804"><a href="#cb12-804" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(index,data<span class="sc">$</span>yt,<span class="at">pch=</span><span class="dv">19</span>,<span class="at">cex=</span><span class="fl">0.3</span>,<span class="at">col=</span><span class="st">'lightgray'</span>,<span class="at">xlab=</span><span class="st">"time"</span>,</span>
<span id="cb12-805"><a href="#cb12-805" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab=</span><span class="st">"Google hits"</span>,<span class="at">main=</span><span class="st">"trend"</span>)</span>
<span id="cb12-806"><a href="#cb12-806" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index,results_smoothed<span class="sc">$</span>mnt[,<span class="dv">1</span>],<span class="at">lwd=</span><span class="dv">2</span>,<span class="at">col=</span><span class="st">'magenta'</span>)</span>
<span id="cb12-807"><a href="#cb12-807" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(index,results_smoothed<span class="sc">$</span>mnt[,<span class="dv">2</span>],<span class="at">col=</span><span class="st">'darkblue'</span>,<span class="at">lwd=</span><span class="dv">2</span>,</span>
<span id="cb12-808"><a href="#cb12-808" aria-hidden="true" tabindex="-1"></a>     <span class="at">type=</span><span class="st">'l'</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.6</span>,<span class="fl">0.6</span>), <span class="at">xlab=</span><span class="st">"time"</span>,</span>
<span id="cb12-809"><a href="#cb12-809" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab=</span><span class="st">"rate of change"</span>)</span>
<span id="cb12-810"><a href="#cb12-810" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h=</span><span class="dv">0</span>,<span class="at">col=</span><span class="st">'red'</span>,<span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb12-811"><a href="#cb12-811" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-812"><a href="#cb12-812" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot seasonal components </span></span>
<span id="cb12-813"><a href="#cb12-813" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb12-814"><a href="#cb12-814" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(index,results_smoothed<span class="sc">$</span>mnt[,<span class="dv">3</span>],<span class="at">lwd=</span><span class="dv">2</span>,<span class="at">col=</span><span class="st">"darkgreen"</span>,</span>
<span id="cb12-815"><a href="#cb12-815" aria-hidden="true" tabindex="-1"></a>     <span class="at">type=</span><span class="st">'l'</span>, <span class="at">xlab=</span><span class="st">"time"</span>,<span class="at">ylab=</span><span class="st">""</span>,<span class="at">main=</span><span class="st">"period=12"</span>,</span>
<span id="cb12-816"><a href="#cb12-816" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">12</span>,<span class="dv">12</span>))</span>
<span id="cb12-817"><a href="#cb12-817" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(index,results_smoothed<span class="sc">$</span>mnt[,<span class="dv">5</span>],<span class="at">lwd=</span><span class="dv">2</span>,<span class="at">col=</span><span class="st">"darkgreen"</span>,</span>
<span id="cb12-818"><a href="#cb12-818" aria-hidden="true" tabindex="-1"></a>     <span class="at">type=</span><span class="st">'l'</span>,<span class="at">xlab=</span><span class="st">"time"</span>,<span class="at">ylab=</span><span class="st">""</span>,<span class="at">main=</span><span class="st">"period=6"</span>,</span>
<span id="cb12-819"><a href="#cb12-819" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">12</span>,<span class="dv">12</span>))</span>
<span id="cb12-820"><a href="#cb12-820" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(index,results_smoothed<span class="sc">$</span>mnt[,<span class="dv">7</span>],<span class="at">lwd=</span><span class="dv">2</span>,<span class="at">col=</span><span class="st">"darkgreen"</span>,</span>
<span id="cb12-821"><a href="#cb12-821" aria-hidden="true" tabindex="-1"></a>     <span class="at">type=</span><span class="st">'l'</span>, <span class="at">xlab=</span><span class="st">"time"</span>,<span class="at">ylab=</span><span class="st">""</span>,<span class="at">main=</span><span class="st">"period=4"</span>,</span>
<span id="cb12-822"><a href="#cb12-822" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">12</span>,<span class="dv">12</span>))</span>
<span id="cb12-823"><a href="#cb12-823" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(index,results_smoothed<span class="sc">$</span>mnt[,<span class="dv">9</span>],<span class="at">lwd=</span><span class="dv">2</span>,<span class="at">col=</span><span class="st">"darkgreen"</span>,</span>
<span id="cb12-824"><a href="#cb12-824" aria-hidden="true" tabindex="-1"></a>     <span class="at">type=</span><span class="st">'l'</span>, <span class="at">xlab=</span><span class="st">"time"</span>,<span class="at">ylab=</span><span class="st">""</span>,<span class="at">main=</span><span class="st">"period=3"</span>,</span>
<span id="cb12-825"><a href="#cb12-825" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">12</span>,<span class="dv">12</span>))</span>
<span id="cb12-826"><a href="#cb12-826" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-827"><a href="#cb12-827" aria-hidden="true" tabindex="-1"></a><span class="co">#Estimate for the observational variance: St[T]</span></span>
<span id="cb12-828"><a href="#cb12-828" aria-hidden="true" tabindex="-1"></a>results_filtered<span class="sc">$</span>St[T]</span>
<span id="cb12-829"><a href="#cb12-829" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-830"><a href="#cb12-830" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-831"><a href="#cb12-831" aria-hidden="true" tabindex="-1"></a><span class="fu">### All dlm functions unknown v</span></span>
<span id="cb12-832"><a href="#cb12-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-835"><a href="#cb12-835" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-836"><a href="#cb12-836" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: code-all-dlm-functions-unknown-v</span></span>
<span id="cb12-837"><a href="#cb12-837" aria-hidden="true" tabindex="-1"></a><span class="do">## create list for matrices</span></span>
<span id="cb12-838"><a href="#cb12-838" aria-hidden="true" tabindex="-1"></a>set_up_dlm_matrices_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(Ft, Gt, Wt_star){</span>
<span id="cb12-839"><a href="#cb12-839" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.array</span>(Gt)){</span>
<span id="cb12-840"><a href="#cb12-840" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Stop</span>(<span class="st">"Gt and Ft should be array"</span>)</span>
<span id="cb12-841"><a href="#cb12-841" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-842"><a href="#cb12-842" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">missing</span>(Wt_star)){</span>
<span id="cb12-843"><a href="#cb12-843" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">Ft=</span>Ft, <span class="at">Gt=</span>Gt))</span>
<span id="cb12-844"><a href="#cb12-844" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb12-845"><a href="#cb12-845" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">Ft=</span>Ft, <span class="at">Gt=</span>Gt, <span class="at">Wt_star=</span>Wt_star))</span>
<span id="cb12-846"><a href="#cb12-846" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-847"><a href="#cb12-847" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-848"><a href="#cb12-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-849"><a href="#cb12-849" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-850"><a href="#cb12-850" aria-hidden="true" tabindex="-1"></a><span class="do">## create list for initial states</span></span>
<span id="cb12-851"><a href="#cb12-851" aria-hidden="true" tabindex="-1"></a>set_up_initial_states_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(m0, C0_star, n0, S0){</span>
<span id="cb12-852"><a href="#cb12-852" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">m0=</span>m0, <span class="at">C0_star=</span>C0_star, <span class="at">n0=</span>n0, <span class="at">S0=</span>S0))</span>
<span id="cb12-853"><a href="#cb12-853" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-854"><a href="#cb12-854" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-855"><a href="#cb12-855" aria-hidden="true" tabindex="-1"></a>forward_filter_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(data, matrices, </span>
<span id="cb12-856"><a href="#cb12-856" aria-hidden="true" tabindex="-1"></a>                              initial_states, delta){</span>
<span id="cb12-857"><a href="#cb12-857" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve dataset</span></span>
<span id="cb12-858"><a href="#cb12-858" aria-hidden="true" tabindex="-1"></a>  yt <span class="ot">&lt;-</span> data<span class="sc">$</span>yt</span>
<span id="cb12-859"><a href="#cb12-859" aria-hidden="true" tabindex="-1"></a>  T<span class="ot">&lt;-</span> <span class="fu">length</span>(yt)</span>
<span id="cb12-860"><a href="#cb12-860" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-861"><a href="#cb12-861" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb12-862"><a href="#cb12-862" aria-hidden="true" tabindex="-1"></a>  Ft <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Ft</span>
<span id="cb12-863"><a href="#cb12-863" aria-hidden="true" tabindex="-1"></a>  Gt <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Gt</span>
<span id="cb12-864"><a href="#cb12-864" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb12-865"><a href="#cb12-865" aria-hidden="true" tabindex="-1"></a>    Wt_star <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Wt_star</span>
<span id="cb12-866"><a href="#cb12-866" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-867"><a href="#cb12-867" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-868"><a href="#cb12-868" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve initial state</span></span>
<span id="cb12-869"><a href="#cb12-869" aria-hidden="true" tabindex="-1"></a>  m0 <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>m0</span>
<span id="cb12-870"><a href="#cb12-870" aria-hidden="true" tabindex="-1"></a>  C0_star <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>C0_star</span>
<span id="cb12-871"><a href="#cb12-871" aria-hidden="true" tabindex="-1"></a>  n0 <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>n0</span>
<span id="cb12-872"><a href="#cb12-872" aria-hidden="true" tabindex="-1"></a>  S0 <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>S0</span>
<span id="cb12-873"><a href="#cb12-873" aria-hidden="true" tabindex="-1"></a>  C0 <span class="ot">&lt;-</span> S0<span class="sc">*</span>C0_star</span>
<span id="cb12-874"><a href="#cb12-874" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-875"><a href="#cb12-875" aria-hidden="true" tabindex="-1"></a>  <span class="do">## create placeholder for results</span></span>
<span id="cb12-876"><a href="#cb12-876" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">dim</span>(Gt)[<span class="dv">1</span>]</span>
<span id="cb12-877"><a href="#cb12-877" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span>T, <span class="at">ncol=</span>d)</span>
<span id="cb12-878"><a href="#cb12-878" aria-hidden="true" tabindex="-1"></a>  Rt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, T))</span>
<span id="cb12-879"><a href="#cb12-879" aria-hidden="true" tabindex="-1"></a>  ft <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb12-880"><a href="#cb12-880" aria-hidden="true" tabindex="-1"></a>  Qt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb12-881"><a href="#cb12-881" aria-hidden="true" tabindex="-1"></a>  mt <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span>T, <span class="at">ncol=</span>d)</span>
<span id="cb12-882"><a href="#cb12-882" aria-hidden="true" tabindex="-1"></a>  Ct <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, T))</span>
<span id="cb12-883"><a href="#cb12-883" aria-hidden="true" tabindex="-1"></a>  et <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb12-884"><a href="#cb12-884" aria-hidden="true" tabindex="-1"></a>  nt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb12-885"><a href="#cb12-885" aria-hidden="true" tabindex="-1"></a>  St <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb12-886"><a href="#cb12-886" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb12-887"><a href="#cb12-887" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-888"><a href="#cb12-888" aria-hidden="true" tabindex="-1"></a>  <span class="co"># moments of priors at t</span></span>
<span id="cb12-889"><a href="#cb12-889" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T){</span>
<span id="cb12-890"><a href="#cb12-890" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb12-891"><a href="#cb12-891" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> Gt[, , i] <span class="sc">%*%</span> m0</span>
<span id="cb12-892"><a href="#cb12-892" aria-hidden="true" tabindex="-1"></a>      Pt <span class="ot">&lt;-</span> Gt[, , i] <span class="sc">%*%</span> C0 <span class="sc">%*%</span> <span class="fu">t</span>(Gt[, , i])</span>
<span id="cb12-893"><a href="#cb12-893" aria-hidden="true" tabindex="-1"></a>      Pt <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Pt <span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Pt)</span>
<span id="cb12-894"><a href="#cb12-894" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb12-895"><a href="#cb12-895" aria-hidden="true" tabindex="-1"></a>        Wt <span class="ot">&lt;-</span> Wt_star[, , i]<span class="sc">*</span>S0</span>
<span id="cb12-896"><a href="#cb12-896" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Pt <span class="sc">+</span> Wt</span>
<span id="cb12-897"><a href="#cb12-897" aria-hidden="true" tabindex="-1"></a>        Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb12-898"><a href="#cb12-898" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb12-899"><a href="#cb12-899" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Pt<span class="sc">/</span>delta</span>
<span id="cb12-900"><a href="#cb12-900" aria-hidden="true" tabindex="-1"></a>        Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb12-901"><a href="#cb12-901" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb12-902"><a href="#cb12-902" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-903"><a href="#cb12-903" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb12-904"><a href="#cb12-904" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> Gt[, , i] <span class="sc">%*%</span> <span class="fu">t</span>(mt[i<span class="dv">-1</span>, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb12-905"><a href="#cb12-905" aria-hidden="true" tabindex="-1"></a>      Pt <span class="ot">&lt;-</span> Gt[, , i] <span class="sc">%*%</span> Ct[, , i<span class="dv">-1</span>] <span class="sc">%*%</span> <span class="fu">t</span>(Gt[, , i])</span>
<span id="cb12-906"><a href="#cb12-906" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb12-907"><a href="#cb12-907" aria-hidden="true" tabindex="-1"></a>        Wt <span class="ot">&lt;-</span> Wt_star[, , i] <span class="sc">*</span> St[i<span class="dv">-1</span>]</span>
<span id="cb12-908"><a href="#cb12-908" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Pt <span class="sc">+</span> Wt</span>
<span id="cb12-909"><a href="#cb12-909" aria-hidden="true" tabindex="-1"></a>        Rt[,,i]<span class="ot">=</span><span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb12-910"><a href="#cb12-910" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb12-911"><a href="#cb12-911" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Pt<span class="sc">/</span>delta</span>
<span id="cb12-912"><a href="#cb12-912" aria-hidden="true" tabindex="-1"></a>        Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb12-913"><a href="#cb12-913" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb12-914"><a href="#cb12-914" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-915"><a href="#cb12-915" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-916"><a href="#cb12-916" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments of one-step forecast:</span></span>
<span id="cb12-917"><a href="#cb12-917" aria-hidden="true" tabindex="-1"></a>    ft[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , i]) <span class="sc">%*%</span> <span class="fu">t</span>(at[i, , <span class="at">drop=</span><span class="cn">FALSE</span>]) </span>
<span id="cb12-918"><a href="#cb12-918" aria-hidden="true" tabindex="-1"></a>    Qt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , i]) <span class="sc">%*%</span> Rt[, , i] <span class="sc">%*%</span> Ft[, , i] <span class="sc">+</span> </span>
<span id="cb12-919"><a href="#cb12-919" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(i<span class="sc">==</span><span class="dv">1</span>, S0, St[i<span class="dv">-1</span>])</span>
<span id="cb12-920"><a href="#cb12-920" aria-hidden="true" tabindex="-1"></a>    et[i] <span class="ot">&lt;-</span> yt[i] <span class="sc">-</span> ft[i]</span>
<span id="cb12-921"><a href="#cb12-921" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-922"><a href="#cb12-922" aria-hidden="true" tabindex="-1"></a>    nt[i] <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(i<span class="sc">==</span><span class="dv">1</span>, n0, nt[i<span class="dv">-1</span>]) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb12-923"><a href="#cb12-923" aria-hidden="true" tabindex="-1"></a>    St[i] <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(i<span class="sc">==</span><span class="dv">1</span>, S0, </span>
<span id="cb12-924"><a href="#cb12-924" aria-hidden="true" tabindex="-1"></a>                    St[i<span class="dv">-1</span>])<span class="sc">*</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>nt[i]<span class="sc">*</span>(et[i]<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span>Qt[i]<span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb12-925"><a href="#cb12-925" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-926"><a href="#cb12-926" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments of posterior at t:</span></span>
<span id="cb12-927"><a href="#cb12-927" aria-hidden="true" tabindex="-1"></a>    At <span class="ot">&lt;-</span> Rt[, , i] <span class="sc">%*%</span> Ft[, , i] <span class="sc">/</span> Qt[i]</span>
<span id="cb12-928"><a href="#cb12-928" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-929"><a href="#cb12-929" aria-hidden="true" tabindex="-1"></a>    mt[i, ] <span class="ot">&lt;-</span> at[i, ] <span class="sc">+</span> <span class="fu">t</span>(At) <span class="sc">*</span> et[i]</span>
<span id="cb12-930"><a href="#cb12-930" aria-hidden="true" tabindex="-1"></a>    Ct[, , i] <span class="ot">&lt;-</span> St[i]<span class="sc">/</span><span class="fu">ifelse</span>(i<span class="sc">==</span><span class="dv">1</span>, S0, </span>
<span id="cb12-931"><a href="#cb12-931" aria-hidden="true" tabindex="-1"></a>                  St[i<span class="dv">-1</span>])<span class="sc">*</span>(Rt[, , i] <span class="sc">-</span> Qt[i] <span class="sc">*</span> At <span class="sc">%*%</span> <span class="fu">t</span>(At))</span>
<span id="cb12-932"><a href="#cb12-932" aria-hidden="true" tabindex="-1"></a>    Ct[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Ct[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Ct[,,i])</span>
<span id="cb12-933"><a href="#cb12-933" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-934"><a href="#cb12-934" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Forward filtering is completed!</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb12-935"><a href="#cb12-935" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mt =</span> mt, <span class="at">Ct =</span> Ct,  <span class="at">at =</span> at, <span class="at">Rt =</span> Rt, </span>
<span id="cb12-936"><a href="#cb12-936" aria-hidden="true" tabindex="-1"></a>              <span class="at">ft =</span> ft, <span class="at">Qt =</span> Qt,  <span class="at">et =</span> et, </span>
<span id="cb12-937"><a href="#cb12-937" aria-hidden="true" tabindex="-1"></a>              <span class="at">nt =</span> nt, <span class="at">St =</span> St))</span>
<span id="cb12-938"><a href="#cb12-938" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-939"><a href="#cb12-939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-940"><a href="#cb12-940" aria-hidden="true" tabindex="-1"></a><span class="do">### smoothing function </span><span class="al">###</span></span>
<span id="cb12-941"><a href="#cb12-941" aria-hidden="true" tabindex="-1"></a>backward_smoothing_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(data, matrices, </span>
<span id="cb12-942"><a href="#cb12-942" aria-hidden="true" tabindex="-1"></a>                                posterior_states,delta){</span>
<span id="cb12-943"><a href="#cb12-943" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve data </span></span>
<span id="cb12-944"><a href="#cb12-944" aria-hidden="true" tabindex="-1"></a>  yt <span class="ot">&lt;-</span> data<span class="sc">$</span>yt</span>
<span id="cb12-945"><a href="#cb12-945" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> <span class="fu">length</span>(yt) </span>
<span id="cb12-946"><a href="#cb12-946" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-947"><a href="#cb12-947" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb12-948"><a href="#cb12-948" aria-hidden="true" tabindex="-1"></a>  Ft <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Ft</span>
<span id="cb12-949"><a href="#cb12-949" aria-hidden="true" tabindex="-1"></a>  Gt <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Gt</span>
<span id="cb12-950"><a href="#cb12-950" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-951"><a href="#cb12-951" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb12-952"><a href="#cb12-952" aria-hidden="true" tabindex="-1"></a>  mt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>mt</span>
<span id="cb12-953"><a href="#cb12-953" aria-hidden="true" tabindex="-1"></a>  Ct <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>Ct</span>
<span id="cb12-954"><a href="#cb12-954" aria-hidden="true" tabindex="-1"></a>  Rt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>Rt</span>
<span id="cb12-955"><a href="#cb12-955" aria-hidden="true" tabindex="-1"></a>  nt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>nt</span>
<span id="cb12-956"><a href="#cb12-956" aria-hidden="true" tabindex="-1"></a>  St <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>St</span>
<span id="cb12-957"><a href="#cb12-957" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>at</span>
<span id="cb12-958"><a href="#cb12-958" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-959"><a href="#cb12-959" aria-hidden="true" tabindex="-1"></a>  <span class="do">## create placeholder for posterior moments </span></span>
<span id="cb12-960"><a href="#cb12-960" aria-hidden="true" tabindex="-1"></a>  mnt <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">dim</span>(mt)[<span class="dv">1</span>], <span class="at">ncol =</span> <span class="fu">dim</span>(mt)[<span class="dv">2</span>])</span>
<span id="cb12-961"><a href="#cb12-961" aria-hidden="true" tabindex="-1"></a>  Cnt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">dim</span>(Ct))</span>
<span id="cb12-962"><a href="#cb12-962" aria-hidden="true" tabindex="-1"></a>  fnt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb12-963"><a href="#cb12-963" aria-hidden="true" tabindex="-1"></a>  Qnt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb12-964"><a href="#cb12-964" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-965"><a href="#cb12-965" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> T<span class="sc">:</span><span class="dv">1</span>){</span>
<span id="cb12-966"><a href="#cb12-966" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> T){</span>
<span id="cb12-967"><a href="#cb12-967" aria-hidden="true" tabindex="-1"></a>      mnt[i, ] <span class="ot">&lt;-</span> mt[i, ]</span>
<span id="cb12-968"><a href="#cb12-968" aria-hidden="true" tabindex="-1"></a>      Cnt[, , i] <span class="ot">&lt;-</span> Ct[, , i]</span>
<span id="cb12-969"><a href="#cb12-969" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb12-970"><a href="#cb12-970" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb12-971"><a href="#cb12-971" aria-hidden="true" tabindex="-1"></a>        inv_Rtp1 <span class="ot">&lt;-</span> <span class="fu">chol2inv</span>(<span class="fu">chol</span>(Rt[, , i<span class="sc">+</span><span class="dv">1</span>]))</span>
<span id="cb12-972"><a href="#cb12-972" aria-hidden="true" tabindex="-1"></a>        Bt <span class="ot">&lt;-</span> Ct[, , i] <span class="sc">%*%</span> <span class="fu">t</span>(Gt[, , i<span class="sc">+</span><span class="dv">1</span>]) <span class="sc">%*%</span> inv_Rtp1</span>
<span id="cb12-973"><a href="#cb12-973" aria-hidden="true" tabindex="-1"></a>        mnt[i, ] <span class="ot">&lt;-</span> mt[i, ] <span class="sc">+</span> Bt <span class="sc">%*%</span> (mnt[i<span class="sc">+</span><span class="dv">1</span>, ] <span class="sc">-</span> at[i<span class="sc">+</span><span class="dv">1</span>, ])</span>
<span id="cb12-974"><a href="#cb12-974" aria-hidden="true" tabindex="-1"></a>        Cnt[, , i] <span class="ot">&lt;-</span> Ct[, , i] <span class="sc">+</span> Bt <span class="sc">%*%</span> (Cnt[, , i<span class="sc">+</span><span class="dv">1</span>] <span class="sc">-</span> </span>
<span id="cb12-975"><a href="#cb12-975" aria-hidden="true" tabindex="-1"></a>                                    Rt[, , i<span class="sc">+</span><span class="dv">1</span>]) <span class="sc">%*%</span> <span class="fu">t</span>(Bt)</span>
<span id="cb12-976"><a href="#cb12-976" aria-hidden="true" tabindex="-1"></a>        Cnt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Cnt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Cnt[,,i])</span>
<span id="cb12-977"><a href="#cb12-977" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb12-978"><a href="#cb12-978" aria-hidden="true" tabindex="-1"></a>        inv_Gt <span class="ot">&lt;-</span> <span class="fu">solve</span>(Gt[, , i<span class="sc">+</span><span class="dv">1</span>])</span>
<span id="cb12-979"><a href="#cb12-979" aria-hidden="true" tabindex="-1"></a>        mnt[i, ] <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">-</span>delta)<span class="sc">*</span>mt[i, ] <span class="sc">+</span> </span>
<span id="cb12-980"><a href="#cb12-980" aria-hidden="true" tabindex="-1"></a>                delta<span class="sc">*</span>inv_Gt <span class="sc">%*%</span> <span class="fu">t</span>(mnt[i<span class="sc">+</span><span class="dv">1</span>, ,<span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb12-981"><a href="#cb12-981" aria-hidden="true" tabindex="-1"></a>        Cnt[, , i] <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">-</span>delta)<span class="sc">*</span>Ct[, , i] <span class="sc">+</span> </span>
<span id="cb12-982"><a href="#cb12-982" aria-hidden="true" tabindex="-1"></a>                delta<span class="sc">^</span><span class="dv">2</span><span class="sc">*</span>inv_Gt <span class="sc">%*%</span> Cnt[, , i <span class="sc">+</span> <span class="dv">1</span>]  <span class="sc">%*%</span> <span class="fu">t</span>(inv_Gt)</span>
<span id="cb12-983"><a href="#cb12-983" aria-hidden="true" tabindex="-1"></a>        Cnt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Cnt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Cnt[,,i])</span>
<span id="cb12-984"><a href="#cb12-984" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb12-985"><a href="#cb12-985" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-986"><a href="#cb12-986" aria-hidden="true" tabindex="-1"></a>    fnt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , i]) <span class="sc">%*%</span> <span class="fu">t</span>(mnt[i, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb12-987"><a href="#cb12-987" aria-hidden="true" tabindex="-1"></a>    Qnt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , i]) <span class="sc">%*%</span> <span class="fu">t</span>(Cnt[, , i]) <span class="sc">%*%</span> Ft[, , i]</span>
<span id="cb12-988"><a href="#cb12-988" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-989"><a href="#cb12-989" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T){</span>
<span id="cb12-990"><a href="#cb12-990" aria-hidden="true" tabindex="-1"></a>     Cnt[,,i]<span class="ot">=</span>St[T]<span class="sc">*</span>Cnt[,,i]<span class="sc">/</span>St[i] </span>
<span id="cb12-991"><a href="#cb12-991" aria-hidden="true" tabindex="-1"></a>     Qnt[i]<span class="ot">=</span>St[T]<span class="sc">*</span>Qnt[i]<span class="sc">/</span>St[i]</span>
<span id="cb12-992"><a href="#cb12-992" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-993"><a href="#cb12-993" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Backward smoothing is completed!</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb12-994"><a href="#cb12-994" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mnt =</span> mnt, <span class="at">Cnt =</span> Cnt, <span class="at">fnt=</span>fnt, <span class="at">Qnt=</span>Qnt))</span>
<span id="cb12-995"><a href="#cb12-995" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-996"><a href="#cb12-996" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-997"><a href="#cb12-997" aria-hidden="true" tabindex="-1"></a><span class="do">## Forecast Distribution for k step</span></span>
<span id="cb12-998"><a href="#cb12-998" aria-hidden="true" tabindex="-1"></a>forecast_function_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(posterior_states, k, </span>
<span id="cb12-999"><a href="#cb12-999" aria-hidden="true" tabindex="-1"></a>                                        matrices, delta){</span>
<span id="cb12-1000"><a href="#cb12-1000" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-1001"><a href="#cb12-1001" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb12-1002"><a href="#cb12-1002" aria-hidden="true" tabindex="-1"></a>  Ft <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Ft</span>
<span id="cb12-1003"><a href="#cb12-1003" aria-hidden="true" tabindex="-1"></a>  Gt <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Gt</span>
<span id="cb12-1004"><a href="#cb12-1004" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb12-1005"><a href="#cb12-1005" aria-hidden="true" tabindex="-1"></a>    Wt_star <span class="ot">&lt;-</span> matrices<span class="sc">$</span>Wt_star</span>
<span id="cb12-1006"><a href="#cb12-1006" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-1007"><a href="#cb12-1007" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-1008"><a href="#cb12-1008" aria-hidden="true" tabindex="-1"></a>  mt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>mt</span>
<span id="cb12-1009"><a href="#cb12-1009" aria-hidden="true" tabindex="-1"></a>  Ct <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>Ct</span>
<span id="cb12-1010"><a href="#cb12-1010" aria-hidden="true" tabindex="-1"></a>  St <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>St</span>
<span id="cb12-1011"><a href="#cb12-1011" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>at</span>
<span id="cb12-1012"><a href="#cb12-1012" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-1013"><a href="#cb12-1013" aria-hidden="true" tabindex="-1"></a>  <span class="do">## set up matrices</span></span>
<span id="cb12-1014"><a href="#cb12-1014" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> <span class="fu">dim</span>(mt)[<span class="dv">1</span>] <span class="co"># time points</span></span>
<span id="cb12-1015"><a href="#cb12-1015" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">dim</span>(mt)[<span class="dv">2</span>] <span class="co"># dimension of state parameter vector</span></span>
<span id="cb12-1016"><a href="#cb12-1016" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-1017"><a href="#cb12-1017" aria-hidden="true" tabindex="-1"></a>  <span class="do">## placeholder for results</span></span>
<span id="cb12-1018"><a href="#cb12-1018" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> k, <span class="at">ncol =</span> d)</span>
<span id="cb12-1019"><a href="#cb12-1019" aria-hidden="true" tabindex="-1"></a>  Rt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, k))</span>
<span id="cb12-1020"><a href="#cb12-1020" aria-hidden="true" tabindex="-1"></a>  ft <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k)</span>
<span id="cb12-1021"><a href="#cb12-1021" aria-hidden="true" tabindex="-1"></a>  Qt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k)</span>
<span id="cb12-1022"><a href="#cb12-1022" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-1023"><a href="#cb12-1023" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k){</span>
<span id="cb12-1024"><a href="#cb12-1024" aria-hidden="true" tabindex="-1"></a>    <span class="do">## moments of state distribution</span></span>
<span id="cb12-1025"><a href="#cb12-1025" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb12-1026"><a href="#cb12-1026" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> <span class="fu">t</span>(mt[T, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb12-1027"><a href="#cb12-1027" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-1028"><a href="#cb12-1028" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb12-1029"><a href="#cb12-1029" aria-hidden="true" tabindex="-1"></a>       Rt[, , i] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> Ct[, , T] <span class="sc">%*%</span> </span>
<span id="cb12-1030"><a href="#cb12-1030" aria-hidden="true" tabindex="-1"></a>         <span class="fu">t</span>(Gt[, , T<span class="sc">+</span>i]) <span class="sc">+</span> St[T]<span class="sc">*</span>Wt_star[, , T<span class="sc">+</span>i]</span>
<span id="cb12-1031"><a href="#cb12-1031" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb12-1032"><a href="#cb12-1032" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> Ct[, , T] <span class="sc">%*%</span> </span>
<span id="cb12-1033"><a href="#cb12-1033" aria-hidden="true" tabindex="-1"></a>          <span class="fu">t</span>(Gt[, , T<span class="sc">+</span>i])<span class="sc">/</span>delta</span>
<span id="cb12-1034"><a href="#cb12-1034" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb12-1035"><a href="#cb12-1035" aria-hidden="true" tabindex="-1"></a>      Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb12-1036"><a href="#cb12-1036" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-1037"><a href="#cb12-1037" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb12-1038"><a href="#cb12-1038" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> <span class="fu">t</span>(at[i<span class="dv">-1</span>, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb12-1039"><a href="#cb12-1039" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">missing</span>(delta)){</span>
<span id="cb12-1040"><a href="#cb12-1040" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> Rt[, , i<span class="dv">-1</span>] <span class="sc">%*%</span> </span>
<span id="cb12-1041"><a href="#cb12-1041" aria-hidden="true" tabindex="-1"></a>          <span class="fu">t</span>(Gt[, , T<span class="sc">+</span>i]) <span class="sc">+</span> St[T]<span class="sc">*</span>Wt_star[, , T <span class="sc">+</span> i]</span>
<span id="cb12-1042"><a href="#cb12-1042" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb12-1043"><a href="#cb12-1043" aria-hidden="true" tabindex="-1"></a>        Rt[, , i] <span class="ot">&lt;-</span> Gt[, , T<span class="sc">+</span>i] <span class="sc">%*%</span> Rt[, , i<span class="dv">-1</span>] <span class="sc">%*%</span> </span>
<span id="cb12-1044"><a href="#cb12-1044" aria-hidden="true" tabindex="-1"></a>          <span class="fu">t</span>(Gt[, , T<span class="sc">+</span>i])<span class="sc">/</span>delta</span>
<span id="cb12-1045"><a href="#cb12-1045" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb12-1046"><a href="#cb12-1046" aria-hidden="true" tabindex="-1"></a>      Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i])</span>
<span id="cb12-1047"><a href="#cb12-1047" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-1048"><a href="#cb12-1048" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-1049"><a href="#cb12-1049" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-1050"><a href="#cb12-1050" aria-hidden="true" tabindex="-1"></a>    <span class="do">## moments of forecast distribution</span></span>
<span id="cb12-1051"><a href="#cb12-1051" aria-hidden="true" tabindex="-1"></a>    ft[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , T<span class="sc">+</span>i]) <span class="sc">%*%</span> <span class="fu">t</span>(at[i, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb12-1052"><a href="#cb12-1052" aria-hidden="true" tabindex="-1"></a>    Qt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(Ft[, , T<span class="sc">+</span>i]) <span class="sc">%*%</span> Rt[, , i] <span class="sc">%*%</span> Ft[, , T<span class="sc">+</span>i] <span class="sc">+</span> </span>
<span id="cb12-1053"><a href="#cb12-1053" aria-hidden="true" tabindex="-1"></a>      St[T]</span>
<span id="cb12-1054"><a href="#cb12-1054" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-1055"><a href="#cb12-1055" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Forecasting is completed!</span><span class="sc">\n</span><span class="st">"</span>) <span class="co"># indicator of completion</span></span>
<span id="cb12-1056"><a href="#cb12-1056" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">at=</span>at, <span class="at">Rt=</span>Rt, <span class="at">ft=</span>ft, <span class="at">Qt=</span>Qt))</span>
<span id="cb12-1057"><a href="#cb12-1057" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-1058"><a href="#cb12-1058" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1059"><a href="#cb12-1059" aria-hidden="true" tabindex="-1"></a><span class="do">## obtain 95% credible interval</span></span>
<span id="cb12-1060"><a href="#cb12-1060" aria-hidden="true" tabindex="-1"></a>get_credible_interval_unknown_v <span class="ot">&lt;-</span> <span class="cf">function</span>(ft, Qt, nt, </span>
<span id="cb12-1061"><a href="#cb12-1061" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">quantile =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)){</span>
<span id="cb12-1062"><a href="#cb12-1062" aria-hidden="true" tabindex="-1"></a>  bound <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span><span class="fu">length</span>(ft), <span class="at">ncol=</span><span class="dv">2</span>)</span>
<span id="cb12-1063"><a href="#cb12-1063" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1064"><a href="#cb12-1064" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((<span class="fu">length</span>(nt)<span class="sc">==</span><span class="dv">1</span>)){</span>
<span id="cb12-1065"><a href="#cb12-1065" aria-hidden="true" tabindex="-1"></a>   <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(ft)){</span>
<span id="cb12-1066"><a href="#cb12-1066" aria-hidden="true" tabindex="-1"></a>      t_quantile <span class="ot">&lt;-</span> <span class="fu">qt</span>(quantile[<span class="dv">1</span>], <span class="at">df =</span> nt)</span>
<span id="cb12-1067"><a href="#cb12-1067" aria-hidden="true" tabindex="-1"></a>      bound[t, <span class="dv">1</span>] <span class="ot">&lt;-</span> ft[t] <span class="sc">+</span> t_quantile<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(Qt[t])) </span>
<span id="cb12-1068"><a href="#cb12-1068" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-1069"><a href="#cb12-1069" aria-hidden="true" tabindex="-1"></a>  <span class="co"># upper bound of 95% credible interval</span></span>
<span id="cb12-1070"><a href="#cb12-1070" aria-hidden="true" tabindex="-1"></a>      t_quantile <span class="ot">&lt;-</span> <span class="fu">qt</span>(quantile[<span class="dv">2</span>], <span class="at">df =</span> nt)</span>
<span id="cb12-1071"><a href="#cb12-1071" aria-hidden="true" tabindex="-1"></a>      bound[t, <span class="dv">2</span>] <span class="ot">&lt;-</span> ft[t] <span class="sc">+</span> </span>
<span id="cb12-1072"><a href="#cb12-1072" aria-hidden="true" tabindex="-1"></a>        t_quantile<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(Qt[t]))}</span>
<span id="cb12-1073"><a href="#cb12-1073" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb12-1074"><a href="#cb12-1074" aria-hidden="true" tabindex="-1"></a>  <span class="co"># lower bound of 95% credible interval</span></span>
<span id="cb12-1075"><a href="#cb12-1075" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(ft)){</span>
<span id="cb12-1076"><a href="#cb12-1076" aria-hidden="true" tabindex="-1"></a>      t_quantile <span class="ot">&lt;-</span> <span class="fu">qt</span>(quantile[<span class="dv">1</span>], <span class="at">df =</span> nt[t])</span>
<span id="cb12-1077"><a href="#cb12-1077" aria-hidden="true" tabindex="-1"></a>      bound[t, <span class="dv">1</span>] <span class="ot">&lt;-</span> ft[t] <span class="sc">+</span> </span>
<span id="cb12-1078"><a href="#cb12-1078" aria-hidden="true" tabindex="-1"></a>        t_quantile<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(Qt[t])) </span>
<span id="cb12-1079"><a href="#cb12-1079" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-1080"><a href="#cb12-1080" aria-hidden="true" tabindex="-1"></a>  <span class="co"># upper bound of 95% credible interval</span></span>
<span id="cb12-1081"><a href="#cb12-1081" aria-hidden="true" tabindex="-1"></a>      t_quantile <span class="ot">&lt;-</span> <span class="fu">qt</span>(quantile[<span class="dv">2</span>], <span class="at">df =</span> nt[t])</span>
<span id="cb12-1082"><a href="#cb12-1082" aria-hidden="true" tabindex="-1"></a>      bound[t, <span class="dv">2</span>] <span class="ot">&lt;-</span> ft[t] <span class="sc">+</span> </span>
<span id="cb12-1083"><a href="#cb12-1083" aria-hidden="true" tabindex="-1"></a>        t_quantile<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(Qt[t]))}</span>
<span id="cb12-1084"><a href="#cb12-1084" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-1085"><a href="#cb12-1085" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(bound)</span>
<span id="cb12-1086"><a href="#cb12-1086" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1087"><a href="#cb12-1087" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-1088"><a href="#cb12-1088" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-1089"><a href="#cb12-1089" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1090"><a href="#cb12-1090" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1091"><a href="#cb12-1091" aria-hidden="true" tabindex="-1"></a><span class="fu">### Discount factor selection functions</span></span>
<span id="cb12-1092"><a href="#cb12-1092" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1095"><a href="#cb12-1095" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-1096"><a href="#cb12-1096" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: code-discount-factor-selection</span></span>
<span id="cb12-1097"><a href="#cb12-1097" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1098"><a href="#cb12-1098" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1099"><a href="#cb12-1099" aria-hidden="true" tabindex="-1"></a><span class="do">##################################################</span></span>
<span id="cb12-1100"><a href="#cb12-1100" aria-hidden="true" tabindex="-1"></a><span class="do">##### using discount factor ##########</span></span>
<span id="cb12-1101"><a href="#cb12-1101" aria-hidden="true" tabindex="-1"></a><span class="do">##################################################</span></span>
<span id="cb12-1102"><a href="#cb12-1102" aria-hidden="true" tabindex="-1"></a><span class="do">## compute measures of forecasting accuracy</span></span>
<span id="cb12-1103"><a href="#cb12-1103" aria-hidden="true" tabindex="-1"></a><span class="do">## MAD: mean absolute deviation</span></span>
<span id="cb12-1104"><a href="#cb12-1104" aria-hidden="true" tabindex="-1"></a><span class="do">## MSE: mean square error</span></span>
<span id="cb12-1105"><a href="#cb12-1105" aria-hidden="true" tabindex="-1"></a><span class="do">## MAPE: mean absolute percentage error</span></span>
<span id="cb12-1106"><a href="#cb12-1106" aria-hidden="true" tabindex="-1"></a><span class="do">## Neg LL: Negative log-likelihood of disc,</span></span>
<span id="cb12-1107"><a href="#cb12-1107" aria-hidden="true" tabindex="-1"></a><span class="do">##         based on the one step ahead forecast distribution</span></span>
<span id="cb12-1108"><a href="#cb12-1108" aria-hidden="true" tabindex="-1"></a>measure_forecast_accuracy <span class="ot">&lt;-</span> <span class="cf">function</span>(et, yt, <span class="at">Qt=</span><span class="cn">NA</span>, <span class="at">nt=</span><span class="cn">NA</span>, type){</span>
<span id="cb12-1109"><a href="#cb12-1109" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(type <span class="sc">==</span> <span class="st">"MAD"</span>){</span>
<span id="cb12-1110"><a href="#cb12-1110" aria-hidden="true" tabindex="-1"></a>    measure <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">abs</span>(et))</span>
<span id="cb12-1111"><a href="#cb12-1111" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span> <span class="cf">if</span>(type <span class="sc">==</span> <span class="st">"MSE"</span>){</span>
<span id="cb12-1112"><a href="#cb12-1112" aria-hidden="true" tabindex="-1"></a>    measure <span class="ot">&lt;-</span> <span class="fu">mean</span>(et<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb12-1113"><a href="#cb12-1113" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span> <span class="cf">if</span>(type <span class="sc">==</span> <span class="st">"MAPE"</span>){</span>
<span id="cb12-1114"><a href="#cb12-1114" aria-hidden="true" tabindex="-1"></a>    measure <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">abs</span>(et)<span class="sc">/</span>yt)</span>
<span id="cb12-1115"><a href="#cb12-1115" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span> <span class="cf">if</span>(type <span class="sc">==</span> <span class="st">"NLL"</span>){</span>
<span id="cb12-1116"><a href="#cb12-1116" aria-hidden="true" tabindex="-1"></a>    measure <span class="ot">&lt;-</span> <span class="fu">log_likelihood_one_step_ahead</span>(et, Qt, nt)</span>
<span id="cb12-1117"><a href="#cb12-1117" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb12-1118"><a href="#cb12-1118" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Wrong type!"</span>)</span>
<span id="cb12-1119"><a href="#cb12-1119" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-1120"><a href="#cb12-1120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(measure)</span>
<span id="cb12-1121"><a href="#cb12-1121" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-1122"><a href="#cb12-1122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1123"><a href="#cb12-1123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1124"><a href="#cb12-1124" aria-hidden="true" tabindex="-1"></a><span class="do">## compute log likelihood of one step ahead forecast function</span></span>
<span id="cb12-1125"><a href="#cb12-1125" aria-hidden="true" tabindex="-1"></a>log_likelihood_one_step_ahead <span class="ot">&lt;-</span> <span class="cf">function</span>(et, Qt, nt){</span>
<span id="cb12-1126"><a href="#cb12-1126" aria-hidden="true" tabindex="-1"></a>  <span class="do">## et:the one-step-ahead error</span></span>
<span id="cb12-1127"><a href="#cb12-1127" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Qt: variance of one-step-ahead forecast function</span></span>
<span id="cb12-1128"><a href="#cb12-1128" aria-hidden="true" tabindex="-1"></a>  <span class="do">## nt: degrees freedom of t distribution</span></span>
<span id="cb12-1129"><a href="#cb12-1129" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> <span class="fu">length</span>(et)</span>
<span id="cb12-1130"><a href="#cb12-1130" aria-hidden="true" tabindex="-1"></a>  aux<span class="ot">=</span><span class="dv">0</span></span>
<span id="cb12-1131"><a href="#cb12-1131" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T){</span>
<span id="cb12-1132"><a href="#cb12-1132" aria-hidden="true" tabindex="-1"></a>    zt<span class="ot">=</span>et[t]<span class="sc">/</span><span class="fu">sqrt</span>(Qt[t])</span>
<span id="cb12-1133"><a href="#cb12-1133" aria-hidden="true" tabindex="-1"></a>    aux<span class="ot">=</span>(<span class="fu">dt</span>(zt,<span class="at">df=</span>nt[t],<span class="at">log=</span><span class="cn">TRUE</span>)<span class="sc">-</span><span class="fu">log</span>(<span class="fu">sqrt</span>(Qt[t]))) <span class="sc">+</span> aux </span>
<span id="cb12-1134"><a href="#cb12-1134" aria-hidden="true" tabindex="-1"></a>  } </span>
<span id="cb12-1135"><a href="#cb12-1135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="sc">-</span>aux)</span>
<span id="cb12-1136"><a href="#cb12-1136" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-1137"><a href="#cb12-1137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1138"><a href="#cb12-1138" aria-hidden="true" tabindex="-1"></a><span class="do">## Maximize log density of one-step-ahead forecast function to select discount factor</span></span>
<span id="cb12-1139"><a href="#cb12-1139" aria-hidden="true" tabindex="-1"></a>adaptive_dlm <span class="ot">&lt;-</span> <span class="cf">function</span>(data, matrices, initial_states, df_range, type, </span>
<span id="cb12-1140"><a href="#cb12-1140" aria-hidden="true" tabindex="-1"></a>                         <span class="at">forecast=</span><span class="cn">TRUE</span>){</span>
<span id="cb12-1141"><a href="#cb12-1141" aria-hidden="true" tabindex="-1"></a>  measure_best <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb12-1142"><a href="#cb12-1142" aria-hidden="true" tabindex="-1"></a>  measure <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">length</span>(df_range))</span>
<span id="cb12-1143"><a href="#cb12-1143" aria-hidden="true" tabindex="-1"></a>  valid_data <span class="ot">&lt;-</span> data<span class="sc">$</span>valid_data</span>
<span id="cb12-1144"><a href="#cb12-1144" aria-hidden="true" tabindex="-1"></a>  df_opt <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb12-1145"><a href="#cb12-1145" aria-hidden="true" tabindex="-1"></a>  j <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb12-1146"><a href="#cb12-1146" aria-hidden="true" tabindex="-1"></a>  <span class="do">## find the optimal discount factor</span></span>
<span id="cb12-1147"><a href="#cb12-1147" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> df_range){</span>
<span id="cb12-1148"><a href="#cb12-1148" aria-hidden="true" tabindex="-1"></a>    j <span class="ot">&lt;-</span> j <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb12-1149"><a href="#cb12-1149" aria-hidden="true" tabindex="-1"></a>    results_tmp <span class="ot">&lt;-</span> <span class="fu">forward_filter_unknown_v</span>(data, matrices, initial_states, i)</span>
<span id="cb12-1150"><a href="#cb12-1150" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb12-1151"><a href="#cb12-1151" aria-hidden="true" tabindex="-1"></a>    measure[j] <span class="ot">&lt;-</span> <span class="fu">measure_forecast_accuracy</span>(<span class="at">et=</span>results_tmp<span class="sc">$</span>et, <span class="at">yt=</span>data<span class="sc">$</span>yt,</span>
<span id="cb12-1152"><a href="#cb12-1152" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">Qt=</span>results_tmp<span class="sc">$</span>Qt, </span>
<span id="cb12-1153"><a href="#cb12-1153" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">nt=</span><span class="fu">c</span>(initial_states<span class="sc">$</span>n0,results_tmp<span class="sc">$</span>nt), <span class="at">type=</span>type)</span>
<span id="cb12-1154"><a href="#cb12-1154" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-1155"><a href="#cb12-1155" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-1156"><a href="#cb12-1156" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(j <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb12-1157"><a href="#cb12-1157" aria-hidden="true" tabindex="-1"></a>      measure_best <span class="ot">&lt;-</span> measure[j]</span>
<span id="cb12-1158"><a href="#cb12-1158" aria-hidden="true" tabindex="-1"></a>      results_filtered <span class="ot">&lt;-</span> results_tmp</span>
<span id="cb12-1159"><a href="#cb12-1159" aria-hidden="true" tabindex="-1"></a>      df_opt <span class="ot">&lt;-</span> i</span>
<span id="cb12-1160"><a href="#cb12-1160" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span> <span class="cf">if</span>(measure[j] <span class="sc">&lt;</span> measure_best){</span>
<span id="cb12-1161"><a href="#cb12-1161" aria-hidden="true" tabindex="-1"></a>      measure_best <span class="ot">&lt;-</span> measure[j]</span>
<span id="cb12-1162"><a href="#cb12-1162" aria-hidden="true" tabindex="-1"></a>      results_filtered <span class="ot">&lt;-</span> results_tmp</span>
<span id="cb12-1163"><a href="#cb12-1163" aria-hidden="true" tabindex="-1"></a>      df_opt <span class="ot">&lt;-</span> i</span>
<span id="cb12-1164"><a href="#cb12-1164" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-1165"><a href="#cb12-1165" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-1166"><a href="#cb12-1166" aria-hidden="true" tabindex="-1"></a>  results_smoothed <span class="ot">&lt;-</span> <span class="fu">backward_smoothing_unknown_v</span>(data, matrices, results_filtered, <span class="at">delta =</span> df_opt)</span>
<span id="cb12-1167"><a href="#cb12-1167" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(forecast){</span>
<span id="cb12-1168"><a href="#cb12-1168" aria-hidden="true" tabindex="-1"></a>    results_forecast <span class="ot">&lt;-</span> <span class="fu">forecast_function</span>(results_filtered, <span class="fu">length</span>(valid_data), </span>
<span id="cb12-1169"><a href="#cb12-1169" aria-hidden="true" tabindex="-1"></a>                                          matrices, df_opt)</span>
<span id="cb12-1170"><a href="#cb12-1170" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">results_filtered=</span>results_filtered, </span>
<span id="cb12-1171"><a href="#cb12-1171" aria-hidden="true" tabindex="-1"></a>                <span class="at">results_smoothed=</span>results_smoothed, </span>
<span id="cb12-1172"><a href="#cb12-1172" aria-hidden="true" tabindex="-1"></a>                <span class="at">results_forecast=</span>results_forecast, </span>
<span id="cb12-1173"><a href="#cb12-1173" aria-hidden="true" tabindex="-1"></a>                <span class="at">df_opt =</span> df_opt, <span class="at">measure=</span>measure))</span>
<span id="cb12-1174"><a href="#cb12-1174" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb12-1175"><a href="#cb12-1175" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">results_filtered=</span>results_filtered, </span>
<span id="cb12-1176"><a href="#cb12-1176" aria-hidden="true" tabindex="-1"></a>                <span class="at">results_smoothed=</span>results_smoothed, </span>
<span id="cb12-1177"><a href="#cb12-1177" aria-hidden="true" tabindex="-1"></a>                <span class="at">df_opt =</span> df_opt, <span class="at">measure=</span>measure))</span>
<span id="cb12-1178"><a href="#cb12-1178" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-1179"><a href="#cb12-1179" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-1180"><a href="#cb12-1180" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-1181"><a href="#cb12-1181" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-1182"><a href="#cb12-1182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1183"><a href="#cb12-1183" aria-hidden="true" tabindex="-1"></a>::: {.callout-info}</span>
<span id="cb12-1184"><a href="#cb12-1184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1185"><a href="#cb12-1185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1186"><a href="#cb12-1186" aria-hidden="true" tabindex="-1"></a><span class="fu">### Grading Criteria</span></span>
<span id="cb12-1187"><a href="#cb12-1187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1188"><a href="#cb12-1188" aria-hidden="true" tabindex="-1"></a>The assignment will be graded based on the uploaded pictures summarizing the results.  Estimates of some of the model parameters and additional discussion will also be requested. </span>
<span id="cb12-1189"><a href="#cb12-1189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1190"><a href="#cb12-1190" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb12-1191"><a href="#cb12-1191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1192"><a href="#cb12-1192" aria-hidden="true" tabindex="-1"></a><span class="fu"># Case Studies</span></span>
<span id="cb12-1193"><a href="#cb12-1193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1194"><a href="#cb12-1194" aria-hidden="true" tabindex="-1"></a><span class="fu">## EEG data</span></span>
<span id="cb12-1195"><a href="#cb12-1195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1196"><a href="#cb12-1196" aria-hidden="true" tabindex="-1"></a><span class="fu">## Google Trends</span></span>
<span id="cb12-1197"><a href="#cb12-1197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1198"><a href="#cb12-1198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1199"><a href="#cb12-1199" aria-hidden="true" tabindex="-1"></a><span class="fu"># Quiz - NDLM, Part II</span></span>
<span id="cb12-1200"><a href="#cb12-1200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1201"><a href="#cb12-1201" aria-hidden="true" tabindex="-1"></a>This is omitted due to the Coursera honor code.</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"closeEffect":"fade","descPosition":"bottom","loop":true,"openEffect":"fade","selector":".lightbox","skin":"my-css-class"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>