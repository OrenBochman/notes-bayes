<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.11">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Oren Bochman">
<meta name="dcterms.date" content="2024-11-07">
<meta name="keywords" content="Time Series, Filtering, Kalman filtering, Smoothing, NDLM, Normal Dynamic Linear Models, Polynomial Trend Models, Regression Models, Superposition Principle, R code">
<meta name="description" content="Normal Dynamic Linear Models (NDLMs) are a class of models used for time series analysis that allow for flexible modeling of temporal dependencies.">

<title>94&nbsp; Bayesian Inference in the NDLM: Part 1 M3L7 – Bayesian Statistics</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./C4-L08.html" rel="next">
<link href="./C4-L06.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-279bd408c6dfe7bd56e8b154fe269440.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-923206e44a13b4518db4dede9f4ebdc9.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-279bd408c6dfe7bd56e8b154fe269440.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-cec409635dab7d42c7b562035797153a.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-987387ce273b62b48f1747d606bce1d5.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-cec409635dab7d42c7b562035797153a.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>

      .quarto-title-block .quarto-title-banner {
        background-image: url(images/banner_deep.jpg);
background-size: cover;
      }
</style>

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css">

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar floating slimcontent quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const queryPrefersDark = window.matchMedia('(prefers-color-scheme: dark)');
    const darkModeDefault = queryPrefersDark.matches;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    queryPrefersDark.addEventListener("change", e => {
      if(window.localStorage.getItem("quarto-color-scheme") !== null)
        return;
      const alternate = e.matches
      toggleColorMode(alternate);
      localAlternateSentinel = e.matches ? 'alternate' : 'default'; // this is used alongside local storage!
      toggleGiscusIfUsed(alternate, darkModeDefault);
    });
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./C4-L00.html">Time Series Analysis</a></li><li class="breadcrumb-item"><a href="./C4-L07.html"><span class="chapter-number">94</span>&nbsp; <span class="chapter-title">Bayesian Inference in the NDLM: Part 1 M3L7</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./C4-L00.html">Time Series Analysis</a></li><li class="breadcrumb-item"><a href="./C4-L07.html"><span class="chapter-number">94</span>&nbsp; <span class="chapter-title">Bayesian Inference in the NDLM: Part 1 M3L7</span></a></li></ol></nav>
      <div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">94</span>&nbsp; <span class="chapter-title">Bayesian Inference in the NDLM: Part 1 M3L7</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
            <p class="subtitle lead">Time Series Analysis</p>
                  <div>
        <div class="description">
          Normal Dynamic Linear Models (NDLMs) are a class of models used for time series analysis that allow for flexible modeling of temporal dependencies.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Bayesian Statistics</div>
                <div class="quarto-category">Time Series</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Oren Bochman </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">November 7, 2024</p>
      </div>
    </div>
    
      
    </div>
    

  <div>
    <div class="keywords">
      <div class="block-title">Keywords</div>
      <p>Time Series, Filtering, Kalman filtering, Smoothing, NDLM, Normal Dynamic Linear Models, Polynomial Trend Models, Regression Models, Superposition Principle, R code</p>
    </div>
  </div>
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Bayesian Statistics</a> 
        <div class="sidebar-tools-main">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./C1-L00.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">From Concept to Data Analysis</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Probability - M1L1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L01-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Paradigms of probability - M1L1HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Bayes’ Theorem - M1L2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L02-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Conditional Probability and Bayes’ Law - M1L2HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L02-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Probability and Bayes’ Theorem - M1L2HW2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Distributions - M1L3</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L03-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Random Variables - M1L3HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L03-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Homework on Distributions - M1L3HW2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Frequentist Inference - M2L4</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L04-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Frequentist MLE - M2L3HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Bayesian Inference - M2L5</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L05-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Homework on Likelihoods and MLEs - M2L5HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L05-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Homework on Bayesian Inference - M2L5HW2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Priors - M3L6</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L06-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Homework Posterior Probabilities - M3L6HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L07.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">M3L7 - Binomial Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L07-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Homework on Priors - M2L7HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L08.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Poisson Data - M3L8</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L08-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Homework on Poisson Data - M3L8HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L08-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Beta Bernoulli - M3L8HW2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L09.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">M4L9 - Exponential Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L09-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Homework on Exponential Data - M4L9HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Normally distributed Data - M4L10</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L10-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Homework on Normal Data - M4L10HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Non-Informative Priors - M4L11</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L11-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Homework Alternative Priors - M4L11HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Brief Review of Regression - M4L12</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L12-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">Homework Regression - M4L12HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1-L12-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">Homework Regression - M4L12HW2</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./C2-L00.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Techniques and Models</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">Statistical Modeling - M1L1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">M1L2 - Bayesian Modeling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">Monte Carlo estimation - M1L3</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">Metropolis-Hastings - M2L4</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L04-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">Homework on the Metropolis-Hastings algorithm - M2L4HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">Gibbs sampling - M2L5</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L05-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">Homework Gibbs-Sampling algorithm - M2L22HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">37</span>&nbsp; <span class="chapter-title">Assessing Convergence - M2L5</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L06-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">38</span>&nbsp; <span class="chapter-title">Homework on the Gibbs-Sampling algorithm - M2L5HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L06-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">Homework on M-H algorithm M2L5HW2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L07.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">40</span>&nbsp; <span class="chapter-title">Linear regression - M3L7</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L07-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">41</span>&nbsp; <span class="chapter-title">Homework on Linear Regression Model Part 1 - M2L5HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L07-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">42</span>&nbsp; <span class="chapter-title">Homework on Deviance information criterion - M2L5HW2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L08.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">43</span>&nbsp; <span class="chapter-title">ANOVA - M3L8</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L08-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">44</span>&nbsp; <span class="chapter-title">Homework on ANOVA - M3L8HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L08-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">45</span>&nbsp; <span class="chapter-title">Homework on Multiple Factor ANOVA - M3L8HW2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L09.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">46</span>&nbsp; <span class="chapter-title">Logistic regression - M3L9</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L09-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">47</span>&nbsp; <span class="chapter-title">Homework on Logistic Regression - M3L9HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">48</span>&nbsp; <span class="chapter-title">Poisson regression - M4L10</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L10-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">49</span>&nbsp; <span class="chapter-title">Homework on Poisson regression - M4L10HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">50</span>&nbsp; <span class="chapter-title">Hierarchical modeling - M4L11</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L11-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">51</span>&nbsp; <span class="chapter-title">Homework on Hierarchical Models - M4L11HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L11-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">52</span>&nbsp; <span class="chapter-title">Homework on Non-Normal Hierarchical Models - M4L11HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">53</span>&nbsp; <span class="chapter-title">Capstone Project - M4L12</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2-L12-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">54</span>&nbsp; <span class="chapter-title">Homework on Predictive distributions and mixture models - M4L12HW1</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./C3-L00.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Mixture Models</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">55</span>&nbsp; <span class="chapter-title">Definition of Mixture Models - M1L1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L01-Ex1-Basic-Definitions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">56</span>&nbsp; <span class="chapter-title">Basic Concepts of Mixture Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L01-Ex2-Gaussian-mixtures.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">57</span>&nbsp; <span class="chapter-title">Mixtures of Gaussians</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L01-Ex3-Zero-Inflated-distribution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">58</span>&nbsp; <span class="chapter-title">Zero inflated distributions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L01-Ex4-Def-mixture-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">59</span>&nbsp; <span class="chapter-title">Definition of Mixture Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">60</span>&nbsp; <span class="chapter-title">Likelihood functions for Mixture Models - M1L2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L02-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">61</span>&nbsp; <span class="chapter-title">Homework The Likelihood function - M1L2HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L02-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">62</span>&nbsp; <span class="chapter-title">Homework Identifiability - M1L2HW2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L02-Ex3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">63</span>&nbsp; <span class="chapter-title">Homework The likelihood function M1L2HW3</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L02-Ex4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">64</span>&nbsp; <span class="chapter-title">Homework on simulating from a Poisson Mixture Model - M1L2HW4</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L02-Ex5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">65</span>&nbsp; <span class="chapter-title">HW - Simulation of Poisson mixture model - M1L2HW5</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L02-Ex6.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">66</span>&nbsp; <span class="chapter-title">Homework Sim mixture of exponential distributions - M1L2HW6</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">67</span>&nbsp; <span class="chapter-title">The EM algorithm for Mixture models - M2L3</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L03-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">68</span>&nbsp; <span class="chapter-title">The EM algorithm for Zero-Inflated Mixtures</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L03-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">69</span>&nbsp; <span class="chapter-title">The EM algorithm for Mixture Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">70</span>&nbsp; <span class="chapter-title">MCMC for Mixture Models - M4L1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L04-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">71</span>&nbsp; <span class="chapter-title">The MCMC algorithm for Zero-Inflated Mixtures - M4L1HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L04-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">72</span>&nbsp; <span class="chapter-title">Markov chain Monte Carlo algorithms for Mixture Models - M4L1HW2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">73</span>&nbsp; <span class="chapter-title">Density Estimation - M4L5</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">74</span>&nbsp; <span class="chapter-title">Clustering - M4L6</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L07.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">75</span>&nbsp; <span class="chapter-title">Classification - M4L7</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L07-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">76</span>&nbsp; <span class="chapter-title">Old Faithful eruptions density estimation with the EM algorithm - M4L7HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L07-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">77</span>&nbsp; <span class="chapter-title">Old Faithful eruptions density estimation with the MCMC algorithms - M4L7HW2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L07-Ex3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">78</span>&nbsp; <span class="chapter-title">Homework on Bayesian Mixture Models for Classification of Banknotes - M4L7HW3</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L08.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">79</span>&nbsp; <span class="chapter-title">Computational Considerations - M5L8</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L08-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">80</span>&nbsp; <span class="chapter-title">Computational considerations for Mixture Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L09.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">81</span>&nbsp; <span class="chapter-title">Determining the number of components - M5L9</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L09-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">82</span>&nbsp; <span class="chapter-title">Homework on Bayesian Information Criteria (BIC) - M5L09HW1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L09-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">83</span>&nbsp; <span class="chapter-title">Homework on Estimating the number of components in Bayesian settings - M5L09HW2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L09-Ex3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">84</span>&nbsp; <span class="chapter-title">Homework on Estimating the partition structure in Bayesian models - M5L09HW3</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C3-L09-Ex4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">85</span>&nbsp; <span class="chapter-title">Homework on BIC for zero-inflated mixtures - M5L09HW4</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./C4-L00.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Time Series Analysis</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C4-L01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">86</span>&nbsp; <span class="chapter-title">Stationarity, The ACF and the PCF M1L1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C4-L02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">87</span>&nbsp; <span class="chapter-title">The AR(1) process: definitions and properties - M1L2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C4-L03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">88</span>&nbsp; <span class="chapter-title">The AR(1): MLE and Bayesian inference - M1L3</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C4-L04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">89</span>&nbsp; <span class="chapter-title">The AR(p) process - M2L4</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C4-L05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">90</span>&nbsp; <span class="chapter-title">Bayesian Inference in the AR(p) - M2L5</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C4-L05-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">91</span>&nbsp; <span class="chapter-title">Quiz: Spectral representation of the AR(p) - M2L5</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C4-L05-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">92</span>&nbsp; <span class="chapter-title">Graded Assignment: Bayesian analysis of an EEG dataset using an AR(p) - M2L5</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C4-L06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">93</span>&nbsp; <span class="chapter-title">Normal Dynamic Linear Models, Part 1 - M3L6</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C4-L07.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">94</span>&nbsp; <span class="chapter-title">Bayesian Inference in the NDLM: Part 1 M3L7</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C4-L08.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">95</span>&nbsp; <span class="chapter-title">Seasonal NDLMs M4L8</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C4-L09.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">96</span>&nbsp; <span class="chapter-title">Bayesian Inference in the NDLM: Part 2 - M4L9</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C4-L10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">97</span>&nbsp; <span class="chapter-title">Final Project</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C4-L11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">98</span>&nbsp; <span class="chapter-title">Week 0: Feynman Notebook on Bayesian Analysis</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./C5-L00.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Capstone Project</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C5-L01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">99</span>&nbsp; <span class="chapter-title">Bayesian Conjugate Analysis for Autogressive Time Series Models - M1L1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C5-L01-Ex1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">100</span>&nbsp; <span class="chapter-title">Homework - Practice Quiz for Week 1 – M1L1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C5-L01-Ex2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">101</span>&nbsp; <span class="chapter-title">Homework - first-step-for-the-project – M1L1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C5-L02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">102</span>&nbsp; <span class="chapter-title">Model Selection Criteria - M2L2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C5-L03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">103</span>&nbsp; <span class="chapter-title">Bayesian location mixture of AR(p) models - M3L3</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./C6-L00.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Non-Parametric Models</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C6-L01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">104</span>&nbsp; <span class="chapter-title">Gaussian Processes for Regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C6-L02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">105</span>&nbsp; <span class="chapter-title">Dirichlet Process</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Appendix: Notation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Appendix: Discrete Distributions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Appendix: Continuous Distributions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">D</span>&nbsp; <span class="chapter-title">Appendix: Exponents &amp; Logarithms</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A07.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">E</span>&nbsp; <span class="chapter-title">Appendix: The Law of Large Numbers</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A08.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">F</span>&nbsp; <span class="chapter-title">Appendix: The Central Limit Theorem</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A09.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">G</span>&nbsp; <span class="chapter-title">Appendix: Conjugate Priors</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">H</span>&nbsp; <span class="chapter-title">Appendix: Link Function</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">I</span>&nbsp; <span class="chapter-title">Appendix: Bayes by backprop</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">J</span>&nbsp; <span class="chapter-title">Bayesian Books in R &amp; Python</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A13.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">K</span>&nbsp; <span class="chapter-title">Appendix: Yule-Walker Equations &amp; Durbin-Levinson Recursion</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A14.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">L</span>&nbsp; <span class="chapter-title">Moore-Penrose Inversion &amp; Cholesky Decomposition</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A15.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">M</span>&nbsp; <span class="chapter-title">Appendix: Inequalities</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A16.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">N</span>&nbsp; <span class="chapter-title">Appendix: Wold’s theorem</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">O</span>&nbsp; <span class="chapter-title">References</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#filtering" id="toc-filtering" class="nav-link active" data-scroll-target="#filtering"><span class="header-section-number">94.1</span> Filtering <span class="emoji" data-emoji="movie_camera">🎥</span></a></li>
  <li><a href="#summary-of-filtering-distributions" id="toc-summary-of-filtering-distributions" class="nav-link" data-scroll-target="#summary-of-filtering-distributions"><span class="header-section-number">94.2</span> Summary of filtering distributions <span class="emoji" data-emoji="spiral_notepad">🗒️</span></a>
  <ul class="collapse">
  <li><a href="#bayesian-inference-in-ndlm-known-variances" id="toc-bayesian-inference-in-ndlm-known-variances" class="nav-link" data-scroll-target="#bayesian-inference-in-ndlm-known-variances"><span class="header-section-number">94.2.1</span> Bayesian Inference in NDLM: Known Variances</a></li>
  </ul></li>
  <li><a href="#code-filtering-in-the-ndlm-example-mathcalr" id="toc-code-filtering-in-the-ndlm-example-mathcalr" class="nav-link" data-scroll-target="#code-filtering-in-the-ndlm-example-mathcalr"><span class="header-section-number">94.3</span> code Filtering in the NDLM: Example <span class="emoji" data-emoji="spiral_notepad">🗒️</span> <span class="math inline">\mathcal{R}</span></a></li>
  <li><a href="#smoothing-and-forecasting" id="toc-smoothing-and-forecasting" class="nav-link" data-scroll-target="#smoothing-and-forecasting"><span class="header-section-number">94.4</span> Smoothing and forecasting <span class="emoji" data-emoji="movie_camera">🎥</span></a></li>
  <li><a href="#summary-of-the-smoothing-and-forecasting-distributions" id="toc-summary-of-the-smoothing-and-forecasting-distributions" class="nav-link" data-scroll-target="#summary-of-the-smoothing-and-forecasting-distributions"><span class="header-section-number">94.5</span> Summary of the smoothing and forecasting distributions <span class="emoji" data-emoji="spiral_notepad">🗒️</span></a>
  <ul class="collapse">
  <li><a href="#sec-inference-NDLM" id="toc-sec-inference-NDLM" class="nav-link" data-scroll-target="#sec-inference-NDLM"><span class="header-section-number">94.5.1</span> Bayesian Inference in NDLM: Known Variances</a></li>
  </ul></li>
  <li><a href="#smoothing-in-the-ndlm-example" id="toc-smoothing-in-the-ndlm-example" class="nav-link" data-scroll-target="#smoothing-in-the-ndlm-example"><span class="header-section-number">94.6</span> Smoothing in the NDLM, Example <span class="emoji" data-emoji="movie_camera">🎥</span></a></li>
  <li><a href="#sec-smoothing-in-the-NDLM" id="toc-sec-smoothing-in-the-NDLM" class="nav-link" data-scroll-target="#sec-smoothing-in-the-NDLM"><span class="header-section-number">94.7</span> Code: Smoothing in the NDLM, Example <span class="emoji" data-emoji="spiral_notepad">🗒️</span> <span class="math inline">\mathcal{R}</span></a></li>
  <li><a href="#sec-second-order-polynomial" id="toc-sec-second-order-polynomial" class="nav-link" data-scroll-target="#sec-second-order-polynomial"><span class="header-section-number">94.8</span> Second order polynomial: Filtering and smoothing example <span class="emoji" data-emoji="movie_camera">🎥</span></a></li>
  <li><a href="#using-the-dlm-package-in-r" id="toc-using-the-dlm-package-in-r" class="nav-link" data-scroll-target="#using-the-dlm-package-in-r"><span class="header-section-number">94.9</span> Using the dlm package in R <span class="emoji" data-emoji="movie_camera">🎥</span></a></li>
  <li><a href="#sec-dlm-package" id="toc-sec-dlm-package" class="nav-link" data-scroll-target="#sec-dlm-package"><span class="header-section-number">94.10</span> Code: Using the <code>dlm</code> package <span class="emoji" data-emoji="spiral_notepad">🗒️</span> <span class="math inline">\mathcal{R}</span></a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">







<div class="no-row-height column-margin column-container"><div id="vid-sean-law" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-vid figure">
<div aria-describedby="vid-sean-law-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-video ratio ratio-16x9"><iframe data-external="1" src="https://www.youtube.com/embed/0O6dlq6a4rA" title="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-vid" id="vid-sean-law-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Video&nbsp;94.1: Sean Law - STUMPY: Modern Time Series Analysis with Matrix Profiles
</figcaption>
</figure>
</div></div><p>We will now delve into Bayesian inference in the case of the normal dynamic linear model where both the observational variance and the system variance are known. We will talk about filtering equations, smoothing equations and also forecasting in this setting using Bayesian approach</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Reality check
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>A large portion of the next video is dedicated to laying the ground for use bayesian inference in the NDLM. I was thinking we will infer <span class="math inline">F, G,V, W</span> from the data, once we supply a normal prior <span class="math inline">\mathcal{N}(M,C)</span>. But this is not the case. In fact we don’t seem to be particularly Bayesian when going about constructing the NDLM model.</p>
<p>(i.e.&nbsp;filtering smoothing, of the parameters <span class="math inline">\theta_t</span> given the data and forecasting <span class="math inline">y_t</span> based on that)</p>
<p>I was initially disappointed that we assume that we know everything I want to infer. This is an open question for the proverbial <a href="./C4-L06.html">Feynman Notebook</a>. In reality that is just another problem. But that not the process with time series analysis.</p>
<p>However, at some point I saw a talk about <a href="https://stumpy.readthedocs.io/en/latest/Tutorial_STUMPY_Basics.html">STUMPY</a> which does many cool time series stuff in python. And the speaker Sean Law talks about all the different Data Science &amp; DSP Mojos <code>#magicspells</code> one can use, the nascent issues when comparing lots of times series or even just time series with lots of data. He makes another point that there is <code>#NoFreeLunch</code> - each Mojo comes with with its own assumptions and limitations before making the case for using <a href="https://stumpy.readthedocs.io/en/latest/Tutorial_STUMPY_Basics.html">Matrix Profiles</a>.</p>
<p>Prado lays the ground for working with a time series with around 300 data points - i.e.&nbsp;something we can still plot and view on the screen then inspect it. This might unlock for us, the NDLM framework which while flexible requires us to have a detailed form of the the model and its priors. This is easy enough if we deal with a synthetic data set, less so if we have need to analyze an novel time series for which we lack much intuition. Here we will need todo a preliminary exploratory data analysis before we can step in and construct our NDLM.</p>
<p>I suppose they expect that you will use some other non-bayesian tools to do this as we haven’t really covered this in her course.</p>
<p>Splitting a TS into trend periods and a stationary residual isn’t too tricky in R. Getting the inverse periods is then possible. Doing regression on the residuals is also possible. So if we have done all that we should be able to write down an NDLM based on all that we learned. And this will allow us to do filtering, smoothing and forecasting with error estimates.</p>
</div>
</div>
</div>
<section id="filtering" class="level2 page-columns page-full" data-number="94.1">
<h2 data-number="94.1" class="anchored" data-anchor-id="filtering"><span class="header-section-number">94.1</span> Filtering <span class="emoji" data-emoji="movie_camera">🎥</span></h2>

<div class="no-row-height column-margin column-container"><div id="fig-derivation-for-the-prior-and-forecast-at-time-t" class="quarto-float quarto-figure quarto-figure-center anchored" data-group="slides">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-derivation-for-the-prior-and-forecast-at-time-t-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="images/m3_0041.png" class="lightbox" data-gallery="slides" title="Figure&nbsp;94.1: Derivation for the Prior and Forecast at Time t"><img src="images/m3_0041.png" class="img-fluid figure-img" style="width:53mm"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-derivation-for-the-prior-and-forecast-at-time-t-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;94.1: Derivation for the Prior and Forecast at Time t
</figcaption>
</figure>
</div><div id="fig-derivation-of-the-posterior-at-time-t" class="quarto-float quarto-figure quarto-figure-center anchored" data-group="slides">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-derivation-of-the-posterior-at-time-t-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="images/m3_0042.png" class="lightbox" data-gallery="slides" title="Figure&nbsp;94.2: Derivation of the Posterior at Time t"><img src="images/m3_0042.png" class="img-fluid figure-img" style="width:53mm"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-derivation-of-the-posterior-at-time-t-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;94.2: Derivation of the Posterior at Time t
</figcaption>
</figure>
</div></div>
<p>Recall we are working in a Bayesian setting where a NDLM model with a normal prior would like this:</p>
<p><span id="eq-generic-NDLM"><span class="math display">
\begin{aligned}
  y_t &amp;= F_t' \theta_t + \nu_t &amp; \nu_t &amp;\sim \mathcal{N}(0, v_t) &amp; \text{(observation)} \\
  \theta_t &amp;= G_t \theta_{t-1} + \omega_t &amp; \omega_t &amp;\sim  \mathcal{N}(0, W_t) &amp; \text{(evolution)} \\
  &amp; &amp;(\theta_0 \mid \mathcal{D}_0) &amp; \sim  \mathcal{N}(m_0, C_0) &amp; \text{(prior)}
\end{aligned}
\tag{94.1}</span></span></p>
<ul>
<li>In the prior <span class="math inline">\mathcal{D}_0</span> stands for the information that we have before collecting any data and</li>
<li>We are assuming <span class="math inline">\theta_0</span> follows a normal distribution with</li>
<li><span class="math inline">m_0</span> mean</li>
<li><span class="math inline">C_0</span> variance covariance matrix.</li>
</ul>
<p>Since we are doing filtering which is a retrospective analysis, of past states we assume that we know <span class="math inline">m_0, C_0, \nu_t, \omega_t, F_t, G_t \qquad \forall t</span>.</p>
<p>However, there is often great interest in looking back in time in order to get a clearer picture of what happened.</p>
<p>We are interested in performing Bayesian inference in this setting and we talked about different kinds of distributions.</p>
<ul>
<li>One is the <strong>filtering distribution</strong> that allows us to update the distribution of <span class="math inline">\theta_t</span> as we receive observations and information over time.</li>
<li>The other one is <strong>smoothing equations</strong> that allows us to just revisit the past once we have observed a chunk of data.</li>
</ul>
<p>In a Bayesian setting, you have to set <em>a prior distribution</em>. <mark>We will work with the prior distribution that is conjugate.</mark></p>
<p>In this case we have to begin with a distribution at time zero for <span class="math inline">\theta_0</span>. So before we have seen any data at all, I have this prior distribution.</p>
<p>We also assume a prior distribution of the form:</p>
<p><span id="eq-filtering-assumption-1"><span class="math display">
(\theta_{t} \mid \mathcal{D}_{t-1}) \sim \mathcal{N}(m_{t-1}, C_{t-1}).
\tag{94.2}</span></span></p>
<p>We assume that this the filtering distribution follows this normal distribution based on</p>
<ol type="1">
<li>the prior in <a href="#eq-generic-NDLM" class="quarto-xref">Equation&nbsp;<span class="quarto-unresolved-ref">eq-generic-NDLM</span></a> being conjugate of the normal and<br>
</li>
<li>the linearity of the model in <a href="#eq-generic-NDLM" class="quarto-xref">Equation&nbsp;<span class="quarto-unresolved-ref">eq-generic-NDLM</span></a>.</li>
</ol>
<p>These result in updates to the model parameters and uncertainty, at each time step, preserving the normal structure from the prior.</p>
<p>Then, we can obtain the following distributions:</p>
<ol type="1">
<li>Prior at Time <span class="math inline">t</span></li>
</ol>
<p><span id="eq-prior-at-time-t"><span class="math display">
  (\theta_t \mid \mathcal{D}_{t-1}) \sim  \mathcal{N}(a_t, R_t) \qquad \text{(prior at time t)} \qquad
   \tag{94.3}</span></span></p>
<p>with</p>
<p><span id="eq-derivation-for-a-t-and-R-t"><span class="math display"> \begin{aligned}
  a_t \doteq&amp; \mathbb{E}[\theta_t \mid \mathcal{D}_{t-1}] =&amp; G_t  \mathbb{E}[G_t \theta_{t-1} \mid \mathcal{D}_{t-1} ] =&amp; G_t m_{t-1} \\
  R_t \doteq&amp; \mathbb{V}ar[\theta_t \mid \mathcal{D}_{t-1}] =&amp; G_t \mathbb{V}ar[\theta_t \mid \mathcal{D}_{t-1}] =&amp; G_t C_{t-1} G_t' + W_t.
  \end{aligned}
   \tag{94.4}</span></span></p>
<p>Where we simply took the first and second moments of the system equation from <a href="#eq-generic-NDLM" class="quarto-xref">Equation&nbsp;<span class="quarto-unresolved-ref">eq-generic-NDLM</span></a> conditioned on our information set <span class="math inline">\mathcal{D}_{t-1}</span></p>
<ol start="2" type="1">
<li>One-Step Forecast</li>
</ol>
<p><span id="eq-one-step-forecast-fn"><span class="math display">
  (y_t \mid \mathcal{D}_{t-1}) \sim  \mathcal{N}(f_t, q_t) \qquad \text{(one step forecast fn)} \qquad
   \tag{94.5}</span></span></p>
<p>with</p>
<p><span id="eq-derivation-for-f-t-and-q-t"><span class="math display">\begin{aligned}
  f_t
     &amp; \doteq \mathbb{E}[ y_t \mid \mathcal{D}_{t-1} ]
     &amp; = F_t' \mathbb{E}[ y_t \mid \mathcal{D}_{t-1} ]
     &amp; = F_t' a_t \\
  q_t
     &amp; \doteq \mathbb{V}ar[y_t \mid \mathcal{D}_{t-1}]
     &amp; = F_t' \mathbb{V}ar[y_t \mid \mathcal{D}_{t-1}]  
     &amp; = F_t' R_t F_t + v_t
  \end{aligned}
   \tag{94.6}</span></span></p>
<p>Where we took the first moments on the observation equation conditioned on the information set <span class="math inline">\mathcal{D}_t</span> and substituted <a href="#eq-one-step-forecast-fn" class="quarto-xref">Equation&nbsp;<span class="quarto-unresolved-ref">eq-one-step-forecast-fn</span></a></p>
<ol start="3" type="1">
<li>Posterior at Time <span class="math inline">t</span></li>
</ol>
<p><span class="math display">
  (\theta_t \mid \mathcal{D}_t) \sim  \mathcal{N}(m_t, C_t)
  </span></p>
<p>with</p>
<p><span id="eq-posterior-at-time-t"><span class="math display">\begin{aligned}
  m_t &amp;= a_t + R_t F_t q_t^{-1} (y_t - f_t), \\
  C_t &amp;= R_t - R_t F_t q_t^{-1} F_t' R_t.
  \end{aligned}
   \tag{94.7}</span></span></p>
<p>These can be derived via Normal theory or via the Multivariate Bayes’ theorem. The background for both seems to be provided in <span class="citation" data-cites="west2013bayesian">(<a href="#ref-west2013bayesian" role="doc-biblioref">West and Harrison 2013, secs. 17.2.3 p.639</a>)</span></p>
<p>Now, denoting <span class="math inline">e_t = (y_t - f_t)</span> and <span class="math inline">A_t = R_t F_t q_t^{-1}</span>, we can rewrite the equations above as:</p>
<p>It follows that</p>
<p><span class="math display">
\begin{pmatrix}Y \\ \theta\end{pmatrix} \sim \mathcal{N}
\left(
  \begin{pmatrix}F'a \\ a \end{pmatrix},
  \begin{pmatrix} F'RF + V &amp; F'R \\ RF &amp; R \end{pmatrix}
\right)
</span></p>
<p>Therefore, identifying <span class="math inline">Y</span> with <span class="math inline">X_1</span> and <span class="math inline">\theta</span> with <span class="math inline">X_2</span> in the partition of <span class="math inline">X</span> in 17.2.2, we have RF R )]</p>
<p>Therefore, identifying Y with X1 and θ with X2 in the partition of X in 17.2.2, we have <span class="math display">
Y \sim \mathcal{N}[F'a, F'RF + V]
</span></p>
<p><span class="math display">
(\theta \mid Y) \sim \mathcal{N}[m, C],
</span></p>
<p>where</p>
<p><span class="math display">
m = a + RF[F′RF + V]−1[Y − F′a]
</span></p>
<p>and <span class="math display">
C = R − RF[F′RF + V]−1F′R.
</span></p>
<p><span id="eq-posterior-distribution"><span class="math display">
  \begin{aligned}
  \theta \mid \mathcal{D}_t &amp;\sim \mathcal{N}(m_t,C_t)\\
  m_t &amp;\doteq a_t + A_t e_t, \\
  C_t &amp;\doteq R_t - A_t q_t A_t'
  \end{aligned}
\tag{94.8}</span></span></p>
<p><a href="#eq-derivation-for-a-t-and-R-t" class="quarto-xref">Equation&nbsp;<span class="quarto-unresolved-ref">eq-derivation-for-a-t-and-R-t</span></a> , <a href="#eq-derivation-for-f-t-and-q-t" class="quarto-xref">Equation&nbsp;<span class="quarto-unresolved-ref">eq-derivation-for-f-t-and-q-t</span></a> and <a href="#eq-posterior-distribution" class="quarto-xref">Equation&nbsp;<span class="quarto-unresolved-ref">eq-posterior-distribution</span></a> are often referred to as the <a href="https://en.wikipedia.org/wiki/Kalman_filter">Kalman filtering</a> equations.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Video Transcript
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<!-- transcript of https://www.coursera.org/learn/bayesian-statistics-time-series-analysis/lecture/EILYM/filtering -->
<p><mark>I will now discuss Bayesian inference in the case of the normal dynamic linear model where both the observational variance and the system variance are known. We will talk about filtering equations, smoothing equations and also forecasting in this setting using Bayesian approach.</mark></p>
<p><del>So recall we are working with a model that looks like this: … And then this is my first equation, the observation equation and I have a system equation that looks like this.</del></p>
<p><del>We are going to assume that <span class="math inline">V_t</span> and <span class="math inline">W_t</span> are known for every t. And we also know what the <span class="math inline">F_t</span>’s and the <span class="math inline">G_t</span>’s are here. So the response is a uni-dimensional <span class="math inline">y_t</span> and then I have, say, <span class="math inline">\theta_t</span> is a vector of a given dimension, depending on the structure of the model.</del></p>
<p><mark>We are interested in performing <strong>Bayesian inference</strong> in this setting and we talked about different kinds of distributions</mark></p>
<ul>
<li><p><mark>One is the <strong>filtering distribution</strong> that allows us to update the distribution of <span class="math inline">\theta_t</span> as we receive observations and information over time.</mark></p></li>
<li><p><mark>The other one is <strong>smoothing equations</strong> that allows us to just revisit the past once we have observed a chunk of data.</mark></p></li>
</ul>
<p><del>So I will be talking about those and also smoothing.</del></p>
<p><del>In a Bayesian setting, you have to set a prior distribution.</del> <mark>We will work with the prior distribution that is conjugate.</mark></p>
<p><del>In this case I have to begin with distribution at time zero. So before I know, I have seen any data at all,</del> <mark>I have this prior distribution. <span class="math inline">D_0</span> stands for the information that I have before collecting any data. And we are going to assume, That this <span class="math inline">\theta_0</span> follows a normal distribution with <span class="math inline">m_0</span> mean and variance covariance matrix <span class="math inline">C_0</span>. So these are also specified when you’re working with this model.</mark></p>
<p>So we assume that this <span class="math inline">m_0</span> and <span class="math inline">C_0</span> is known.</p>
<p><mark>Once we have this setting using these equations, we can obtain the filtering equations.</mark></p>
<p>So the first assumption is going to be that we have, a structure.</p>
<p>So for <span class="math inline">\theta_{t -1} \mid \mathcal{D}_{t-1}</span> is going to have this normal structure which is going to happen basically because we’re using this conjugate prior. And because we have normal structure in the model, is going to lead to the following distribution. So the first one is the prior at time <span class="math inline">t</span>.</p>
<p><mark>So if I want to think about why my distribution for the t is given the information I have up to <span class="math inline">t-1</span>, I can look at the equations of the model and use this second equation. And by looking at this equation, if I condition on the information I have up to <span class="math inline">t-1</span>, I can see that, say, <span class="math inline">\theta_t</span> is written as a linear function of, <span class="math inline">\theta_{t -1}</span> and I have the assumption of normality here.</mark></p>
<p><del>Therefore, say, <span class="math inline">\theta_t</span> going to follow a normal distribution with some mean and some variance. So now we’re going to compute this mean and this variance using this equation. So if you think about the expected value of <span class="math inline">\theta_t</span>, given <span class="math inline">D_{t -1}</span>, that’s just going to be <span class="math inline">G_t</span> is a constant here. So I have my <span class="math inline">G_t</span> and then I have expected value of <span class="math inline">\theta_{t -1}</span> given <span class="math inline">G_{t -1}</span> plus expect the value of this <span class="math inline">\omega_t</span>.</del></p>
<p>But <span class="math inline">\omega_t</span> is a zero mean, normally distributed quantity, so it’s just going to be zero. Using the assumption that I have this structure, then I have that the <span class="math inline">\mathbb{E}[\theta_t \mid \mathcal{D}_{t -1}] = G_t \times m_{t-1}</span>. We’re going to call this quantity <span class="math inline">a_t</span>, so we have here <span class="math inline">a_t</span>. For the variance covariance matrix, then we just have to compute, do the same type of operation. And again, we can use this equation and see that we obtain this <span class="math inline">G_t</span> variance of <span class="math inline">\theta_{t-1} \mid \mathcal{D}_{t -1} G_t'</span>. And then we have now the variance of the omega, the variance of the omega is just <span class="math inline">W_t</span>. So we have <span class="math inline">G_t = C_{t -1} G_t' + W_t</span>. So we can call this quantity <span class="math inline">R_t</span> and just have the form of this prior distribution at time <span class="math inline">t</span>.</p>
<p>I can now think about another distribution which is the distribution of <span class="math inline">y_t \mid \mathcal{D}_{t-1}</span>. So this is the so called one-step ahead, Forecast, And in the one-step ahead forecast again is a similar type of structure. So now we’re going to use the first equation rather than the second equation and we see that <span class="math inline">y_t</span> is written in terms of a linear function of <span class="math inline">\theta_t</span>. And we have also the Gaussian in assumption here. So again the <span class="math inline">y_t</span> is going to be normally distributed, And we just have to compute the mean and the variance for this <span class="math inline">y_t</span>. So using the first equation, we have the expected value of <span class="math inline">y_t</span> given <span class="math inline">D_{t -1}</span> is just <span class="math inline">F_t' \mathbb{E}[\theta_t \mid D_{t -1}]</span>. And we computed this before, so this is, again, the expected value of <span class="math inline">\theta_t</span> given <span class="math inline">D_{t -1}</span> is what we computed here. So this is to be <span class="math inline">F_t' a_t</span>. And we are going to call this little <span class="math inline">f_t</span>. Then, for the variance, Again, we use this equation, we have this component, so we are going to get <span class="math inline">F_t' R_t F_t + D_t</span>. And I’m going to call this <span class="math inline">q_t</span>. So my final distribution, the one-step ahead forecast distribution, tells me that this follows a normal <span class="math inline">f_t q_t</span>. The next equations we are going to discuss are the equations that tell me about what is the distribution of <span class="math inline">\theta_t</span> once we incorporate the information provided by <span class="math inline">y_t</span>. The next distribution is the posterior of <span class="math inline">\theta_t</span> given <span class="math inline">D_t</span>. So that’s, <span class="math inline">\theta_t</span> given <span class="math inline">D_t</span>. And we can write <span class="math inline">D_t</span> as whatever information we have at time <span class="math inline">t- 1</span>. And the new data point with this just <span class="math inline">y_t</span>. So we just want to update the distribution of <span class="math inline">\theta_t</span> given that we have received this additional data point at time <span class="math inline">t</span>. There are two ways of computing this distribution. One uses normal theory, the other one uses Bayes’ theorem. And you obtain that the distribution of <span class="math inline">\theta_t</span> given <span class="math inline">D_t</span> is going to be a normal, with mean we call it <span class="math inline">m_t</span> and variance <span class="math inline">C_t</span>. We will see how to obtain this distribution or the moments of this distribution using normal theory.</p>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p>So, again, we can write down, if we think about just combining the vector <span class="math inline">\theta_t</span> with the observation</p>
</blockquote>
</blockquote>
<p><span class="math inline">Y_t</span> given <span class="math inline">D_{t -1}</span>, right? We have information about <span class="math inline">\theta_t \mid t-1</span>. That’s the prior for <span class="math inline">\theta_{ta,t}</span>, based on the information at <span class="math inline">t -1</span>. And then we also computed before the one step ahead forecast distribution for <span class="math inline">y_t| \mathcal{D}_{t -1}</span>. So we know that when we combine these two in a single vector, we’re going to have a multivariate normal distribution and the first component is going to be <span class="math inline">a_t</span>. The second component is what we have called <span class="math inline">F_t</span>, so that’s the mean. And then for the covariance matrix. We’re going to have now, what goes here is just the variance of <span class="math inline">\theta_t</span> given <span class="math inline">D_{t -1}</span>, which we have called <span class="math inline">R_t</span>. What goes here is the variance of <span class="math inline">y_t \mid \mathcal{D}_{t -1}</span> and we have called this <span class="math inline">q_t</span>. And now we have to compute the covariance between <span class="math inline">\theta_t</span> and <span class="math inline">y_t</span>, and that goes here. And the covariance between <span class="math inline">y_t</span> and <span class="math inline">\theta_t</span>, which is just the transpose of that, is going to go here. So if I think about computing the covariance of <span class="math inline">\theta_t</span> and <span class="math inline">y_t \mid \mathcal{D}_{t -1}</span>, I can write <span class="math inline">y_t</span> using the first equation here as a function of <span class="math inline">\theta_t</span>. That’s going to give us, <span class="math inline">F_t' \theta_t + v_t</span> given <span class="math inline">D_{t -1}</span>. And in this one we can see that this is going to give us basically the variance of <span class="math inline">\theta_t</span> given <span class="math inline">D_{t -1}</span> and then multiplied by <span class="math inline">F_t' F_t</span> which gives me the <span class="math inline">F_t</span>. So this is going to be variance of <span class="math inline">\theta_t</span> given <span class="math inline">D_{t -1}</span> times <span class="math inline">F_t</span>. And then there is a term that combines the <span class="math inline">\theta_t</span> with the noise but they are independent, so the covariance is going to be zero. So this one is simply going to be my <span class="math inline">R_t F_t</span>, so this goes here, And what goes here is just the covariance of <span class="math inline">y_t</span> with <span class="math inline">\theta_t</span> or the transpose of this. So this is going to give me <span class="math inline">F_t' R_t'</span>, but <span class="math inline">R_t</span> is a covariance matrix, so <span class="math inline">R_t' = R_t</span>. So now I have my full multivariate distribution and I can use properties of the multivariate distribution to compute the distribution of, <span class="math inline">\theta_t</span>, given <span class="math inline">y_t</span> and <span class="math inline">D_{t -1}</span>. So that’s going to be a conditional distribution, I’m going to condition on the <span class="math inline">y_t</span>. And when I combine <span class="math inline">y_t</span> and <span class="math inline">D_{t -1}</span> that gives me just the information up to time <span class="math inline">t</span>. So we are interested in just finding, say, <span class="math inline">\theta_t</span> given <span class="math inline">y_t</span> and <span class="math inline">D_{t -1}</span> which is the same as <span class="math inline">\theta_t</span> given <span class="math inline">D_t</span>. We partition the normal distribution in this way, so I can just think about this is the first component and then I have these different pieces in my covariance matrix. And we know from normal theory that if we have a distribution, if we have a vector that is partitioned into vectors here where they are normally distributed. And I have my mean partition here and let’s say I have one component here, Then we know that if I wanted to compute the distribution of <span class="math inline">X_1</span> conditional on <span class="math inline">X_2</span>, that’s going to give me normal, let’s say <span class="math inline">\alpha^*</span>. And let’s call this one the <span class="math inline">\sigma^*</span>, where <span class="math inline">\alpha^*</span> is going to be my <span class="math inline">\alpha_1 + \sigma_{12}^{-1}</span>. And then I have <span class="math inline">_1 - \alpha_2</span> and then I have my <span class="math inline">\sigma^*</span>. And this one gives me my <span class="math inline">\sigma_{11} - \sigma_{21}</span>. So this is a result from normal theory. So if I want my conditional distribution of <span class="math inline">X_1</span> given <span class="math inline">X_2</span> I can apply these equations. So we notice we have the same type of structure here. If I partition my vector and in <span class="math inline">\theta_t</span> and <span class="math inline">y_t</span>. And now I condition on, I take the distribution of <span class="math inline">\theta_t</span> conditioning on <span class="math inline">y_t</span>. I’m going to have that same structure where this is normal, <span class="math inline">m_t C_t</span>. And my <span class="math inline">m_t</span> using normal theory, again, is going to be <span class="math inline">a_t + \sigma_{22}^{-1}</span>. And then I have <span class="math inline">y_t - f_t</span>. So that’s my mean and my covariance matrix. It’s going to be <span class="math inline">R_t - q_t^{-1}</span> and then I have this transpose again. So if we simplify things a bit here and we call <span class="math inline">e_t</span>, it’s just the error that we make when we compare <span class="math inline">y_t</span>, which is the observation with the prediction, right? And then I also use the notation I call <span class="math inline">a_t</span>, let’s call here <span class="math inline">A_t R_t F_t q_t^{-1}</span>. Then we can write this down, to mean, we can write as <span class="math inline">a_t + A_t</span>. And the covariance matrix. We can write it as <span class="math inline">R_t, A_t q_t A_t'</span>. So this gives me the posterior mean after receiving this <span class="math inline">y_t</span> observation. And you can see that you can write down the posterior mean, has this usual form of the prior plus something that relates to the error that I make with the prediction.</p>
<p>So the <span class="math inline">y_t</span> appears there and then is weighted by this quantity that we just call <span class="math inline">a_t</span>.</p>
<p>And for the covariance structure, we are also incorporating information about the prior and what the <span class="math inline">y_t</span> observation provides. So this gives us our filtering equation for <span class="math inline">\theta_t</span> given <span class="math inline">D_t</span>. And now we can apply all these equations as we receive observations from <span class="math inline">t = 1</span> all the way to <span class="math inline">T</span>. If we happen to have <span class="math inline">T</span> observations in the time series, we can do this filtering process and obtain these distributions as we receive information.</p>
</div>
</div>
</div>
</section>
<section id="summary-of-filtering-distributions" class="level2" data-number="94.2">
<h2 data-number="94.2" class="anchored" data-anchor-id="summary-of-filtering-distributions"><span class="header-section-number">94.2</span> Summary of filtering distributions <span class="emoji" data-emoji="spiral_notepad">🗒️</span></h2>
<section id="bayesian-inference-in-ndlm-known-variances" class="level3" data-number="94.2.1">
<h3 data-number="94.2.1" class="anchored" data-anchor-id="bayesian-inference-in-ndlm-known-variances"><span class="header-section-number">94.2.1</span> Bayesian Inference in NDLM: Known Variances</h3>
<p>Consider an NDLM given by:</p>
<p><span id="eq-generic-NDLM"><span class="math display">
\begin{aligned}
y_t &amp;= F_t' \theta_t + \nu_t, \quad \nu_t \sim  \mathcal{N}(0, v_t), \\
\theta_t &amp;= G_t \theta_{t-1} + \omega_t, \quad \omega_t \sim  \mathcal{N}(0, W_t),
\end{aligned}
\tag{94.9}</span></span></p>
<p>with <span class="math inline">F_t</span>, <span class="math inline">G_t</span>, <span class="math inline">v_t</span>, and <span class="math inline">W_t</span> known. We also assume a prior distribution of the form <span class="math inline">(\theta_0 \mid \mathcal{D}_0) \sim  \mathcal{N}(m_0, C_0)</span>, with <span class="math inline">m_0</span>, <span class="math inline">C_0</span> known.</p>
<section id="filtering-1" class="level4" data-number="94.2.1.1">
<h4 data-number="94.2.1.1" class="anchored" data-anchor-id="filtering-1"><span class="header-section-number">94.2.1.1</span> Filtering</h4>
<p>We are interested in finding <span class="math inline">\mathbb{P}r(\theta_t \mid \mathcal{D}_t)</span> for all <span class="math inline">t</span>. Assume that the posterior at <span class="math inline">t-1</span> is such that:</p>
<p><span id="eq-filtering"><span class="math display">
(\theta_{t-1} \mid \mathcal{D}_{t-1}) \sim  \mathcal{N}(m_{t-1}, C_{t-1}).
\tag{94.10}</span></span></p>
<p>Then, we can obtain the following:</p>
<ol type="1">
<li>Prior at Time <span class="math inline">t</span></li>
</ol>
<p><span class="math display">
(\theta_t \mid \mathcal{D}_{t-1}) \sim  \mathcal{N}(a_t, R_t),
</span></p>
<p>with</p>
<p><span class="math display">
a_t = G_t m_{t-1} \qquad R_t = G_t C_{t-1} G_t' + W_t.
</span></p>
<ol start="2" type="1">
<li>One-Step Forecast</li>
</ol>
<p><span class="math display">
(y_t \mid D_{t-1}) \sim  \mathcal{N}(f_t, q_t),
</span></p>
<p>with</p>
<p><span class="math display">
f_t = F_t' a_t, \quad q_t = F_t' R_t F_t + v_t.
</span></p>
<ol start="3" type="1">
<li>Posterior at Time <span class="math inline">t: (\theta_t \mid \mathcal{D}_t) \sim  \mathcal{N}(m_t, C_t)</span> with</li>
</ol>
<p><span class="math display">\begin{aligned}
m_t &amp;= a_t + R_t F_t q_t^{-1} (y_t - f_t), \\
C_t &amp;= R_t - R_t F_t q_t^{-1} F_t' R_t.
\end{aligned}
</span></p>
<p>Now, denoting <span class="math inline">e_t = (y_t - f_t)</span> and <span class="math inline">A_t = R_t F_t q_t^{-1}</span>, we can rewrite the equations above as:</p>
<p><span class="math display">\begin{aligned}
m_t &amp;= a_t + A_t e_t, \\
C_t &amp;= R_t - A_t q_t A_t'
\end{aligned}
</span></p>
</section>
</section>
</section>
<section id="code-filtering-in-the-ndlm-example-mathcalr" class="level2" data-number="94.3">
<h2 data-number="94.3" class="anchored" data-anchor-id="code-filtering-in-the-ndlm-example-mathcalr"><span class="header-section-number">94.3</span> code Filtering in the NDLM: Example <span class="emoji" data-emoji="spiral_notepad">🗒️</span> <span class="math inline">\mathcal{R}</span></h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="do">#################################################</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="do">##### Univariate DLM: Known, constant variances</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="do">#################################################</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>set_up_dlm_matrices <span class="ot">&lt;-</span> <span class="cf">function</span>(FF, GG, VV, WW){</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">FF=</span>FF, <span class="at">GG=</span>GG, <span class="at">VV=</span>VV, <span class="at">WW=</span>WW))</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>set_up_initial_states <span class="ot">&lt;-</span> <span class="cf">function</span>(m0, C0){</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">m0=</span>m0, <span class="at">C0=</span>C0))</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="do">### forward update equations </span><span class="al">###</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>forward_filter <span class="ot">&lt;-</span> <span class="cf">function</span>(data, matrices, initial_states){</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve dataset</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  y_t <span class="ot">&lt;-</span> data<span class="sc">$</span>y_t</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> <span class="fu">length</span>(y_t)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve a set of quadruples </span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># FF, GG, VV, WW are scalar</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  FF <span class="ot">&lt;-</span> matrices<span class="sc">$</span>FF  </span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  GG <span class="ot">&lt;-</span> matrices<span class="sc">$</span>GG</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  VV <span class="ot">&lt;-</span> matrices<span class="sc">$</span>VV</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>  WW <span class="ot">&lt;-</span> matrices<span class="sc">$</span>WW</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve initial states</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>  m0 <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>m0</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>  C0 <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>C0</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>  <span class="do">## create placeholder for results</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">dim</span>(GG)[<span class="dv">1</span>]</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow=</span>T, <span class="at">ncol=</span>d)</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>  Rt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, T))</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>  ft <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>  Qt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>  mt <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow=</span>T, <span class="at">ncol=</span>d)</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>  Ct <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, T))</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>  et <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T){</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments of priors at t</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> <span class="fu">t</span>(m0)</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>      Rt[, , i] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> C0 <span class="sc">%*%</span> <span class="fu">t</span>(GG) <span class="sc">+</span> WW</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>      Rt[, , i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[, , i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[, , i])</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> <span class="fu">t</span>(mt[i<span class="dv">-1</span>, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>      Rt[, , i] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> Ct[, , i<span class="dv">-1</span>] <span class="sc">%*%</span> <span class="fu">t</span>(GG) <span class="sc">+</span> WW</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>      Rt[, , i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[, , i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[, , i])</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments of one-step forecast:</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>    ft[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(FF) <span class="sc">%*%</span> (at[i, ]) </span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>    Qt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(FF) <span class="sc">%*%</span> Rt[, , i] <span class="sc">%*%</span> FF <span class="sc">+</span> VV</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments of posterior at t:</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>    At <span class="ot">&lt;-</span> Rt[, , i] <span class="sc">%*%</span> FF <span class="sc">/</span> Qt[i]</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>    et[i] <span class="ot">&lt;-</span> y_t[i] <span class="sc">-</span> ft[i]</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>    mt[i, ] <span class="ot">&lt;-</span> at[i, ] <span class="sc">+</span> <span class="fu">t</span>(At) <span class="sc">*</span> et[i]</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>    Ct[, , i] <span class="ot">&lt;-</span> Rt[, , i] <span class="sc">-</span> Qt[i] <span class="sc">*</span> At <span class="sc">%*%</span> <span class="fu">t</span>(At)</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>    Ct[, , i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Ct[, , i]<span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Ct[, , i])</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Forward filtering is completed!"</span>) <span class="co"># indicator of completion</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mt =</span> mt, <span class="at">Ct =</span> Ct, <span class="at">at =</span> at, <span class="at">Rt =</span> </span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>                Rt, <span class="at">ft =</span> ft, <span class="at">Qt =</span> Qt))</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>forecast_function <span class="ot">&lt;-</span> <span class="cf">function</span>(posterior_states, k, matrices){</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>  FF <span class="ot">&lt;-</span> matrices<span class="sc">$</span>FF</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>  GG <span class="ot">&lt;-</span> matrices<span class="sc">$</span>GG</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>  WW <span class="ot">&lt;-</span> matrices<span class="sc">$</span>WW</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>  VV <span class="ot">&lt;-</span> matrices<span class="sc">$</span>VV</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>  mt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>mt</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>  Ct <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>Ct</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>  <span class="do">## set up matrices</span></span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> <span class="fu">dim</span>(mt)[<span class="dv">1</span>] <span class="co"># time points</span></span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">dim</span>(mt)[<span class="dv">2</span>] <span class="co"># dimension of state-space parameter vector</span></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>  <span class="do">## placeholder for results</span></span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> k, <span class="at">ncol =</span> d)</span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>  Rt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, k))</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>  ft <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k)</span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>  Qt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k)</span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k){</span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>    <span class="do">## moments of state distribution</span></span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> <span class="fu">t</span>(mt[T, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>      Rt[, , i] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> Ct[, , T] <span class="sc">%*%</span> <span class="fu">t</span>(GG) <span class="sc">+</span> WW</span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>      Rt[, , i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[, , i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[, , i])</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> <span class="fu">t</span>(at[i<span class="dv">-1</span>, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>      Rt[, , i] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> Rt[, , i<span class="dv">-1</span>] <span class="sc">%*%</span> <span class="fu">t</span>(GG) <span class="sc">+</span> WW</span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>      Rt[, , i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[, , i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[, , i])</span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>    <span class="do">## moments of forecast distribution</span></span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>    ft[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(FF) <span class="sc">%*%</span> <span class="fu">t</span>(at[i, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>    Qt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(FF) <span class="sc">%*%</span> Rt[, , i] <span class="sc">%*%</span> FF <span class="sc">+</span> VV</span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Forecasting is completed!"</span>) <span class="co"># indicator of completion</span></span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">at=</span>at, <span class="at">Rt=</span>Rt, <span class="at">ft=</span>ft, <span class="at">Qt=</span>Qt))</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a><span class="do">## obtain 95% credible interval</span></span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>get_credible_interval <span class="ot">&lt;-</span> <span class="cf">function</span>(mu, sigma2, </span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>                          <span class="at">quantile =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)){</span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>  z_quantile <span class="ot">&lt;-</span> <span class="fu">qnorm</span>(quantile)</span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>  bound <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span><span class="fu">length</span>(mu), <span class="at">ncol=</span><span class="dv">2</span>)</span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>  bound[, <span class="dv">1</span>] <span class="ot">&lt;-</span> mu <span class="sc">+</span> </span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>    z_quantile[<span class="dv">1</span>]<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(sigma2)) <span class="co"># lower bound</span></span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>  bound[, <span class="dv">2</span>] <span class="ot">&lt;-</span> mu <span class="sc">+</span> </span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>    z_quantile[<span class="dv">2</span>]<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(sigma2)) <span class="co"># upper bound</span></span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(bound)</span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a><span class="do">####################### Example: Lake Huron Data ######################</span></span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(LakeHuron,<span class="at">main=</span><span class="st">"Lake Huron Data"</span>,</span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab=</span><span class="st">"level in feet"</span>) <span class="co"># Total of 98 observations </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="C4-L07_files/figure-html/lst-filtering-in-the-NDLM-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="C4-L07_files/figure-html/lst-filtering-in-the-NDLM-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>k<span class="ot">=</span><span class="dv">4</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>T<span class="ot">=</span><span class="fu">length</span>(LakeHuron)<span class="sc">-</span>k <span class="co"># We take the first 94 observations </span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>                      <span class="co"># only as our data</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>ts_data<span class="ot">=</span>LakeHuron[<span class="dv">1</span><span class="sc">:</span>T]</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>ts_validation_data <span class="ot">&lt;-</span> LakeHuron[(T<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span><span class="dv">98</span>]</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y_t =</span> ts_data)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># First order polynomial model </span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="do">## set up the DLM matrices </span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>FF <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">1</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>GG <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">1</span>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>VV <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">1</span>)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>WW <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">1</span>)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>m0 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">570</span>)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>C0 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fl">1e4</span>)</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="do">## wrap up all matrices and initial values</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>matrices <span class="ot">&lt;-</span> <span class="fu">set_up_dlm_matrices</span>(FF, GG, VV, WW)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>initial_states <span class="ot">&lt;-</span> <span class="fu">set_up_initial_states</span>(m0, C0)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="do">## filtering</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>results_filtered <span class="ot">&lt;-</span> <span class="fu">forward_filter</span>(data, matrices, </span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>                                   initial_states)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Forward filtering is completed!</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(results_filtered)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "mt" "Ct" "at" "Rt" "ft" "Qt"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>ci_filtered <span class="ot">&lt;-</span> <span class="fu">get_credible_interval</span>(results_filtered<span class="sc">$</span>mt, </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>                                     results_filtered<span class="sc">$</span>Ct)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="do">## forecasting </span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>results_forecast <span class="ot">&lt;-</span> <span class="fu">forecast_function</span>(results_filtered,k, </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>                                      matrices)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Forecasting is completed!</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>ci_forecast <span class="ot">&lt;-</span> <span class="fu">get_credible_interval</span>(results_forecast<span class="sc">$</span>ft, </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>                                     results_forecast<span class="sc">$</span>Qt)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>index<span class="ot">=</span><span class="fu">seq</span>(<span class="dv">1875</span>, <span class="dv">1972</span>, <span class="at">length.out =</span> <span class="fu">length</span>(LakeHuron))</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>index_filt<span class="ot">=</span>index[<span class="dv">1</span><span class="sc">:</span>T]</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>index_forecast<span class="ot">=</span>index[(T<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span><span class="dv">98</span>]</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(index, LakeHuron, <span class="at">ylab =</span> <span class="st">"level"</span>, </span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Lake Huron Level"</span>,<span class="at">type=</span><span class="st">'l'</span>,</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"time"</span>,<span class="at">lty=</span><span class="dv">3</span>,<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">574</span>,<span class="dv">584</span>))</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(index,LakeHuron,<span class="at">pch=</span><span class="dv">20</span>)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, results_filtered<span class="sc">$</span>mt, <span class="at">type=</span><span class="st">'l'</span>,</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'red'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, ci_filtered[, <span class="dv">1</span>], <span class="at">type=</span><span class="st">'l'</span>, </span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'red'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, ci_filtered[, <span class="dv">2</span>], <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'red'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_forecast, results_forecast<span class="sc">$</span>ft, <span class="at">type=</span><span class="st">'l'</span>,</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'green'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_forecast, ci_forecast[, <span class="dv">1</span>], <span class="at">type=</span><span class="st">'l'</span>,</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'green'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_forecast, ci_forecast[, <span class="dv">2</span>], <span class="at">type=</span><span class="st">'l'</span>,</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'green'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">'bottomleft'</span>, <span class="at">legend=</span><span class="fu">c</span>(<span class="st">"filtered"</span>,<span class="st">"forecast"</span>),</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"green"</span>), <span class="at">lty=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="C4-L07_files/figure-html/lst-filtering-in-the-NDLM-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="C4-L07_files/figure-html/lst-filtering-in-the-NDLM-2.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Now consider a 100 times smaller signal to noise ratio </span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>VV <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">1</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>WW <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fl">0.01</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>matrices_2 <span class="ot">&lt;-</span> <span class="fu">set_up_dlm_matrices</span>(FF,GG, VV, WW)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="do">## filtering</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>results_filtered_2 <span class="ot">&lt;-</span> <span class="fu">forward_filter</span>(data, matrices_2, </span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>                                     initial_states)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Forward filtering is completed!</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>ci_filtered_2 <span class="ot">&lt;-</span> <span class="fu">get_credible_interval</span>(results_filtered_2<span class="sc">$</span>mt, </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>                                       results_filtered_2<span class="sc">$</span>Ct)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>results_forecast_2 <span class="ot">&lt;-</span> <span class="fu">forecast_function</span>(results_filtered_2, </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">length</span>(ts_validation_data), </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>                             matrices_2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Forecasting is completed!</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>ci_forecast_2 <span class="ot">&lt;-</span> <span class="fu">get_credible_interval</span>(results_forecast_2<span class="sc">$</span>ft, </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>                                       results_forecast_2<span class="sc">$</span>Qt)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(index, LakeHuron, <span class="at">ylab =</span> <span class="st">"level"</span>, </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Lake Huron Level"</span>,<span class="at">type=</span><span class="st">'l'</span>,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"time"</span>,<span class="at">lty=</span><span class="dv">3</span>,<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">574</span>,<span class="dv">584</span>))</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(index,LakeHuron,<span class="at">pch=</span><span class="dv">20</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, results_filtered_2<span class="sc">$</span>mt, <span class="at">type=</span><span class="st">'l'</span>, </span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'magenta'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, ci_filtered_2[, <span class="dv">1</span>], <span class="at">type=</span><span class="st">'l'</span>, </span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'magenta'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, ci_filtered_2[, <span class="dv">2</span>], <span class="at">type=</span><span class="st">'l'</span>, </span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'magenta'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_forecast, results_forecast_2<span class="sc">$</span>ft, <span class="at">type=</span><span class="st">'l'</span>, </span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'green'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_forecast, ci_forecast_2[, <span class="dv">1</span>], <span class="at">type=</span><span class="st">'l'</span>, </span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'green'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_forecast, ci_forecast_2[, <span class="dv">2</span>], <span class="at">type=</span><span class="st">'l'</span>, </span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'green'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">'bottomleft'</span>, <span class="at">legend=</span><span class="fu">c</span>(<span class="st">"filtered"</span>,<span class="st">"forecast"</span>),</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"magenta"</span>, <span class="st">"green"</span>), <span class="at">lty=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="C4-L07_files/figure-html/lst-filtering-in-the-NDLM-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="C4-L07_files/figure-html/lst-filtering-in-the-NDLM-3.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(index_filt,results_filtered<span class="sc">$</span>mt,<span class="at">type=</span><span class="st">'l'</span>,<span class="at">col=</span><span class="st">'red'</span>,<span class="at">lwd=</span><span class="dv">2</span>,</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">574</span>,<span class="dv">584</span>),<span class="at">ylab=</span><span class="st">"level"</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt,results_filtered_2<span class="sc">$</span>mt,<span class="at">col=</span><span class="st">'magenta'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(index,LakeHuron,<span class="at">pch=</span><span class="dv">20</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index,LakeHuron,<span class="at">lty=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="C4-L07_files/figure-html/lst-filtering-in-the-NDLM-4.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="C4-L07_files/figure-html/lst-filtering-in-the-NDLM-4.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="smoothing-and-forecasting" class="level2 page-columns page-full" data-number="94.4">
<h2 data-number="94.4" class="anchored" data-anchor-id="smoothing-and-forecasting"><span class="header-section-number">94.4</span> Smoothing and forecasting <span class="emoji" data-emoji="movie_camera">🎥</span></h2>

<div class="no-row-height column-margin column-container"><div id="fig-smoothing" class="quarto-float quarto-figure quarto-figure-center anchored" data-group="slides">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-smoothing-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="images/m3_0051.png" class="lightbox" data-gallery="slides" title="Figure&nbsp;94.3: Smoothing"><img src="images/m3_0051.png" class="img-fluid figure-img" style="width:53mm"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-smoothing-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;94.3: Smoothing
</figcaption>
</figure>
</div><div id="fig-forecasting" class="quarto-float quarto-figure quarto-figure-center anchored" data-group="slides">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-forecasting-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="images/m3_0052.png" class="lightbox" data-gallery="slides" title="Figure&nbsp;94.4: Forecasting"><img src="images/m3_0052.png" class="img-fluid figure-img" style="width:53mm"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-forecasting-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;94.4: Forecasting
</figcaption>
</figure>
</div></div>
<p>We now discuss the <strong>smoothing equations</strong> for the case of the NDLM, where we are assuming that the variance at the <em>observation level</em> <span class="math inline">\nu_t</span> and the covariance matrix at the <em>system level</em> <span class="math inline">\mathbf{W}_t</span> are both known.</p>
<p><span id="eq-inference-NDLM"><span class="math display"> \begin{aligned}
y_t &amp;= \mathbf{F}_t' \mathbf{\theta}_t + \nu_t, &amp;\nu_t &amp;\sim \mathcal{N} (0, v_t), &amp; \text{(observation)} \\
\mathbf{\theta}_t &amp; = \mathbf{G}_t \mathbf{\theta}_{t-1} + \mathbf{\omega}_t, &amp;\mathbf{\omega}_t &amp; \sim \mathcal{N} (0, \mathbf{W}_t), &amp; \text{(evolution)} \\
&amp;\{ \mathbf{F}_t, \mathbf{G}_t, v_t, \mathbf{W}_t \}  &amp;(\mathbf{\omega}_0 \mid \mathcal{D}_0) &amp; \sim \mathcal{N}(\mathbf{m}_0, \mathbf{C}_0) &amp; \text{(prior)}
\end{aligned}
\tag{94.11}</span></span></p>
<p>with <span class="math inline">F_t</span>, <span class="math inline">G_t</span>, <span class="math inline">v_t</span>, <span class="math inline">W_t</span>, <span class="math inline">m_0</span> and <span class="math inline">C_0</span> known.</p>
<p>We have discussed the filtering equations, i.e.&nbsp;the process for obtaining the distributions of <span class="math inline">\theta_t \mid \mathcal{D}_t</span>, as we collect observations over time, called filtering.</p>
<p>We do this by updating the distribution of <span class="math inline">\theta_t</span> given the data we have collected step by step, as we move forward in time - updating the from the prior distribution.</p>
<p>Now we will discuss what happens when we do smoothing, meaning when we revisit the distributions of <span class="math inline">\theta_t</span>, given now that we have received a set of observations.</p>
<section id="smoothing" class="level4" data-number="94.4.0.1">
<h4 data-number="94.4.0.1" class="anchored" data-anchor-id="smoothing"><span class="header-section-number">94.4.0.1</span> Smoothing</h4>
<p>For <span class="math inline">t &lt; T</span>, we have that:</p>
<p><span class="math display">
(\theta_t \mid D_T) \sim  \mathcal{N}(a_T(t - T), R_T(t - T)),
</span></p>
<p>where</p>
<p><span class="math display">
a_T(t - T) = m_t - B_t [a_{t+1} - a_T(t - T + 1)],
</span></p>
<p><span class="math display">
R_T(t - T) = C_t - B_t [R_{t+1} - R_T(t - T + 1)] B_t',
</span></p>
<p>for <span class="math inline">t = (T - 1), (T - 2), \dots, 0</span>, with <span class="math inline">B_t = C_t G_t' R_{t+1}^{-1}</span>, and <span class="math inline">a_T(0) = m_T</span>, <span class="math inline">R_T(0) = C_T</span>. Here <span class="math inline">a_t</span>, <span class="math inline">m_t</span>, <span class="math inline">R_t</span>, and <span class="math inline">C_t</span> are obtained using the filtering equations as explained before.</p>
</section>
<section id="forecasting" class="level4" data-number="94.4.0.2">
<h4 data-number="94.4.0.2" class="anchored"><span class="header-section-number">94.4.0.2</span> Forecasting</h4>
<p>For <span class="math inline">h \geq 0</span>, it is possible to show that:</p>
<p><span class="math display">
(\theta_{t+h} \mid D_t) \sim  \mathcal{N}(a_t(h), R_t(h)),
</span></p>
<p><span class="math display">
(y_{t+h} \mid D_t) \sim  \mathcal{N}(f_t(h), q_t(h)),
</span></p>
<p>with</p>
<p><span class="math display">
a_t(h) = G_{t+h} a_t(h - 1),
</span></p>
<p><span class="math display">
R_t(h) = G_{t+h} R_t(h - 1) G_{t+h}' + W_{t+h},
</span></p>
<p><span class="math display">
f_t(h) = F_{t+h}' a_t(h),
</span></p>
<p><span class="math display">
q_t(h) = F_{t+h}' R_t(h) F_{t+h} + v_{t+h},
</span></p>
<p>and</p>
<p><span class="math display">
a_t(0) = m_t, \quad R_t(0) = C_t.
</span></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Video Transcript
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<!-- transcript of https://www.coursera.org/learn/bayesian-statistics-time-series-analysis/lecture/EIciI/smoothing-and-forecasting -->
<section id="smoothing-1" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="smoothing-1">Smoothing</h3>
<blockquote class="blockquote">
<p>We know, we now discuss the smoothing equations for the case of the normal dynamic linear model. When we are assuming that both the variance at the observation level is known and the covariance matrix at the system level is also known.</p>
</blockquote>
</section>
<section id="the-ndlm-we-will-be-inferring" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="the-ndlm-we-will-be-inferring">the NDLM we will be inferring</h3>
<blockquote class="blockquote">
<p>Recall we have two equations here, we have the observation equation, where <span class="math inline">y_t</span> is modeled as <span class="math inline">F_t'\theta_t + \text{noise}</span> the noise is <span class="math inline">\mathcal{N}(0,\nu_t)</span>. And we’re assuming that the vt is given. We are also assuming that we know Ft for all t. And then in the evolution equation we have <span class="math inline">\theta_t= G_t \theta(t-1) + noise</span>. And then again, the assumption for the <span class="math inline">w_t</span> is here is that they are normally distributed with mean zero, and these variants co variance matrix, capital <span class="math inline">W_t</span>. So we can summarize the model in terms of <span class="math inline">F_t</span>, <span class="math inline">G_t</span>, <span class="math inline">Vt</span> and <span class="math inline">W_t</span>, that are given for all t. We have discussed the filtering equations.</p>
</blockquote>
</section>
<section id="recall-what-is-filtering" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="recall-what-is-filtering">Recall what is Filtering?</h3>
<blockquote class="blockquote">
<p>So the process for obtaining the distributions of <span class="math inline">\theta_t \mid \mathcal{D}_t</span>, as we collect observations over time is called filtering.</p>
</blockquote>
</section>
<section id="recall-what-is-smoothing" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="recall-what-is-smoothing">Recall what is Smoothing?</h3>
<blockquote class="blockquote">
<p>Now we will discuss what happens when we do smoothing, meaning when we revisit the distributions of <span class="math inline">\theta_t</span>, given now that we have received a set of observations.</p>
</blockquote>
</section>
<section id="filtering-illustrated" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="filtering-illustrated">Filtering illustrated</h3>
<blockquote class="blockquote">
<p>So Just to illustrate the process, we have here, <span class="math inline">\theta_0</span>,<span class="math inline">\theta_1</span> all way up to <span class="math inline">\theta_4</span>. And we can assume just for the sake of the example, that we are going to receive three observations. So we are going to proceed with the filtering, and then once we receive the last observation at time three, we’re going to go backwards and we’re going to revisit the distributions for the state parameters.</p>
<p>So just to remind you how the filtering works, we move forward, before we receive any observations. In the NDLM, when we have all the variances known. The <em>conjugate prior</em> distribution is a <span class="math inline">\mathcal{N}(m_0,C_0)</span>, and this is specified by the user, before collecting any observations.</p>
<p>We can then use the structure of the model, meaning the system equation and the observation equation to obtain the distribution of <span class="math inline">\theta_t \mid \mathcal{D}_0</span>. Before observing the first <span class="math inline">y</span>. This gives us first the distribution of <span class="math inline">\theta_t</span>, <span class="math inline">\theta_1 \mid \mathcal{D}_0</span>, which is <span class="math inline">\mathcal{N}(a_1, R_1)</span>. And then we can also get the one step ahead forecast distribution for <span class="math inline">y_1 \mid  \mathcal{D}_0</span>, which is a <span class="math inline">\mathcal{N}(f_1, q_1)</span>. And we have discussed how to obtain these moments using the filtering equations.</p>
<p>Then we received the first observation, and the first observation can allows us to update the distribution of . So we obtain now the distribution of <span class="math inline">\theta1 \mid y_1</span>, and whatever information we have at <span class="math inline">\mathcal{D}_0</span>. So this gives us <span class="math inline">\mathcal{N}(m_1, C_1)</span>. And using again the structure of the model, we can get the prior distribution for <span class="math inline">\theta_2</span> given the one and that’s a <span class="math inline">\mathcal{N}(a_2, R_2)</span>. And then the one step ahead forecast distribution now for <span class="math inline">y_2 \mid \mathcal{D}_1</span> and that’s a <span class="math inline">\mathcal{N}(f_2, q_2)</span>. So we can receive <span class="math inline">y_2</span> update the distribution of and we can continue this process, now get the priors at <span class="math inline">T=3</span>. And then once we get the observation at <span class="math inline">T=3</span>, we update the distribution. And we can continue like this with the prior for <span class="math inline">\theta_4</span> and so on. Let’s say that we stop here, at <span class="math inline">T=3</span>.</p>
</blockquote>
<blockquote class="blockquote">
<p>And <mark>now we are interested in answering the question. Well, what is the distribution for example of <span class="math inline">\theta_2</span> given that, now, I obtain not only <span class="math inline">y_1</span> and <span class="math inline">y_2</span>, but also <span class="math inline">y_3</span>. I want to revisit that distribution using all that information. Same thing for say, the distribution of <span class="math inline">\theta_0 \mid D_0, y_1, y_2, y_3</span>. So that’s what it’s called smoothing.</mark></p>
<p>So the smoothing equations, allow us to obtain those distributions. So just to talk a little bit about the notation again, in the normal dynamic linear model where <span class="math inline">v_t</span> and <span class="math inline">w_t</span> are known for all t’s. We have that this is a normal, so the notation here, the <span class="math inline">T &gt;t</span>, here. So we’re looking at the distribution of <span class="math inline">\theta_t</span>, now in the past and that one follows a normal distribution with mean aT(t-T). So the notation here for the subscript T means that I’m conditioning on all the information I have to T. And then the variance covariance matrix is given by this, RT(t-T). So this is just going to indicate how many steps I’m going to go backwards as you will see in the example.</p>
</blockquote>
<blockquote class="blockquote">
<p>So we have some recursions in the same way that we have the filtering equations. Now we have the smoothing equations. And for these smoothing equations we have that the mean. You can see here, that whenever you’re computing a particular step t- T, you’re going to need a quantity that you computed in the previous step, t-T+1. So you’re going to need that, is a recursion, but you’re also going to need mt and and at+1. So those are quantities that you computed using the filtering equations. So in order to get the smoothing equations, you first have to proceed with the filtering. Similarly for RT(t-T), you have also that depends on something you previously obtained. And then you also have the Ct, the Rt+1 and so on. So those quantities you computed when you were updating the filtering equations. The recursion begins with aT(0) meaning that you are not going to go backwards any points in time. So that is precisely the mean is going to be whatever you computed with the filtering equations of up to T, that’s mT. And then RT(0) is going to be CT. So just to again illustrate how this would work in the example, if we start here right? If we condition, so the first step would be to compute again to initialize using the distribution of given D3. And that is a normal with mean a3(0) and variance covariance matrix R3(0), But those are precisely m3 and C3 respectively. Then we go backwards one step. And if we want to look at what is the distribution of <span class="math inline">\theta^2</span>, now conditional on D3. That’s a normal with mean a3(-1) and variance covariance matrix R3(-1). So if you look at the equations down here, you will see that, in order to compute a3 (-1), and R3(-1). You’re going to need m2,C2, a3,R3 and then what you computed here these moments in the previous step, a3(0) and R3(0). Then you obtain that distribution and you can now look at the distribution of given D3, that’s the normal a3(-2), R3(-2). And once again, to compute these moments, you’re going to need <span class="math inline">m1,C1,a2,R2</span> and then you’re going to need a3(-1),R3(-1). And you can continue all the way down to given D3 using these recursions. So the smoothing equations allow us to, just compute all these distributions. And the important equations work basically because of the linear and Gaussian structure in the normal dynamic linear model.</p>
</blockquote>
</section>
<section id="forecasting-1" class="level3" data-number="94.4.1">
<h3 data-number="94.4.1" class="anchored" data-anchor-id="forecasting-1"><span class="header-section-number">94.4.1</span> Forecasting</h3>
<blockquote class="blockquote">
<p>In a similar way, we can compute the forecasting distributions. Now we are going to be looking forward, and in the case of forecasting, we are interested in the distribution of <span class="math inline">\theta(t+h)</span> given <span class="math inline">D_t</span>. And now h is a positive lag. So here we assume that is <span class="math inline">h≥0</span>. So we are going to have the recursion is a <span class="math inline">N(a_t(h), R_t(h))</span>. The mean is <span class="math inline">a_t(h)</span> and we are going to use the structure of the model to obtain these recursions, again. So here we are using the system equation, and the moment at(h) depends on what you computed at <span class="math inline">a_t(h-1)</span> the previous lag, times <span class="math inline">G_{t+h}</span>. And then, would you initialize the recursion with <span class="math inline">a_t(0)=m_t</span>.</p>
</blockquote>
<blockquote class="blockquote">
<p>Similarly, for the covariance matrix h steps ahead, you’re going to have a recursion that depends on <span class="math inline">Rt(h-1)</span>. And then you’re going to need to input also <span class="math inline">G_{t+h}</span> and <span class="math inline">W_{t+h}</span>. To initialize, the recursion with <span class="math inline">Rt(0)= Ct</span>. So you can see that in order to compute these moments, you’re going to need mt and Ct to start with. And then you’re also going to have to input all the G’s and the W’s for the number of steps ahead that you require.</p>
</blockquote>
<blockquote class="blockquote">
<p>Similarly, you can compute the distribution, the h steps ahead distribution of y_t+h given Dt. And that one also follows a normal, with mean <span class="math inline">f_t(h)</span>, <span class="math inline">q_t(h)</span>. And now we also have a recursion here, <span class="math inline">ft(h)</span> depends on <span class="math inline">at(h)</span> and as we said, <span class="math inline">a_t(h)</span> depends on <span class="math inline">a_t(h-1)</span> and so on. And <span class="math inline">q_t(h)</span> is just given by these equations. So once again, you have to have access to <span class="math inline">F_{t+h}</span> for all the <span class="math inline">h</span>, a number of steps ahead that you are trying to compute this distribution. And then you also have to provide the observational variance for every h value. So that you get <span class="math inline">v_{t+h}</span>. So this is specified in the modeling framework as well. If you want proceed with the forecasting distributions.</p>
</blockquote>
</section>
</div>
</div>
</div>
</section>
</section>
<section id="summary-of-the-smoothing-and-forecasting-distributions" class="level2" data-number="94.5">
<h2 data-number="94.5" class="anchored" data-anchor-id="summary-of-the-smoothing-and-forecasting-distributions"><span class="header-section-number">94.5</span> Summary of the smoothing and forecasting distributions <span class="emoji" data-emoji="spiral_notepad">🗒️</span></h2>
<!-- start -->
<section id="sec-inference-NDLM" class="level3" data-number="94.5.1">
<h3 data-number="94.5.1" class="anchored" data-anchor-id="sec-inference-NDLM"><span class="header-section-number">94.5.1</span> Bayesian Inference in NDLM: Known Variances</h3>
<p>Consider the NDLM given by:</p>
<p><span id="eq-inference-NDLM"><span class="math display"> \begin{aligned}
y_t &amp;= \mathbf{F}_t' \mathbf{\theta}_t + \nu_t, &amp;\nu_t &amp;\sim \mathcal{N} (0, v_t), \\
\mathbf{\theta}_t &amp;= \mathbf{G}_t \mathbf{\theta}_{t-1} + \mathbf{\omega}_t, &amp;\mathbf{\omega}_t &amp;\sim \mathcal{N} (0, \mathbf{W}_t), \\
&amp;\{ \mathbf{F}_t, \mathbf{G}_t, v_t, \mathbf{W}_t \}  &amp;(\mathbf{\omega}_0 \mid \mathcal{D}_0) &amp;\sim  \mathcal{N}(\mathbf{m}_0, \mathbf{C}_0)
\end{aligned}
\tag{94.12}</span></span></p>
<p>with <span class="math inline">F_t</span>, <span class="math inline">G_t</span>, <span class="math inline">v_t</span>, and <span class="math inline">W_t</span> known.</p>
<p>We also assume a prior distribution of the form <span class="math inline">(\theta_0 \mid D_0) \sim  \mathcal{N}(m_0, C_0)</span>, with <span class="math inline">m_0</span> and <span class="math inline">C_0</span> known.</p>
<section id="smoothing-2" class="level4" data-number="94.5.1.1">
<h4 data-number="94.5.1.1" class="anchored" data-anchor-id="smoothing-2"><span class="header-section-number">94.5.1.1</span> Smoothing</h4>
<p>For <span class="math inline">t &lt; T</span>, we have that:</p>
<p><span class="math display">
(\theta_t \mid D_T) \sim  \mathcal{N}(a_T(t - T), R_T(t - T)),
</span></p>
<p>where</p>
<p><span class="math display">
a_T(t - T) = m_t - B_t [a_{t+1} - a_T(t - T + 1)],
</span></p>
<p><span class="math display">
R_T(t - T) = C_t - B_t [R_{t+1} - R_T(t - T + 1)] B_t',
</span></p>
<p>for <span class="math inline">t = (T - 1), (T - 2), \dots, 0</span>, with <span class="math inline">B_t = C_t G_t' R_{t+1}^{-1}</span>, and <span class="math inline">a_T(0) = m_T</span>, <span class="math inline">R_T(0) = C_T</span>. Here <span class="math inline">a_t</span>, <span class="math inline">m_t</span>, <span class="math inline">R_t</span>, and <span class="math inline">C_t</span> are obtained using the filtering equations as explained before.</p>
</section>
<section id="forecasting-2" class="level4" data-number="94.5.1.2">
<h4 data-number="94.5.1.2" class="anchored" data-anchor-id="forecasting-2"><span class="header-section-number">94.5.1.2</span> Forecasting</h4>
<p>For <span class="math inline">h \geq 0</span>, it is possible to show that:</p>
<p><span class="math display">
(\theta_{t+h} \mid D_t) \sim  \mathcal{N}(a_t(h), R_t(h)),
</span></p>
<p><span class="math display">
(y_{t+h} \mid D_t) \sim  \mathcal{N}(f_t(h), q_t(h)),
</span></p>
<p>with</p>
<p><span class="math display">
a_t(h) = G_{t+h} a_t(h - 1),
</span></p>
<p><span class="math display">
R_t(h) = G_{t+h} R_t(h - 1) G_{t+h}' + W_{t+h},
</span></p>
<p><span class="math display">
f_t(h) = F_{t+h}' a_t(h),
</span></p>
<p><span class="math display">
q_t(h) = F_{t+h}' R_t(h) F_{t+h} + v_{t+h},
</span></p>
<p>and</p>
<p><span class="math display">
a_t(0) = m_t, \quad R_t(0) = C_t.
</span></p>
<!-- end -->
</section>
</section>
</section>
<section id="smoothing-in-the-ndlm-example" class="level2" data-number="94.6">
<h2 data-number="94.6" class="anchored" data-anchor-id="smoothing-in-the-ndlm-example"><span class="header-section-number">94.6</span> Smoothing in the NDLM, Example <span class="emoji" data-emoji="movie_camera">🎥</span></h2>
<p>This segment covers the code in the following section</p>
</section>
<section id="sec-smoothing-in-the-NDLM" class="level2" data-number="94.7">
<h2 data-number="94.7" class="anchored" data-anchor-id="sec-smoothing-in-the-NDLM"><span class="header-section-number">94.7</span> Code: Smoothing in the NDLM, Example <span class="emoji" data-emoji="spiral_notepad">🗒️</span> <span class="math inline">\mathcal{R}</span></h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="do">#################################################</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="do">##### Univariate DLM: Known, constant variances</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="do">#################################################</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>set_up_dlm_matrices <span class="ot">&lt;-</span> <span class="cf">function</span>(FF, GG, VV, WW){</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">FF=</span>FF, <span class="at">GG=</span>GG, <span class="at">VV=</span>VV, <span class="at">WW=</span>WW))</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>set_up_initial_states <span class="ot">&lt;-</span> <span class="cf">function</span>(m0, C0){</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">m0=</span>m0, <span class="at">C0=</span>C0))</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="do">### forward update equations </span><span class="al">###</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>forward_filter <span class="ot">&lt;-</span> <span class="cf">function</span>(data, matrices, initial_states){</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve dataset</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>  y_t <span class="ot">&lt;-</span> data<span class="sc">$</span>y_t</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> <span class="fu">length</span>(y_t)</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve a set of quadruples </span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># FF, GG, VV, WW are scalar</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>  FF <span class="ot">&lt;-</span> matrices<span class="sc">$</span>FF  </span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>  GG <span class="ot">&lt;-</span> matrices<span class="sc">$</span>GG</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>  VV <span class="ot">&lt;-</span> matrices<span class="sc">$</span>VV</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>  WW <span class="ot">&lt;-</span> matrices<span class="sc">$</span>WW</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve initial states</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>  m0 <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>m0</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>  C0 <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>C0</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>  <span class="do">## create placeholder for results</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">dim</span>(GG)[<span class="dv">1</span>]</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow=</span>T, <span class="at">ncol=</span>d)</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>  Rt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, T))</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>  ft <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>  Qt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>  mt <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow=</span>T, <span class="at">ncol=</span>d)</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>  Ct <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, T))</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>  et <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T){</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments of priors at t</span></span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> <span class="fu">t</span>(m0)</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>      Rt[, , i] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> C0 <span class="sc">%*%</span> <span class="fu">t</span>(GG) <span class="sc">+</span> WW</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>      Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i]) </span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> <span class="fu">t</span>(mt[i<span class="dv">-1</span>, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>      Rt[, , i] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> Ct[, , i<span class="dv">-1</span>] <span class="sc">%*%</span> <span class="fu">t</span>(GG) <span class="sc">+</span> WW</span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>      Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i]) </span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments of one-step forecast:</span></span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>    ft[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(FF) <span class="sc">%*%</span> (at[i, ]) </span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>    Qt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(FF) <span class="sc">%*%</span> Rt[, , i] <span class="sc">%*%</span> FF <span class="sc">+</span> VV</span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments of posterior at t:</span></span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a>    At <span class="ot">&lt;-</span> Rt[, , i] <span class="sc">%*%</span> FF <span class="sc">/</span> Qt[i]</span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>    et[i] <span class="ot">&lt;-</span> y_t[i] <span class="sc">-</span> ft[i]</span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>    mt[i, ] <span class="ot">&lt;-</span> at[i, ] <span class="sc">+</span> <span class="fu">t</span>(At) <span class="sc">*</span> et[i]</span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>    Ct[, , i] <span class="ot">&lt;-</span> Rt[, , i] <span class="sc">-</span> Qt[i] <span class="sc">*</span> At <span class="sc">%*%</span> <span class="fu">t</span>(At)</span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>    Ct[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Ct[,,i] <span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Ct[,,i]) </span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Forward filtering is completed!"</span>) <span class="co"># indicator of completion</span></span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mt =</span> mt, <span class="at">Ct =</span> Ct, <span class="at">at =</span> at, <span class="at">Rt =</span> Rt, </span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>              <span class="at">ft =</span> ft, <span class="at">Qt =</span> Qt))</span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a>forecast_function <span class="ot">&lt;-</span> <span class="cf">function</span>(posterior_states, k, matrices){</span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a>  FF <span class="ot">&lt;-</span> matrices<span class="sc">$</span>FF</span>
<span id="cb15-73"><a href="#cb15-73" aria-hidden="true" tabindex="-1"></a>  GG <span class="ot">&lt;-</span> matrices<span class="sc">$</span>GG</span>
<span id="cb15-74"><a href="#cb15-74" aria-hidden="true" tabindex="-1"></a>  WW <span class="ot">&lt;-</span> matrices<span class="sc">$</span>WW</span>
<span id="cb15-75"><a href="#cb15-75" aria-hidden="true" tabindex="-1"></a>  VV <span class="ot">&lt;-</span> matrices<span class="sc">$</span>VV</span>
<span id="cb15-76"><a href="#cb15-76" aria-hidden="true" tabindex="-1"></a>  mt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>mt</span>
<span id="cb15-77"><a href="#cb15-77" aria-hidden="true" tabindex="-1"></a>  Ct <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>Ct</span>
<span id="cb15-78"><a href="#cb15-78" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-79"><a href="#cb15-79" aria-hidden="true" tabindex="-1"></a>  <span class="do">## set up matrices</span></span>
<span id="cb15-80"><a href="#cb15-80" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> <span class="fu">dim</span>(mt)[<span class="dv">1</span>] <span class="co"># time points</span></span>
<span id="cb15-81"><a href="#cb15-81" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">dim</span>(mt)[<span class="dv">2</span>] <span class="co"># dimension of state parameter vector</span></span>
<span id="cb15-82"><a href="#cb15-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-83"><a href="#cb15-83" aria-hidden="true" tabindex="-1"></a>  <span class="do">## placeholder for results</span></span>
<span id="cb15-84"><a href="#cb15-84" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> k, <span class="at">ncol =</span> d)</span>
<span id="cb15-85"><a href="#cb15-85" aria-hidden="true" tabindex="-1"></a>  Rt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, k))</span>
<span id="cb15-86"><a href="#cb15-86" aria-hidden="true" tabindex="-1"></a>  ft <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k)</span>
<span id="cb15-87"><a href="#cb15-87" aria-hidden="true" tabindex="-1"></a>  Qt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k)</span>
<span id="cb15-88"><a href="#cb15-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-89"><a href="#cb15-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-90"><a href="#cb15-90" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k){</span>
<span id="cb15-91"><a href="#cb15-91" aria-hidden="true" tabindex="-1"></a>    <span class="do">## moments of state distribution</span></span>
<span id="cb15-92"><a href="#cb15-92" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb15-93"><a href="#cb15-93" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> <span class="fu">t</span>(mt[T, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb15-94"><a href="#cb15-94" aria-hidden="true" tabindex="-1"></a>      Rt[, , i] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> Ct[, , T] <span class="sc">%*%</span> <span class="fu">t</span>(GG) <span class="sc">+</span> WW</span>
<span id="cb15-95"><a href="#cb15-95" aria-hidden="true" tabindex="-1"></a>      Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i]) </span>
<span id="cb15-96"><a href="#cb15-96" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb15-97"><a href="#cb15-97" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> <span class="fu">t</span>(at[i<span class="dv">-1</span>, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb15-98"><a href="#cb15-98" aria-hidden="true" tabindex="-1"></a>      Rt[, , i] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> Rt[, , i<span class="dv">-1</span>] <span class="sc">%*%</span> <span class="fu">t</span>(GG) <span class="sc">+</span> WW</span>
<span id="cb15-99"><a href="#cb15-99" aria-hidden="true" tabindex="-1"></a>      Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i]) </span>
<span id="cb15-100"><a href="#cb15-100" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb15-101"><a href="#cb15-101" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-102"><a href="#cb15-102" aria-hidden="true" tabindex="-1"></a>    <span class="do">## moments of forecast distribution</span></span>
<span id="cb15-103"><a href="#cb15-103" aria-hidden="true" tabindex="-1"></a>    ft[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(FF) <span class="sc">%*%</span> <span class="fu">t</span>(at[i, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb15-104"><a href="#cb15-104" aria-hidden="true" tabindex="-1"></a>    Qt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(FF) <span class="sc">%*%</span> Rt[, , i] <span class="sc">%*%</span> FF <span class="sc">+</span> VV</span>
<span id="cb15-105"><a href="#cb15-105" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-106"><a href="#cb15-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Forecasting is completed!"</span>) <span class="co"># indicator of completion</span></span>
<span id="cb15-107"><a href="#cb15-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">at=</span>at, <span class="at">Rt=</span>Rt, <span class="at">ft=</span>ft, <span class="at">Qt=</span>Qt))</span>
<span id="cb15-108"><a href="#cb15-108" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-109"><a href="#cb15-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-110"><a href="#cb15-110" aria-hidden="true" tabindex="-1"></a><span class="do">## obtain 95% credible interval</span></span>
<span id="cb15-111"><a href="#cb15-111" aria-hidden="true" tabindex="-1"></a>get_credible_interval <span class="ot">&lt;-</span> <span class="cf">function</span>(mu, sigma2, </span>
<span id="cb15-112"><a href="#cb15-112" aria-hidden="true" tabindex="-1"></a>                          <span class="at">quantile =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)){</span>
<span id="cb15-113"><a href="#cb15-113" aria-hidden="true" tabindex="-1"></a>  z_quantile <span class="ot">&lt;-</span> <span class="fu">qnorm</span>(quantile)</span>
<span id="cb15-114"><a href="#cb15-114" aria-hidden="true" tabindex="-1"></a>  bound <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span><span class="fu">length</span>(mu), <span class="at">ncol=</span><span class="dv">2</span>)</span>
<span id="cb15-115"><a href="#cb15-115" aria-hidden="true" tabindex="-1"></a>  bound[, <span class="dv">1</span>] <span class="ot">&lt;-</span> mu <span class="sc">+</span> z_quantile[<span class="dv">1</span>]<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(sigma2)) <span class="co"># lower bound</span></span>
<span id="cb15-116"><a href="#cb15-116" aria-hidden="true" tabindex="-1"></a>  bound[, <span class="dv">2</span>] <span class="ot">&lt;-</span> mu <span class="sc">+</span> z_quantile[<span class="dv">2</span>]<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(sigma2)) <span class="co"># upper bound</span></span>
<span id="cb15-117"><a href="#cb15-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(bound)</span>
<span id="cb15-118"><a href="#cb15-118" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-119"><a href="#cb15-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-120"><a href="#cb15-120" aria-hidden="true" tabindex="-1"></a><span class="do">### smoothing equations </span><span class="al">###</span></span>
<span id="cb15-121"><a href="#cb15-121" aria-hidden="true" tabindex="-1"></a>backward_smoothing <span class="ot">&lt;-</span> <span class="cf">function</span>(data, matrices, </span>
<span id="cb15-122"><a href="#cb15-122" aria-hidden="true" tabindex="-1"></a>                               posterior_states){</span>
<span id="cb15-123"><a href="#cb15-123" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve data </span></span>
<span id="cb15-124"><a href="#cb15-124" aria-hidden="true" tabindex="-1"></a>  y_t <span class="ot">&lt;-</span> data<span class="sc">$</span>y_t</span>
<span id="cb15-125"><a href="#cb15-125" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> <span class="fu">length</span>(y_t) </span>
<span id="cb15-126"><a href="#cb15-126" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-127"><a href="#cb15-127" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb15-128"><a href="#cb15-128" aria-hidden="true" tabindex="-1"></a>  FF <span class="ot">&lt;-</span> matrices<span class="sc">$</span>FF</span>
<span id="cb15-129"><a href="#cb15-129" aria-hidden="true" tabindex="-1"></a>  GG <span class="ot">&lt;-</span> matrices<span class="sc">$</span>GG</span>
<span id="cb15-130"><a href="#cb15-130" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-131"><a href="#cb15-131" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb15-132"><a href="#cb15-132" aria-hidden="true" tabindex="-1"></a>  mt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>mt</span>
<span id="cb15-133"><a href="#cb15-133" aria-hidden="true" tabindex="-1"></a>  Ct <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>Ct</span>
<span id="cb15-134"><a href="#cb15-134" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>at</span>
<span id="cb15-135"><a href="#cb15-135" aria-hidden="true" tabindex="-1"></a>  Rt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>Rt</span>
<span id="cb15-136"><a href="#cb15-136" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-137"><a href="#cb15-137" aria-hidden="true" tabindex="-1"></a>  <span class="do">## create placeholder for posterior moments </span></span>
<span id="cb15-138"><a href="#cb15-138" aria-hidden="true" tabindex="-1"></a>  mnt <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">dim</span>(mt)[<span class="dv">1</span>], <span class="at">ncol =</span> <span class="fu">dim</span>(mt)[<span class="dv">2</span>])</span>
<span id="cb15-139"><a href="#cb15-139" aria-hidden="true" tabindex="-1"></a>  Cnt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">dim</span>(Ct))</span>
<span id="cb15-140"><a href="#cb15-140" aria-hidden="true" tabindex="-1"></a>  fnt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb15-141"><a href="#cb15-141" aria-hidden="true" tabindex="-1"></a>  Qnt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb15-142"><a href="#cb15-142" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> T<span class="sc">:</span><span class="dv">1</span>){</span>
<span id="cb15-143"><a href="#cb15-143" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments for the distributions of the state vector given D_T</span></span>
<span id="cb15-144"><a href="#cb15-144" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> T){</span>
<span id="cb15-145"><a href="#cb15-145" aria-hidden="true" tabindex="-1"></a>      mnt[i, ] <span class="ot">&lt;-</span> mt[i, ]</span>
<span id="cb15-146"><a href="#cb15-146" aria-hidden="true" tabindex="-1"></a>      Cnt[, , i] <span class="ot">&lt;-</span> Ct[, , i]</span>
<span id="cb15-147"><a href="#cb15-147" aria-hidden="true" tabindex="-1"></a>      Cnt[, , i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Cnt[, , i] <span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Cnt[, , i]) </span>
<span id="cb15-148"><a href="#cb15-148" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb15-149"><a href="#cb15-149" aria-hidden="true" tabindex="-1"></a>      inv_Rtp1<span class="ot">&lt;-</span><span class="fu">solve</span>(Rt[,,i<span class="sc">+</span><span class="dv">1</span>])</span>
<span id="cb15-150"><a href="#cb15-150" aria-hidden="true" tabindex="-1"></a>      Bt <span class="ot">&lt;-</span> Ct[, , i] <span class="sc">%*%</span> <span class="fu">t</span>(GG) <span class="sc">%*%</span> inv_Rtp1</span>
<span id="cb15-151"><a href="#cb15-151" aria-hidden="true" tabindex="-1"></a>      mnt[i, ] <span class="ot">&lt;-</span> mt[i, ] <span class="sc">+</span> Bt <span class="sc">%*%</span> (mnt[i<span class="sc">+</span><span class="dv">1</span>, ] <span class="sc">-</span> at[i<span class="sc">+</span><span class="dv">1</span>, ])</span>
<span id="cb15-152"><a href="#cb15-152" aria-hidden="true" tabindex="-1"></a>      Cnt[, , i] <span class="ot">&lt;-</span> Ct[, , i] <span class="sc">+</span> Bt <span class="sc">%*%</span> (Cnt[, , i <span class="sc">+</span> <span class="dv">1</span>] <span class="sc">-</span> Rt[, , i<span class="sc">+</span><span class="dv">1</span>]) <span class="sc">%*%</span> <span class="fu">t</span>(Bt)</span>
<span id="cb15-153"><a href="#cb15-153" aria-hidden="true" tabindex="-1"></a>      Cnt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Cnt[,,i] <span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Cnt[,,i]) </span>
<span id="cb15-154"><a href="#cb15-154" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb15-155"><a href="#cb15-155" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments for the smoothed distribution of the mean response of the series</span></span>
<span id="cb15-156"><a href="#cb15-156" aria-hidden="true" tabindex="-1"></a>    fnt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(FF) <span class="sc">%*%</span> <span class="fu">t</span>(mnt[i, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb15-157"><a href="#cb15-157" aria-hidden="true" tabindex="-1"></a>    Qnt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(FF) <span class="sc">%*%</span> <span class="fu">t</span>(Cnt[, , i]) <span class="sc">%*%</span> FF</span>
<span id="cb15-158"><a href="#cb15-158" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-159"><a href="#cb15-159" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Backward smoothing is completed!"</span>)</span>
<span id="cb15-160"><a href="#cb15-160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mnt =</span> mnt, <span class="at">Cnt =</span> Cnt, <span class="at">fnt=</span>fnt, <span class="at">Qnt=</span>Qnt))</span>
<span id="cb15-161"><a href="#cb15-161" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-162"><a href="#cb15-162" aria-hidden="true" tabindex="-1"></a><span class="do">####################### Example: Lake Huron Data ######################</span></span>
<span id="cb15-163"><a href="#cb15-163" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(LakeHuron,<span class="at">main=</span><span class="st">"Lake Huron Data"</span>,<span class="at">ylab=</span><span class="st">"level in feet"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="C4-L07_files/figure-html/lst-smoothing-in-the-NDLM-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9"><img src="C4-L07_files/figure-html/lst-smoothing-in-the-NDLM-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 98 observations total </span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>k<span class="ot">=</span><span class="dv">4</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>T<span class="ot">=</span><span class="fu">length</span>(LakeHuron)<span class="sc">-</span>k <span class="co"># We take the first 94 observations </span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>                     <span class="co">#  as our data</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>ts_data<span class="ot">=</span>LakeHuron[<span class="dv">1</span><span class="sc">:</span>T]</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>ts_validation_data <span class="ot">&lt;-</span> LakeHuron[(T<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span><span class="dv">98</span>]</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y_t =</span> ts_data)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="do">## set up matrices</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>FF <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">1</span>)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>GG <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">1</span>)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>VV <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">1</span>)</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>WW <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">1</span>)</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>m0 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">570</span>)</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>C0 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fl">1e4</span>)</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="do">## wrap up all matrices and initial values</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>matrices <span class="ot">&lt;-</span> <span class="fu">set_up_dlm_matrices</span>(FF,GG,VV,WW)</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>initial_states <span class="ot">&lt;-</span> <span class="fu">set_up_initial_states</span>(m0, C0)</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a><span class="do">## filtering</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>results_filtered <span class="ot">&lt;-</span> <span class="fu">forward_filter</span>(data, matrices, </span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>                                   initial_states)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Forward filtering is completed!</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>ci_filtered<span class="ot">&lt;-</span><span class="fu">get_credible_interval</span>(results_filtered<span class="sc">$</span>mt,</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>                                   results_filtered<span class="sc">$</span>Ct)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="do">## smoothing</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>results_smoothed <span class="ot">&lt;-</span> <span class="fu">backward_smoothing</span>(data, matrices, </span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>                                       results_filtered)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Backward smoothing is completed!</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>ci_smoothed <span class="ot">&lt;-</span> <span class="fu">get_credible_interval</span>(results_smoothed<span class="sc">$</span>mnt, </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>                                     results_smoothed<span class="sc">$</span>Cnt)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>index<span class="ot">=</span><span class="fu">seq</span>(<span class="dv">1875</span>, <span class="dv">1972</span>, <span class="at">length.out =</span> <span class="fu">length</span>(LakeHuron))</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>index_filt<span class="ot">=</span>index[<span class="dv">1</span><span class="sc">:</span>T]</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(index, LakeHuron, <span class="at">main =</span> <span class="st">"Lake Huron Level "</span>,<span class="at">type=</span><span class="st">'l'</span>,</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"time"</span>,<span class="at">ylab=</span><span class="st">"level in feet"</span>,<span class="at">lty=</span><span class="dv">3</span>,<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">575</span>,<span class="dv">583</span>))</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(index,LakeHuron,<span class="at">pch=</span><span class="dv">20</span>)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, results_filtered<span class="sc">$</span>mt, <span class="at">type=</span><span class="st">'l'</span>, </span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'red'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, ci_filtered[,<span class="dv">1</span>], <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'red'</span>,<span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, ci_filtered[,<span class="dv">2</span>], <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'red'</span>,<span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, results_smoothed<span class="sc">$</span>mnt, <span class="at">type=</span><span class="st">'l'</span>, </span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'blue'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, ci_smoothed[,<span class="dv">1</span>], <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'blue'</span>,<span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, ci_smoothed[,<span class="dv">2</span>], <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'blue'</span>,<span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">'bottomleft'</span>, <span class="at">legend=</span><span class="fu">c</span>(<span class="st">"filtered"</span>,<span class="st">"smoothed"</span>),</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>), <span class="at">lty=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="C4-L07_files/figure-html/lst-smoothing-in-the-NDLM-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10"><img src="C4-L07_files/figure-html/lst-smoothing-in-the-NDLM-2.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="sec-second-order-polynomial" class="level2" data-number="94.8">
<h2 data-number="94.8" class="anchored" data-anchor-id="sec-second-order-polynomial"><span class="header-section-number">94.8</span> Second order polynomial: Filtering and smoothing example <span class="emoji" data-emoji="movie_camera">🎥</span></h2>
<p>In this video walk through the code provided in the section below the comment</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Video Transcript
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<!-- transcript of https://www.coursera.org/learn/bayesian-statistics-time-series-analysis/lecture/EMgQY/second-order-polynomial-filtering-and-smoothing-example -->
<p>We now consider another example where instead of fitting a first order polynomial we’re fitting a second order polynomial DLM. So I just want to show you how to set up the structure of the model in a case in which you have a state parameter vector. That is of dimension larger than one in this particular case we have a bivariate state parameter vector. So once again we are going to source this file that has all the DLM functions for the case in which the <span class="math inline">F</span>, <span class="math inline">G</span>, <span class="math inline">V</span> and <span class="math inline">W</span> are known. So we’re just assuming that this is the case and then we’re assuming that <span class="math inline">F</span>, <span class="math inline">G</span>, <span class="math inline">V</span> and <span class="math inline">W</span> are constant over time in these examples. So we just I’m going to use a new data set which is also data set available in R this data set corresponds to the atmospheric CO2 concentrations in parts per million in the location of Mauna Loa. And this is monthly data so I’m just plotting the data here. If you look at the data you can see that it has two important features. One of them is an increasing trend as the time increases the concentration increases. And then the other very specific feature that you can see in this data set is this seasonal behavior. So right now what I’m going to do with this example is we are going to ignore the seasonal behavior, and we are going to try to fit the model that captures the linear increasing trend using a second order polynomial model.</p>
<p>So I’m going to just specify everything here. We are going to use the entire data set here. We’re going to analyze the entire data. We are going to read in this into a list and then we’re going to set up the DLM in matrices. So here because the model it’s a second order polynomial we are going to have a state vector. That is of dimension two the F matrix is going to be, so it’s a vector that has 1 in the first entry and 0 in the second one. And then G is this upper triangular matrix that has 1s in the diagonal and 1 above the diagonal as well. So the two parameters that we’re fitting here one of them you can view the two components in the state of theta_t parameter vector. The first component corresponds to the baseline of the level and then the second component corresponds to the rate of growth in that level that we are fitting. So just defining the F and G like that. And then V the observational variance I’m just going to set it at 10. You can play with different numbers here, and the W is a diagonal matrix with .0001 in each of the elements in the diagonal. So these models are not as flexible as the ones that we are going to consider later. So in particular we are using an assumption that the two components in the state sector are independent over time which is usually not very realistic. And we can consider more flexible models later but just to show you here how to fit these models, for the prior distribution I have again two components. So I’m going to say that a priori my baseline is 315 parts per million. And then for the second, the rate of growth is going to be 0 a priori. And then I have C0 which is this 10 times the diagonal of dimension 2 so this is an identity matrix. So is we have a diagonal with the elements in the diagonal equal to 10. So we wrap up all the DLM matrices with the functions that we defined before. And then we proceed with the filtering equations just using the forward filter function. We can obtain credible intervals for the expected value of y_t via this filtering equations.</p>
<p>So the reason why I’m calling it the expected value of <span class="math inline">y_t</span> via filtering it’s just the first component of the say that theta_t vectors. So that corresponds to the level of the series, the expected value of that <span class="math inline">y_t</span>. And then, I can compute the smoothing equations using the backward smoothing. And again I have to pass the data, the structure of the model in terms of the matrices and the results that I obtained via the filtering equations. And I can compute credible intervals for this expected value via smoothing and as we mentioned before, it has the same structure the smoothing and the filtering is just that, we call the mean and the variance mt and Ct. In the case of the filtering equations for the smoothing equations we just call them mnt and Cnt. So now we can plot all the results here. I’m just going to plot the results that correspond to the smoothing distributions just for you to see. And we can see here that is this trend that is estimated here is capturing the structure of this linear increasing trend. And you can play with different values of the signal to noise ratio. So different values of the V and the W. And if you change the values so that there is more or less signal to noise ratio, you will see that you will capture more of the seasonal structure and less of this linear trend structure. If you were to change those values. So if I go back a little bit here you can see that I have a very low signal to noise ratio and I picked this on purpose, because I didn’t want to capture any of the seasonal behavior that I observe in the series through these parameters. So I’m assuming that a lot of the variation that I see now I’m just keeping it in the noise. Just because I want to just get a very smooth estimate for this linear trend through a second order polynomial model. In practice what we’re going to do later is we really want to construct a model in which we have a component for the linear trend using the second order polynomial model. And then we add another component that will allow us to capture also the seasonal behavior that we observe in this series using a Fourier component model. So we will illustrate that later, in a separate example here is just again to show you how to use the code for specifying a second order polynomial.</p>
</div>
</div>
</div>
</section>
<section id="using-the-dlm-package-in-r" class="level2" data-number="94.9">
<h2 data-number="94.9" class="anchored" data-anchor-id="using-the-dlm-package-in-r"><span class="header-section-number">94.9</span> Using the dlm package in R <span class="emoji" data-emoji="movie_camera">🎥</span></h2>
<p>The <code>dlm</code> package in R is a powerful tool for working with dynamic linear models. The package provides a wide range of functions for filtering, smoothing, forecasting, and parameter estimation in DLMs. In this video, we walk through the code provided in <a href="#lst-dlm-package" class="quarto-xref">Listing&nbsp;<span class="quarto-unresolved-ref">lst-dlm-package</span></a>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Video Transcript
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<!-- transcript of https://www.coursera.org/learn/bayesian-statistics-time-series-analysis/lecture/lg1g0/using-the-dlm-package-in-r -->
<p>So here I’m going to show you how to use the <code>dlm</code> package to fit these dynamic linear models as well. So the dlm is package that is available from Cran. And it allows you to compute the filtering smoothing and forecasting equations for dynamic linear models. So I’m just going to show you how to do the same thing we’ve been doing with the code that I provided just using the dlm package. So I’m going to just run here the first examples that we ran. And I’m going to show you how to do the same again. So here, I’m just going through the Lake Huron data. So just setting up every_thing as we did before. And then going through the filtering and smoothing equations. And so we can now plot the results and just want to have all the results here. So we have the red line corresponds to the posterior mean for the distribution of <span class="math inline">\theta_t</span> given the <span class="math inline">Dt</span> using a first order polynomial model to fit the data. And the blue line corresponds to the smoothing mean. So the mean of the posterior distribution of the smoothing equations here. So now we can look at how to fit this with the dlm package. So you have to call, install the package if you don’t have it installed. And then just call that library once you have installed the package. And the dlm package has a different set of functions to construct the model first.</p>
<p>So I’m going to use the function that is called the <code>dlmModPoly</code>, which allows you to fit polynomial models. So it constructs the polynomial models. The default function as you can see here is a function in that assumes that the polynomial model is of order 2. So here I want to polynomial model of all the 1. And then I’m going to specify the variance at the observational level, which is called dV in that package. dW is the variance at the evolution level. And then I have my prior mean for theta and the prior variance. I’m just using exactly the same prior distribution. And the package provides two functions of the dlm filter function allows you to providing the data. And the model that you just define computes the filtering recursions here. And then there is another function that is called the dlmSmooth that you essentially pass the results of the filtering equations. And then you obtain the smoothing distributions. So we’re just going to do that. And now I’m going to plot the results that I obtained from those filtering equations. One thing that you can see here, if I do names of, let’s say results_filter_dlm. You can see that the way in which the dlm functions from the dlm package keep the results. It has a particular format. So in the case of the dlm package, you’re going to have the information about what model you fitted. Then you have the mean of theta_t given Dt is kept in this m object. And then you have a is the prior mean of theta_t, given the t -1. And then f is the mean of the one step ahead forecast distribution. And then you have these U.C, D.C, U.R, D.R, those are just decompositions of the C variance matrix. So each of the Cs at time t. And then if you have also the composition of the R matrices. So the model, the way in which the functions are implemented in this <code>dlm</code> package. Assume used an SVD decomposition of all the matrices. So you have to keep in mind if you’re going to recover the structure here for the different components in the model. You have to keep this in mind. So for the filtering results, this is the structure. If you do names of the results, smooth, with the dlm package. You’re going to have again, here is the mean here that is called S and then you have the decomposition of the matrix as well. So, I’m just going to plot now for the filtering results. I’m just going to plot the mean here. And then for the smoothing distribution, I’m also going to plot that means. In this case, we’re working with the first order polynomial. So the dimension of the state vector is 1. So you can see that we obtain exactly the same results. And you can compare them numerically. The upper plot corresponds to the results we get with the code that we’ve been using. And the second block corresponds to just using the code from the dlm package. We can also run the example with the second order polynomial. So again, if I use the specification of the model that we use before with the functions that we described. I can keep my results there. And if I use the dlm package, I can use again, this is a second order polynomial model. I say that the order of the polynomial is 2, I use this dlmModPoly function. I specify the observational variance, the system variance m0 and C0. So I’m using exactly the same priors in this case. And then I use the dlm filter function and the dlm smooth just to compute the moments of the filtering and smoothing distributions. And then I can plot every_thing here. We are plotting just the first component here. The posterior distribution for the first component of the theta vector. Which also corresponds to the expected value of the <span class="math inline">y_t</span>. And then if I do the same with the dlm package, you can see that you obtain the same results. So again, the upper plot corresponds to the results that we get from the code that we’ve been using. And then the bottom plot corresponds to the results that we get from the dlm package. So I just wanted to illustrate this. You’re welcome to always use the dlm package. Just keep in mind the structure in which the matrices are kept is a little bit different than what we have been discussing. Because the dlm package uses and SVD decomposition of the covariance matrices and keeps every_thing like that. So there are some differences. But you can also use this package to obtain inference in the case of dynamic linear models.</p>
</div>
</div>
</div>
</section>
<section id="sec-dlm-package" class="level2" data-number="94.10">
<h2 data-number="94.10" class="anchored" data-anchor-id="sec-dlm-package"><span class="header-section-number">94.10</span> Code: Using the <code>dlm</code> package <span class="emoji" data-emoji="spiral_notepad">🗒️</span> <span class="math inline">\mathcal{R}</span></h2>
<div class="cell">
<div id="lst-dlm-package" class="r cell-code listing quarto-float quarto-figure quarto-figure-left anchored">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-dlm-package-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;94.1: Using the <code>dlm</code> package for dynamic linear models
</figcaption>
<div aria-describedby="lst-dlm-package-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="do">#################################################</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="do">##### Univariate DLM: Known, constant variances</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="do">#################################################</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>set_up_dlm_matrices <span class="ot">&lt;-</span> <span class="cf">function</span>(FF, GG, VV, WW){</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">FF=</span>FF, <span class="at">GG=</span>GG, <span class="at">VV=</span>VV, <span class="at">WW=</span>WW))</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>set_up_initial_states <span class="ot">&lt;-</span> <span class="cf">function</span>(m0, C0){</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">m0=</span>m0, <span class="at">C0=</span>C0))</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="do">### forward update equations </span><span class="al">###</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>forward_filter <span class="ot">&lt;-</span> <span class="cf">function</span>(data, matrices, initial_states){</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve dataset</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>  y_t <span class="ot">&lt;-</span> data<span class="sc">$</span>y_t</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> <span class="fu">length</span>(y_t)</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve a set of quadruples </span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># FF, GG, VV, WW are scalar</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>  FF <span class="ot">&lt;-</span> matrices<span class="sc">$</span>FF  </span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>  GG <span class="ot">&lt;-</span> matrices<span class="sc">$</span>GG</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>  VV <span class="ot">&lt;-</span> matrices<span class="sc">$</span>VV</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>  WW <span class="ot">&lt;-</span> matrices<span class="sc">$</span>WW</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve initial states</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>  m0 <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>m0</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>  C0 <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>C0</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>  <span class="do">## create placeholder for results</span></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">dim</span>(GG)[<span class="dv">1</span>]</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow=</span>T, <span class="at">ncol=</span>d)</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>  Rt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, T))</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>  ft <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>  Qt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>  mt <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow=</span>T, <span class="at">ncol=</span>d)</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>  Ct <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, T))</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>  et <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T){</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments of priors at t</span></span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> <span class="fu">t</span>(m0)</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>      Rt[, , i] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> C0 <span class="sc">%*%</span> <span class="fu">t</span>(GG) <span class="sc">+</span> WW</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>      Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i]) </span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> <span class="fu">t</span>(mt[i<span class="dv">-1</span>, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>      Rt[, , i] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> Ct[, , i<span class="dv">-1</span>] <span class="sc">%*%</span> <span class="fu">t</span>(GG) <span class="sc">+</span> WW</span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>      Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i]) </span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments of one-step forecast:</span></span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>    ft[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(FF) <span class="sc">%*%</span> (at[i, ]) </span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>    Qt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(FF) <span class="sc">%*%</span> Rt[, , i] <span class="sc">%*%</span> FF <span class="sc">+</span> VV</span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments of posterior at t:</span></span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>    At <span class="ot">&lt;-</span> Rt[, , i] <span class="sc">%*%</span> FF <span class="sc">/</span> Qt[i]</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>    et[i] <span class="ot">&lt;-</span> y_t[i] <span class="sc">-</span> ft[i]</span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>    mt[i, ] <span class="ot">&lt;-</span> at[i, ] <span class="sc">+</span> <span class="fu">t</span>(At) <span class="sc">*</span> et[i]</span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>    Ct[, , i] <span class="ot">&lt;-</span> Rt[, , i] <span class="sc">-</span> Qt[i] <span class="sc">*</span> At <span class="sc">%*%</span> <span class="fu">t</span>(At)</span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>    Ct[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Ct[,,i] <span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Ct[,,i]) </span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Forward filtering is completed!"</span>) <span class="co"># indicator of completion</span></span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mt =</span> mt, <span class="at">Ct =</span> Ct, <span class="at">at =</span> at, <span class="at">Rt =</span> Rt, </span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>              <span class="at">ft =</span> ft, <span class="at">Qt =</span> Qt))</span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a>forecast_function <span class="ot">&lt;-</span> <span class="cf">function</span>(posterior_states, k, matrices){</span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a>  FF <span class="ot">&lt;-</span> matrices<span class="sc">$</span>FF</span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a>  GG <span class="ot">&lt;-</span> matrices<span class="sc">$</span>GG</span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a>  WW <span class="ot">&lt;-</span> matrices<span class="sc">$</span>WW</span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a>  VV <span class="ot">&lt;-</span> matrices<span class="sc">$</span>VV</span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a>  mt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>mt</span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a>  Ct <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>Ct</span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a>  <span class="do">## set up matrices</span></span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> <span class="fu">dim</span>(mt)[<span class="dv">1</span>] <span class="co"># time points</span></span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">dim</span>(mt)[<span class="dv">2</span>] <span class="co"># dimension of state parameter vector</span></span>
<span id="cb21-81"><a href="#cb21-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-82"><a href="#cb21-82" aria-hidden="true" tabindex="-1"></a>  <span class="do">## placeholder for results</span></span>
<span id="cb21-83"><a href="#cb21-83" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> k, <span class="at">ncol =</span> d)</span>
<span id="cb21-84"><a href="#cb21-84" aria-hidden="true" tabindex="-1"></a>  Rt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, k))</span>
<span id="cb21-85"><a href="#cb21-85" aria-hidden="true" tabindex="-1"></a>  ft <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k)</span>
<span id="cb21-86"><a href="#cb21-86" aria-hidden="true" tabindex="-1"></a>  Qt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k)</span>
<span id="cb21-87"><a href="#cb21-87" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-88"><a href="#cb21-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-89"><a href="#cb21-89" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k){</span>
<span id="cb21-90"><a href="#cb21-90" aria-hidden="true" tabindex="-1"></a>    <span class="do">## moments of state distribution</span></span>
<span id="cb21-91"><a href="#cb21-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb21-92"><a href="#cb21-92" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> <span class="fu">t</span>(mt[T, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb21-93"><a href="#cb21-93" aria-hidden="true" tabindex="-1"></a>      Rt[, , i] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> Ct[, , T] <span class="sc">%*%</span> <span class="fu">t</span>(GG) <span class="sc">+</span> WW</span>
<span id="cb21-94"><a href="#cb21-94" aria-hidden="true" tabindex="-1"></a>      Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i]) </span>
<span id="cb21-95"><a href="#cb21-95" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb21-96"><a href="#cb21-96" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> <span class="fu">t</span>(at[i<span class="dv">-1</span>, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb21-97"><a href="#cb21-97" aria-hidden="true" tabindex="-1"></a>      Rt[, , i] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> Rt[, , i<span class="dv">-1</span>] <span class="sc">%*%</span> <span class="fu">t</span>(GG) <span class="sc">+</span> WW</span>
<span id="cb21-98"><a href="#cb21-98" aria-hidden="true" tabindex="-1"></a>      Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i]) </span>
<span id="cb21-99"><a href="#cb21-99" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-100"><a href="#cb21-100" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-101"><a href="#cb21-101" aria-hidden="true" tabindex="-1"></a>    <span class="do">## moments of forecast distribution</span></span>
<span id="cb21-102"><a href="#cb21-102" aria-hidden="true" tabindex="-1"></a>    ft[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(FF) <span class="sc">%*%</span> <span class="fu">t</span>(at[i, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb21-103"><a href="#cb21-103" aria-hidden="true" tabindex="-1"></a>    Qt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(FF) <span class="sc">%*%</span> Rt[, , i] <span class="sc">%*%</span> FF <span class="sc">+</span> VV</span>
<span id="cb21-104"><a href="#cb21-104" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-105"><a href="#cb21-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Forecasting is completed!"</span>) <span class="co"># indicator of completion</span></span>
<span id="cb21-106"><a href="#cb21-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">at=</span>at, <span class="at">Rt=</span>Rt, <span class="at">ft=</span>ft, <span class="at">Qt=</span>Qt))</span>
<span id="cb21-107"><a href="#cb21-107" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-108"><a href="#cb21-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-109"><a href="#cb21-109" aria-hidden="true" tabindex="-1"></a><span class="do">## obtain 95% credible interval</span></span>
<span id="cb21-110"><a href="#cb21-110" aria-hidden="true" tabindex="-1"></a>get_credible_interval <span class="ot">&lt;-</span> <span class="cf">function</span>(mu, sigma2, </span>
<span id="cb21-111"><a href="#cb21-111" aria-hidden="true" tabindex="-1"></a>                          <span class="at">quantile =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)){</span>
<span id="cb21-112"><a href="#cb21-112" aria-hidden="true" tabindex="-1"></a>  z_quantile <span class="ot">&lt;-</span> <span class="fu">qnorm</span>(quantile)</span>
<span id="cb21-113"><a href="#cb21-113" aria-hidden="true" tabindex="-1"></a>  bound <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span><span class="fu">length</span>(mu), <span class="at">ncol=</span><span class="dv">2</span>)</span>
<span id="cb21-114"><a href="#cb21-114" aria-hidden="true" tabindex="-1"></a>  bound[, <span class="dv">1</span>] <span class="ot">&lt;-</span> mu <span class="sc">+</span> z_quantile[<span class="dv">1</span>]<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(sigma2)) <span class="co"># lower bound</span></span>
<span id="cb21-115"><a href="#cb21-115" aria-hidden="true" tabindex="-1"></a>  bound[, <span class="dv">2</span>] <span class="ot">&lt;-</span> mu <span class="sc">+</span> z_quantile[<span class="dv">2</span>]<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(sigma2)) <span class="co"># upper bound</span></span>
<span id="cb21-116"><a href="#cb21-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(bound)</span>
<span id="cb21-117"><a href="#cb21-117" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-118"><a href="#cb21-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-119"><a href="#cb21-119" aria-hidden="true" tabindex="-1"></a><span class="do">### smoothing equations </span><span class="al">###</span></span>
<span id="cb21-120"><a href="#cb21-120" aria-hidden="true" tabindex="-1"></a>backward_smoothing <span class="ot">&lt;-</span> <span class="cf">function</span>(data, matrices, </span>
<span id="cb21-121"><a href="#cb21-121" aria-hidden="true" tabindex="-1"></a>                               posterior_states){</span>
<span id="cb21-122"><a href="#cb21-122" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve data </span></span>
<span id="cb21-123"><a href="#cb21-123" aria-hidden="true" tabindex="-1"></a>  y_t <span class="ot">&lt;-</span> data<span class="sc">$</span>y_t</span>
<span id="cb21-124"><a href="#cb21-124" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> <span class="fu">length</span>(y_t) </span>
<span id="cb21-125"><a href="#cb21-125" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-126"><a href="#cb21-126" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb21-127"><a href="#cb21-127" aria-hidden="true" tabindex="-1"></a>  FF <span class="ot">&lt;-</span> matrices<span class="sc">$</span>FF</span>
<span id="cb21-128"><a href="#cb21-128" aria-hidden="true" tabindex="-1"></a>  GG <span class="ot">&lt;-</span> matrices<span class="sc">$</span>GG</span>
<span id="cb21-129"><a href="#cb21-129" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-130"><a href="#cb21-130" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb21-131"><a href="#cb21-131" aria-hidden="true" tabindex="-1"></a>  mt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>mt</span>
<span id="cb21-132"><a href="#cb21-132" aria-hidden="true" tabindex="-1"></a>  Ct <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>Ct</span>
<span id="cb21-133"><a href="#cb21-133" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>at</span>
<span id="cb21-134"><a href="#cb21-134" aria-hidden="true" tabindex="-1"></a>  Rt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>Rt</span>
<span id="cb21-135"><a href="#cb21-135" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-136"><a href="#cb21-136" aria-hidden="true" tabindex="-1"></a>  <span class="do">## create placeholder for posterior moments </span></span>
<span id="cb21-137"><a href="#cb21-137" aria-hidden="true" tabindex="-1"></a>  mnt <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">dim</span>(mt)[<span class="dv">1</span>], <span class="at">ncol =</span> <span class="fu">dim</span>(mt)[<span class="dv">2</span>])</span>
<span id="cb21-138"><a href="#cb21-138" aria-hidden="true" tabindex="-1"></a>  Cnt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">dim</span>(Ct))</span>
<span id="cb21-139"><a href="#cb21-139" aria-hidden="true" tabindex="-1"></a>  fnt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb21-140"><a href="#cb21-140" aria-hidden="true" tabindex="-1"></a>  Qnt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb21-141"><a href="#cb21-141" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> T<span class="sc">:</span><span class="dv">1</span>){</span>
<span id="cb21-142"><a href="#cb21-142" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments for the distributions of the state vector given D_T</span></span>
<span id="cb21-143"><a href="#cb21-143" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> T){</span>
<span id="cb21-144"><a href="#cb21-144" aria-hidden="true" tabindex="-1"></a>      mnt[i, ] <span class="ot">&lt;-</span> mt[i, ]</span>
<span id="cb21-145"><a href="#cb21-145" aria-hidden="true" tabindex="-1"></a>      Cnt[, , i] <span class="ot">&lt;-</span> Ct[, , i]</span>
<span id="cb21-146"><a href="#cb21-146" aria-hidden="true" tabindex="-1"></a>      Cnt[, , i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Cnt[, , i] <span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Cnt[, , i]) </span>
<span id="cb21-147"><a href="#cb21-147" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb21-148"><a href="#cb21-148" aria-hidden="true" tabindex="-1"></a>      inv_Rtp1<span class="ot">&lt;-</span><span class="fu">solve</span>(Rt[,,i<span class="sc">+</span><span class="dv">1</span>])</span>
<span id="cb21-149"><a href="#cb21-149" aria-hidden="true" tabindex="-1"></a>      Bt <span class="ot">&lt;-</span> Ct[, , i] <span class="sc">%*%</span> <span class="fu">t</span>(GG) <span class="sc">%*%</span> inv_Rtp1</span>
<span id="cb21-150"><a href="#cb21-150" aria-hidden="true" tabindex="-1"></a>      mnt[i, ] <span class="ot">&lt;-</span> mt[i, ] <span class="sc">+</span> Bt <span class="sc">%*%</span> (mnt[i<span class="sc">+</span><span class="dv">1</span>, ] <span class="sc">-</span> at[i<span class="sc">+</span><span class="dv">1</span>, ])</span>
<span id="cb21-151"><a href="#cb21-151" aria-hidden="true" tabindex="-1"></a>      Cnt[, , i] <span class="ot">&lt;-</span> Ct[, , i] <span class="sc">+</span> Bt <span class="sc">%*%</span> (Cnt[, , i <span class="sc">+</span> <span class="dv">1</span>] <span class="sc">-</span> Rt[, , i<span class="sc">+</span><span class="dv">1</span>]) <span class="sc">%*%</span> <span class="fu">t</span>(Bt)</span>
<span id="cb21-152"><a href="#cb21-152" aria-hidden="true" tabindex="-1"></a>      Cnt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Cnt[,,i] <span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Cnt[,,i]) </span>
<span id="cb21-153"><a href="#cb21-153" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-154"><a href="#cb21-154" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments for the smoothed distribution of the mean response of the series</span></span>
<span id="cb21-155"><a href="#cb21-155" aria-hidden="true" tabindex="-1"></a>    fnt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(FF) <span class="sc">%*%</span> <span class="fu">t</span>(mnt[i, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb21-156"><a href="#cb21-156" aria-hidden="true" tabindex="-1"></a>    Qnt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(FF) <span class="sc">%*%</span> <span class="fu">t</span>(Cnt[, , i]) <span class="sc">%*%</span> FF</span>
<span id="cb21-157"><a href="#cb21-157" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-158"><a href="#cb21-158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Backward smoothing is completed!"</span>)</span>
<span id="cb21-159"><a href="#cb21-159" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mnt =</span> mnt, <span class="at">Cnt =</span> Cnt, <span class="at">fnt=</span>fnt, <span class="at">Qnt=</span>Qnt))</span>
<span id="cb21-160"><a href="#cb21-160" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-161"><a href="#cb21-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-162"><a href="#cb21-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-163"><a href="#cb21-163" aria-hidden="true" tabindex="-1"></a><span class="do">####################### Example: Lake Huron Data ######################</span></span>
<span id="cb21-164"><a href="#cb21-164" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(LakeHuron) <span class="co"># 98 observations total </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="C4-L07_files/figure-html/lst-dlm-package-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11"><img src="C4-L07_files/figure-html/lst-dlm-package-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div id="lst-dlm-package" class="r cell-code listing quarto-float quarto-figure quarto-figure-left anchored">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-dlm-package-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;94.2: Using the <code>dlm</code> package for dynamic linear models
</figcaption>
<div aria-describedby="lst-dlm-package-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>k<span class="ot">=</span><span class="dv">4</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>T<span class="ot">=</span><span class="fu">length</span>(LakeHuron)<span class="sc">-</span>k <span class="co"># We take the first </span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>                      <span class="co"># 94 observations only as our data</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>ts_data<span class="ot">=</span>LakeHuron[<span class="dv">1</span><span class="sc">:</span>T]</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>ts_validation_data <span class="ot">&lt;-</span> LakeHuron[(T<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span><span class="dv">98</span>]</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y_t =</span> ts_data)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="do">## set up dlm matrices</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>GG <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">1</span>)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>FF <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">1</span>)</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>VV <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">1</span>)</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>WW <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">1</span>)</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>m0 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">570</span>)</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>C0 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fl">1e4</span>)</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="do">## wrap up all matrices and initial values</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>matrices <span class="ot">&lt;-</span> <span class="fu">set_up_dlm_matrices</span>(FF, GG, VV, WW)</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>initial_states <span class="ot">&lt;-</span> <span class="fu">set_up_initial_states</span>(m0, C0)</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="do">## filtering and smoothing </span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>results_filtered <span class="ot">&lt;-</span> <span class="fu">forward_filter</span>(data, matrices, </span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>                                   initial_states)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Forward filtering is completed!</code></pre>
</div>
<div id="lst-dlm-package" class="r cell-code listing quarto-float quarto-figure quarto-figure-left anchored">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-dlm-package-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;94.3: Using the <code>dlm</code> package for dynamic linear models
</figcaption>
<div aria-describedby="lst-dlm-package-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>results_smoothed <span class="ot">&lt;-</span> <span class="fu">backward_smoothing</span>(data, matrices, </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>                                       results_filtered)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Backward smoothing is completed!</code></pre>
</div>
<div id="lst-dlm-package" class="r cell-code listing quarto-float quarto-figure quarto-figure-left anchored">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-dlm-package-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;94.4: Using the <code>dlm</code> package for dynamic linear models
</figcaption>
<div aria-describedby="lst-dlm-package-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>index<span class="ot">=</span><span class="fu">seq</span>(<span class="dv">1875</span>, <span class="dv">1972</span>, <span class="at">length.out =</span> <span class="fu">length</span>(LakeHuron))</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>index_filt<span class="ot">=</span>index[<span class="dv">1</span><span class="sc">:</span>T]</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">1</span>), <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">1</span>))</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(index, LakeHuron, <span class="at">main =</span> <span class="st">"Lake Huron Level "</span>,<span class="at">type=</span><span class="st">'l'</span>,</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"time"</span>,<span class="at">ylab=</span><span class="st">"feet"</span>,<span class="at">lty=</span><span class="dv">3</span>,<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">575</span>,<span class="dv">583</span>))</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(index,LakeHuron,<span class="at">pch=</span><span class="dv">20</span>)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, results_filtered<span class="sc">$</span>mt, <span class="at">type=</span><span class="st">'l'</span>, </span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'red'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, results_smoothed<span class="sc">$</span>mnt, <span class="at">type=</span><span class="st">'l'</span>, </span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'blue'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Now let's look at the DLM package </span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dlm)</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>model<span class="ot">=</span><span class="fu">dlmModPoly</span>(<span class="at">order=</span><span class="dv">1</span>,<span class="at">dV=</span><span class="dv">1</span>,<span class="at">dW=</span><span class="dv">1</span>,<span class="at">m0=</span><span class="dv">570</span>,<span class="at">C0=</span><span class="fl">1e4</span>)</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>results_filtered_dlm<span class="ot">=</span><span class="fu">dlmFilter</span>(LakeHuron[<span class="dv">1</span><span class="sc">:</span>T],model)</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>results_smoothed_dlm<span class="ot">=</span><span class="fu">dlmSmooth</span>(results_filtered_dlm)</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(index_filt, LakeHuron[<span class="dv">1</span><span class="sc">:</span>T], <span class="at">ylab =</span> <span class="st">"level"</span>, </span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Lake Huron Level"</span>,</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>     <span class="at">type=</span><span class="st">'l'</span>, <span class="at">xlab=</span><span class="st">"time"</span>,<span class="at">lty=</span><span class="dv">3</span>,<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">575</span>,<span class="dv">583</span>))</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(index_filt,LakeHuron[<span class="dv">1</span><span class="sc">:</span>T],<span class="at">pch=</span><span class="dv">20</span>)</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt,results_filtered_dlm<span class="sc">$</span>m[<span class="sc">-</span><span class="dv">1</span>],<span class="at">col=</span><span class="st">'red'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt,results_smoothed_dlm<span class="sc">$</span>s[<span class="sc">-</span><span class="dv">1</span>],<span class="at">col=</span><span class="st">'blue'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="C4-L07_files/figure-html/lst-dlm-package-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-12"><img src="C4-L07_files/figure-html/lst-dlm-package-2.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div id="lst-dlm-package" class="r cell-code listing quarto-float quarto-figure quarto-figure-left anchored">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-dlm-package-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;94.5: Using the <code>dlm</code> package for dynamic linear models
</figcaption>
<div aria-describedby="lst-dlm-package-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Similarly, for the second order polynomial and the co2 data:</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>T<span class="ot">=</span><span class="fu">length</span>(co2)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>data<span class="ot">=</span><span class="fu">list</span>(<span class="at">y_t =</span> co2)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>FF <span class="ot">&lt;-</span> (<span class="fu">as.matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>)))</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>GG <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>),<span class="at">ncol=</span><span class="dv">2</span>,<span class="at">byrow=</span>T)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>VV <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">200</span>)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>WW <span class="ot">&lt;-</span> <span class="fl">0.01</span><span class="sc">*</span><span class="fu">diag</span>(<span class="dv">2</span>)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>m0 <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">as.matrix</span>(<span class="fu">c</span>(<span class="dv">320</span>,<span class="dv">0</span>)))</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>C0 <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">*</span><span class="fu">diag</span>(<span class="dv">2</span>)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="do">## wrap up all matrices and initial values</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>matrices <span class="ot">&lt;-</span> <span class="fu">set_up_dlm_matrices</span>(FF,GG, VV, WW)</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>initial_states <span class="ot">&lt;-</span> <span class="fu">set_up_initial_states</span>(m0, C0)</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a><span class="do">## filtering and smoothing </span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>results_filtered <span class="ot">&lt;-</span> <span class="fu">forward_filter</span>(data, matrices, </span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>                                   initial_states)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Forward filtering is completed!</code></pre>
</div>
<div id="lst-dlm-package" class="r cell-code listing quarto-float quarto-figure quarto-figure-left anchored">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-dlm-package-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;94.6: Using the <code>dlm</code> package for dynamic linear models
</figcaption>
<div aria-describedby="lst-dlm-package-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>results_smoothed <span class="ot">&lt;-</span> <span class="fu">backward_smoothing</span>(data, matrices, </span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>                                       results_filtered)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Backward smoothing is completed!</code></pre>
</div>
<div id="lst-dlm-package" class="r cell-code listing quarto-float quarto-figure quarto-figure-left anchored">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-dlm-package-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;94.7: Using the <code>dlm</code> package for dynamic linear models
</figcaption>
<div aria-describedby="lst-dlm-package-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Now, using the DLM package: </span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>model<span class="ot">=</span><span class="fu">dlmModPoly</span>(<span class="at">order=</span><span class="dv">2</span>,<span class="at">dV=</span><span class="dv">200</span>,<span class="at">dW=</span><span class="fl">0.01</span><span class="sc">*</span><span class="fu">rep</span>(<span class="dv">1</span>,<span class="dv">2</span>),</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">m0=</span><span class="fu">c</span>(<span class="dv">320</span>,<span class="dv">0</span>),<span class="at">C0=</span><span class="dv">10</span><span class="sc">*</span><span class="fu">diag</span>(<span class="dv">2</span>))</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co"># filtering and smoothing </span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>results_filtered_dlm<span class="ot">=</span><span class="fu">dlmFilter</span>(data<span class="sc">$</span>y_t,model)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>results_smoothed_dlm<span class="ot">=</span><span class="fu">dlmSmooth</span>(results_filtered_dlm)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">1</span>), <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">1</span>))</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">as.vector</span>(<span class="fu">time</span>(co2)),co2,<span class="at">type=</span><span class="st">'l'</span>,<span class="at">xlab=</span><span class="st">"time"</span>,</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">300</span>,<span class="dv">380</span>))</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">as.vector</span>(<span class="fu">time</span>(co2)),results_filtered<span class="sc">$</span>mt[,<span class="dv">1</span>],</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'red'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">as.vector</span>(<span class="fu">time</span>(co2)),results_smoothed<span class="sc">$</span>mnt[,<span class="dv">1</span>],</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'blue'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">as.vector</span>(<span class="fu">time</span>(co2)),co2,<span class="at">type=</span><span class="st">'l'</span>,<span class="at">xlab=</span><span class="st">"time"</span>,</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">300</span>,<span class="dv">380</span>))</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">as.vector</span>(<span class="fu">time</span>(co2)),results_filtered_dlm<span class="sc">$</span>m[<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>],</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'red'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">as.vector</span>(<span class="fu">time</span>(co2)),results_smoothed_dlm<span class="sc">$</span>s[<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>],</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'blue'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="C4-L07_files/figure-html/lst-dlm-package-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-13"><img src="C4-L07_files/figure-html/lst-dlm-package-3.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-west2013bayesian" class="csl-entry" role="listitem">
West, M., and J. Harrison. 2013. <em>Bayesian Forecasting and Dynamic Models</em>. Springer Series in Statistics. Springer New York. <a href="https://books.google.co.il/books?id=NmfaBwAAQBAJ">https://books.google.co.il/books?id=NmfaBwAAQBAJ</a>.
</div>
</div>
</section>

</main> <!-- /main -->
<script type="text/javascript">

// replace cmd keyboard shortcut w/ control on non-Mac platforms
const kPlatformMac = typeof navigator !== 'undefined' ? /Mac/.test(navigator.platform) : false;
if (!kPlatformMac) {
   var kbds = document.querySelectorAll("kbd")
   kbds.forEach(function(kbd) {
      kbd.innerHTML = kbd.innerHTML.replace(/⌘/g, '⌃');
   });
}

// tweak headings in pymd
document.querySelectorAll(".pymd span.co").forEach(el => {
   if (!el.innerText.startsWith("#|")) {
      el.style.fontWeight = 1000;
   }
});

</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
        for (let i=0; i<annoteTargets.length; i++) {
          const annoteTarget = annoteTargets[i];
          const targetCell = annoteTarget.getAttribute("data-target-cell");
          const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
          const contentFn = () => {
            const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
            if (content) {
              const tipContent = content.cloneNode(true);
              tipContent.classList.add("code-annotation-tip-content");
              return tipContent.outerHTML;
            }
          }
          const config = {
            allowHTML: true,
            content: contentFn,
            onShow: (instance) => {
              selectCodeLines(instance.reference);
              instance.reference.classList.add('code-annotation-active');
              window.tippy.hideAll();
            },
            onHide: (instance) => {
              unselectCodeLines();
              instance.reference.classList.remove('code-annotation-active');
            },
            maxWidth: 300,
            delay: [50, 0],
            duration: [200, 0],
            offset: [5, 10],
            arrow: true,
            appendTo: function(el) {
              return el.parentElement.parentElement.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'quarto',
            placement: 'right',
            popperOptions: {
              modifiers: [
              {
                name: 'flip',
                options: {
                  flipVariations: false, // true by default
                  allowedAutoPlacements: ['right'],
                  fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
                },
              },
              {
                name: 'preventOverflow',
                options: {
                  mainAxis: false,
                  altAxis: false
                }
              }
              ]        
            }      
          };
          window.tippy(annoteTarget, config); 
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./C4-L06.html" class="pagination-link" aria-label="Normal Dynamic Linear Models, Part 1 - M3L6">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">93</span>&nbsp; <span class="chapter-title">Normal Dynamic Linear Models, Part 1 - M3L6</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./C4-L08.html" class="pagination-link" aria-label="Seasonal NDLMs M4L8">
        <span class="nav-page-text"><span class="chapter-number">95</span>&nbsp; <span class="chapter-title">Seasonal NDLMs M4L8</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb32" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2024-11-07</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Bayesian Inference in the NDLM: Part 1 M3L7"</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> Time Series Analysis</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> "Normal Dynamic Linear Models (NDLMs) are a class of models used for time series analysis that allow for flexible modeling of temporal dependencies."</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span><span class="co"> </span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="co">  - Bayesian Statistics</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co">  - Time Series</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="an">keywords:</span><span class="co"> </span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="co">  - Time Series</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="co">  - Filtering</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="co">  - Kalman filtering</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="co">  - Smoothing</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="co">  - NDLM</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="co">  - Normal Dynamic Linear Models</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="co">  - Polynomial Trend Models</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="co">  - Regression Models</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a><span class="co">  - Superposition Principle</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a><span class="co">  - R code</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a><span class="an">fig-caption:</span><span class="co"> Notes about ... Bayesian Statistics</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a><span class="an">title-block-banner:</span><span class="co"> images/banner_deep.jpg</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>:::: {.content-hidden when-format="pdf"}</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>::: {#vid-sean-law .column-margin}</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>{{&lt; video https://www.youtube.com/watch?v=0O6dlq6a4rA&amp;ab_channel=SciPy &gt;}}</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>Sean Law - STUMPY: Modern Time Series Analysis with Matrix Profiles </span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>::::</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>We will now delve into Bayesian inference in the case of the normal dynamic linear model where both the observational variance and the system variance are known. We will talk about filtering equations, smoothing equations and also forecasting in this setting using Bayesian approach</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>::: {.callout-note collapse='true'}</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a><span class="fu">### Reality check {.unnumbered}</span></span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>A large portion of the next video is dedicated to laying the ground for use bayesian inference in the NDLM. I was thinking we will infer $F, G,V, W$ from the data, once we supply a normal prior $\mathcal{N}(M,C)$. But this is not the case. In fact we don't seem to be particularly Bayesian when going about constructing the NDLM model. </span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a> (i.e. filtering smoothing, of the parameters $\theta_t$ given the data and forecasting $y_t$ based on that)</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>I was initially disappointed that we assume that we know everything I want to infer. This is an open question for the proverbial <span class="co">[</span><span class="ot">Feynman Notebook</span><span class="co">](./C4-L06.qmd)</span>. In reality that is just another problem.</span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a> But that not the process with time series analysis. </span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a>However, at some point I saw a talk about <span class="co">[</span><span class="ot">STUMPY</span><span class="co">](https://stumpy.readthedocs.io/en/latest/Tutorial_STUMPY_Basics.html)</span> which does many cool time series stuff in python. And the speaker Sean Law talks about all the different Data Science &amp; DSP Mojos <span class="in">`#magicspells`</span> one can use, the nascent issues when comparing lots of times series or even just time series with lots of data. He makes another point that there is <span class="in">`#NoFreeLunch`</span> - each Mojo comes with with its own assumptions and limitations before making the case for using <span class="co">[</span><span class="ot">Matrix Profiles</span><span class="co">](https://stumpy.readthedocs.io/en/latest/Tutorial_STUMPY_Basics.html)</span>.</span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a>Prado lays the ground for working with a time series with around 300 data points - i.e. something we can still plot and view on the screen then inspect it. This might unlock for us, the NDLM framework which while flexible requires us to have a detailed form of the the model and its priors. This is easy enough if we deal with a synthetic data set, less so if we have need to analyze an novel time series for which we lack much intuition. Here we will need todo a preliminary exploratory data analysis before we can step in and construct our NDLM.</span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a>I suppose they expect that you will use some other non-bayesian tools to do this as we haven't really covered this in her course.</span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a>Splitting a TS into trend periods and a stationary residual isn't too tricky in R. Getting the inverse periods is then possible. Doing regression on the residuals is also possible. So if we have done all that we should be able to write down an NDLM based on all that we learned. And this will allow us to do filtering, smoothing and forecasting with error estimates.</span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a><span class="fu">## Filtering  :movie_camera: </span></span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a><span class="al">![Derivation for the Prior and Forecast at Time t](images/m3_0041.png)</span>{#fig-derivation-for-the-prior-and-forecast-at-time-t .column-margin  group="slides" width="53mm"}</span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a><span class="al">![Derivation of the Posterior at Time t](images/m3_0042.png)</span>{#fig-derivation-of-the-posterior-at-time-t .column-margin  group="slides" width="53mm"}</span>
<span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-68"><a href="#cb32-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-69"><a href="#cb32-69" aria-hidden="true" tabindex="-1"></a>Recall we are working in a Bayesian setting where a NDLM model with a normal prior would like this:</span>
<span id="cb32-70"><a href="#cb32-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-71"><a href="#cb32-71" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-72"><a href="#cb32-72" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb32-73"><a href="#cb32-73" aria-hidden="true" tabindex="-1"></a>  y_t &amp;= F_t' \theta_t + \nu_t &amp; \nu_t &amp;\sim \mathcal{N}(0, v_t) &amp; \text{(observation)} <span class="sc">\\</span></span>
<span id="cb32-74"><a href="#cb32-74" aria-hidden="true" tabindex="-1"></a>  \theta_t &amp;= G_t \theta_{t-1} + \omega_t &amp; \omega_t &amp;\sim  \mathcal{N}(0, W_t) &amp; \text{(evolution)} <span class="sc">\\</span></span>
<span id="cb32-75"><a href="#cb32-75" aria-hidden="true" tabindex="-1"></a>  &amp; &amp;(\theta_0 \mid \mathcal{D}_0) &amp; \sim  \mathcal{N}(m_0, C_0) &amp; \text{(prior)}</span>
<span id="cb32-76"><a href="#cb32-76" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb32-77"><a href="#cb32-77" aria-hidden="true" tabindex="-1"></a>$$ {#eq-generic-NDLM}</span>
<span id="cb32-78"><a href="#cb32-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-79"><a href="#cb32-79" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>In the prior  $\mathcal{D}_0$ stands for the information that we have before collecting any data and </span>
<span id="cb32-80"><a href="#cb32-80" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>We are assuming $\theta_0$ follows a normal distribution with </span>
<span id="cb32-81"><a href="#cb32-81" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$m_0$ mean</span>
<span id="cb32-82"><a href="#cb32-82" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$C_0$ variance covariance matrix.</span>
<span id="cb32-83"><a href="#cb32-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-84"><a href="#cb32-84" aria-hidden="true" tabindex="-1"></a>Since we are doing filtering which is a retrospective analysis, of past states we assume that we know $m_0, C_0, \nu_t, \omega_t, F_t, G_t \qquad \forall t$.</span>
<span id="cb32-85"><a href="#cb32-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-86"><a href="#cb32-86" aria-hidden="true" tabindex="-1"></a>However, there is often great interest in looking back in time in order to get a clearer picture of what happened.</span>
<span id="cb32-87"><a href="#cb32-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-88"><a href="#cb32-88" aria-hidden="true" tabindex="-1"></a>We are interested in performing Bayesian inference in this setting and we talked about different kinds of distributions. </span>
<span id="cb32-89"><a href="#cb32-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-90"><a href="#cb32-90" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>One is the **filtering distribution** that allows us to update the distribution of $\theta_t$ as we receive observations and information over time. </span>
<span id="cb32-91"><a href="#cb32-91" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The other one is **smoothing equations** that allows us to just revisit the past once we have observed a chunk of data. </span>
<span id="cb32-92"><a href="#cb32-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-93"><a href="#cb32-93" aria-hidden="true" tabindex="-1"></a>In a Bayesian setting, you have to set *a prior distribution*. <span class="co">[</span><span class="ot">We will work with the prior distribution that is conjugate.</span><span class="co">]</span>{.mark} </span>
<span id="cb32-94"><a href="#cb32-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-95"><a href="#cb32-95" aria-hidden="true" tabindex="-1"></a>In this case we have to begin with a distribution at time zero for $\theta_0$. So before we have seen any data at all, I have this prior distribution. </span>
<span id="cb32-96"><a href="#cb32-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-97"><a href="#cb32-97" aria-hidden="true" tabindex="-1"></a>We also assume a prior distribution of the form:</span>
<span id="cb32-98"><a href="#cb32-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-99"><a href="#cb32-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-100"><a href="#cb32-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-101"><a href="#cb32-101" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-102"><a href="#cb32-102" aria-hidden="true" tabindex="-1"></a>(\theta_{t} \mid \mathcal{D}_{t-1}) \sim \mathcal{N}(m_{t-1}, C_{t-1}).</span>
<span id="cb32-103"><a href="#cb32-103" aria-hidden="true" tabindex="-1"></a>$$ {#eq-filtering-assumption-1}</span>
<span id="cb32-104"><a href="#cb32-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-105"><a href="#cb32-105" aria-hidden="true" tabindex="-1"></a>We assume that this the filtering distribution follows this normal distribution based on </span>
<span id="cb32-106"><a href="#cb32-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-107"><a href="#cb32-107" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>the prior in <span class="co">[</span><span class="ot">@eq-generic-NDLM</span><span class="co">]</span> being conjugate of the normal and  </span>
<span id="cb32-108"><a href="#cb32-108" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>the linearity of the model in <span class="co">[</span><span class="ot">@eq-generic-NDLM</span><span class="co">]</span>. </span>
<span id="cb32-109"><a href="#cb32-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-110"><a href="#cb32-110" aria-hidden="true" tabindex="-1"></a>These result in updates to the model parameters and uncertainty, at each time step, preserving the normal structure from the prior.</span>
<span id="cb32-111"><a href="#cb32-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-112"><a href="#cb32-112" aria-hidden="true" tabindex="-1"></a>Then, we can obtain the following distributions:</span>
<span id="cb32-113"><a href="#cb32-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-114"><a href="#cb32-114" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Prior at Time $t$</span>
<span id="cb32-115"><a href="#cb32-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-116"><a href="#cb32-116" aria-hidden="true" tabindex="-1"></a>  $$</span>
<span id="cb32-117"><a href="#cb32-117" aria-hidden="true" tabindex="-1"></a>  (\theta_t \mid \mathcal{D}_{t-1}) \sim  \mathcal{N}(a_t, R_t) \qquad \text{(prior at time t)} \qquad</span>
<span id="cb32-118"><a href="#cb32-118" aria-hidden="true" tabindex="-1"></a>  $$ {#eq-prior-at-time-t}</span>
<span id="cb32-119"><a href="#cb32-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-120"><a href="#cb32-120" aria-hidden="true" tabindex="-1"></a>  with </span>
<span id="cb32-121"><a href="#cb32-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-122"><a href="#cb32-122" aria-hidden="true" tabindex="-1"></a>  $$ \begin{aligned}</span>
<span id="cb32-123"><a href="#cb32-123" aria-hidden="true" tabindex="-1"></a>  a_t \doteq&amp; \mathbb{E}<span class="co">[</span><span class="ot">\theta_t \mid \mathcal{D}_{t-1}</span><span class="co">]</span> =&amp; G_t  \mathbb{E}<span class="co">[</span><span class="ot">G_t \theta_{t-1} \mid \mathcal{D}_{t-1} </span><span class="co">]</span> =&amp; G_t m_{t-1} <span class="sc">\\</span></span>
<span id="cb32-124"><a href="#cb32-124" aria-hidden="true" tabindex="-1"></a>  R_t \doteq&amp; \mathbb{V}ar<span class="co">[</span><span class="ot">\theta_t \mid \mathcal{D}_{t-1}</span><span class="co">]</span> =&amp; G_t \mathbb{V}ar<span class="co">[</span><span class="ot">\theta_t \mid \mathcal{D}_{t-1}</span><span class="co">]</span> =&amp; G_t C_{t-1} G_t' + W_t.</span>
<span id="cb32-125"><a href="#cb32-125" aria-hidden="true" tabindex="-1"></a>  \end{aligned}</span>
<span id="cb32-126"><a href="#cb32-126" aria-hidden="true" tabindex="-1"></a>  $$ {#eq-derivation-for-a-t-and-R-t}</span>
<span id="cb32-127"><a href="#cb32-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-128"><a href="#cb32-128" aria-hidden="true" tabindex="-1"></a>  Where we simply took the first and second moments of the system equation from <span class="co">[</span><span class="ot">@eq-generic-NDLM</span><span class="co">]</span> conditioned on our information set $\mathcal{D}_{t-1}$ </span>
<span id="cb32-129"><a href="#cb32-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-130"><a href="#cb32-130" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>One-Step Forecast</span>
<span id="cb32-131"><a href="#cb32-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-132"><a href="#cb32-132" aria-hidden="true" tabindex="-1"></a>  $$</span>
<span id="cb32-133"><a href="#cb32-133" aria-hidden="true" tabindex="-1"></a>  (y_t \mid \mathcal{D}_{t-1}) \sim  \mathcal{N}(f_t, q_t) \qquad \text{(one step forecast fn)} \qquad</span>
<span id="cb32-134"><a href="#cb32-134" aria-hidden="true" tabindex="-1"></a>  $$ {#eq-one-step-forecast-fn}</span>
<span id="cb32-135"><a href="#cb32-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-136"><a href="#cb32-136" aria-hidden="true" tabindex="-1"></a>  with</span>
<span id="cb32-137"><a href="#cb32-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-138"><a href="#cb32-138" aria-hidden="true" tabindex="-1"></a>  $$\begin{aligned}</span>
<span id="cb32-139"><a href="#cb32-139" aria-hidden="true" tabindex="-1"></a>  f_t </span>
<span id="cb32-140"><a href="#cb32-140" aria-hidden="true" tabindex="-1"></a>     &amp; \doteq \mathbb{E}<span class="co">[</span><span class="ot"> y_t \mid \mathcal{D}_{t-1} </span><span class="co">]</span></span>
<span id="cb32-141"><a href="#cb32-141" aria-hidden="true" tabindex="-1"></a>     &amp; = F_t' \mathbb{E}<span class="co">[</span><span class="ot"> y_t \mid \mathcal{D}_{t-1} </span><span class="co">]</span></span>
<span id="cb32-142"><a href="#cb32-142" aria-hidden="true" tabindex="-1"></a>     &amp; = F_t' a_t <span class="sc">\\</span></span>
<span id="cb32-143"><a href="#cb32-143" aria-hidden="true" tabindex="-1"></a>  q_t </span>
<span id="cb32-144"><a href="#cb32-144" aria-hidden="true" tabindex="-1"></a>     &amp; \doteq \mathbb{V}ar<span class="co">[</span><span class="ot">y_t \mid \mathcal{D}_{t-1}</span><span class="co">]</span> </span>
<span id="cb32-145"><a href="#cb32-145" aria-hidden="true" tabindex="-1"></a>     &amp; = F_t' \mathbb{V}ar<span class="co">[</span><span class="ot">y_t \mid \mathcal{D}_{t-1}</span><span class="co">]</span>  </span>
<span id="cb32-146"><a href="#cb32-146" aria-hidden="true" tabindex="-1"></a>     &amp; = F_t' R_t F_t + v_t</span>
<span id="cb32-147"><a href="#cb32-147" aria-hidden="true" tabindex="-1"></a>  \end{aligned}</span>
<span id="cb32-148"><a href="#cb32-148" aria-hidden="true" tabindex="-1"></a>  $$ {#eq-derivation-for-f-t-and-q-t}</span>
<span id="cb32-149"><a href="#cb32-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-150"><a href="#cb32-150" aria-hidden="true" tabindex="-1"></a>  Where we took the first moments on the observation equation conditioned on the information set $\mathcal{D}_t$ and substituted @eq-one-step-forecast-fn </span>
<span id="cb32-151"><a href="#cb32-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-152"><a href="#cb32-152" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Posterior at Time $t$ </span>
<span id="cb32-153"><a href="#cb32-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-154"><a href="#cb32-154" aria-hidden="true" tabindex="-1"></a>  $$</span>
<span id="cb32-155"><a href="#cb32-155" aria-hidden="true" tabindex="-1"></a>  (\theta_t \mid \mathcal{D}_t) \sim  \mathcal{N}(m_t, C_t)</span>
<span id="cb32-156"><a href="#cb32-156" aria-hidden="true" tabindex="-1"></a>  $$ </span>
<span id="cb32-157"><a href="#cb32-157" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-158"><a href="#cb32-158" aria-hidden="true" tabindex="-1"></a>  with</span>
<span id="cb32-159"><a href="#cb32-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-160"><a href="#cb32-160" aria-hidden="true" tabindex="-1"></a>  $$\begin{aligned}</span>
<span id="cb32-161"><a href="#cb32-161" aria-hidden="true" tabindex="-1"></a>  m_t &amp;= a_t + R_t F_t q_t^{-1} (y_t - f_t), <span class="sc">\\</span></span>
<span id="cb32-162"><a href="#cb32-162" aria-hidden="true" tabindex="-1"></a>  C_t &amp;= R_t - R_t F_t q_t^{-1} F_t' R_t.</span>
<span id="cb32-163"><a href="#cb32-163" aria-hidden="true" tabindex="-1"></a>  \end{aligned}</span>
<span id="cb32-164"><a href="#cb32-164" aria-hidden="true" tabindex="-1"></a>  $$ {#eq-posterior-at-time-t}</span>
<span id="cb32-165"><a href="#cb32-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-166"><a href="#cb32-166" aria-hidden="true" tabindex="-1"></a>  These can be derived via Normal theory or via the Multivariate Bayes' theorem. The background for both seems to be provided in <span class="co">[</span><span class="ot">@west2013bayesian §17.2.3 p.639</span><span class="co">]</span></span>
<span id="cb32-167"><a href="#cb32-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-168"><a href="#cb32-168" aria-hidden="true" tabindex="-1"></a>Now, denoting $e_t = (y_t - f_t)$ and $A_t = R_t F_t q_t^{-1}$, we can rewrite the equations above as:</span>
<span id="cb32-169"><a href="#cb32-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-170"><a href="#cb32-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-171"><a href="#cb32-171" aria-hidden="true" tabindex="-1"></a>It follows that </span>
<span id="cb32-172"><a href="#cb32-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-173"><a href="#cb32-173" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-174"><a href="#cb32-174" aria-hidden="true" tabindex="-1"></a>\begin{pmatrix}Y <span class="sc">\\</span> \theta\end{pmatrix} \sim \mathcal{N}</span>
<span id="cb32-175"><a href="#cb32-175" aria-hidden="true" tabindex="-1"></a>\left(</span>
<span id="cb32-176"><a href="#cb32-176" aria-hidden="true" tabindex="-1"></a>  \begin{pmatrix}F'a <span class="sc">\\</span> a \end{pmatrix},</span>
<span id="cb32-177"><a href="#cb32-177" aria-hidden="true" tabindex="-1"></a>  \begin{pmatrix} F'RF + V &amp; F'R <span class="sc">\\</span> RF &amp; R \end{pmatrix}</span>
<span id="cb32-178"><a href="#cb32-178" aria-hidden="true" tabindex="-1"></a>\right)</span>
<span id="cb32-179"><a href="#cb32-179" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-180"><a href="#cb32-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-181"><a href="#cb32-181" aria-hidden="true" tabindex="-1"></a>Therefore, identifying $Y$ with $X_1$ and $\theta$ with $X_2$ in the partition of $X$ in 17.2.2, we have</span>
<span id="cb32-182"><a href="#cb32-182" aria-hidden="true" tabindex="-1"></a>RF R</span>
<span id="cb32-183"><a href="#cb32-183" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb32-184"><a href="#cb32-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-185"><a href="#cb32-185" aria-hidden="true" tabindex="-1"></a>Therefore, identifying Y with X1 and θ with X2 in the partition of X in 17.2.2, we have</span>
<span id="cb32-186"><a href="#cb32-186" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-187"><a href="#cb32-187" aria-hidden="true" tabindex="-1"></a>Y \sim \mathcal{N}<span class="co">[</span><span class="ot">F'a, F'RF + V</span><span class="co">]</span></span>
<span id="cb32-188"><a href="#cb32-188" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-189"><a href="#cb32-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-190"><a href="#cb32-190" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-191"><a href="#cb32-191" aria-hidden="true" tabindex="-1"></a>(\theta \mid Y) \sim \mathcal{N}<span class="co">[</span><span class="ot">m, C</span><span class="co">]</span>,</span>
<span id="cb32-192"><a href="#cb32-192" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-193"><a href="#cb32-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-194"><a href="#cb32-194" aria-hidden="true" tabindex="-1"></a>where</span>
<span id="cb32-195"><a href="#cb32-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-196"><a href="#cb32-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-197"><a href="#cb32-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-198"><a href="#cb32-198" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-199"><a href="#cb32-199" aria-hidden="true" tabindex="-1"></a>m = a + RF<span class="co">[</span><span class="ot">F′RF + V</span><span class="co">]</span>−1<span class="co">[</span><span class="ot">Y − F′a</span><span class="co">]</span></span>
<span id="cb32-200"><a href="#cb32-200" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-201"><a href="#cb32-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-202"><a href="#cb32-202" aria-hidden="true" tabindex="-1"></a>and</span>
<span id="cb32-203"><a href="#cb32-203" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-204"><a href="#cb32-204" aria-hidden="true" tabindex="-1"></a>C = R − RF<span class="co">[</span><span class="ot">F′RF + V</span><span class="co">]</span>−1F′R.</span>
<span id="cb32-205"><a href="#cb32-205" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-206"><a href="#cb32-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-207"><a href="#cb32-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-208"><a href="#cb32-208" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-209"><a href="#cb32-209" aria-hidden="true" tabindex="-1"></a>  \begin{aligned}</span>
<span id="cb32-210"><a href="#cb32-210" aria-hidden="true" tabindex="-1"></a>  \theta \mid \mathcal{D}_t &amp;\sim \mathcal{N}(m_t,C_t)<span class="sc">\\</span></span>
<span id="cb32-211"><a href="#cb32-211" aria-hidden="true" tabindex="-1"></a>  m_t &amp;\doteq a_t + A_t e_t, <span class="sc">\\</span></span>
<span id="cb32-212"><a href="#cb32-212" aria-hidden="true" tabindex="-1"></a>  C_t &amp;\doteq R_t - A_t q_t A_t'</span>
<span id="cb32-213"><a href="#cb32-213" aria-hidden="true" tabindex="-1"></a>  \end{aligned}</span>
<span id="cb32-214"><a href="#cb32-214" aria-hidden="true" tabindex="-1"></a>$$ {#eq-posterior-distribution}</span>
<span id="cb32-215"><a href="#cb32-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-216"><a href="#cb32-216" aria-hidden="true" tabindex="-1"></a>@eq-derivation-for-a-t-and-R-t , @eq-derivation-for-f-t-and-q-t and @eq-posterior-distribution are often referred to as the <span class="co">[</span><span class="ot">Kalman filtering</span><span class="co">](https://en.wikipedia.org/wiki/Kalman_filter)</span> equations. </span>
<span id="cb32-217"><a href="#cb32-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-218"><a href="#cb32-218" aria-hidden="true" tabindex="-1"></a>::: {.callout-note collapse="true"}</span>
<span id="cb32-219"><a href="#cb32-219" aria-hidden="true" tabindex="-1"></a><span class="fu">## Video Transcript</span></span>
<span id="cb32-220"><a href="#cb32-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-221"><a href="#cb32-221" aria-hidden="true" tabindex="-1"></a>{{&lt; include _C4-L03-T05.qmd &gt;}}</span>
<span id="cb32-222"><a href="#cb32-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-223"><a href="#cb32-223" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb32-224"><a href="#cb32-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-225"><a href="#cb32-225" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary of filtering distributions  :spiral_notepad: </span></span>
<span id="cb32-226"><a href="#cb32-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-227"><a href="#cb32-227" aria-hidden="true" tabindex="-1"></a><span class="fu">### Bayesian Inference in NDLM: Known Variances</span></span>
<span id="cb32-228"><a href="#cb32-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-229"><a href="#cb32-229" aria-hidden="true" tabindex="-1"></a>Consider an NDLM given by:</span>
<span id="cb32-230"><a href="#cb32-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-231"><a href="#cb32-231" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-232"><a href="#cb32-232" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb32-233"><a href="#cb32-233" aria-hidden="true" tabindex="-1"></a>y_t &amp;= F_t' \theta_t + \nu_t, \quad \nu_t \sim  \mathcal{N}(0, v_t), <span class="sc">\\</span></span>
<span id="cb32-234"><a href="#cb32-234" aria-hidden="true" tabindex="-1"></a>\theta_t &amp;= G_t \theta_{t-1} + \omega_t, \quad \omega_t \sim  \mathcal{N}(0, W_t), </span>
<span id="cb32-235"><a href="#cb32-235" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb32-236"><a href="#cb32-236" aria-hidden="true" tabindex="-1"></a>$$ {#eq-generic-NDLM}</span>
<span id="cb32-237"><a href="#cb32-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-238"><a href="#cb32-238" aria-hidden="true" tabindex="-1"></a>with $F_t$, $G_t$, $v_t$, and $W_t$ known. We also assume a prior distribution of the form $(\theta_0 \mid \mathcal{D}_0) \sim  \mathcal{N}(m_0, C_0)$, with $m_0$, $C_0$ known.</span>
<span id="cb32-239"><a href="#cb32-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-240"><a href="#cb32-240" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Filtering</span></span>
<span id="cb32-241"><a href="#cb32-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-242"><a href="#cb32-242" aria-hidden="true" tabindex="-1"></a>We are interested in finding $\mathbb{P}r(\theta_t \mid \mathcal{D}_t)$ for all $t$. Assume that the posterior at $t-1$ is such that:</span>
<span id="cb32-243"><a href="#cb32-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-244"><a href="#cb32-244" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-245"><a href="#cb32-245" aria-hidden="true" tabindex="-1"></a>(\theta_{t-1} \mid \mathcal{D}_{t-1}) \sim  \mathcal{N}(m_{t-1}, C_{t-1}).</span>
<span id="cb32-246"><a href="#cb32-246" aria-hidden="true" tabindex="-1"></a>$$ {#eq-filtering}</span>
<span id="cb32-247"><a href="#cb32-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-248"><a href="#cb32-248" aria-hidden="true" tabindex="-1"></a>Then, we can obtain the following:</span>
<span id="cb32-249"><a href="#cb32-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-250"><a href="#cb32-250" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Prior at Time $t$</span>
<span id="cb32-251"><a href="#cb32-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-252"><a href="#cb32-252" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-253"><a href="#cb32-253" aria-hidden="true" tabindex="-1"></a>(\theta_t \mid \mathcal{D}_{t-1}) \sim  \mathcal{N}(a_t, R_t),</span>
<span id="cb32-254"><a href="#cb32-254" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-255"><a href="#cb32-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-256"><a href="#cb32-256" aria-hidden="true" tabindex="-1"></a>with</span>
<span id="cb32-257"><a href="#cb32-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-258"><a href="#cb32-258" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-259"><a href="#cb32-259" aria-hidden="true" tabindex="-1"></a>a_t = G_t m_{t-1} \qquad R_t = G_t C_{t-1} G_t' + W_t.</span>
<span id="cb32-260"><a href="#cb32-260" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-261"><a href="#cb32-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-262"><a href="#cb32-262" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>One-Step Forecast</span>
<span id="cb32-263"><a href="#cb32-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-264"><a href="#cb32-264" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-265"><a href="#cb32-265" aria-hidden="true" tabindex="-1"></a>(y_t \mid D_{t-1}) \sim  \mathcal{N}(f_t, q_t),</span>
<span id="cb32-266"><a href="#cb32-266" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-267"><a href="#cb32-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-268"><a href="#cb32-268" aria-hidden="true" tabindex="-1"></a>with</span>
<span id="cb32-269"><a href="#cb32-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-270"><a href="#cb32-270" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-271"><a href="#cb32-271" aria-hidden="true" tabindex="-1"></a>f_t = F_t' a_t, \quad q_t = F_t' R_t F_t + v_t.</span>
<span id="cb32-272"><a href="#cb32-272" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-273"><a href="#cb32-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-274"><a href="#cb32-274" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Posterior at Time $t: (\theta_t \mid \mathcal{D}_t) \sim  \mathcal{N}(m_t, C_t)$ with</span>
<span id="cb32-275"><a href="#cb32-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-276"><a href="#cb32-276" aria-hidden="true" tabindex="-1"></a>$$\begin{aligned}</span>
<span id="cb32-277"><a href="#cb32-277" aria-hidden="true" tabindex="-1"></a>m_t &amp;= a_t + R_t F_t q_t^{-1} (y_t - f_t), <span class="sc">\\</span></span>
<span id="cb32-278"><a href="#cb32-278" aria-hidden="true" tabindex="-1"></a>C_t &amp;= R_t - R_t F_t q_t^{-1} F_t' R_t.</span>
<span id="cb32-279"><a href="#cb32-279" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb32-280"><a href="#cb32-280" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-281"><a href="#cb32-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-282"><a href="#cb32-282" aria-hidden="true" tabindex="-1"></a>Now, denoting $e_t = (y_t - f_t)$ and $A_t = R_t F_t q_t^{-1}$, we can rewrite the equations above as:</span>
<span id="cb32-283"><a href="#cb32-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-284"><a href="#cb32-284" aria-hidden="true" tabindex="-1"></a>$$\begin{aligned}</span>
<span id="cb32-285"><a href="#cb32-285" aria-hidden="true" tabindex="-1"></a>m_t &amp;= a_t + A_t e_t, <span class="sc">\\</span></span>
<span id="cb32-286"><a href="#cb32-286" aria-hidden="true" tabindex="-1"></a>C_t &amp;= R_t - A_t q_t A_t'</span>
<span id="cb32-287"><a href="#cb32-287" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb32-288"><a href="#cb32-288" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-289"><a href="#cb32-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-290"><a href="#cb32-290" aria-hidden="true" tabindex="-1"></a><span class="fu">## code Filtering in the NDLM: Example  :spiral_notepad:  $\mathcal{R}$</span></span>
<span id="cb32-291"><a href="#cb32-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-294"><a href="#cb32-294" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-295"><a href="#cb32-295" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: lst-filtering-in-the-NDLM</span></span>
<span id="cb32-296"><a href="#cb32-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-297"><a href="#cb32-297" aria-hidden="true" tabindex="-1"></a><span class="do">#################################################</span></span>
<span id="cb32-298"><a href="#cb32-298" aria-hidden="true" tabindex="-1"></a><span class="do">##### Univariate DLM: Known, constant variances</span></span>
<span id="cb32-299"><a href="#cb32-299" aria-hidden="true" tabindex="-1"></a><span class="do">#################################################</span></span>
<span id="cb32-300"><a href="#cb32-300" aria-hidden="true" tabindex="-1"></a>set_up_dlm_matrices <span class="ot">&lt;-</span> <span class="cf">function</span>(FF, GG, VV, WW){</span>
<span id="cb32-301"><a href="#cb32-301" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">FF=</span>FF, <span class="at">GG=</span>GG, <span class="at">VV=</span>VV, <span class="at">WW=</span>WW))</span>
<span id="cb32-302"><a href="#cb32-302" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-303"><a href="#cb32-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-304"><a href="#cb32-304" aria-hidden="true" tabindex="-1"></a>set_up_initial_states <span class="ot">&lt;-</span> <span class="cf">function</span>(m0, C0){</span>
<span id="cb32-305"><a href="#cb32-305" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">m0=</span>m0, <span class="at">C0=</span>C0))</span>
<span id="cb32-306"><a href="#cb32-306" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-307"><a href="#cb32-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-308"><a href="#cb32-308" aria-hidden="true" tabindex="-1"></a><span class="do">### forward update equations </span><span class="al">###</span></span>
<span id="cb32-309"><a href="#cb32-309" aria-hidden="true" tabindex="-1"></a>forward_filter <span class="ot">&lt;-</span> <span class="cf">function</span>(data, matrices, initial_states){</span>
<span id="cb32-310"><a href="#cb32-310" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve dataset</span></span>
<span id="cb32-311"><a href="#cb32-311" aria-hidden="true" tabindex="-1"></a>  y_t <span class="ot">&lt;-</span> data<span class="sc">$</span>y_t</span>
<span id="cb32-312"><a href="#cb32-312" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> <span class="fu">length</span>(y_t)</span>
<span id="cb32-313"><a href="#cb32-313" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-314"><a href="#cb32-314" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve a set of quadruples </span></span>
<span id="cb32-315"><a href="#cb32-315" aria-hidden="true" tabindex="-1"></a>  <span class="co"># FF, GG, VV, WW are scalar</span></span>
<span id="cb32-316"><a href="#cb32-316" aria-hidden="true" tabindex="-1"></a>  FF <span class="ot">&lt;-</span> matrices<span class="sc">$</span>FF  </span>
<span id="cb32-317"><a href="#cb32-317" aria-hidden="true" tabindex="-1"></a>  GG <span class="ot">&lt;-</span> matrices<span class="sc">$</span>GG</span>
<span id="cb32-318"><a href="#cb32-318" aria-hidden="true" tabindex="-1"></a>  VV <span class="ot">&lt;-</span> matrices<span class="sc">$</span>VV</span>
<span id="cb32-319"><a href="#cb32-319" aria-hidden="true" tabindex="-1"></a>  WW <span class="ot">&lt;-</span> matrices<span class="sc">$</span>WW</span>
<span id="cb32-320"><a href="#cb32-320" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-321"><a href="#cb32-321" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve initial states</span></span>
<span id="cb32-322"><a href="#cb32-322" aria-hidden="true" tabindex="-1"></a>  m0 <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>m0</span>
<span id="cb32-323"><a href="#cb32-323" aria-hidden="true" tabindex="-1"></a>  C0 <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>C0</span>
<span id="cb32-324"><a href="#cb32-324" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-325"><a href="#cb32-325" aria-hidden="true" tabindex="-1"></a>  <span class="do">## create placeholder for results</span></span>
<span id="cb32-326"><a href="#cb32-326" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">dim</span>(GG)[<span class="dv">1</span>]</span>
<span id="cb32-327"><a href="#cb32-327" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow=</span>T, <span class="at">ncol=</span>d)</span>
<span id="cb32-328"><a href="#cb32-328" aria-hidden="true" tabindex="-1"></a>  Rt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, T))</span>
<span id="cb32-329"><a href="#cb32-329" aria-hidden="true" tabindex="-1"></a>  ft <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb32-330"><a href="#cb32-330" aria-hidden="true" tabindex="-1"></a>  Qt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb32-331"><a href="#cb32-331" aria-hidden="true" tabindex="-1"></a>  mt <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow=</span>T, <span class="at">ncol=</span>d)</span>
<span id="cb32-332"><a href="#cb32-332" aria-hidden="true" tabindex="-1"></a>  Ct <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, T))</span>
<span id="cb32-333"><a href="#cb32-333" aria-hidden="true" tabindex="-1"></a>  et <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb32-334"><a href="#cb32-334" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-335"><a href="#cb32-335" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T){</span>
<span id="cb32-336"><a href="#cb32-336" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments of priors at t</span></span>
<span id="cb32-337"><a href="#cb32-337" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb32-338"><a href="#cb32-338" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> <span class="fu">t</span>(m0)</span>
<span id="cb32-339"><a href="#cb32-339" aria-hidden="true" tabindex="-1"></a>      Rt[, , i] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> C0 <span class="sc">%*%</span> <span class="fu">t</span>(GG) <span class="sc">+</span> WW</span>
<span id="cb32-340"><a href="#cb32-340" aria-hidden="true" tabindex="-1"></a>      Rt[, , i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[, , i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[, , i])</span>
<span id="cb32-341"><a href="#cb32-341" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb32-342"><a href="#cb32-342" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> <span class="fu">t</span>(mt[i<span class="dv">-1</span>, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb32-343"><a href="#cb32-343" aria-hidden="true" tabindex="-1"></a>      Rt[, , i] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> Ct[, , i<span class="dv">-1</span>] <span class="sc">%*%</span> <span class="fu">t</span>(GG) <span class="sc">+</span> WW</span>
<span id="cb32-344"><a href="#cb32-344" aria-hidden="true" tabindex="-1"></a>      Rt[, , i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[, , i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[, , i])</span>
<span id="cb32-345"><a href="#cb32-345" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb32-346"><a href="#cb32-346" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-347"><a href="#cb32-347" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments of one-step forecast:</span></span>
<span id="cb32-348"><a href="#cb32-348" aria-hidden="true" tabindex="-1"></a>    ft[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(FF) <span class="sc">%*%</span> (at[i, ]) </span>
<span id="cb32-349"><a href="#cb32-349" aria-hidden="true" tabindex="-1"></a>    Qt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(FF) <span class="sc">%*%</span> Rt[, , i] <span class="sc">%*%</span> FF <span class="sc">+</span> VV</span>
<span id="cb32-350"><a href="#cb32-350" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-351"><a href="#cb32-351" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments of posterior at t:</span></span>
<span id="cb32-352"><a href="#cb32-352" aria-hidden="true" tabindex="-1"></a>    At <span class="ot">&lt;-</span> Rt[, , i] <span class="sc">%*%</span> FF <span class="sc">/</span> Qt[i]</span>
<span id="cb32-353"><a href="#cb32-353" aria-hidden="true" tabindex="-1"></a>    et[i] <span class="ot">&lt;-</span> y_t[i] <span class="sc">-</span> ft[i]</span>
<span id="cb32-354"><a href="#cb32-354" aria-hidden="true" tabindex="-1"></a>    mt[i, ] <span class="ot">&lt;-</span> at[i, ] <span class="sc">+</span> <span class="fu">t</span>(At) <span class="sc">*</span> et[i]</span>
<span id="cb32-355"><a href="#cb32-355" aria-hidden="true" tabindex="-1"></a>    Ct[, , i] <span class="ot">&lt;-</span> Rt[, , i] <span class="sc">-</span> Qt[i] <span class="sc">*</span> At <span class="sc">%*%</span> <span class="fu">t</span>(At)</span>
<span id="cb32-356"><a href="#cb32-356" aria-hidden="true" tabindex="-1"></a>    Ct[, , i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Ct[, , i]<span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Ct[, , i])</span>
<span id="cb32-357"><a href="#cb32-357" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-358"><a href="#cb32-358" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Forward filtering is completed!"</span>) <span class="co"># indicator of completion</span></span>
<span id="cb32-359"><a href="#cb32-359" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mt =</span> mt, <span class="at">Ct =</span> Ct, <span class="at">at =</span> at, <span class="at">Rt =</span> </span>
<span id="cb32-360"><a href="#cb32-360" aria-hidden="true" tabindex="-1"></a>                Rt, <span class="at">ft =</span> ft, <span class="at">Qt =</span> Qt))</span>
<span id="cb32-361"><a href="#cb32-361" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-362"><a href="#cb32-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-363"><a href="#cb32-363" aria-hidden="true" tabindex="-1"></a>forecast_function <span class="ot">&lt;-</span> <span class="cf">function</span>(posterior_states, k, matrices){</span>
<span id="cb32-364"><a href="#cb32-364" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-365"><a href="#cb32-365" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb32-366"><a href="#cb32-366" aria-hidden="true" tabindex="-1"></a>  FF <span class="ot">&lt;-</span> matrices<span class="sc">$</span>FF</span>
<span id="cb32-367"><a href="#cb32-367" aria-hidden="true" tabindex="-1"></a>  GG <span class="ot">&lt;-</span> matrices<span class="sc">$</span>GG</span>
<span id="cb32-368"><a href="#cb32-368" aria-hidden="true" tabindex="-1"></a>  WW <span class="ot">&lt;-</span> matrices<span class="sc">$</span>WW</span>
<span id="cb32-369"><a href="#cb32-369" aria-hidden="true" tabindex="-1"></a>  VV <span class="ot">&lt;-</span> matrices<span class="sc">$</span>VV</span>
<span id="cb32-370"><a href="#cb32-370" aria-hidden="true" tabindex="-1"></a>  mt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>mt</span>
<span id="cb32-371"><a href="#cb32-371" aria-hidden="true" tabindex="-1"></a>  Ct <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>Ct</span>
<span id="cb32-372"><a href="#cb32-372" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-373"><a href="#cb32-373" aria-hidden="true" tabindex="-1"></a>  <span class="do">## set up matrices</span></span>
<span id="cb32-374"><a href="#cb32-374" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> <span class="fu">dim</span>(mt)[<span class="dv">1</span>] <span class="co"># time points</span></span>
<span id="cb32-375"><a href="#cb32-375" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">dim</span>(mt)[<span class="dv">2</span>] <span class="co"># dimension of state-space parameter vector</span></span>
<span id="cb32-376"><a href="#cb32-376" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-377"><a href="#cb32-377" aria-hidden="true" tabindex="-1"></a>  <span class="do">## placeholder for results</span></span>
<span id="cb32-378"><a href="#cb32-378" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> k, <span class="at">ncol =</span> d)</span>
<span id="cb32-379"><a href="#cb32-379" aria-hidden="true" tabindex="-1"></a>  Rt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, k))</span>
<span id="cb32-380"><a href="#cb32-380" aria-hidden="true" tabindex="-1"></a>  ft <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k)</span>
<span id="cb32-381"><a href="#cb32-381" aria-hidden="true" tabindex="-1"></a>  Qt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k)</span>
<span id="cb32-382"><a href="#cb32-382" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-383"><a href="#cb32-383" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-384"><a href="#cb32-384" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k){</span>
<span id="cb32-385"><a href="#cb32-385" aria-hidden="true" tabindex="-1"></a>    <span class="do">## moments of state distribution</span></span>
<span id="cb32-386"><a href="#cb32-386" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb32-387"><a href="#cb32-387" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> <span class="fu">t</span>(mt[T, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb32-388"><a href="#cb32-388" aria-hidden="true" tabindex="-1"></a>      Rt[, , i] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> Ct[, , T] <span class="sc">%*%</span> <span class="fu">t</span>(GG) <span class="sc">+</span> WW</span>
<span id="cb32-389"><a href="#cb32-389" aria-hidden="true" tabindex="-1"></a>      Rt[, , i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[, , i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[, , i])</span>
<span id="cb32-390"><a href="#cb32-390" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb32-391"><a href="#cb32-391" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> <span class="fu">t</span>(at[i<span class="dv">-1</span>, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb32-392"><a href="#cb32-392" aria-hidden="true" tabindex="-1"></a>      Rt[, , i] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> Rt[, , i<span class="dv">-1</span>] <span class="sc">%*%</span> <span class="fu">t</span>(GG) <span class="sc">+</span> WW</span>
<span id="cb32-393"><a href="#cb32-393" aria-hidden="true" tabindex="-1"></a>      Rt[, , i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[, , i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[, , i])</span>
<span id="cb32-394"><a href="#cb32-394" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb32-395"><a href="#cb32-395" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-396"><a href="#cb32-396" aria-hidden="true" tabindex="-1"></a>    <span class="do">## moments of forecast distribution</span></span>
<span id="cb32-397"><a href="#cb32-397" aria-hidden="true" tabindex="-1"></a>    ft[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(FF) <span class="sc">%*%</span> <span class="fu">t</span>(at[i, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb32-398"><a href="#cb32-398" aria-hidden="true" tabindex="-1"></a>    Qt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(FF) <span class="sc">%*%</span> Rt[, , i] <span class="sc">%*%</span> FF <span class="sc">+</span> VV</span>
<span id="cb32-399"><a href="#cb32-399" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-400"><a href="#cb32-400" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Forecasting is completed!"</span>) <span class="co"># indicator of completion</span></span>
<span id="cb32-401"><a href="#cb32-401" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">at=</span>at, <span class="at">Rt=</span>Rt, <span class="at">ft=</span>ft, <span class="at">Qt=</span>Qt))</span>
<span id="cb32-402"><a href="#cb32-402" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-403"><a href="#cb32-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-404"><a href="#cb32-404" aria-hidden="true" tabindex="-1"></a><span class="do">## obtain 95% credible interval</span></span>
<span id="cb32-405"><a href="#cb32-405" aria-hidden="true" tabindex="-1"></a>get_credible_interval <span class="ot">&lt;-</span> <span class="cf">function</span>(mu, sigma2, </span>
<span id="cb32-406"><a href="#cb32-406" aria-hidden="true" tabindex="-1"></a>                          <span class="at">quantile =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)){</span>
<span id="cb32-407"><a href="#cb32-407" aria-hidden="true" tabindex="-1"></a>  z_quantile <span class="ot">&lt;-</span> <span class="fu">qnorm</span>(quantile)</span>
<span id="cb32-408"><a href="#cb32-408" aria-hidden="true" tabindex="-1"></a>  bound <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span><span class="fu">length</span>(mu), <span class="at">ncol=</span><span class="dv">2</span>)</span>
<span id="cb32-409"><a href="#cb32-409" aria-hidden="true" tabindex="-1"></a>  bound[, <span class="dv">1</span>] <span class="ot">&lt;-</span> mu <span class="sc">+</span> </span>
<span id="cb32-410"><a href="#cb32-410" aria-hidden="true" tabindex="-1"></a>    z_quantile[<span class="dv">1</span>]<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(sigma2)) <span class="co"># lower bound</span></span>
<span id="cb32-411"><a href="#cb32-411" aria-hidden="true" tabindex="-1"></a>  bound[, <span class="dv">2</span>] <span class="ot">&lt;-</span> mu <span class="sc">+</span> </span>
<span id="cb32-412"><a href="#cb32-412" aria-hidden="true" tabindex="-1"></a>    z_quantile[<span class="dv">2</span>]<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(sigma2)) <span class="co"># upper bound</span></span>
<span id="cb32-413"><a href="#cb32-413" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(bound)</span>
<span id="cb32-414"><a href="#cb32-414" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-415"><a href="#cb32-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-416"><a href="#cb32-416" aria-hidden="true" tabindex="-1"></a><span class="do">####################### Example: Lake Huron Data ######################</span></span>
<span id="cb32-417"><a href="#cb32-417" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(LakeHuron,<span class="at">main=</span><span class="st">"Lake Huron Data"</span>,</span>
<span id="cb32-418"><a href="#cb32-418" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab=</span><span class="st">"level in feet"</span>) <span class="co"># Total of 98 observations </span></span>
<span id="cb32-419"><a href="#cb32-419" aria-hidden="true" tabindex="-1"></a>k<span class="ot">=</span><span class="dv">4</span></span>
<span id="cb32-420"><a href="#cb32-420" aria-hidden="true" tabindex="-1"></a>T<span class="ot">=</span><span class="fu">length</span>(LakeHuron)<span class="sc">-</span>k <span class="co"># We take the first 94 observations </span></span>
<span id="cb32-421"><a href="#cb32-421" aria-hidden="true" tabindex="-1"></a>                      <span class="co"># only as our data</span></span>
<span id="cb32-422"><a href="#cb32-422" aria-hidden="true" tabindex="-1"></a>ts_data<span class="ot">=</span>LakeHuron[<span class="dv">1</span><span class="sc">:</span>T]</span>
<span id="cb32-423"><a href="#cb32-423" aria-hidden="true" tabindex="-1"></a>ts_validation_data <span class="ot">&lt;-</span> LakeHuron[(T<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span><span class="dv">98</span>]</span>
<span id="cb32-424"><a href="#cb32-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-425"><a href="#cb32-425" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y_t =</span> ts_data)</span>
<span id="cb32-426"><a href="#cb32-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-427"><a href="#cb32-427" aria-hidden="true" tabindex="-1"></a><span class="co"># First order polynomial model </span></span>
<span id="cb32-428"><a href="#cb32-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-429"><a href="#cb32-429" aria-hidden="true" tabindex="-1"></a><span class="do">## set up the DLM matrices </span></span>
<span id="cb32-430"><a href="#cb32-430" aria-hidden="true" tabindex="-1"></a>FF <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">1</span>)</span>
<span id="cb32-431"><a href="#cb32-431" aria-hidden="true" tabindex="-1"></a>GG <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">1</span>)</span>
<span id="cb32-432"><a href="#cb32-432" aria-hidden="true" tabindex="-1"></a>VV <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">1</span>)</span>
<span id="cb32-433"><a href="#cb32-433" aria-hidden="true" tabindex="-1"></a>WW <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">1</span>)</span>
<span id="cb32-434"><a href="#cb32-434" aria-hidden="true" tabindex="-1"></a>m0 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">570</span>)</span>
<span id="cb32-435"><a href="#cb32-435" aria-hidden="true" tabindex="-1"></a>C0 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fl">1e4</span>)</span>
<span id="cb32-436"><a href="#cb32-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-437"><a href="#cb32-437" aria-hidden="true" tabindex="-1"></a><span class="do">## wrap up all matrices and initial values</span></span>
<span id="cb32-438"><a href="#cb32-438" aria-hidden="true" tabindex="-1"></a>matrices <span class="ot">&lt;-</span> <span class="fu">set_up_dlm_matrices</span>(FF, GG, VV, WW)</span>
<span id="cb32-439"><a href="#cb32-439" aria-hidden="true" tabindex="-1"></a>initial_states <span class="ot">&lt;-</span> <span class="fu">set_up_initial_states</span>(m0, C0)</span>
<span id="cb32-440"><a href="#cb32-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-441"><a href="#cb32-441" aria-hidden="true" tabindex="-1"></a><span class="do">## filtering</span></span>
<span id="cb32-442"><a href="#cb32-442" aria-hidden="true" tabindex="-1"></a>results_filtered <span class="ot">&lt;-</span> <span class="fu">forward_filter</span>(data, matrices, </span>
<span id="cb32-443"><a href="#cb32-443" aria-hidden="true" tabindex="-1"></a>                                   initial_states)</span>
<span id="cb32-444"><a href="#cb32-444" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(results_filtered)</span>
<span id="cb32-445"><a href="#cb32-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-446"><a href="#cb32-446" aria-hidden="true" tabindex="-1"></a>ci_filtered <span class="ot">&lt;-</span> <span class="fu">get_credible_interval</span>(results_filtered<span class="sc">$</span>mt, </span>
<span id="cb32-447"><a href="#cb32-447" aria-hidden="true" tabindex="-1"></a>                                     results_filtered<span class="sc">$</span>Ct)</span>
<span id="cb32-448"><a href="#cb32-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-449"><a href="#cb32-449" aria-hidden="true" tabindex="-1"></a><span class="do">## forecasting </span></span>
<span id="cb32-450"><a href="#cb32-450" aria-hidden="true" tabindex="-1"></a>results_forecast <span class="ot">&lt;-</span> <span class="fu">forecast_function</span>(results_filtered,k, </span>
<span id="cb32-451"><a href="#cb32-451" aria-hidden="true" tabindex="-1"></a>                                      matrices)</span>
<span id="cb32-452"><a href="#cb32-452" aria-hidden="true" tabindex="-1"></a>ci_forecast <span class="ot">&lt;-</span> <span class="fu">get_credible_interval</span>(results_forecast<span class="sc">$</span>ft, </span>
<span id="cb32-453"><a href="#cb32-453" aria-hidden="true" tabindex="-1"></a>                                     results_forecast<span class="sc">$</span>Qt)</span>
<span id="cb32-454"><a href="#cb32-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-455"><a href="#cb32-455" aria-hidden="true" tabindex="-1"></a>index<span class="ot">=</span><span class="fu">seq</span>(<span class="dv">1875</span>, <span class="dv">1972</span>, <span class="at">length.out =</span> <span class="fu">length</span>(LakeHuron))</span>
<span id="cb32-456"><a href="#cb32-456" aria-hidden="true" tabindex="-1"></a>index_filt<span class="ot">=</span>index[<span class="dv">1</span><span class="sc">:</span>T]</span>
<span id="cb32-457"><a href="#cb32-457" aria-hidden="true" tabindex="-1"></a>index_forecast<span class="ot">=</span>index[(T<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span><span class="dv">98</span>]</span>
<span id="cb32-458"><a href="#cb32-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-459"><a href="#cb32-459" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(index, LakeHuron, <span class="at">ylab =</span> <span class="st">"level"</span>, </span>
<span id="cb32-460"><a href="#cb32-460" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Lake Huron Level"</span>,<span class="at">type=</span><span class="st">'l'</span>,</span>
<span id="cb32-461"><a href="#cb32-461" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"time"</span>,<span class="at">lty=</span><span class="dv">3</span>,<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">574</span>,<span class="dv">584</span>))</span>
<span id="cb32-462"><a href="#cb32-462" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(index,LakeHuron,<span class="at">pch=</span><span class="dv">20</span>)</span>
<span id="cb32-463"><a href="#cb32-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-464"><a href="#cb32-464" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, results_filtered<span class="sc">$</span>mt, <span class="at">type=</span><span class="st">'l'</span>,</span>
<span id="cb32-465"><a href="#cb32-465" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'red'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb32-466"><a href="#cb32-466" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, ci_filtered[, <span class="dv">1</span>], <span class="at">type=</span><span class="st">'l'</span>, </span>
<span id="cb32-467"><a href="#cb32-467" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'red'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb32-468"><a href="#cb32-468" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, ci_filtered[, <span class="dv">2</span>], <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'red'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb32-469"><a href="#cb32-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-470"><a href="#cb32-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-471"><a href="#cb32-471" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_forecast, results_forecast<span class="sc">$</span>ft, <span class="at">type=</span><span class="st">'l'</span>,</span>
<span id="cb32-472"><a href="#cb32-472" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'green'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb32-473"><a href="#cb32-473" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_forecast, ci_forecast[, <span class="dv">1</span>], <span class="at">type=</span><span class="st">'l'</span>,</span>
<span id="cb32-474"><a href="#cb32-474" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'green'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb32-475"><a href="#cb32-475" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_forecast, ci_forecast[, <span class="dv">2</span>], <span class="at">type=</span><span class="st">'l'</span>,</span>
<span id="cb32-476"><a href="#cb32-476" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'green'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb32-477"><a href="#cb32-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-478"><a href="#cb32-478" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">'bottomleft'</span>, <span class="at">legend=</span><span class="fu">c</span>(<span class="st">"filtered"</span>,<span class="st">"forecast"</span>),</span>
<span id="cb32-479"><a href="#cb32-479" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"green"</span>), <span class="at">lty=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb32-480"><a href="#cb32-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-481"><a href="#cb32-481" aria-hidden="true" tabindex="-1"></a><span class="co">#Now consider a 100 times smaller signal to noise ratio </span></span>
<span id="cb32-482"><a href="#cb32-482" aria-hidden="true" tabindex="-1"></a>VV <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">1</span>)</span>
<span id="cb32-483"><a href="#cb32-483" aria-hidden="true" tabindex="-1"></a>WW <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fl">0.01</span>)</span>
<span id="cb32-484"><a href="#cb32-484" aria-hidden="true" tabindex="-1"></a>matrices_2 <span class="ot">&lt;-</span> <span class="fu">set_up_dlm_matrices</span>(FF,GG, VV, WW)</span>
<span id="cb32-485"><a href="#cb32-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-486"><a href="#cb32-486" aria-hidden="true" tabindex="-1"></a><span class="do">## filtering</span></span>
<span id="cb32-487"><a href="#cb32-487" aria-hidden="true" tabindex="-1"></a>results_filtered_2 <span class="ot">&lt;-</span> <span class="fu">forward_filter</span>(data, matrices_2, </span>
<span id="cb32-488"><a href="#cb32-488" aria-hidden="true" tabindex="-1"></a>                                     initial_states)</span>
<span id="cb32-489"><a href="#cb32-489" aria-hidden="true" tabindex="-1"></a>ci_filtered_2 <span class="ot">&lt;-</span> <span class="fu">get_credible_interval</span>(results_filtered_2<span class="sc">$</span>mt, </span>
<span id="cb32-490"><a href="#cb32-490" aria-hidden="true" tabindex="-1"></a>                                       results_filtered_2<span class="sc">$</span>Ct)</span>
<span id="cb32-491"><a href="#cb32-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-492"><a href="#cb32-492" aria-hidden="true" tabindex="-1"></a>results_forecast_2 <span class="ot">&lt;-</span> <span class="fu">forecast_function</span>(results_filtered_2, </span>
<span id="cb32-493"><a href="#cb32-493" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">length</span>(ts_validation_data), </span>
<span id="cb32-494"><a href="#cb32-494" aria-hidden="true" tabindex="-1"></a>                             matrices_2)</span>
<span id="cb32-495"><a href="#cb32-495" aria-hidden="true" tabindex="-1"></a>ci_forecast_2 <span class="ot">&lt;-</span> <span class="fu">get_credible_interval</span>(results_forecast_2<span class="sc">$</span>ft, </span>
<span id="cb32-496"><a href="#cb32-496" aria-hidden="true" tabindex="-1"></a>                                       results_forecast_2<span class="sc">$</span>Qt)</span>
<span id="cb32-497"><a href="#cb32-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-498"><a href="#cb32-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-499"><a href="#cb32-499" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(index, LakeHuron, <span class="at">ylab =</span> <span class="st">"level"</span>, </span>
<span id="cb32-500"><a href="#cb32-500" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Lake Huron Level"</span>,<span class="at">type=</span><span class="st">'l'</span>,</span>
<span id="cb32-501"><a href="#cb32-501" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"time"</span>,<span class="at">lty=</span><span class="dv">3</span>,<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">574</span>,<span class="dv">584</span>))</span>
<span id="cb32-502"><a href="#cb32-502" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(index,LakeHuron,<span class="at">pch=</span><span class="dv">20</span>)</span>
<span id="cb32-503"><a href="#cb32-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-504"><a href="#cb32-504" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, results_filtered_2<span class="sc">$</span>mt, <span class="at">type=</span><span class="st">'l'</span>, </span>
<span id="cb32-505"><a href="#cb32-505" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'magenta'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb32-506"><a href="#cb32-506" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, ci_filtered_2[, <span class="dv">1</span>], <span class="at">type=</span><span class="st">'l'</span>, </span>
<span id="cb32-507"><a href="#cb32-507" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'magenta'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb32-508"><a href="#cb32-508" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, ci_filtered_2[, <span class="dv">2</span>], <span class="at">type=</span><span class="st">'l'</span>, </span>
<span id="cb32-509"><a href="#cb32-509" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'magenta'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb32-510"><a href="#cb32-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-511"><a href="#cb32-511" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_forecast, results_forecast_2<span class="sc">$</span>ft, <span class="at">type=</span><span class="st">'l'</span>, </span>
<span id="cb32-512"><a href="#cb32-512" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'green'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb32-513"><a href="#cb32-513" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_forecast, ci_forecast_2[, <span class="dv">1</span>], <span class="at">type=</span><span class="st">'l'</span>, </span>
<span id="cb32-514"><a href="#cb32-514" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'green'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb32-515"><a href="#cb32-515" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_forecast, ci_forecast_2[, <span class="dv">2</span>], <span class="at">type=</span><span class="st">'l'</span>, </span>
<span id="cb32-516"><a href="#cb32-516" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'green'</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb32-517"><a href="#cb32-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-518"><a href="#cb32-518" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">'bottomleft'</span>, <span class="at">legend=</span><span class="fu">c</span>(<span class="st">"filtered"</span>,<span class="st">"forecast"</span>),</span>
<span id="cb32-519"><a href="#cb32-519" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"magenta"</span>, <span class="st">"green"</span>), <span class="at">lty=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb32-520"><a href="#cb32-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-521"><a href="#cb32-521" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(index_filt,results_filtered<span class="sc">$</span>mt,<span class="at">type=</span><span class="st">'l'</span>,<span class="at">col=</span><span class="st">'red'</span>,<span class="at">lwd=</span><span class="dv">2</span>,</span>
<span id="cb32-522"><a href="#cb32-522" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">574</span>,<span class="dv">584</span>),<span class="at">ylab=</span><span class="st">"level"</span>)</span>
<span id="cb32-523"><a href="#cb32-523" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt,results_filtered_2<span class="sc">$</span>mt,<span class="at">col=</span><span class="st">'magenta'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb32-524"><a href="#cb32-524" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(index,LakeHuron,<span class="at">pch=</span><span class="dv">20</span>)</span>
<span id="cb32-525"><a href="#cb32-525" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index,LakeHuron,<span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb32-526"><a href="#cb32-526" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-527"><a href="#cb32-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-528"><a href="#cb32-528" aria-hidden="true" tabindex="-1"></a><span class="fu">## Smoothing and forecasting  :movie_camera: </span></span>
<span id="cb32-529"><a href="#cb32-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-530"><a href="#cb32-530" aria-hidden="true" tabindex="-1"></a><span class="al">![Smoothing](images/m3_0051.png)</span>{#fig-smoothing .column-margin group="slides" width="53mm"}</span>
<span id="cb32-531"><a href="#cb32-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-532"><a href="#cb32-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-533"><a href="#cb32-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-534"><a href="#cb32-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-535"><a href="#cb32-535" aria-hidden="true" tabindex="-1"></a><span class="al">![Forecasting](images/m3_0052.png)</span>{#fig-forecasting .column-margin group="slides" width="53mm"}</span>
<span id="cb32-536"><a href="#cb32-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-537"><a href="#cb32-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-538"><a href="#cb32-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-539"><a href="#cb32-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-540"><a href="#cb32-540" aria-hidden="true" tabindex="-1"></a>We now discuss the **smoothing equations** for the case of the NDLM, where we are assuming that the variance at the *observation level* $\nu_t$ and the covariance matrix at the *system level* $\mathbf{W}_t$ are both known.</span>
<span id="cb32-541"><a href="#cb32-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-542"><a href="#cb32-542" aria-hidden="true" tabindex="-1"></a>$$ \begin{aligned}</span>
<span id="cb32-543"><a href="#cb32-543" aria-hidden="true" tabindex="-1"></a>y_t &amp;= \mathbf{F}_t' \mathbf{\theta}_t + \nu_t, &amp;\nu_t &amp;\sim \mathcal{N} (0, v_t), &amp; \text{(observation)} <span class="sc">\\</span></span>
<span id="cb32-544"><a href="#cb32-544" aria-hidden="true" tabindex="-1"></a>\mathbf{\theta}_t &amp; = \mathbf{G}_t \mathbf{\theta}_{t-1} + \mathbf{\omega}_t, &amp;\mathbf{\omega}_t &amp; \sim \mathcal{N} (0, \mathbf{W}_t), &amp; \text{(evolution)} <span class="sc">\\</span></span>
<span id="cb32-545"><a href="#cb32-545" aria-hidden="true" tabindex="-1"></a>&amp;<span class="sc">\{</span> \mathbf{F}_t, \mathbf{G}_t, v_t, \mathbf{W}_t <span class="sc">\}</span>  &amp;(\mathbf{\omega}_0 \mid \mathcal{D}_0) &amp; \sim \mathcal{N}(\mathbf{m}_0, \mathbf{C}_0) &amp; \text{(prior)}</span>
<span id="cb32-546"><a href="#cb32-546" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb32-547"><a href="#cb32-547" aria-hidden="true" tabindex="-1"></a>$$ {#eq-inference-NDLM}</span>
<span id="cb32-548"><a href="#cb32-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-549"><a href="#cb32-549" aria-hidden="true" tabindex="-1"></a>with $F_t$, $G_t$, $v_t$, $W_t$, $m_0$ and $C_0$ known.</span>
<span id="cb32-550"><a href="#cb32-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-551"><a href="#cb32-551" aria-hidden="true" tabindex="-1"></a>We have discussed the filtering equations, i.e. the process for obtaining the distributions of $\theta_t \mid \mathcal{D}_t$, as we collect observations over time, called filtering. </span>
<span id="cb32-552"><a href="#cb32-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-553"><a href="#cb32-553" aria-hidden="true" tabindex="-1"></a>We do this by updating the distribution of $\theta_t$ given the data we have collected step by step, as we move forward in time - updating the from the prior distribution.</span>
<span id="cb32-554"><a href="#cb32-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-555"><a href="#cb32-555" aria-hidden="true" tabindex="-1"></a>Now we will discuss what happens when we do smoothing, meaning when we revisit the distributions of $\theta_t$, given now that we have received a set of observations.</span>
<span id="cb32-556"><a href="#cb32-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-557"><a href="#cb32-557" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Smoothing</span></span>
<span id="cb32-558"><a href="#cb32-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-559"><a href="#cb32-559" aria-hidden="true" tabindex="-1"></a>For $t &lt; T$, we have that:</span>
<span id="cb32-560"><a href="#cb32-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-561"><a href="#cb32-561" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-562"><a href="#cb32-562" aria-hidden="true" tabindex="-1"></a>(\theta_t \mid D_T) \sim  \mathcal{N}(a_T(t - T), R_T(t - T)),</span>
<span id="cb32-563"><a href="#cb32-563" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-564"><a href="#cb32-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-565"><a href="#cb32-565" aria-hidden="true" tabindex="-1"></a>where</span>
<span id="cb32-566"><a href="#cb32-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-567"><a href="#cb32-567" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-568"><a href="#cb32-568" aria-hidden="true" tabindex="-1"></a>a_T(t - T) = m_t - B_t <span class="co">[</span><span class="ot">a_{t+1} - a_T(t - T + 1)</span><span class="co">]</span>,</span>
<span id="cb32-569"><a href="#cb32-569" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-570"><a href="#cb32-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-571"><a href="#cb32-571" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-572"><a href="#cb32-572" aria-hidden="true" tabindex="-1"></a>R_T(t - T) = C_t - B_t <span class="co">[</span><span class="ot">R_{t+1} - R_T(t - T + 1)</span><span class="co">]</span> B_t',</span>
<span id="cb32-573"><a href="#cb32-573" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-574"><a href="#cb32-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-575"><a href="#cb32-575" aria-hidden="true" tabindex="-1"></a>for $t = (T - 1), (T - 2), \dots, 0$, with $B_t = C_t G_t' R_{t+1}^{-1}$, and $a_T(0) = m_T$, $R_T(0) = C_T$. Here $a_t$, $m_t$, $R_t$, and $C_t$ are obtained using the filtering equations as explained before.</span>
<span id="cb32-576"><a href="#cb32-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-577"><a href="#cb32-577" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Forecasting</span></span>
<span id="cb32-578"><a href="#cb32-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-579"><a href="#cb32-579" aria-hidden="true" tabindex="-1"></a>For $h \geq 0$, it is possible to show that:</span>
<span id="cb32-580"><a href="#cb32-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-581"><a href="#cb32-581" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-582"><a href="#cb32-582" aria-hidden="true" tabindex="-1"></a>(\theta_{t+h} \mid D_t) \sim  \mathcal{N}(a_t(h), R_t(h)),</span>
<span id="cb32-583"><a href="#cb32-583" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-584"><a href="#cb32-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-585"><a href="#cb32-585" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-586"><a href="#cb32-586" aria-hidden="true" tabindex="-1"></a>(y_{t+h} \mid D_t) \sim  \mathcal{N}(f_t(h), q_t(h)),</span>
<span id="cb32-587"><a href="#cb32-587" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-588"><a href="#cb32-588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-589"><a href="#cb32-589" aria-hidden="true" tabindex="-1"></a>with</span>
<span id="cb32-590"><a href="#cb32-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-591"><a href="#cb32-591" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-592"><a href="#cb32-592" aria-hidden="true" tabindex="-1"></a>a_t(h) = G_{t+h} a_t(h - 1),</span>
<span id="cb32-593"><a href="#cb32-593" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-594"><a href="#cb32-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-595"><a href="#cb32-595" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-596"><a href="#cb32-596" aria-hidden="true" tabindex="-1"></a>R_t(h) = G_{t+h} R_t(h - 1) G_{t+h}' + W_{t+h},</span>
<span id="cb32-597"><a href="#cb32-597" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-598"><a href="#cb32-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-599"><a href="#cb32-599" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-600"><a href="#cb32-600" aria-hidden="true" tabindex="-1"></a>f_t(h) = F_{t+h}' a_t(h),</span>
<span id="cb32-601"><a href="#cb32-601" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-602"><a href="#cb32-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-603"><a href="#cb32-603" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-604"><a href="#cb32-604" aria-hidden="true" tabindex="-1"></a>q_t(h) = F_{t+h}' R_t(h) F_{t+h} + v_{t+h},</span>
<span id="cb32-605"><a href="#cb32-605" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-606"><a href="#cb32-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-607"><a href="#cb32-607" aria-hidden="true" tabindex="-1"></a>and</span>
<span id="cb32-608"><a href="#cb32-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-609"><a href="#cb32-609" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-610"><a href="#cb32-610" aria-hidden="true" tabindex="-1"></a>a_t(0) = m_t, \quad R_t(0) = C_t.</span>
<span id="cb32-611"><a href="#cb32-611" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-612"><a href="#cb32-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-613"><a href="#cb32-613" aria-hidden="true" tabindex="-1"></a>::: {.callout-note collapse="true"}</span>
<span id="cb32-614"><a href="#cb32-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-615"><a href="#cb32-615" aria-hidden="true" tabindex="-1"></a><span class="fu">## Video Transcript</span></span>
<span id="cb32-616"><a href="#cb32-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-617"><a href="#cb32-617" aria-hidden="true" tabindex="-1"></a>{{&lt; include _C4-L03-T06.qmd &gt;}}</span>
<span id="cb32-618"><a href="#cb32-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-619"><a href="#cb32-619" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb32-620"><a href="#cb32-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-621"><a href="#cb32-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-622"><a href="#cb32-622" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary of the smoothing and forecasting distributions  :spiral_notepad: </span></span>
<span id="cb32-623"><a href="#cb32-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-624"><a href="#cb32-624" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- start --&gt;</span></span>
<span id="cb32-625"><a href="#cb32-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-626"><a href="#cb32-626" aria-hidden="true" tabindex="-1"></a><span class="fu">### Bayesian Inference in NDLM: Known Variances {#sec-inference-NDLM}</span></span>
<span id="cb32-627"><a href="#cb32-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-628"><a href="#cb32-628" aria-hidden="true" tabindex="-1"></a>Consider the NDLM given by:</span>
<span id="cb32-629"><a href="#cb32-629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-630"><a href="#cb32-630" aria-hidden="true" tabindex="-1"></a>$$ \begin{aligned}</span>
<span id="cb32-631"><a href="#cb32-631" aria-hidden="true" tabindex="-1"></a>y_t &amp;= \mathbf{F}_t' \mathbf{\theta}_t + \nu_t, &amp;\nu_t &amp;\sim \mathcal{N} (0, v_t), <span class="sc">\\</span></span>
<span id="cb32-632"><a href="#cb32-632" aria-hidden="true" tabindex="-1"></a>\mathbf{\theta}_t &amp;= \mathbf{G}_t \mathbf{\theta}_{t-1} + \mathbf{\omega}_t, &amp;\mathbf{\omega}_t &amp;\sim \mathcal{N} (0, \mathbf{W}_t), <span class="sc">\\</span></span>
<span id="cb32-633"><a href="#cb32-633" aria-hidden="true" tabindex="-1"></a>&amp;<span class="sc">\{</span> \mathbf{F}_t, \mathbf{G}_t, v_t, \mathbf{W}_t <span class="sc">\}</span>  &amp;(\mathbf{\omega}_0 \mid \mathcal{D}_0) &amp;\sim  \mathcal{N}(\mathbf{m}_0, \mathbf{C}_0)</span>
<span id="cb32-634"><a href="#cb32-634" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb32-635"><a href="#cb32-635" aria-hidden="true" tabindex="-1"></a>$$ {#eq-inference-NDLM}</span>
<span id="cb32-636"><a href="#cb32-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-637"><a href="#cb32-637" aria-hidden="true" tabindex="-1"></a>with $F_t$, $G_t$, $v_t$, and $W_t$ known. </span>
<span id="cb32-638"><a href="#cb32-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-639"><a href="#cb32-639" aria-hidden="true" tabindex="-1"></a>We also assume a prior distribution of the form </span>
<span id="cb32-640"><a href="#cb32-640" aria-hidden="true" tabindex="-1"></a>$(\theta_0 \mid D_0) \sim  \mathcal{N}(m_0, C_0)$, with $m_0$ and $C_0$ known.</span>
<span id="cb32-641"><a href="#cb32-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-642"><a href="#cb32-642" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Smoothing</span></span>
<span id="cb32-643"><a href="#cb32-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-644"><a href="#cb32-644" aria-hidden="true" tabindex="-1"></a>For $t &lt; T$, we have that:</span>
<span id="cb32-645"><a href="#cb32-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-646"><a href="#cb32-646" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-647"><a href="#cb32-647" aria-hidden="true" tabindex="-1"></a>(\theta_t \mid D_T) \sim  \mathcal{N}(a_T(t - T), R_T(t - T)),</span>
<span id="cb32-648"><a href="#cb32-648" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-649"><a href="#cb32-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-650"><a href="#cb32-650" aria-hidden="true" tabindex="-1"></a>where</span>
<span id="cb32-651"><a href="#cb32-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-652"><a href="#cb32-652" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-653"><a href="#cb32-653" aria-hidden="true" tabindex="-1"></a>a_T(t - T) = m_t - B_t <span class="co">[</span><span class="ot">a_{t+1} - a_T(t - T + 1)</span><span class="co">]</span>,</span>
<span id="cb32-654"><a href="#cb32-654" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-655"><a href="#cb32-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-656"><a href="#cb32-656" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-657"><a href="#cb32-657" aria-hidden="true" tabindex="-1"></a>R_T(t - T) = C_t - B_t <span class="co">[</span><span class="ot">R_{t+1} - R_T(t - T + 1)</span><span class="co">]</span> B_t',</span>
<span id="cb32-658"><a href="#cb32-658" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-659"><a href="#cb32-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-660"><a href="#cb32-660" aria-hidden="true" tabindex="-1"></a>for $t = (T - 1), (T - 2), \dots, 0$, with $B_t = C_t G_t' R_{t+1}^{-1}$, and $a_T(0) = m_T$, $R_T(0) = C_T$. Here $a_t$, $m_t$, $R_t$, and $C_t$ are obtained using the filtering equations as explained before.</span>
<span id="cb32-661"><a href="#cb32-661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-662"><a href="#cb32-662" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Forecasting</span></span>
<span id="cb32-663"><a href="#cb32-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-664"><a href="#cb32-664" aria-hidden="true" tabindex="-1"></a>For $h \geq 0$, it is possible to show that:</span>
<span id="cb32-665"><a href="#cb32-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-666"><a href="#cb32-666" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-667"><a href="#cb32-667" aria-hidden="true" tabindex="-1"></a>(\theta_{t+h} \mid D_t) \sim  \mathcal{N}(a_t(h), R_t(h)),</span>
<span id="cb32-668"><a href="#cb32-668" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-669"><a href="#cb32-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-670"><a href="#cb32-670" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-671"><a href="#cb32-671" aria-hidden="true" tabindex="-1"></a>(y_{t+h} \mid D_t) \sim  \mathcal{N}(f_t(h), q_t(h)),</span>
<span id="cb32-672"><a href="#cb32-672" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-673"><a href="#cb32-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-674"><a href="#cb32-674" aria-hidden="true" tabindex="-1"></a>with</span>
<span id="cb32-675"><a href="#cb32-675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-676"><a href="#cb32-676" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-677"><a href="#cb32-677" aria-hidden="true" tabindex="-1"></a>a_t(h) = G_{t+h} a_t(h - 1),</span>
<span id="cb32-678"><a href="#cb32-678" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-679"><a href="#cb32-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-680"><a href="#cb32-680" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-681"><a href="#cb32-681" aria-hidden="true" tabindex="-1"></a>R_t(h) = G_{t+h} R_t(h - 1) G_{t+h}' + W_{t+h},</span>
<span id="cb32-682"><a href="#cb32-682" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-683"><a href="#cb32-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-684"><a href="#cb32-684" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-685"><a href="#cb32-685" aria-hidden="true" tabindex="-1"></a>f_t(h) = F_{t+h}' a_t(h),</span>
<span id="cb32-686"><a href="#cb32-686" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-687"><a href="#cb32-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-688"><a href="#cb32-688" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-689"><a href="#cb32-689" aria-hidden="true" tabindex="-1"></a>q_t(h) = F_{t+h}' R_t(h) F_{t+h} + v_{t+h},</span>
<span id="cb32-690"><a href="#cb32-690" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-691"><a href="#cb32-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-692"><a href="#cb32-692" aria-hidden="true" tabindex="-1"></a>and</span>
<span id="cb32-693"><a href="#cb32-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-694"><a href="#cb32-694" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-695"><a href="#cb32-695" aria-hidden="true" tabindex="-1"></a>a_t(0) = m_t, \quad R_t(0) = C_t.</span>
<span id="cb32-696"><a href="#cb32-696" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-697"><a href="#cb32-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-698"><a href="#cb32-698" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- end --&gt;</span></span>
<span id="cb32-699"><a href="#cb32-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-700"><a href="#cb32-700" aria-hidden="true" tabindex="-1"></a><span class="fu">## Smoothing in the NDLM, Example  :movie_camera: </span></span>
<span id="cb32-701"><a href="#cb32-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-702"><a href="#cb32-702" aria-hidden="true" tabindex="-1"></a>This segment covers the code  in the following section</span>
<span id="cb32-703"><a href="#cb32-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-704"><a href="#cb32-704" aria-hidden="true" tabindex="-1"></a><span class="fu">## Code: Smoothing in the NDLM, Example  :spiral_notepad:  $\mathcal{R}$ {#sec-smoothing-in-the-NDLM}</span></span>
<span id="cb32-705"><a href="#cb32-705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-708"><a href="#cb32-708" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-709"><a href="#cb32-709" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: lst-smoothing-in-the-NDLM</span></span>
<span id="cb32-710"><a href="#cb32-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-711"><a href="#cb32-711" aria-hidden="true" tabindex="-1"></a><span class="do">#################################################</span></span>
<span id="cb32-712"><a href="#cb32-712" aria-hidden="true" tabindex="-1"></a><span class="do">##### Univariate DLM: Known, constant variances</span></span>
<span id="cb32-713"><a href="#cb32-713" aria-hidden="true" tabindex="-1"></a><span class="do">#################################################</span></span>
<span id="cb32-714"><a href="#cb32-714" aria-hidden="true" tabindex="-1"></a>set_up_dlm_matrices <span class="ot">&lt;-</span> <span class="cf">function</span>(FF, GG, VV, WW){</span>
<span id="cb32-715"><a href="#cb32-715" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">FF=</span>FF, <span class="at">GG=</span>GG, <span class="at">VV=</span>VV, <span class="at">WW=</span>WW))</span>
<span id="cb32-716"><a href="#cb32-716" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-717"><a href="#cb32-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-718"><a href="#cb32-718" aria-hidden="true" tabindex="-1"></a>set_up_initial_states <span class="ot">&lt;-</span> <span class="cf">function</span>(m0, C0){</span>
<span id="cb32-719"><a href="#cb32-719" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">m0=</span>m0, <span class="at">C0=</span>C0))</span>
<span id="cb32-720"><a href="#cb32-720" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-721"><a href="#cb32-721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-722"><a href="#cb32-722" aria-hidden="true" tabindex="-1"></a><span class="do">### forward update equations </span><span class="al">###</span></span>
<span id="cb32-723"><a href="#cb32-723" aria-hidden="true" tabindex="-1"></a>forward_filter <span class="ot">&lt;-</span> <span class="cf">function</span>(data, matrices, initial_states){</span>
<span id="cb32-724"><a href="#cb32-724" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve dataset</span></span>
<span id="cb32-725"><a href="#cb32-725" aria-hidden="true" tabindex="-1"></a>  y_t <span class="ot">&lt;-</span> data<span class="sc">$</span>y_t</span>
<span id="cb32-726"><a href="#cb32-726" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> <span class="fu">length</span>(y_t)</span>
<span id="cb32-727"><a href="#cb32-727" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-728"><a href="#cb32-728" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve a set of quadruples </span></span>
<span id="cb32-729"><a href="#cb32-729" aria-hidden="true" tabindex="-1"></a>  <span class="co"># FF, GG, VV, WW are scalar</span></span>
<span id="cb32-730"><a href="#cb32-730" aria-hidden="true" tabindex="-1"></a>  FF <span class="ot">&lt;-</span> matrices<span class="sc">$</span>FF  </span>
<span id="cb32-731"><a href="#cb32-731" aria-hidden="true" tabindex="-1"></a>  GG <span class="ot">&lt;-</span> matrices<span class="sc">$</span>GG</span>
<span id="cb32-732"><a href="#cb32-732" aria-hidden="true" tabindex="-1"></a>  VV <span class="ot">&lt;-</span> matrices<span class="sc">$</span>VV</span>
<span id="cb32-733"><a href="#cb32-733" aria-hidden="true" tabindex="-1"></a>  WW <span class="ot">&lt;-</span> matrices<span class="sc">$</span>WW</span>
<span id="cb32-734"><a href="#cb32-734" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-735"><a href="#cb32-735" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve initial states</span></span>
<span id="cb32-736"><a href="#cb32-736" aria-hidden="true" tabindex="-1"></a>  m0 <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>m0</span>
<span id="cb32-737"><a href="#cb32-737" aria-hidden="true" tabindex="-1"></a>  C0 <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>C0</span>
<span id="cb32-738"><a href="#cb32-738" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-739"><a href="#cb32-739" aria-hidden="true" tabindex="-1"></a>  <span class="do">## create placeholder for results</span></span>
<span id="cb32-740"><a href="#cb32-740" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">dim</span>(GG)[<span class="dv">1</span>]</span>
<span id="cb32-741"><a href="#cb32-741" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow=</span>T, <span class="at">ncol=</span>d)</span>
<span id="cb32-742"><a href="#cb32-742" aria-hidden="true" tabindex="-1"></a>  Rt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, T))</span>
<span id="cb32-743"><a href="#cb32-743" aria-hidden="true" tabindex="-1"></a>  ft <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb32-744"><a href="#cb32-744" aria-hidden="true" tabindex="-1"></a>  Qt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb32-745"><a href="#cb32-745" aria-hidden="true" tabindex="-1"></a>  mt <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow=</span>T, <span class="at">ncol=</span>d)</span>
<span id="cb32-746"><a href="#cb32-746" aria-hidden="true" tabindex="-1"></a>  Ct <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, T))</span>
<span id="cb32-747"><a href="#cb32-747" aria-hidden="true" tabindex="-1"></a>  et <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb32-748"><a href="#cb32-748" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-749"><a href="#cb32-749" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-750"><a href="#cb32-750" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T){</span>
<span id="cb32-751"><a href="#cb32-751" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments of priors at t</span></span>
<span id="cb32-752"><a href="#cb32-752" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb32-753"><a href="#cb32-753" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> <span class="fu">t</span>(m0)</span>
<span id="cb32-754"><a href="#cb32-754" aria-hidden="true" tabindex="-1"></a>      Rt[, , i] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> C0 <span class="sc">%*%</span> <span class="fu">t</span>(GG) <span class="sc">+</span> WW</span>
<span id="cb32-755"><a href="#cb32-755" aria-hidden="true" tabindex="-1"></a>      Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i]) </span>
<span id="cb32-756"><a href="#cb32-756" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb32-757"><a href="#cb32-757" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> <span class="fu">t</span>(mt[i<span class="dv">-1</span>, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb32-758"><a href="#cb32-758" aria-hidden="true" tabindex="-1"></a>      Rt[, , i] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> Ct[, , i<span class="dv">-1</span>] <span class="sc">%*%</span> <span class="fu">t</span>(GG) <span class="sc">+</span> WW</span>
<span id="cb32-759"><a href="#cb32-759" aria-hidden="true" tabindex="-1"></a>      Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i]) </span>
<span id="cb32-760"><a href="#cb32-760" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb32-761"><a href="#cb32-761" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-762"><a href="#cb32-762" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments of one-step forecast:</span></span>
<span id="cb32-763"><a href="#cb32-763" aria-hidden="true" tabindex="-1"></a>    ft[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(FF) <span class="sc">%*%</span> (at[i, ]) </span>
<span id="cb32-764"><a href="#cb32-764" aria-hidden="true" tabindex="-1"></a>    Qt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(FF) <span class="sc">%*%</span> Rt[, , i] <span class="sc">%*%</span> FF <span class="sc">+</span> VV</span>
<span id="cb32-765"><a href="#cb32-765" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-766"><a href="#cb32-766" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments of posterior at t:</span></span>
<span id="cb32-767"><a href="#cb32-767" aria-hidden="true" tabindex="-1"></a>    At <span class="ot">&lt;-</span> Rt[, , i] <span class="sc">%*%</span> FF <span class="sc">/</span> Qt[i]</span>
<span id="cb32-768"><a href="#cb32-768" aria-hidden="true" tabindex="-1"></a>    et[i] <span class="ot">&lt;-</span> y_t[i] <span class="sc">-</span> ft[i]</span>
<span id="cb32-769"><a href="#cb32-769" aria-hidden="true" tabindex="-1"></a>    mt[i, ] <span class="ot">&lt;-</span> at[i, ] <span class="sc">+</span> <span class="fu">t</span>(At) <span class="sc">*</span> et[i]</span>
<span id="cb32-770"><a href="#cb32-770" aria-hidden="true" tabindex="-1"></a>    Ct[, , i] <span class="ot">&lt;-</span> Rt[, , i] <span class="sc">-</span> Qt[i] <span class="sc">*</span> At <span class="sc">%*%</span> <span class="fu">t</span>(At)</span>
<span id="cb32-771"><a href="#cb32-771" aria-hidden="true" tabindex="-1"></a>    Ct[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Ct[,,i] <span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Ct[,,i]) </span>
<span id="cb32-772"><a href="#cb32-772" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-773"><a href="#cb32-773" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Forward filtering is completed!"</span>) <span class="co"># indicator of completion</span></span>
<span id="cb32-774"><a href="#cb32-774" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mt =</span> mt, <span class="at">Ct =</span> Ct, <span class="at">at =</span> at, <span class="at">Rt =</span> Rt, </span>
<span id="cb32-775"><a href="#cb32-775" aria-hidden="true" tabindex="-1"></a>              <span class="at">ft =</span> ft, <span class="at">Qt =</span> Qt))</span>
<span id="cb32-776"><a href="#cb32-776" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-777"><a href="#cb32-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-778"><a href="#cb32-778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-779"><a href="#cb32-779" aria-hidden="true" tabindex="-1"></a>forecast_function <span class="ot">&lt;-</span> <span class="cf">function</span>(posterior_states, k, matrices){</span>
<span id="cb32-780"><a href="#cb32-780" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-781"><a href="#cb32-781" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb32-782"><a href="#cb32-782" aria-hidden="true" tabindex="-1"></a>  FF <span class="ot">&lt;-</span> matrices<span class="sc">$</span>FF</span>
<span id="cb32-783"><a href="#cb32-783" aria-hidden="true" tabindex="-1"></a>  GG <span class="ot">&lt;-</span> matrices<span class="sc">$</span>GG</span>
<span id="cb32-784"><a href="#cb32-784" aria-hidden="true" tabindex="-1"></a>  WW <span class="ot">&lt;-</span> matrices<span class="sc">$</span>WW</span>
<span id="cb32-785"><a href="#cb32-785" aria-hidden="true" tabindex="-1"></a>  VV <span class="ot">&lt;-</span> matrices<span class="sc">$</span>VV</span>
<span id="cb32-786"><a href="#cb32-786" aria-hidden="true" tabindex="-1"></a>  mt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>mt</span>
<span id="cb32-787"><a href="#cb32-787" aria-hidden="true" tabindex="-1"></a>  Ct <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>Ct</span>
<span id="cb32-788"><a href="#cb32-788" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-789"><a href="#cb32-789" aria-hidden="true" tabindex="-1"></a>  <span class="do">## set up matrices</span></span>
<span id="cb32-790"><a href="#cb32-790" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> <span class="fu">dim</span>(mt)[<span class="dv">1</span>] <span class="co"># time points</span></span>
<span id="cb32-791"><a href="#cb32-791" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">dim</span>(mt)[<span class="dv">2</span>] <span class="co"># dimension of state parameter vector</span></span>
<span id="cb32-792"><a href="#cb32-792" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-793"><a href="#cb32-793" aria-hidden="true" tabindex="-1"></a>  <span class="do">## placeholder for results</span></span>
<span id="cb32-794"><a href="#cb32-794" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> k, <span class="at">ncol =</span> d)</span>
<span id="cb32-795"><a href="#cb32-795" aria-hidden="true" tabindex="-1"></a>  Rt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, k))</span>
<span id="cb32-796"><a href="#cb32-796" aria-hidden="true" tabindex="-1"></a>  ft <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k)</span>
<span id="cb32-797"><a href="#cb32-797" aria-hidden="true" tabindex="-1"></a>  Qt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k)</span>
<span id="cb32-798"><a href="#cb32-798" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-799"><a href="#cb32-799" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-800"><a href="#cb32-800" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k){</span>
<span id="cb32-801"><a href="#cb32-801" aria-hidden="true" tabindex="-1"></a>    <span class="do">## moments of state distribution</span></span>
<span id="cb32-802"><a href="#cb32-802" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb32-803"><a href="#cb32-803" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> <span class="fu">t</span>(mt[T, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb32-804"><a href="#cb32-804" aria-hidden="true" tabindex="-1"></a>      Rt[, , i] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> Ct[, , T] <span class="sc">%*%</span> <span class="fu">t</span>(GG) <span class="sc">+</span> WW</span>
<span id="cb32-805"><a href="#cb32-805" aria-hidden="true" tabindex="-1"></a>      Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i]) </span>
<span id="cb32-806"><a href="#cb32-806" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb32-807"><a href="#cb32-807" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> <span class="fu">t</span>(at[i<span class="dv">-1</span>, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb32-808"><a href="#cb32-808" aria-hidden="true" tabindex="-1"></a>      Rt[, , i] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> Rt[, , i<span class="dv">-1</span>] <span class="sc">%*%</span> <span class="fu">t</span>(GG) <span class="sc">+</span> WW</span>
<span id="cb32-809"><a href="#cb32-809" aria-hidden="true" tabindex="-1"></a>      Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i]) </span>
<span id="cb32-810"><a href="#cb32-810" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb32-811"><a href="#cb32-811" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-812"><a href="#cb32-812" aria-hidden="true" tabindex="-1"></a>    <span class="do">## moments of forecast distribution</span></span>
<span id="cb32-813"><a href="#cb32-813" aria-hidden="true" tabindex="-1"></a>    ft[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(FF) <span class="sc">%*%</span> <span class="fu">t</span>(at[i, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb32-814"><a href="#cb32-814" aria-hidden="true" tabindex="-1"></a>    Qt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(FF) <span class="sc">%*%</span> Rt[, , i] <span class="sc">%*%</span> FF <span class="sc">+</span> VV</span>
<span id="cb32-815"><a href="#cb32-815" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-816"><a href="#cb32-816" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Forecasting is completed!"</span>) <span class="co"># indicator of completion</span></span>
<span id="cb32-817"><a href="#cb32-817" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">at=</span>at, <span class="at">Rt=</span>Rt, <span class="at">ft=</span>ft, <span class="at">Qt=</span>Qt))</span>
<span id="cb32-818"><a href="#cb32-818" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-819"><a href="#cb32-819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-820"><a href="#cb32-820" aria-hidden="true" tabindex="-1"></a><span class="do">## obtain 95% credible interval</span></span>
<span id="cb32-821"><a href="#cb32-821" aria-hidden="true" tabindex="-1"></a>get_credible_interval <span class="ot">&lt;-</span> <span class="cf">function</span>(mu, sigma2, </span>
<span id="cb32-822"><a href="#cb32-822" aria-hidden="true" tabindex="-1"></a>                          <span class="at">quantile =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)){</span>
<span id="cb32-823"><a href="#cb32-823" aria-hidden="true" tabindex="-1"></a>  z_quantile <span class="ot">&lt;-</span> <span class="fu">qnorm</span>(quantile)</span>
<span id="cb32-824"><a href="#cb32-824" aria-hidden="true" tabindex="-1"></a>  bound <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span><span class="fu">length</span>(mu), <span class="at">ncol=</span><span class="dv">2</span>)</span>
<span id="cb32-825"><a href="#cb32-825" aria-hidden="true" tabindex="-1"></a>  bound[, <span class="dv">1</span>] <span class="ot">&lt;-</span> mu <span class="sc">+</span> z_quantile[<span class="dv">1</span>]<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(sigma2)) <span class="co"># lower bound</span></span>
<span id="cb32-826"><a href="#cb32-826" aria-hidden="true" tabindex="-1"></a>  bound[, <span class="dv">2</span>] <span class="ot">&lt;-</span> mu <span class="sc">+</span> z_quantile[<span class="dv">2</span>]<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(sigma2)) <span class="co"># upper bound</span></span>
<span id="cb32-827"><a href="#cb32-827" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(bound)</span>
<span id="cb32-828"><a href="#cb32-828" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-829"><a href="#cb32-829" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-830"><a href="#cb32-830" aria-hidden="true" tabindex="-1"></a><span class="do">### smoothing equations </span><span class="al">###</span></span>
<span id="cb32-831"><a href="#cb32-831" aria-hidden="true" tabindex="-1"></a>backward_smoothing <span class="ot">&lt;-</span> <span class="cf">function</span>(data, matrices, </span>
<span id="cb32-832"><a href="#cb32-832" aria-hidden="true" tabindex="-1"></a>                               posterior_states){</span>
<span id="cb32-833"><a href="#cb32-833" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve data </span></span>
<span id="cb32-834"><a href="#cb32-834" aria-hidden="true" tabindex="-1"></a>  y_t <span class="ot">&lt;-</span> data<span class="sc">$</span>y_t</span>
<span id="cb32-835"><a href="#cb32-835" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> <span class="fu">length</span>(y_t) </span>
<span id="cb32-836"><a href="#cb32-836" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-837"><a href="#cb32-837" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb32-838"><a href="#cb32-838" aria-hidden="true" tabindex="-1"></a>  FF <span class="ot">&lt;-</span> matrices<span class="sc">$</span>FF</span>
<span id="cb32-839"><a href="#cb32-839" aria-hidden="true" tabindex="-1"></a>  GG <span class="ot">&lt;-</span> matrices<span class="sc">$</span>GG</span>
<span id="cb32-840"><a href="#cb32-840" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-841"><a href="#cb32-841" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb32-842"><a href="#cb32-842" aria-hidden="true" tabindex="-1"></a>  mt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>mt</span>
<span id="cb32-843"><a href="#cb32-843" aria-hidden="true" tabindex="-1"></a>  Ct <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>Ct</span>
<span id="cb32-844"><a href="#cb32-844" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>at</span>
<span id="cb32-845"><a href="#cb32-845" aria-hidden="true" tabindex="-1"></a>  Rt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>Rt</span>
<span id="cb32-846"><a href="#cb32-846" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-847"><a href="#cb32-847" aria-hidden="true" tabindex="-1"></a>  <span class="do">## create placeholder for posterior moments </span></span>
<span id="cb32-848"><a href="#cb32-848" aria-hidden="true" tabindex="-1"></a>  mnt <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">dim</span>(mt)[<span class="dv">1</span>], <span class="at">ncol =</span> <span class="fu">dim</span>(mt)[<span class="dv">2</span>])</span>
<span id="cb32-849"><a href="#cb32-849" aria-hidden="true" tabindex="-1"></a>  Cnt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">dim</span>(Ct))</span>
<span id="cb32-850"><a href="#cb32-850" aria-hidden="true" tabindex="-1"></a>  fnt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb32-851"><a href="#cb32-851" aria-hidden="true" tabindex="-1"></a>  Qnt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb32-852"><a href="#cb32-852" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> T<span class="sc">:</span><span class="dv">1</span>){</span>
<span id="cb32-853"><a href="#cb32-853" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments for the distributions of the state vector given D_T</span></span>
<span id="cb32-854"><a href="#cb32-854" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> T){</span>
<span id="cb32-855"><a href="#cb32-855" aria-hidden="true" tabindex="-1"></a>      mnt[i, ] <span class="ot">&lt;-</span> mt[i, ]</span>
<span id="cb32-856"><a href="#cb32-856" aria-hidden="true" tabindex="-1"></a>      Cnt[, , i] <span class="ot">&lt;-</span> Ct[, , i]</span>
<span id="cb32-857"><a href="#cb32-857" aria-hidden="true" tabindex="-1"></a>      Cnt[, , i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Cnt[, , i] <span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Cnt[, , i]) </span>
<span id="cb32-858"><a href="#cb32-858" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb32-859"><a href="#cb32-859" aria-hidden="true" tabindex="-1"></a>      inv_Rtp1<span class="ot">&lt;-</span><span class="fu">solve</span>(Rt[,,i<span class="sc">+</span><span class="dv">1</span>])</span>
<span id="cb32-860"><a href="#cb32-860" aria-hidden="true" tabindex="-1"></a>      Bt <span class="ot">&lt;-</span> Ct[, , i] <span class="sc">%*%</span> <span class="fu">t</span>(GG) <span class="sc">%*%</span> inv_Rtp1</span>
<span id="cb32-861"><a href="#cb32-861" aria-hidden="true" tabindex="-1"></a>      mnt[i, ] <span class="ot">&lt;-</span> mt[i, ] <span class="sc">+</span> Bt <span class="sc">%*%</span> (mnt[i<span class="sc">+</span><span class="dv">1</span>, ] <span class="sc">-</span> at[i<span class="sc">+</span><span class="dv">1</span>, ])</span>
<span id="cb32-862"><a href="#cb32-862" aria-hidden="true" tabindex="-1"></a>      Cnt[, , i] <span class="ot">&lt;-</span> Ct[, , i] <span class="sc">+</span> Bt <span class="sc">%*%</span> (Cnt[, , i <span class="sc">+</span> <span class="dv">1</span>] <span class="sc">-</span> Rt[, , i<span class="sc">+</span><span class="dv">1</span>]) <span class="sc">%*%</span> <span class="fu">t</span>(Bt)</span>
<span id="cb32-863"><a href="#cb32-863" aria-hidden="true" tabindex="-1"></a>      Cnt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Cnt[,,i] <span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Cnt[,,i]) </span>
<span id="cb32-864"><a href="#cb32-864" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb32-865"><a href="#cb32-865" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments for the smoothed distribution of the mean response of the series</span></span>
<span id="cb32-866"><a href="#cb32-866" aria-hidden="true" tabindex="-1"></a>    fnt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(FF) <span class="sc">%*%</span> <span class="fu">t</span>(mnt[i, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb32-867"><a href="#cb32-867" aria-hidden="true" tabindex="-1"></a>    Qnt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(FF) <span class="sc">%*%</span> <span class="fu">t</span>(Cnt[, , i]) <span class="sc">%*%</span> FF</span>
<span id="cb32-868"><a href="#cb32-868" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-869"><a href="#cb32-869" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Backward smoothing is completed!"</span>)</span>
<span id="cb32-870"><a href="#cb32-870" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mnt =</span> mnt, <span class="at">Cnt =</span> Cnt, <span class="at">fnt=</span>fnt, <span class="at">Qnt=</span>Qnt))</span>
<span id="cb32-871"><a href="#cb32-871" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-872"><a href="#cb32-872" aria-hidden="true" tabindex="-1"></a><span class="do">####################### Example: Lake Huron Data ######################</span></span>
<span id="cb32-873"><a href="#cb32-873" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(LakeHuron,<span class="at">main=</span><span class="st">"Lake Huron Data"</span>,<span class="at">ylab=</span><span class="st">"level in feet"</span>) </span>
<span id="cb32-874"><a href="#cb32-874" aria-hidden="true" tabindex="-1"></a><span class="co"># 98 observations total </span></span>
<span id="cb32-875"><a href="#cb32-875" aria-hidden="true" tabindex="-1"></a>k<span class="ot">=</span><span class="dv">4</span></span>
<span id="cb32-876"><a href="#cb32-876" aria-hidden="true" tabindex="-1"></a>T<span class="ot">=</span><span class="fu">length</span>(LakeHuron)<span class="sc">-</span>k <span class="co"># We take the first 94 observations </span></span>
<span id="cb32-877"><a href="#cb32-877" aria-hidden="true" tabindex="-1"></a>                     <span class="co">#  as our data</span></span>
<span id="cb32-878"><a href="#cb32-878" aria-hidden="true" tabindex="-1"></a>ts_data<span class="ot">=</span>LakeHuron[<span class="dv">1</span><span class="sc">:</span>T]</span>
<span id="cb32-879"><a href="#cb32-879" aria-hidden="true" tabindex="-1"></a>ts_validation_data <span class="ot">&lt;-</span> LakeHuron[(T<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span><span class="dv">98</span>]</span>
<span id="cb32-880"><a href="#cb32-880" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-881"><a href="#cb32-881" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y_t =</span> ts_data)</span>
<span id="cb32-882"><a href="#cb32-882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-883"><a href="#cb32-883" aria-hidden="true" tabindex="-1"></a><span class="do">## set up matrices</span></span>
<span id="cb32-884"><a href="#cb32-884" aria-hidden="true" tabindex="-1"></a>FF <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">1</span>)</span>
<span id="cb32-885"><a href="#cb32-885" aria-hidden="true" tabindex="-1"></a>GG <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">1</span>)</span>
<span id="cb32-886"><a href="#cb32-886" aria-hidden="true" tabindex="-1"></a>VV <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">1</span>)</span>
<span id="cb32-887"><a href="#cb32-887" aria-hidden="true" tabindex="-1"></a>WW <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">1</span>)</span>
<span id="cb32-888"><a href="#cb32-888" aria-hidden="true" tabindex="-1"></a>m0 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">570</span>)</span>
<span id="cb32-889"><a href="#cb32-889" aria-hidden="true" tabindex="-1"></a>C0 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fl">1e4</span>)</span>
<span id="cb32-890"><a href="#cb32-890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-891"><a href="#cb32-891" aria-hidden="true" tabindex="-1"></a><span class="do">## wrap up all matrices and initial values</span></span>
<span id="cb32-892"><a href="#cb32-892" aria-hidden="true" tabindex="-1"></a>matrices <span class="ot">&lt;-</span> <span class="fu">set_up_dlm_matrices</span>(FF,GG,VV,WW)</span>
<span id="cb32-893"><a href="#cb32-893" aria-hidden="true" tabindex="-1"></a>initial_states <span class="ot">&lt;-</span> <span class="fu">set_up_initial_states</span>(m0, C0)</span>
<span id="cb32-894"><a href="#cb32-894" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-895"><a href="#cb32-895" aria-hidden="true" tabindex="-1"></a><span class="do">## filtering</span></span>
<span id="cb32-896"><a href="#cb32-896" aria-hidden="true" tabindex="-1"></a>results_filtered <span class="ot">&lt;-</span> <span class="fu">forward_filter</span>(data, matrices, </span>
<span id="cb32-897"><a href="#cb32-897" aria-hidden="true" tabindex="-1"></a>                                   initial_states)</span>
<span id="cb32-898"><a href="#cb32-898" aria-hidden="true" tabindex="-1"></a>ci_filtered<span class="ot">&lt;-</span><span class="fu">get_credible_interval</span>(results_filtered<span class="sc">$</span>mt,</span>
<span id="cb32-899"><a href="#cb32-899" aria-hidden="true" tabindex="-1"></a>                                   results_filtered<span class="sc">$</span>Ct)</span>
<span id="cb32-900"><a href="#cb32-900" aria-hidden="true" tabindex="-1"></a><span class="do">## smoothing</span></span>
<span id="cb32-901"><a href="#cb32-901" aria-hidden="true" tabindex="-1"></a>results_smoothed <span class="ot">&lt;-</span> <span class="fu">backward_smoothing</span>(data, matrices, </span>
<span id="cb32-902"><a href="#cb32-902" aria-hidden="true" tabindex="-1"></a>                                       results_filtered)</span>
<span id="cb32-903"><a href="#cb32-903" aria-hidden="true" tabindex="-1"></a>ci_smoothed <span class="ot">&lt;-</span> <span class="fu">get_credible_interval</span>(results_smoothed<span class="sc">$</span>mnt, </span>
<span id="cb32-904"><a href="#cb32-904" aria-hidden="true" tabindex="-1"></a>                                     results_smoothed<span class="sc">$</span>Cnt)</span>
<span id="cb32-905"><a href="#cb32-905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-906"><a href="#cb32-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-907"><a href="#cb32-907" aria-hidden="true" tabindex="-1"></a>index<span class="ot">=</span><span class="fu">seq</span>(<span class="dv">1875</span>, <span class="dv">1972</span>, <span class="at">length.out =</span> <span class="fu">length</span>(LakeHuron))</span>
<span id="cb32-908"><a href="#cb32-908" aria-hidden="true" tabindex="-1"></a>index_filt<span class="ot">=</span>index[<span class="dv">1</span><span class="sc">:</span>T]</span>
<span id="cb32-909"><a href="#cb32-909" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-910"><a href="#cb32-910" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(index, LakeHuron, <span class="at">main =</span> <span class="st">"Lake Huron Level "</span>,<span class="at">type=</span><span class="st">'l'</span>,</span>
<span id="cb32-911"><a href="#cb32-911" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"time"</span>,<span class="at">ylab=</span><span class="st">"level in feet"</span>,<span class="at">lty=</span><span class="dv">3</span>,<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">575</span>,<span class="dv">583</span>))</span>
<span id="cb32-912"><a href="#cb32-912" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(index,LakeHuron,<span class="at">pch=</span><span class="dv">20</span>)</span>
<span id="cb32-913"><a href="#cb32-913" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-914"><a href="#cb32-914" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, results_filtered<span class="sc">$</span>mt, <span class="at">type=</span><span class="st">'l'</span>, </span>
<span id="cb32-915"><a href="#cb32-915" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'red'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb32-916"><a href="#cb32-916" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, ci_filtered[,<span class="dv">1</span>], <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'red'</span>,<span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb32-917"><a href="#cb32-917" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, ci_filtered[,<span class="dv">2</span>], <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'red'</span>,<span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb32-918"><a href="#cb32-918" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-919"><a href="#cb32-919" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, results_smoothed<span class="sc">$</span>mnt, <span class="at">type=</span><span class="st">'l'</span>, </span>
<span id="cb32-920"><a href="#cb32-920" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'blue'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb32-921"><a href="#cb32-921" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, ci_smoothed[,<span class="dv">1</span>], <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'blue'</span>,<span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb32-922"><a href="#cb32-922" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, ci_smoothed[,<span class="dv">2</span>], <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'blue'</span>,<span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb32-923"><a href="#cb32-923" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-924"><a href="#cb32-924" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">'bottomleft'</span>, <span class="at">legend=</span><span class="fu">c</span>(<span class="st">"filtered"</span>,<span class="st">"smoothed"</span>),</span>
<span id="cb32-925"><a href="#cb32-925" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>), <span class="at">lty=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb32-926"><a href="#cb32-926" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-927"><a href="#cb32-927" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-928"><a href="#cb32-928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-929"><a href="#cb32-929" aria-hidden="true" tabindex="-1"></a><span class="fu">## Second order polynomial: Filtering and smoothing example  :movie_camera:  {#sec-second-order-polynomial}</span></span>
<span id="cb32-930"><a href="#cb32-930" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-931"><a href="#cb32-931" aria-hidden="true" tabindex="-1"></a>In this video walk through the code provided in the section below the comment</span>
<span id="cb32-932"><a href="#cb32-932" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-933"><a href="#cb32-933" aria-hidden="true" tabindex="-1"></a>::: {.callout-note collapse="true"}</span>
<span id="cb32-934"><a href="#cb32-934" aria-hidden="true" tabindex="-1"></a><span class="fu">## Video Transcript</span></span>
<span id="cb32-935"><a href="#cb32-935" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-936"><a href="#cb32-936" aria-hidden="true" tabindex="-1"></a>{{&lt; include _C4-L03-T07.qmd &gt;}}</span>
<span id="cb32-937"><a href="#cb32-937" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-938"><a href="#cb32-938" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb32-939"><a href="#cb32-939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-940"><a href="#cb32-940" aria-hidden="true" tabindex="-1"></a><span class="fu">## Using the dlm package in R  :movie_camera: </span></span>
<span id="cb32-941"><a href="#cb32-941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-942"><a href="#cb32-942" aria-hidden="true" tabindex="-1"></a>The <span class="in">`dlm`</span> package in R is a powerful tool for working with dynamic linear models. The package provides a wide range of functions for filtering, smoothing, forecasting, and parameter estimation in DLMs. In this video, we walk through the code provided in @lst-dlm-package.</span>
<span id="cb32-943"><a href="#cb32-943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-944"><a href="#cb32-944" aria-hidden="true" tabindex="-1"></a>::: {.callout-note collapse="true"}</span>
<span id="cb32-945"><a href="#cb32-945" aria-hidden="true" tabindex="-1"></a><span class="fu">## Video Transcript</span></span>
<span id="cb32-946"><a href="#cb32-946" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-947"><a href="#cb32-947" aria-hidden="true" tabindex="-1"></a>{{&lt; include _C4-L03-T08.qmd &gt;}}</span>
<span id="cb32-948"><a href="#cb32-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-949"><a href="#cb32-949" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb32-950"><a href="#cb32-950" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-951"><a href="#cb32-951" aria-hidden="true" tabindex="-1"></a><span class="fu">## Code: Using the `dlm` package  :spiral_notepad:  $\mathcal{R}$ {#sec-dlm-package}</span></span>
<span id="cb32-952"><a href="#cb32-952" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-955"><a href="#cb32-955" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-956"><a href="#cb32-956" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: lst-dlm-package</span></span>
<span id="cb32-957"><a href="#cb32-957" aria-hidden="true" tabindex="-1"></a><span class="co">#| lst-label: lst-dlm-package</span></span>
<span id="cb32-958"><a href="#cb32-958" aria-hidden="true" tabindex="-1"></a><span class="co">#| lst-cap: Using the `dlm` package for dynamic linear models</span></span>
<span id="cb32-959"><a href="#cb32-959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-960"><a href="#cb32-960" aria-hidden="true" tabindex="-1"></a><span class="do">#################################################</span></span>
<span id="cb32-961"><a href="#cb32-961" aria-hidden="true" tabindex="-1"></a><span class="do">##### Univariate DLM: Known, constant variances</span></span>
<span id="cb32-962"><a href="#cb32-962" aria-hidden="true" tabindex="-1"></a><span class="do">#################################################</span></span>
<span id="cb32-963"><a href="#cb32-963" aria-hidden="true" tabindex="-1"></a>set_up_dlm_matrices <span class="ot">&lt;-</span> <span class="cf">function</span>(FF, GG, VV, WW){</span>
<span id="cb32-964"><a href="#cb32-964" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">FF=</span>FF, <span class="at">GG=</span>GG, <span class="at">VV=</span>VV, <span class="at">WW=</span>WW))</span>
<span id="cb32-965"><a href="#cb32-965" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-966"><a href="#cb32-966" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-967"><a href="#cb32-967" aria-hidden="true" tabindex="-1"></a>set_up_initial_states <span class="ot">&lt;-</span> <span class="cf">function</span>(m0, C0){</span>
<span id="cb32-968"><a href="#cb32-968" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">m0=</span>m0, <span class="at">C0=</span>C0))</span>
<span id="cb32-969"><a href="#cb32-969" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-970"><a href="#cb32-970" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-971"><a href="#cb32-971" aria-hidden="true" tabindex="-1"></a><span class="do">### forward update equations </span><span class="al">###</span></span>
<span id="cb32-972"><a href="#cb32-972" aria-hidden="true" tabindex="-1"></a>forward_filter <span class="ot">&lt;-</span> <span class="cf">function</span>(data, matrices, initial_states){</span>
<span id="cb32-973"><a href="#cb32-973" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve dataset</span></span>
<span id="cb32-974"><a href="#cb32-974" aria-hidden="true" tabindex="-1"></a>  y_t <span class="ot">&lt;-</span> data<span class="sc">$</span>y_t</span>
<span id="cb32-975"><a href="#cb32-975" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> <span class="fu">length</span>(y_t)</span>
<span id="cb32-976"><a href="#cb32-976" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-977"><a href="#cb32-977" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve a set of quadruples </span></span>
<span id="cb32-978"><a href="#cb32-978" aria-hidden="true" tabindex="-1"></a>  <span class="co"># FF, GG, VV, WW are scalar</span></span>
<span id="cb32-979"><a href="#cb32-979" aria-hidden="true" tabindex="-1"></a>  FF <span class="ot">&lt;-</span> matrices<span class="sc">$</span>FF  </span>
<span id="cb32-980"><a href="#cb32-980" aria-hidden="true" tabindex="-1"></a>  GG <span class="ot">&lt;-</span> matrices<span class="sc">$</span>GG</span>
<span id="cb32-981"><a href="#cb32-981" aria-hidden="true" tabindex="-1"></a>  VV <span class="ot">&lt;-</span> matrices<span class="sc">$</span>VV</span>
<span id="cb32-982"><a href="#cb32-982" aria-hidden="true" tabindex="-1"></a>  WW <span class="ot">&lt;-</span> matrices<span class="sc">$</span>WW</span>
<span id="cb32-983"><a href="#cb32-983" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-984"><a href="#cb32-984" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve initial states</span></span>
<span id="cb32-985"><a href="#cb32-985" aria-hidden="true" tabindex="-1"></a>  m0 <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>m0</span>
<span id="cb32-986"><a href="#cb32-986" aria-hidden="true" tabindex="-1"></a>  C0 <span class="ot">&lt;-</span> initial_states<span class="sc">$</span>C0</span>
<span id="cb32-987"><a href="#cb32-987" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-988"><a href="#cb32-988" aria-hidden="true" tabindex="-1"></a>  <span class="do">## create placeholder for results</span></span>
<span id="cb32-989"><a href="#cb32-989" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">dim</span>(GG)[<span class="dv">1</span>]</span>
<span id="cb32-990"><a href="#cb32-990" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow=</span>T, <span class="at">ncol=</span>d)</span>
<span id="cb32-991"><a href="#cb32-991" aria-hidden="true" tabindex="-1"></a>  Rt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, T))</span>
<span id="cb32-992"><a href="#cb32-992" aria-hidden="true" tabindex="-1"></a>  ft <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb32-993"><a href="#cb32-993" aria-hidden="true" tabindex="-1"></a>  Qt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb32-994"><a href="#cb32-994" aria-hidden="true" tabindex="-1"></a>  mt <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow=</span>T, <span class="at">ncol=</span>d)</span>
<span id="cb32-995"><a href="#cb32-995" aria-hidden="true" tabindex="-1"></a>  Ct <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, T))</span>
<span id="cb32-996"><a href="#cb32-996" aria-hidden="true" tabindex="-1"></a>  et <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb32-997"><a href="#cb32-997" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-998"><a href="#cb32-998" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-999"><a href="#cb32-999" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T){</span>
<span id="cb32-1000"><a href="#cb32-1000" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments of priors at t</span></span>
<span id="cb32-1001"><a href="#cb32-1001" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb32-1002"><a href="#cb32-1002" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> <span class="fu">t</span>(m0)</span>
<span id="cb32-1003"><a href="#cb32-1003" aria-hidden="true" tabindex="-1"></a>      Rt[, , i] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> C0 <span class="sc">%*%</span> <span class="fu">t</span>(GG) <span class="sc">+</span> WW</span>
<span id="cb32-1004"><a href="#cb32-1004" aria-hidden="true" tabindex="-1"></a>      Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i]) </span>
<span id="cb32-1005"><a href="#cb32-1005" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb32-1006"><a href="#cb32-1006" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> <span class="fu">t</span>(mt[i<span class="dv">-1</span>, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb32-1007"><a href="#cb32-1007" aria-hidden="true" tabindex="-1"></a>      Rt[, , i] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> Ct[, , i<span class="dv">-1</span>] <span class="sc">%*%</span> <span class="fu">t</span>(GG) <span class="sc">+</span> WW</span>
<span id="cb32-1008"><a href="#cb32-1008" aria-hidden="true" tabindex="-1"></a>      Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i]) </span>
<span id="cb32-1009"><a href="#cb32-1009" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb32-1010"><a href="#cb32-1010" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-1011"><a href="#cb32-1011" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments of one-step forecast:</span></span>
<span id="cb32-1012"><a href="#cb32-1012" aria-hidden="true" tabindex="-1"></a>    ft[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(FF) <span class="sc">%*%</span> (at[i, ]) </span>
<span id="cb32-1013"><a href="#cb32-1013" aria-hidden="true" tabindex="-1"></a>    Qt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(FF) <span class="sc">%*%</span> Rt[, , i] <span class="sc">%*%</span> FF <span class="sc">+</span> VV</span>
<span id="cb32-1014"><a href="#cb32-1014" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-1015"><a href="#cb32-1015" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments of posterior at t:</span></span>
<span id="cb32-1016"><a href="#cb32-1016" aria-hidden="true" tabindex="-1"></a>    At <span class="ot">&lt;-</span> Rt[, , i] <span class="sc">%*%</span> FF <span class="sc">/</span> Qt[i]</span>
<span id="cb32-1017"><a href="#cb32-1017" aria-hidden="true" tabindex="-1"></a>    et[i] <span class="ot">&lt;-</span> y_t[i] <span class="sc">-</span> ft[i]</span>
<span id="cb32-1018"><a href="#cb32-1018" aria-hidden="true" tabindex="-1"></a>    mt[i, ] <span class="ot">&lt;-</span> at[i, ] <span class="sc">+</span> <span class="fu">t</span>(At) <span class="sc">*</span> et[i]</span>
<span id="cb32-1019"><a href="#cb32-1019" aria-hidden="true" tabindex="-1"></a>    Ct[, , i] <span class="ot">&lt;-</span> Rt[, , i] <span class="sc">-</span> Qt[i] <span class="sc">*</span> At <span class="sc">%*%</span> <span class="fu">t</span>(At)</span>
<span id="cb32-1020"><a href="#cb32-1020" aria-hidden="true" tabindex="-1"></a>    Ct[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Ct[,,i] <span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Ct[,,i]) </span>
<span id="cb32-1021"><a href="#cb32-1021" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-1022"><a href="#cb32-1022" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Forward filtering is completed!"</span>) <span class="co"># indicator of completion</span></span>
<span id="cb32-1023"><a href="#cb32-1023" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mt =</span> mt, <span class="at">Ct =</span> Ct, <span class="at">at =</span> at, <span class="at">Rt =</span> Rt, </span>
<span id="cb32-1024"><a href="#cb32-1024" aria-hidden="true" tabindex="-1"></a>              <span class="at">ft =</span> ft, <span class="at">Qt =</span> Qt))</span>
<span id="cb32-1025"><a href="#cb32-1025" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-1026"><a href="#cb32-1026" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1027"><a href="#cb32-1027" aria-hidden="true" tabindex="-1"></a>forecast_function <span class="ot">&lt;-</span> <span class="cf">function</span>(posterior_states, k, matrices){</span>
<span id="cb32-1028"><a href="#cb32-1028" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-1029"><a href="#cb32-1029" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb32-1030"><a href="#cb32-1030" aria-hidden="true" tabindex="-1"></a>  FF <span class="ot">&lt;-</span> matrices<span class="sc">$</span>FF</span>
<span id="cb32-1031"><a href="#cb32-1031" aria-hidden="true" tabindex="-1"></a>  GG <span class="ot">&lt;-</span> matrices<span class="sc">$</span>GG</span>
<span id="cb32-1032"><a href="#cb32-1032" aria-hidden="true" tabindex="-1"></a>  WW <span class="ot">&lt;-</span> matrices<span class="sc">$</span>WW</span>
<span id="cb32-1033"><a href="#cb32-1033" aria-hidden="true" tabindex="-1"></a>  VV <span class="ot">&lt;-</span> matrices<span class="sc">$</span>VV</span>
<span id="cb32-1034"><a href="#cb32-1034" aria-hidden="true" tabindex="-1"></a>  mt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>mt</span>
<span id="cb32-1035"><a href="#cb32-1035" aria-hidden="true" tabindex="-1"></a>  Ct <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>Ct</span>
<span id="cb32-1036"><a href="#cb32-1036" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-1037"><a href="#cb32-1037" aria-hidden="true" tabindex="-1"></a>  <span class="do">## set up matrices</span></span>
<span id="cb32-1038"><a href="#cb32-1038" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> <span class="fu">dim</span>(mt)[<span class="dv">1</span>] <span class="co"># time points</span></span>
<span id="cb32-1039"><a href="#cb32-1039" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">dim</span>(mt)[<span class="dv">2</span>] <span class="co"># dimension of state parameter vector</span></span>
<span id="cb32-1040"><a href="#cb32-1040" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-1041"><a href="#cb32-1041" aria-hidden="true" tabindex="-1"></a>  <span class="do">## placeholder for results</span></span>
<span id="cb32-1042"><a href="#cb32-1042" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> k, <span class="at">ncol =</span> d)</span>
<span id="cb32-1043"><a href="#cb32-1043" aria-hidden="true" tabindex="-1"></a>  Rt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(d, d, k))</span>
<span id="cb32-1044"><a href="#cb32-1044" aria-hidden="true" tabindex="-1"></a>  ft <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k)</span>
<span id="cb32-1045"><a href="#cb32-1045" aria-hidden="true" tabindex="-1"></a>  Qt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k)</span>
<span id="cb32-1046"><a href="#cb32-1046" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-1047"><a href="#cb32-1047" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-1048"><a href="#cb32-1048" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k){</span>
<span id="cb32-1049"><a href="#cb32-1049" aria-hidden="true" tabindex="-1"></a>    <span class="do">## moments of state distribution</span></span>
<span id="cb32-1050"><a href="#cb32-1050" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb32-1051"><a href="#cb32-1051" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> <span class="fu">t</span>(mt[T, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb32-1052"><a href="#cb32-1052" aria-hidden="true" tabindex="-1"></a>      Rt[, , i] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> Ct[, , T] <span class="sc">%*%</span> <span class="fu">t</span>(GG) <span class="sc">+</span> WW</span>
<span id="cb32-1053"><a href="#cb32-1053" aria-hidden="true" tabindex="-1"></a>      Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i]) </span>
<span id="cb32-1054"><a href="#cb32-1054" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb32-1055"><a href="#cb32-1055" aria-hidden="true" tabindex="-1"></a>      at[i, ] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> <span class="fu">t</span>(at[i<span class="dv">-1</span>, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb32-1056"><a href="#cb32-1056" aria-hidden="true" tabindex="-1"></a>      Rt[, , i] <span class="ot">&lt;-</span> GG <span class="sc">%*%</span> Rt[, , i<span class="dv">-1</span>] <span class="sc">%*%</span> <span class="fu">t</span>(GG) <span class="sc">+</span> WW</span>
<span id="cb32-1057"><a href="#cb32-1057" aria-hidden="true" tabindex="-1"></a>      Rt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Rt[,,i]<span class="sc">+</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Rt[,,i]) </span>
<span id="cb32-1058"><a href="#cb32-1058" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb32-1059"><a href="#cb32-1059" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-1060"><a href="#cb32-1060" aria-hidden="true" tabindex="-1"></a>    <span class="do">## moments of forecast distribution</span></span>
<span id="cb32-1061"><a href="#cb32-1061" aria-hidden="true" tabindex="-1"></a>    ft[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(FF) <span class="sc">%*%</span> <span class="fu">t</span>(at[i, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb32-1062"><a href="#cb32-1062" aria-hidden="true" tabindex="-1"></a>    Qt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(FF) <span class="sc">%*%</span> Rt[, , i] <span class="sc">%*%</span> FF <span class="sc">+</span> VV</span>
<span id="cb32-1063"><a href="#cb32-1063" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-1064"><a href="#cb32-1064" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Forecasting is completed!"</span>) <span class="co"># indicator of completion</span></span>
<span id="cb32-1065"><a href="#cb32-1065" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">at=</span>at, <span class="at">Rt=</span>Rt, <span class="at">ft=</span>ft, <span class="at">Qt=</span>Qt))</span>
<span id="cb32-1066"><a href="#cb32-1066" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-1067"><a href="#cb32-1067" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1068"><a href="#cb32-1068" aria-hidden="true" tabindex="-1"></a><span class="do">## obtain 95% credible interval</span></span>
<span id="cb32-1069"><a href="#cb32-1069" aria-hidden="true" tabindex="-1"></a>get_credible_interval <span class="ot">&lt;-</span> <span class="cf">function</span>(mu, sigma2, </span>
<span id="cb32-1070"><a href="#cb32-1070" aria-hidden="true" tabindex="-1"></a>                          <span class="at">quantile =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)){</span>
<span id="cb32-1071"><a href="#cb32-1071" aria-hidden="true" tabindex="-1"></a>  z_quantile <span class="ot">&lt;-</span> <span class="fu">qnorm</span>(quantile)</span>
<span id="cb32-1072"><a href="#cb32-1072" aria-hidden="true" tabindex="-1"></a>  bound <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span><span class="fu">length</span>(mu), <span class="at">ncol=</span><span class="dv">2</span>)</span>
<span id="cb32-1073"><a href="#cb32-1073" aria-hidden="true" tabindex="-1"></a>  bound[, <span class="dv">1</span>] <span class="ot">&lt;-</span> mu <span class="sc">+</span> z_quantile[<span class="dv">1</span>]<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(sigma2)) <span class="co"># lower bound</span></span>
<span id="cb32-1074"><a href="#cb32-1074" aria-hidden="true" tabindex="-1"></a>  bound[, <span class="dv">2</span>] <span class="ot">&lt;-</span> mu <span class="sc">+</span> z_quantile[<span class="dv">2</span>]<span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">as.numeric</span>(sigma2)) <span class="co"># upper bound</span></span>
<span id="cb32-1075"><a href="#cb32-1075" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(bound)</span>
<span id="cb32-1076"><a href="#cb32-1076" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-1077"><a href="#cb32-1077" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1078"><a href="#cb32-1078" aria-hidden="true" tabindex="-1"></a><span class="do">### smoothing equations </span><span class="al">###</span></span>
<span id="cb32-1079"><a href="#cb32-1079" aria-hidden="true" tabindex="-1"></a>backward_smoothing <span class="ot">&lt;-</span> <span class="cf">function</span>(data, matrices, </span>
<span id="cb32-1080"><a href="#cb32-1080" aria-hidden="true" tabindex="-1"></a>                               posterior_states){</span>
<span id="cb32-1081"><a href="#cb32-1081" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve data </span></span>
<span id="cb32-1082"><a href="#cb32-1082" aria-hidden="true" tabindex="-1"></a>  y_t <span class="ot">&lt;-</span> data<span class="sc">$</span>y_t</span>
<span id="cb32-1083"><a href="#cb32-1083" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> <span class="fu">length</span>(y_t) </span>
<span id="cb32-1084"><a href="#cb32-1084" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-1085"><a href="#cb32-1085" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb32-1086"><a href="#cb32-1086" aria-hidden="true" tabindex="-1"></a>  FF <span class="ot">&lt;-</span> matrices<span class="sc">$</span>FF</span>
<span id="cb32-1087"><a href="#cb32-1087" aria-hidden="true" tabindex="-1"></a>  GG <span class="ot">&lt;-</span> matrices<span class="sc">$</span>GG</span>
<span id="cb32-1088"><a href="#cb32-1088" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-1089"><a href="#cb32-1089" aria-hidden="true" tabindex="-1"></a>  <span class="do">## retrieve matrices</span></span>
<span id="cb32-1090"><a href="#cb32-1090" aria-hidden="true" tabindex="-1"></a>  mt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>mt</span>
<span id="cb32-1091"><a href="#cb32-1091" aria-hidden="true" tabindex="-1"></a>  Ct <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>Ct</span>
<span id="cb32-1092"><a href="#cb32-1092" aria-hidden="true" tabindex="-1"></a>  at <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>at</span>
<span id="cb32-1093"><a href="#cb32-1093" aria-hidden="true" tabindex="-1"></a>  Rt <span class="ot">&lt;-</span> posterior_states<span class="sc">$</span>Rt</span>
<span id="cb32-1094"><a href="#cb32-1094" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-1095"><a href="#cb32-1095" aria-hidden="true" tabindex="-1"></a>  <span class="do">## create placeholder for posterior moments </span></span>
<span id="cb32-1096"><a href="#cb32-1096" aria-hidden="true" tabindex="-1"></a>  mnt <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">dim</span>(mt)[<span class="dv">1</span>], <span class="at">ncol =</span> <span class="fu">dim</span>(mt)[<span class="dv">2</span>])</span>
<span id="cb32-1097"><a href="#cb32-1097" aria-hidden="true" tabindex="-1"></a>  Cnt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">dim</span>(Ct))</span>
<span id="cb32-1098"><a href="#cb32-1098" aria-hidden="true" tabindex="-1"></a>  fnt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb32-1099"><a href="#cb32-1099" aria-hidden="true" tabindex="-1"></a>  Qnt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb32-1100"><a href="#cb32-1100" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> T<span class="sc">:</span><span class="dv">1</span>){</span>
<span id="cb32-1101"><a href="#cb32-1101" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments for the distributions of the state vector given D_T</span></span>
<span id="cb32-1102"><a href="#cb32-1102" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> T){</span>
<span id="cb32-1103"><a href="#cb32-1103" aria-hidden="true" tabindex="-1"></a>      mnt[i, ] <span class="ot">&lt;-</span> mt[i, ]</span>
<span id="cb32-1104"><a href="#cb32-1104" aria-hidden="true" tabindex="-1"></a>      Cnt[, , i] <span class="ot">&lt;-</span> Ct[, , i]</span>
<span id="cb32-1105"><a href="#cb32-1105" aria-hidden="true" tabindex="-1"></a>      Cnt[, , i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Cnt[, , i] <span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Cnt[, , i]) </span>
<span id="cb32-1106"><a href="#cb32-1106" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb32-1107"><a href="#cb32-1107" aria-hidden="true" tabindex="-1"></a>      inv_Rtp1<span class="ot">&lt;-</span><span class="fu">solve</span>(Rt[,,i<span class="sc">+</span><span class="dv">1</span>])</span>
<span id="cb32-1108"><a href="#cb32-1108" aria-hidden="true" tabindex="-1"></a>      Bt <span class="ot">&lt;-</span> Ct[, , i] <span class="sc">%*%</span> <span class="fu">t</span>(GG) <span class="sc">%*%</span> inv_Rtp1</span>
<span id="cb32-1109"><a href="#cb32-1109" aria-hidden="true" tabindex="-1"></a>      mnt[i, ] <span class="ot">&lt;-</span> mt[i, ] <span class="sc">+</span> Bt <span class="sc">%*%</span> (mnt[i<span class="sc">+</span><span class="dv">1</span>, ] <span class="sc">-</span> at[i<span class="sc">+</span><span class="dv">1</span>, ])</span>
<span id="cb32-1110"><a href="#cb32-1110" aria-hidden="true" tabindex="-1"></a>      Cnt[, , i] <span class="ot">&lt;-</span> Ct[, , i] <span class="sc">+</span> Bt <span class="sc">%*%</span> (Cnt[, , i <span class="sc">+</span> <span class="dv">1</span>] <span class="sc">-</span> Rt[, , i<span class="sc">+</span><span class="dv">1</span>]) <span class="sc">%*%</span> <span class="fu">t</span>(Bt)</span>
<span id="cb32-1111"><a href="#cb32-1111" aria-hidden="true" tabindex="-1"></a>      Cnt[,,i] <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>Cnt[,,i] <span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span><span class="fu">t</span>(Cnt[,,i]) </span>
<span id="cb32-1112"><a href="#cb32-1112" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb32-1113"><a href="#cb32-1113" aria-hidden="true" tabindex="-1"></a>    <span class="co"># moments for the smoothed distribution of the mean response of the series</span></span>
<span id="cb32-1114"><a href="#cb32-1114" aria-hidden="true" tabindex="-1"></a>    fnt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(FF) <span class="sc">%*%</span> <span class="fu">t</span>(mnt[i, , <span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb32-1115"><a href="#cb32-1115" aria-hidden="true" tabindex="-1"></a>    Qnt[i] <span class="ot">&lt;-</span> <span class="fu">t</span>(FF) <span class="sc">%*%</span> <span class="fu">t</span>(Cnt[, , i]) <span class="sc">%*%</span> FF</span>
<span id="cb32-1116"><a href="#cb32-1116" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-1117"><a href="#cb32-1117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Backward smoothing is completed!"</span>)</span>
<span id="cb32-1118"><a href="#cb32-1118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mnt =</span> mnt, <span class="at">Cnt =</span> Cnt, <span class="at">fnt=</span>fnt, <span class="at">Qnt=</span>Qnt))</span>
<span id="cb32-1119"><a href="#cb32-1119" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-1120"><a href="#cb32-1120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1121"><a href="#cb32-1121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1122"><a href="#cb32-1122" aria-hidden="true" tabindex="-1"></a><span class="do">####################### Example: Lake Huron Data ######################</span></span>
<span id="cb32-1123"><a href="#cb32-1123" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(LakeHuron) <span class="co"># 98 observations total </span></span>
<span id="cb32-1124"><a href="#cb32-1124" aria-hidden="true" tabindex="-1"></a>k<span class="ot">=</span><span class="dv">4</span></span>
<span id="cb32-1125"><a href="#cb32-1125" aria-hidden="true" tabindex="-1"></a>T<span class="ot">=</span><span class="fu">length</span>(LakeHuron)<span class="sc">-</span>k <span class="co"># We take the first </span></span>
<span id="cb32-1126"><a href="#cb32-1126" aria-hidden="true" tabindex="-1"></a>                      <span class="co"># 94 observations only as our data</span></span>
<span id="cb32-1127"><a href="#cb32-1127" aria-hidden="true" tabindex="-1"></a>ts_data<span class="ot">=</span>LakeHuron[<span class="dv">1</span><span class="sc">:</span>T]</span>
<span id="cb32-1128"><a href="#cb32-1128" aria-hidden="true" tabindex="-1"></a>ts_validation_data <span class="ot">&lt;-</span> LakeHuron[(T<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span><span class="dv">98</span>]</span>
<span id="cb32-1129"><a href="#cb32-1129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1130"><a href="#cb32-1130" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y_t =</span> ts_data)</span>
<span id="cb32-1131"><a href="#cb32-1131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1132"><a href="#cb32-1132" aria-hidden="true" tabindex="-1"></a><span class="do">## set up dlm matrices</span></span>
<span id="cb32-1133"><a href="#cb32-1133" aria-hidden="true" tabindex="-1"></a>GG <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">1</span>)</span>
<span id="cb32-1134"><a href="#cb32-1134" aria-hidden="true" tabindex="-1"></a>FF <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">1</span>)</span>
<span id="cb32-1135"><a href="#cb32-1135" aria-hidden="true" tabindex="-1"></a>VV <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">1</span>)</span>
<span id="cb32-1136"><a href="#cb32-1136" aria-hidden="true" tabindex="-1"></a>WW <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">1</span>)</span>
<span id="cb32-1137"><a href="#cb32-1137" aria-hidden="true" tabindex="-1"></a>m0 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">570</span>)</span>
<span id="cb32-1138"><a href="#cb32-1138" aria-hidden="true" tabindex="-1"></a>C0 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fl">1e4</span>)</span>
<span id="cb32-1139"><a href="#cb32-1139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1140"><a href="#cb32-1140" aria-hidden="true" tabindex="-1"></a><span class="do">## wrap up all matrices and initial values</span></span>
<span id="cb32-1141"><a href="#cb32-1141" aria-hidden="true" tabindex="-1"></a>matrices <span class="ot">&lt;-</span> <span class="fu">set_up_dlm_matrices</span>(FF, GG, VV, WW)</span>
<span id="cb32-1142"><a href="#cb32-1142" aria-hidden="true" tabindex="-1"></a>initial_states <span class="ot">&lt;-</span> <span class="fu">set_up_initial_states</span>(m0, C0)</span>
<span id="cb32-1143"><a href="#cb32-1143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1144"><a href="#cb32-1144" aria-hidden="true" tabindex="-1"></a><span class="do">## filtering and smoothing </span></span>
<span id="cb32-1145"><a href="#cb32-1145" aria-hidden="true" tabindex="-1"></a>results_filtered <span class="ot">&lt;-</span> <span class="fu">forward_filter</span>(data, matrices, </span>
<span id="cb32-1146"><a href="#cb32-1146" aria-hidden="true" tabindex="-1"></a>                                   initial_states)</span>
<span id="cb32-1147"><a href="#cb32-1147" aria-hidden="true" tabindex="-1"></a>results_smoothed <span class="ot">&lt;-</span> <span class="fu">backward_smoothing</span>(data, matrices, </span>
<span id="cb32-1148"><a href="#cb32-1148" aria-hidden="true" tabindex="-1"></a>                                       results_filtered)</span>
<span id="cb32-1149"><a href="#cb32-1149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1150"><a href="#cb32-1150" aria-hidden="true" tabindex="-1"></a>index<span class="ot">=</span><span class="fu">seq</span>(<span class="dv">1875</span>, <span class="dv">1972</span>, <span class="at">length.out =</span> <span class="fu">length</span>(LakeHuron))</span>
<span id="cb32-1151"><a href="#cb32-1151" aria-hidden="true" tabindex="-1"></a>index_filt<span class="ot">=</span>index[<span class="dv">1</span><span class="sc">:</span>T]</span>
<span id="cb32-1152"><a href="#cb32-1152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1153"><a href="#cb32-1153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1154"><a href="#cb32-1154" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">1</span>), <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">1</span>))</span>
<span id="cb32-1155"><a href="#cb32-1155" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(index, LakeHuron, <span class="at">main =</span> <span class="st">"Lake Huron Level "</span>,<span class="at">type=</span><span class="st">'l'</span>,</span>
<span id="cb32-1156"><a href="#cb32-1156" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"time"</span>,<span class="at">ylab=</span><span class="st">"feet"</span>,<span class="at">lty=</span><span class="dv">3</span>,<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">575</span>,<span class="dv">583</span>))</span>
<span id="cb32-1157"><a href="#cb32-1157" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(index,LakeHuron,<span class="at">pch=</span><span class="dv">20</span>)</span>
<span id="cb32-1158"><a href="#cb32-1158" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, results_filtered<span class="sc">$</span>mt, <span class="at">type=</span><span class="st">'l'</span>, </span>
<span id="cb32-1159"><a href="#cb32-1159" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'red'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb32-1160"><a href="#cb32-1160" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt, results_smoothed<span class="sc">$</span>mnt, <span class="at">type=</span><span class="st">'l'</span>, </span>
<span id="cb32-1161"><a href="#cb32-1161" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'blue'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb32-1162"><a href="#cb32-1162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1163"><a href="#cb32-1163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1164"><a href="#cb32-1164" aria-hidden="true" tabindex="-1"></a><span class="co"># Now let's look at the DLM package </span></span>
<span id="cb32-1165"><a href="#cb32-1165" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dlm)</span>
<span id="cb32-1166"><a href="#cb32-1166" aria-hidden="true" tabindex="-1"></a>model<span class="ot">=</span><span class="fu">dlmModPoly</span>(<span class="at">order=</span><span class="dv">1</span>,<span class="at">dV=</span><span class="dv">1</span>,<span class="at">dW=</span><span class="dv">1</span>,<span class="at">m0=</span><span class="dv">570</span>,<span class="at">C0=</span><span class="fl">1e4</span>)</span>
<span id="cb32-1167"><a href="#cb32-1167" aria-hidden="true" tabindex="-1"></a>results_filtered_dlm<span class="ot">=</span><span class="fu">dlmFilter</span>(LakeHuron[<span class="dv">1</span><span class="sc">:</span>T],model)</span>
<span id="cb32-1168"><a href="#cb32-1168" aria-hidden="true" tabindex="-1"></a>results_smoothed_dlm<span class="ot">=</span><span class="fu">dlmSmooth</span>(results_filtered_dlm)</span>
<span id="cb32-1169"><a href="#cb32-1169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1170"><a href="#cb32-1170" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(index_filt, LakeHuron[<span class="dv">1</span><span class="sc">:</span>T], <span class="at">ylab =</span> <span class="st">"level"</span>, </span>
<span id="cb32-1171"><a href="#cb32-1171" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Lake Huron Level"</span>,</span>
<span id="cb32-1172"><a href="#cb32-1172" aria-hidden="true" tabindex="-1"></a>     <span class="at">type=</span><span class="st">'l'</span>, <span class="at">xlab=</span><span class="st">"time"</span>,<span class="at">lty=</span><span class="dv">3</span>,<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">575</span>,<span class="dv">583</span>))</span>
<span id="cb32-1173"><a href="#cb32-1173" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(index_filt,LakeHuron[<span class="dv">1</span><span class="sc">:</span>T],<span class="at">pch=</span><span class="dv">20</span>)</span>
<span id="cb32-1174"><a href="#cb32-1174" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt,results_filtered_dlm<span class="sc">$</span>m[<span class="sc">-</span><span class="dv">1</span>],<span class="at">col=</span><span class="st">'red'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb32-1175"><a href="#cb32-1175" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(index_filt,results_smoothed_dlm<span class="sc">$</span>s[<span class="sc">-</span><span class="dv">1</span>],<span class="at">col=</span><span class="st">'blue'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb32-1176"><a href="#cb32-1176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1177"><a href="#cb32-1177" aria-hidden="true" tabindex="-1"></a><span class="co"># Similarly, for the second order polynomial and the co2 data:</span></span>
<span id="cb32-1178"><a href="#cb32-1178" aria-hidden="true" tabindex="-1"></a>T<span class="ot">=</span><span class="fu">length</span>(co2)</span>
<span id="cb32-1179"><a href="#cb32-1179" aria-hidden="true" tabindex="-1"></a>data<span class="ot">=</span><span class="fu">list</span>(<span class="at">y_t =</span> co2)</span>
<span id="cb32-1180"><a href="#cb32-1180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1181"><a href="#cb32-1181" aria-hidden="true" tabindex="-1"></a>FF <span class="ot">&lt;-</span> (<span class="fu">as.matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>)))</span>
<span id="cb32-1182"><a href="#cb32-1182" aria-hidden="true" tabindex="-1"></a>GG <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>),<span class="at">ncol=</span><span class="dv">2</span>,<span class="at">byrow=</span>T)</span>
<span id="cb32-1183"><a href="#cb32-1183" aria-hidden="true" tabindex="-1"></a>VV <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">200</span>)</span>
<span id="cb32-1184"><a href="#cb32-1184" aria-hidden="true" tabindex="-1"></a>WW <span class="ot">&lt;-</span> <span class="fl">0.01</span><span class="sc">*</span><span class="fu">diag</span>(<span class="dv">2</span>)</span>
<span id="cb32-1185"><a href="#cb32-1185" aria-hidden="true" tabindex="-1"></a>m0 <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">as.matrix</span>(<span class="fu">c</span>(<span class="dv">320</span>,<span class="dv">0</span>)))</span>
<span id="cb32-1186"><a href="#cb32-1186" aria-hidden="true" tabindex="-1"></a>C0 <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">*</span><span class="fu">diag</span>(<span class="dv">2</span>)</span>
<span id="cb32-1187"><a href="#cb32-1187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1188"><a href="#cb32-1188" aria-hidden="true" tabindex="-1"></a><span class="do">## wrap up all matrices and initial values</span></span>
<span id="cb32-1189"><a href="#cb32-1189" aria-hidden="true" tabindex="-1"></a>matrices <span class="ot">&lt;-</span> <span class="fu">set_up_dlm_matrices</span>(FF,GG, VV, WW)</span>
<span id="cb32-1190"><a href="#cb32-1190" aria-hidden="true" tabindex="-1"></a>initial_states <span class="ot">&lt;-</span> <span class="fu">set_up_initial_states</span>(m0, C0)</span>
<span id="cb32-1191"><a href="#cb32-1191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1192"><a href="#cb32-1192" aria-hidden="true" tabindex="-1"></a><span class="do">## filtering and smoothing </span></span>
<span id="cb32-1193"><a href="#cb32-1193" aria-hidden="true" tabindex="-1"></a>results_filtered <span class="ot">&lt;-</span> <span class="fu">forward_filter</span>(data, matrices, </span>
<span id="cb32-1194"><a href="#cb32-1194" aria-hidden="true" tabindex="-1"></a>                                   initial_states)</span>
<span id="cb32-1195"><a href="#cb32-1195" aria-hidden="true" tabindex="-1"></a>results_smoothed <span class="ot">&lt;-</span> <span class="fu">backward_smoothing</span>(data, matrices, </span>
<span id="cb32-1196"><a href="#cb32-1196" aria-hidden="true" tabindex="-1"></a>                                       results_filtered)</span>
<span id="cb32-1197"><a href="#cb32-1197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1198"><a href="#cb32-1198" aria-hidden="true" tabindex="-1"></a><span class="do">#### Now, using the DLM package: </span></span>
<span id="cb32-1199"><a href="#cb32-1199" aria-hidden="true" tabindex="-1"></a>model<span class="ot">=</span><span class="fu">dlmModPoly</span>(<span class="at">order=</span><span class="dv">2</span>,<span class="at">dV=</span><span class="dv">200</span>,<span class="at">dW=</span><span class="fl">0.01</span><span class="sc">*</span><span class="fu">rep</span>(<span class="dv">1</span>,<span class="dv">2</span>),</span>
<span id="cb32-1200"><a href="#cb32-1200" aria-hidden="true" tabindex="-1"></a>                 <span class="at">m0=</span><span class="fu">c</span>(<span class="dv">320</span>,<span class="dv">0</span>),<span class="at">C0=</span><span class="dv">10</span><span class="sc">*</span><span class="fu">diag</span>(<span class="dv">2</span>))</span>
<span id="cb32-1201"><a href="#cb32-1201" aria-hidden="true" tabindex="-1"></a><span class="co"># filtering and smoothing </span></span>
<span id="cb32-1202"><a href="#cb32-1202" aria-hidden="true" tabindex="-1"></a>results_filtered_dlm<span class="ot">=</span><span class="fu">dlmFilter</span>(data<span class="sc">$</span>y_t,model)</span>
<span id="cb32-1203"><a href="#cb32-1203" aria-hidden="true" tabindex="-1"></a>results_smoothed_dlm<span class="ot">=</span><span class="fu">dlmSmooth</span>(results_filtered_dlm)</span>
<span id="cb32-1204"><a href="#cb32-1204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1205"><a href="#cb32-1205" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">1</span>), <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">1</span>))</span>
<span id="cb32-1206"><a href="#cb32-1206" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">as.vector</span>(<span class="fu">time</span>(co2)),co2,<span class="at">type=</span><span class="st">'l'</span>,<span class="at">xlab=</span><span class="st">"time"</span>,</span>
<span id="cb32-1207"><a href="#cb32-1207" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">300</span>,<span class="dv">380</span>))</span>
<span id="cb32-1208"><a href="#cb32-1208" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">as.vector</span>(<span class="fu">time</span>(co2)),results_filtered<span class="sc">$</span>mt[,<span class="dv">1</span>],</span>
<span id="cb32-1209"><a href="#cb32-1209" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'red'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb32-1210"><a href="#cb32-1210" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">as.vector</span>(<span class="fu">time</span>(co2)),results_smoothed<span class="sc">$</span>mnt[,<span class="dv">1</span>],</span>
<span id="cb32-1211"><a href="#cb32-1211" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'blue'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb32-1212"><a href="#cb32-1212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1213"><a href="#cb32-1213" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">as.vector</span>(<span class="fu">time</span>(co2)),co2,<span class="at">type=</span><span class="st">'l'</span>,<span class="at">xlab=</span><span class="st">"time"</span>,</span>
<span id="cb32-1214"><a href="#cb32-1214" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">300</span>,<span class="dv">380</span>))</span>
<span id="cb32-1215"><a href="#cb32-1215" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">as.vector</span>(<span class="fu">time</span>(co2)),results_filtered_dlm<span class="sc">$</span>m[<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>],</span>
<span id="cb32-1216"><a href="#cb32-1216" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'red'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb32-1217"><a href="#cb32-1217" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">as.vector</span>(<span class="fu">time</span>(co2)),results_smoothed_dlm<span class="sc">$</span>s[<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>],</span>
<span id="cb32-1218"><a href="#cb32-1218" aria-hidden="true" tabindex="-1"></a>      <span class="at">col=</span><span class="st">'blue'</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb32-1219"><a href="#cb32-1219" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-1220"><a href="#cb32-1220" aria-hidden="true" tabindex="-1"></a></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Copyright 2025, Oren Bochman</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>
<script>var lightboxQuarto = GLightbox({"closeEffect":"fade","descPosition":"bottom","loop":true,"openEffect":"fade","selector":".lightbox","skin":"my-css-class"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>